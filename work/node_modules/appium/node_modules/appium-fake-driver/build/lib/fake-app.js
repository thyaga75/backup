'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _xmldom = require('xmldom');

var _xmldom2 = _interopRequireDefault(_xmldom);

var _xpath = require('xpath');

var _xpath2 = _interopRequireDefault(_xpath);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _fakeElement = require('./fake-element');

var readFile = _bluebird2['default'].promisify(_fs2['default'].readFile);

var FakeApp = (function () {
  function FakeApp() {
    _classCallCheck(this, FakeApp);

    this.dom = null;
    this.activeDom = null;
    this.activeWebview = null;
    this.activeFrame = null;
    this.activeAlert = null;
    this.timeouts = {
      implicitWait: null,
      asyncScript: null
    };
    this.lat = 0;
    this.long = 0;
    this.rawXml = '';
    this.currentOrientation = "PORTRAIT";
  }

  _createClass(FakeApp, [{
    key: 'loadApp',
    value: function loadApp(appPath) {
      var data;
      return _regeneratorRuntime.async(function loadApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info("Loading Mock app model");
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(readFile(appPath));

          case 3:
            data = context$2$0.sent;

            _logger2['default'].info("Parsing Mock app XML");
            this.rawXml = data.toString();
            this.dom = new _xmldom2['default'].DOMParser().parseFromString(this.rawXml);
            this.activeDom = this.dom;

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getWebviews',
    value: function getWebviews() {
      return this.xpathQuery('//MockWebView/*[1]').map(function (n) {
        return new FakeWebView(n);
      });
    }
  }, {
    key: 'activateWebview',
    value: function activateWebview(wv) {
      this.activeWebview = wv;
      var fragment = new _xmldom2['default'].XMLSerializer().serializeToString(wv.node);
      this.activeDom = new _xmldom2['default'].DOMParser().parseFromString(fragment, "application/xml");
    }
  }, {
    key: 'deactivateWebview',
    value: function deactivateWebview() {
      this.activeWebview = null;
      this.activeDom = this.dom;
    }
  }, {
    key: 'activateFrame',
    value: function activateFrame(frame) {
      this.activeFrame = frame;
      var fragment = new _xmldom2['default'].XMLSerializer().serializeToString(frame);
      this.activeDom = new _xmldom2['default'].DOMParser().parseFromString(fragment, "application/xml");
    }
  }, {
    key: 'deactivateFrame',
    value: function deactivateFrame() {
      this.activeFrame = null;
      this.activateWebview(this.activeWebview);
    }
  }, {
    key: 'xpathQuery',
    value: function xpathQuery(sel, ctx) {
      return _xpath2['default'].select(sel, ctx || this.activeDom);
    }
  }, {
    key: 'idQuery',
    value: function idQuery(id, ctx) {
      return this.xpathQuery('//*[@id="' + id + '"]', ctx);
    }
  }, {
    key: 'classQuery',
    value: function classQuery(className, ctx) {
      return this.xpathQuery('//' + className, ctx);
    }
  }, {
    key: 'hasAlert',
    value: function hasAlert() {
      return this.activeAlert !== null;
    }
  }, {
    key: 'setAlertText',
    value: function setAlertText(text) {
      if (!this.activeAlert.hasPrompt()) {
        throw new Error("No prompt to set text of");
      }
      this.activeAlert.setAttr('prompt', text);
    }
  }, {
    key: 'showAlert',
    value: function showAlert(alertId) {
      var nodes = this.xpathQuery('//alert[@id="' + alertId + '"]');
      if (nodes.length < 1) {
        throw new Error('Alert ' + alertId + ' doesn\'t exist!');
      }
      this.activeAlert = new _fakeElement.FakeElement(nodes[0], this);
    }
  }, {
    key: 'alertText',
    value: function alertText() {
      return this.activeAlert.getAttr('prompt') || this.activeAlert.nodeAttrs.text;
    }
  }, {
    key: 'handleAlert',
    value: function handleAlert() {
      this.activeAlert = null;
    }
  }, {
    key: 'getScreenshot',
    value: function getScreenshot() {
      return "hahahanotreallyascreenshot";
    }
  }, {
    key: 'title',
    get: function get() {
      var nodes = this.xpathQuery('//title');
      if (nodes.length < 1) {
        throw new Error("No title!");
      }
      return nodes[0].firstChild.data;
    }
  }, {
    key: 'currentGeoLocation',
    get: function get() {
      return {
        latitude: this.lat,
        longitude: this.long
      };
    }
  }, {
    key: 'orientation',
    get: function get() {
      return this.currentOrientation;
    },
    set: function set(o) {
      this.currentOrientation = o;
    }
  }]);

  return FakeApp;
})();

var FakeWebView = function FakeWebView(node) {
  _classCallCheck(this, FakeWebView);

  this.node = node;
};

exports.FakeApp = FakeApp;
//# sourceMappingURL=data:application/json;base64,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QUFPLENBQUMsUUFBUSxDQUFDLElBQ2xDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztLQUN4Qzs7O1dBRVcsdUJBQUc7QUFDYixVQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztLQUN6Qjs7O1dBRWEseUJBQUc7QUFDZixhQUFPLDRCQUE0QixDQUFDO0tBQ3JDOzs7U0F4R1MsZUFBRztBQUNYLFVBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDdkMsVUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtBQUNwQixjQUFNLElBQUksS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO09BQzlCO0FBQ0QsYUFBTyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztLQUNqQzs7O1NBRXNCLGVBQUc7QUFDeEIsYUFBTztBQUNMLGdCQUFRLEVBQUUsSUFBSSxDQUFDLEdBQUc7QUFDbEIsaUJBQVMsRUFBRSxJQUFJLENBQUMsSUFBSTtPQUNyQixDQUFDO0tBQ0g7OztTQUVlLGVBQUc7QUFDakIsYUFBTyxJQUFJLENBQUMsa0JBQWtCLENBQUM7S0FDaEM7U0FFZSxhQUFDLENBQUMsRUFBRTtBQUNsQixVQUFJLENBQUMsa0JBQWtCLEdBQUcsQ0FBQyxDQUFDO0tBQzdCOzs7U0F0Q0csT0FBTzs7O0lBNkhQLFdBQVcsR0FDSCxTQURSLFdBQVcsQ0FDRixJQUFJLEVBQUU7d0JBRGYsV0FBVzs7QUFFYixNQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztDQUNsQjs7UUFHTSxPQUFPLEdBQVAsT0FBTyIsImZpbGUiOiJsaWIvZmFrZS1hcHAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IFhNTERvbSBmcm9tICd4bWxkb20nO1xuaW1wb3J0IHhwYXRoIGZyb20gJ3hwYXRoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgRmFrZUVsZW1lbnQgfSBmcm9tICcuL2Zha2UtZWxlbWVudCc7XG5cbmNvbnN0IHJlYWRGaWxlID0gQi5wcm9taXNpZnkoZnMucmVhZEZpbGUpO1xuXG5jbGFzcyBGYWtlQXBwIHtcbiAgY29uc3RydWN0b3IgKCkge1xuICAgIHRoaXMuZG9tID0gbnVsbDtcbiAgICB0aGlzLmFjdGl2ZURvbSA9IG51bGw7XG4gICAgdGhpcy5hY3RpdmVXZWJ2aWV3ID0gbnVsbDtcbiAgICB0aGlzLmFjdGl2ZUZyYW1lID0gbnVsbDtcbiAgICB0aGlzLmFjdGl2ZUFsZXJ0ID0gbnVsbDtcbiAgICB0aGlzLnRpbWVvdXRzID0ge1xuICAgICAgaW1wbGljaXRXYWl0OiBudWxsLFxuICAgICAgYXN5bmNTY3JpcHQ6IG51bGwsXG4gICAgfTtcbiAgICB0aGlzLmxhdCA9IDA7XG4gICAgdGhpcy5sb25nID0gMDtcbiAgICB0aGlzLnJhd1htbCA9ICcnO1xuICAgIHRoaXMuY3VycmVudE9yaWVudGF0aW9uID0gXCJQT1JUUkFJVFwiO1xuICB9XG5cbiAgZ2V0IHRpdGxlICgpIHtcbiAgICBsZXQgbm9kZXMgPSB0aGlzLnhwYXRoUXVlcnkoJy8vdGl0bGUnKTtcbiAgICBpZiAobm9kZXMubGVuZ3RoIDwgMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTm8gdGl0bGUhXCIpO1xuICAgIH1cbiAgICByZXR1cm4gbm9kZXNbMF0uZmlyc3RDaGlsZC5kYXRhO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRHZW9Mb2NhdGlvbiAoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGxhdGl0dWRlOiB0aGlzLmxhdCxcbiAgICAgIGxvbmdpdHVkZTogdGhpcy5sb25nXG4gICAgfTtcbiAgfVxuXG4gIGdldCBvcmllbnRhdGlvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudE9yaWVudGF0aW9uO1xuICB9XG5cbiAgc2V0IG9yaWVudGF0aW9uIChvKSB7XG4gICAgdGhpcy5jdXJyZW50T3JpZW50YXRpb24gPSBvO1xuICB9XG5cbiAgYXN5bmMgbG9hZEFwcCAoYXBwUGF0aCkge1xuICAgIGxvZy5pbmZvKFwiTG9hZGluZyBNb2NrIGFwcCBtb2RlbFwiKTtcbiAgICBsZXQgZGF0YSA9IGF3YWl0IHJlYWRGaWxlKGFwcFBhdGgpO1xuICAgIGxvZy5pbmZvKFwiUGFyc2luZyBNb2NrIGFwcCBYTUxcIik7XG4gICAgdGhpcy5yYXdYbWwgPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgdGhpcy5kb20gPSBuZXcgWE1MRG9tLkRPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyh0aGlzLnJhd1htbCk7XG4gICAgdGhpcy5hY3RpdmVEb20gPSB0aGlzLmRvbTtcbiAgfVxuXG4gIGdldFdlYnZpZXdzICgpIHtcbiAgICByZXR1cm4gdGhpcy54cGF0aFF1ZXJ5KCcvL01vY2tXZWJWaWV3LypbMV0nKS5tYXAoKG4pID0+IHtcbiAgICAgIHJldHVybiBuZXcgRmFrZVdlYlZpZXcobik7XG4gICAgfSk7XG4gIH1cblxuICBhY3RpdmF0ZVdlYnZpZXcgKHd2KSB7XG4gICAgdGhpcy5hY3RpdmVXZWJ2aWV3ID0gd3Y7XG4gICAgbGV0IGZyYWdtZW50ID0gbmV3IFhNTERvbS5YTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcod3Yubm9kZSk7XG4gICAgdGhpcy5hY3RpdmVEb20gPSBuZXcgWE1MRG9tLkRPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhmcmFnbWVudCxcbiAgICAgICAgXCJhcHBsaWNhdGlvbi94bWxcIik7XG4gIH1cblxuICBkZWFjdGl2YXRlV2VidmlldyAoKSB7XG4gICAgdGhpcy5hY3RpdmVXZWJ2aWV3ID0gbnVsbDtcbiAgICB0aGlzLmFjdGl2ZURvbSA9IHRoaXMuZG9tO1xuICB9XG5cbiAgYWN0aXZhdGVGcmFtZSAoZnJhbWUpIHtcbiAgICB0aGlzLmFjdGl2ZUZyYW1lID0gZnJhbWU7XG4gICAgbGV0IGZyYWdtZW50ID0gbmV3IFhNTERvbS5YTUxTZXJpYWxpemVyKCkuc2VyaWFsaXplVG9TdHJpbmcoZnJhbWUpO1xuICAgIHRoaXMuYWN0aXZlRG9tID0gbmV3IFhNTERvbS5ET01QYXJzZXIoKS5wYXJzZUZyb21TdHJpbmcoZnJhZ21lbnQsXG4gICAgICAgIFwiYXBwbGljYXRpb24veG1sXCIpO1xuICB9XG5cbiAgZGVhY3RpdmF0ZUZyYW1lICgpIHtcbiAgICB0aGlzLmFjdGl2ZUZyYW1lID0gbnVsbDtcbiAgICB0aGlzLmFjdGl2YXRlV2Vidmlldyh0aGlzLmFjdGl2ZVdlYnZpZXcpO1xuICB9XG5cbiAgeHBhdGhRdWVyeSAoc2VsLCBjdHgpIHtcbiAgICByZXR1cm4geHBhdGguc2VsZWN0KHNlbCwgY3R4IHx8IHRoaXMuYWN0aXZlRG9tKTtcbiAgfVxuXG4gIGlkUXVlcnkgKGlkLCBjdHgpIHtcbiAgICByZXR1cm4gdGhpcy54cGF0aFF1ZXJ5KGAvLypbQGlkPVwiJHtpZH1cIl1gLCBjdHgpO1xuICB9XG5cbiAgY2xhc3NRdWVyeSAoY2xhc3NOYW1lLCBjdHgpIHtcbiAgICByZXR1cm4gdGhpcy54cGF0aFF1ZXJ5KGAvLyR7Y2xhc3NOYW1lfWAsIGN0eCk7XG4gIH1cblxuICBoYXNBbGVydCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuYWN0aXZlQWxlcnQgIT09IG51bGw7XG4gIH1cblxuICBzZXRBbGVydFRleHQgKHRleHQpIHtcbiAgICBpZiAoIXRoaXMuYWN0aXZlQWxlcnQuaGFzUHJvbXB0KCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIk5vIHByb21wdCB0byBzZXQgdGV4dCBvZlwiKTtcbiAgICB9XG4gICAgdGhpcy5hY3RpdmVBbGVydC5zZXRBdHRyKCdwcm9tcHQnLCB0ZXh0KTtcbiAgfVxuXG4gIHNob3dBbGVydCAoYWxlcnRJZCkge1xuICAgIGxldCBub2RlcyA9IHRoaXMueHBhdGhRdWVyeShgLy9hbGVydFtAaWQ9XCIke2FsZXJ0SWR9XCJdYCk7XG4gICAgaWYgKG5vZGVzLmxlbmd0aCA8IDEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQWxlcnQgJHthbGVydElkfSBkb2Vzbid0IGV4aXN0IWApO1xuICAgIH1cbiAgICB0aGlzLmFjdGl2ZUFsZXJ0ID0gbmV3IEZha2VFbGVtZW50KG5vZGVzWzBdLCB0aGlzKTtcbiAgfVxuXG4gIGFsZXJ0VGV4dCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuYWN0aXZlQWxlcnQuZ2V0QXR0cigncHJvbXB0JykgfHxcbiAgICAgICAgICAgdGhpcy5hY3RpdmVBbGVydC5ub2RlQXR0cnMudGV4dDtcbiAgfVxuXG4gIGhhbmRsZUFsZXJ0ICgpIHtcbiAgICB0aGlzLmFjdGl2ZUFsZXJ0ID0gbnVsbDtcbiAgfVxuXG4gIGdldFNjcmVlbnNob3QgKCkge1xuICAgIHJldHVybiBcImhhaGFoYW5vdHJlYWxseWFzY3JlZW5zaG90XCI7XG4gIH1cblxufVxuXG5jbGFzcyBGYWtlV2ViVmlldyB7XG4gIGNvbnN0cnVjdG9yIChub2RlKSB7XG4gICAgdGhpcy5ub2RlID0gbm9kZTtcbiAgfVxufVxuXG5leHBvcnQgeyBGYWtlQXBwIH07XG4iXX0=