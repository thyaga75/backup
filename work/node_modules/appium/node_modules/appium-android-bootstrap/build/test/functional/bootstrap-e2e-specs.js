// transpile :mocha

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _ = require('../..');

var _appiumAdb = require('appium-adb');

var _appiumAdb2 = _interopRequireDefault(_appiumAdb);

var _mobileJsonWireProtocol = require('mobile-json-wire-protocol');

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('Android Bootstrap', function () {
  var _this = this;

  this.timeout(60000);
  var adb = undefined,
      androidBootstrap = undefined;
  var rootDir = _path2['default'].resolve(__dirname, process.env.NO_PRECOMPILE ? '../..' : '../../..');
  var apiDemos = _path2['default'].resolve(rootDir, 'test', 'fixtures', 'ApiDemos-debug.apk');
  var systemPort = 4724;
  before(function callee$1$0() {
    var packageName, activityName;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(_appiumAdb2['default'].createADB());

        case 2:
          adb = context$2$0.sent;
          packageName = 'io.appium.android.apis', activityName = '.ApiDemos';
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(adb.install(apiDemos));

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(adb.startApp({ pkg: packageName,
            activity: activityName }));

        case 8:
          androidBootstrap = new _.AndroidBootstrap(adb, systemPort);
          context$2$0.next = 11;
          return _regeneratorRuntime.awrap(androidBootstrap.start('io.appium.android.apis', false));

        case 11:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  after(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(androidBootstrap.shutdown());

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it("sendAction should work", function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(androidBootstrap.sendAction('wake'));

        case 2:
          context$2$0.sent.should.equal(true);

        case 3:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it("sendCommand should work", function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(androidBootstrap.sendCommand(_.COMMAND_TYPES.ACTION, { action: 'getDataDir' }));

        case 2:
          context$2$0.sent.should.equal("/data");

        case 3:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it("sendCommand should correctly throw error", function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(androidBootstrap.sendCommand(_.COMMAND_TYPES.ACTION, { action: 'unknown' }).should.eventually.be.rejectedWith(_mobileJsonWireProtocol.errors.UnknownCommandError));

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it("should cancel onUnexpectedShutdown promise on unexpected uiAutomator shutdown", function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(androidBootstrap.sendCommand(_.COMMAND_TYPES.SHUTDOWN));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(androidBootstrap.onUnexpectedShutdown.should.eventually.be.rejectedWith("Error: UiAUtomator shut down unexpectedly"));

        case 4:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZnVuY3Rpb25hbC9ib290c3RyYXAtZTJlLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O29CQUVpQixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7OztvQkFDNUIsTUFBTTs7OztnQkFDeUIsT0FBTzs7eUJBQ3ZDLFlBQVk7Ozs7c0NBQ0wsMkJBQTJCOztBQUdsRCxrQkFBSyxNQUFNLEVBQUUsQ0FBQztBQUNkLGtCQUFLLEdBQUcsNkJBQWdCLENBQUM7O0FBRXpCLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxZQUFZOzs7QUFDeEMsTUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNwQixNQUFJLEdBQUcsWUFBQTtNQUFFLGdCQUFnQixZQUFBLENBQUM7QUFDMUIsTUFBSSxPQUFPLEdBQUcsa0JBQUssT0FBTyxDQUFDLFNBQVMsRUFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsR0FBRyxPQUFPLEdBQUcsVUFBVSxDQUFDLENBQUM7QUFDN0UsTUFBTSxRQUFRLEdBQUcsa0JBQUssT0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLG9CQUFvQixDQUFDLENBQUM7QUFDakYsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDO0FBQ3hCLFFBQU0sQ0FBQztRQUVDLFdBQVcsRUFDWCxZQUFZOzs7OzsyQ0FGTix1QkFBSSxTQUFTLEVBQUU7OztBQUEzQixhQUFHO0FBQ0cscUJBQVcsR0FBRyx3QkFBd0IsRUFDdEMsWUFBWSxHQUFHLFdBQVc7OzJDQUMxQixHQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQzs7OzsyQ0FDckIsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFDLEdBQUcsRUFBRSxXQUFXO0FBQ2hCLG9CQUFRLEVBQUUsWUFBWSxFQUFDLENBQUM7OztBQUM1QywwQkFBZ0IsR0FBRyx1QkFBcUIsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDOzsyQ0FDbkQsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFLEtBQUssQ0FBQzs7Ozs7OztHQUM5RCxDQUFDLENBQUM7QUFDSCxPQUFLLENBQUM7Ozs7OzJDQUNFLGdCQUFnQixDQUFDLFFBQVEsRUFBRTs7Ozs7OztHQUNsQyxDQUFDLENBQUM7QUFDSCxJQUFFLENBQUMsd0JBQXdCLEVBQUU7Ozs7OzJDQUNwQixnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDOzs7MkJBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJOzs7Ozs7O0dBQzlELENBQUMsQ0FBQztBQUNILElBQUUsQ0FBQyx5QkFBeUIsRUFBRTs7Ozs7MkNBQ3RCLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxnQkFBYyxNQUFNLEVBQUUsRUFBQyxNQUFNLEVBQUUsWUFBWSxFQUFDLENBQUM7OzsyQkFBRSxNQUFNLENBQ3RGLEtBQUssQ0FBQyxPQUFPOzs7Ozs7O0dBQ2hCLENBQUMsQ0FBQztBQUNILElBQUUsQ0FBQywwQ0FBMEMsRUFBRTs7Ozs7MkNBQ3hDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxnQkFBYyxNQUFNLEVBQUUsRUFBQyxNQUFNLEVBQUUsU0FBUyxFQUFDLENBQUMsQ0FBQyxNQUFNLENBQ2pGLFVBQVUsQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLCtCQUFPLG1CQUFtQixDQUFDOzs7Ozs7O0dBQ3pELENBQUMsQ0FBQztBQUNILElBQUUsQ0FBQywrRUFBK0UsRUFBRTs7Ozs7MkNBQzVFLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxnQkFBYyxRQUFRLENBQUM7Ozs7MkNBQ3BELGdCQUFnQixDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQzFELEVBQUUsQ0FBQyxZQUFZLENBQUMsMkNBQTJDLENBQUM7Ozs7Ozs7R0FDaEUsQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDIiwiZmlsZSI6InRlc3QvZnVuY3Rpb25hbC9ib290c3RyYXAtZTJlLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlIDptb2NoYVxuXG5pbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgQW5kcm9pZEJvb3RzdHJhcCwgQ09NTUFORF9UWVBFUyB9IGZyb20gJy4uLy4uJztcbmltcG9ydCBBREIgZnJvbSAnYXBwaXVtLWFkYic7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdtb2JpbGUtanNvbi13aXJlLXByb3RvY29sJztcblxuXG5jaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5kZXNjcmliZSgnQW5kcm9pZCBCb290c3RyYXAnLCBmdW5jdGlvbiAoKSB7XG4gIHRoaXMudGltZW91dCg2MDAwMCk7XG4gIGxldCBhZGIsIGFuZHJvaWRCb290c3RyYXA7XG4gIGxldCByb290RGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuTk9fUFJFQ09NUElMRSA/ICcuLi8uLicgOiAnLi4vLi4vLi4nKTtcbiAgY29uc3QgYXBpRGVtb3MgPSBwYXRoLnJlc29sdmUocm9vdERpciwgJ3Rlc3QnLCAnZml4dHVyZXMnLCAnQXBpRGVtb3MtZGVidWcuYXBrJyk7XG4gIGNvbnN0IHN5c3RlbVBvcnQgPSA0NzI0O1xuICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgIGFkYiA9IGF3YWl0IEFEQi5jcmVhdGVBREIoKTtcbiAgICBjb25zdCBwYWNrYWdlTmFtZSA9ICdpby5hcHBpdW0uYW5kcm9pZC5hcGlzJyxcbiAgICAgICAgICBhY3Rpdml0eU5hbWUgPSAnLkFwaURlbW9zJztcbiAgICBhd2FpdCBhZGIuaW5zdGFsbChhcGlEZW1vcyk7XG4gICAgYXdhaXQgYWRiLnN0YXJ0QXBwKHtwa2c6IHBhY2thZ2VOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHk6IGFjdGl2aXR5TmFtZX0pO1xuICAgIGFuZHJvaWRCb290c3RyYXAgPSBuZXcgQW5kcm9pZEJvb3RzdHJhcChhZGIsIHN5c3RlbVBvcnQpO1xuICAgIGF3YWl0IGFuZHJvaWRCb290c3RyYXAuc3RhcnQoJ2lvLmFwcGl1bS5hbmRyb2lkLmFwaXMnLCBmYWxzZSk7XG4gIH0pO1xuICBhZnRlcihhc3luYyAoKT0+IHtcbiAgICBhd2FpdCBhbmRyb2lkQm9vdHN0cmFwLnNodXRkb3duKCk7XG4gIH0pO1xuICBpdChcInNlbmRBY3Rpb24gc2hvdWxkIHdvcmtcIiwgYXN5bmMgKCkgPT4ge1xuICAgIChhd2FpdCBhbmRyb2lkQm9vdHN0cmFwLnNlbmRBY3Rpb24oJ3dha2UnKSkuc2hvdWxkLmVxdWFsKHRydWUpO1xuICB9KTtcbiAgaXQoXCJzZW5kQ29tbWFuZCBzaG91bGQgd29ya1wiLCBhc3luYyAoKSA9PiB7XG4gICAoYXdhaXQgYW5kcm9pZEJvb3RzdHJhcC5zZW5kQ29tbWFuZChDT01NQU5EX1RZUEVTLkFDVElPTiwge2FjdGlvbjogJ2dldERhdGFEaXInfSkpLnNob3VsZFxuICAgICAuZXF1YWwoXCIvZGF0YVwiKTtcbiAgfSk7XG4gIGl0KFwic2VuZENvbW1hbmQgc2hvdWxkIGNvcnJlY3RseSB0aHJvdyBlcnJvclwiLCBhc3luYyAoKSA9PiB7XG4gICBhd2FpdCBhbmRyb2lkQm9vdHN0cmFwLnNlbmRDb21tYW5kKENPTU1BTkRfVFlQRVMuQUNUSU9OLCB7YWN0aW9uOiAndW5rbm93bid9KS5zaG91bGRcbiAgICAgLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKGVycm9ycy5Vbmtub3duQ29tbWFuZEVycm9yKTtcbiAgfSk7XG4gIGl0KFwic2hvdWxkIGNhbmNlbCBvblVuZXhwZWN0ZWRTaHV0ZG93biBwcm9taXNlIG9uIHVuZXhwZWN0ZWQgdWlBdXRvbWF0b3Igc2h1dGRvd25cIiwgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGFuZHJvaWRCb290c3RyYXAuc2VuZENvbW1hbmQoQ09NTUFORF9UWVBFUy5TSFVURE9XTik7XG4gICAgYXdhaXQgYW5kcm9pZEJvb3RzdHJhcC5vblVuZXhwZWN0ZWRTaHV0ZG93bi5zaG91bGQuZXZlbnR1YWxseVxuICAgICAgLmJlLnJlamVjdGVkV2l0aChcIkVycm9yOiBVaUFVdG9tYXRvciBzaHV0IGRvd24gdW5leHBlY3RlZGx5XCIpO1xuICB9KTtcbn0pO1xuIl19