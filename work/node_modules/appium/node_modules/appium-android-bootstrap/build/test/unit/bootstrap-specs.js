// transpile :mocha

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _2 = require('../..');

var _appiumAdb = require('appium-adb');

var _appiumAdb2 = _interopRequireDefault(_appiumAdb);

var _appiumTestSupport = require('appium-test-support');

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _appiumUiautomator = require('appium-uiautomator');

var _appiumUiautomator2 = _interopRequireDefault(_appiumUiautomator);

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _mobileJsonWireProtocol = require('mobile-json-wire-protocol');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('AndroidBootstrap', function callee$0$0() {
  var systemPort, adb, androidBootstrap, uiAutomator;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        systemPort = 4724;
        adb = new _appiumAdb2['default']();
        androidBootstrap = new _2.AndroidBootstrap(adb, systemPort);
        uiAutomator = new _appiumUiautomator2['default'](adb);

        describe("start", (0, _appiumTestSupport.withSandbox)({ mocks: { adb: adb, uiAutomator: uiAutomator, net: _net2['default'], androidBootstrap: androidBootstrap } }, function (S) {
          it("should return a subProcess", function callee$2$0() {
            var conn, appPackage, disableAndroidWatchers;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  conn = new _events2['default'].EventEmitter();
                  appPackage = 'com.example.android.apis', disableAndroidWatchers = false;

                  androidBootstrap.uiAutomator = uiAutomator;
                  S.mocks.androidBootstrap.expects('init').once().returns('');
                  S.mocks.adb.expects('forwardPort').once().withExactArgs(systemPort, systemPort).returns('');
                  S.mocks.uiAutomator.expects("start").once().returns(conn);
                  S.mocks.net.expects('connect').once().returns(conn);
                  setTimeout(function () {
                    conn.emit("connect");
                  }, 1);
                  context$3$0.next = 10;
                  return _regeneratorRuntime.awrap(androidBootstrap.start(appPackage, disableAndroidWatchers));

                case 10:
                  S.verify();

                case 11:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
        }));
        describe("sendCommand", function () {
          it("should successfully return after receiving data from bootstrap in parts", function callee$2$0() {
            var conn;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  conn = new _events2['default'].EventEmitter();

                  conn.write = _lodash2['default'].noop;
                  conn.setEncoding = _lodash2['default'].noop;
                  androidBootstrap.socketClient = conn;
                  setTimeout(function () {
                    conn.emit("data", '{"status":0, ');
                    conn.emit("data", '"value": "hello"}');
                  }, 1);
                  context$3$0.next = 7;
                  return _regeneratorRuntime.awrap(androidBootstrap.sendCommand(_2.COMMAND_TYPES.ACTION, { action: 'getDataDir' }, 1000));

                case 7:
                  context$3$0.sent.should.equal("hello");

                case 8:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
          it("should successfully return after receiving data from bootstrap", function callee$2$0() {
            var conn;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  conn = new _events2['default'].EventEmitter();

                  conn.write = _lodash2['default'].noop;
                  conn.setEncoding = _lodash2['default'].noop;
                  androidBootstrap.socketClient = conn;
                  setTimeout(function () {
                    conn.emit("data", '{"status":0, "value": "hello"}');
                  }, 0);
                  context$3$0.next = 7;
                  return _regeneratorRuntime.awrap(androidBootstrap.sendCommand(_2.COMMAND_TYPES.ACTION, { action: 'getDataDir' }, 1000));

                case 7:
                  context$3$0.sent.should.equal("hello");

                case 8:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
          it("should throw correct error if status is not zero", function callee$2$0() {
            var conn;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  conn = new _events2['default'].EventEmitter();

                  conn.write = _lodash2['default'].noop;
                  conn.setEncoding = _lodash2['default'].noop;
                  androidBootstrap.socketClient = conn;
                  setTimeout(function () {
                    conn.emit("data", '{"status":7, "value": "not found"}');
                  }, 0);
                  context$3$0.next = 7;
                  return _regeneratorRuntime.awrap(androidBootstrap.sendCommand(_2.COMMAND_TYPES.ACTION, { action: 'getDataDir' }, 1000).should.eventually.be.rejectedWith(_mobileJsonWireProtocol.errors.NoSuchElementError));

                case 7:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
        });
        describe("sendAction", (0, _appiumTestSupport.withSandbox)({ mocks: { androidBootstrap: androidBootstrap } }, function (S) {
          it("should call sendCommand", function callee$2$0() {
            var extra;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  extra = { action: 'wake', params: {} };

                  S.mocks.androidBootstrap.expects('sendCommand').once().withExactArgs('action', extra).returns('');
                  context$3$0.next = 4;
                  return _regeneratorRuntime.awrap(androidBootstrap.sendAction('wake'));

                case 4:
                  S.verify();

                case 5:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
        }));
        describe("shutdown", (0, _appiumTestSupport.withSandbox)({ mocks: { androidBootstrap: androidBootstrap, uiAutomator: uiAutomator } }, function (S) {
          it("should call sendCommand", function callee$2$0() {
            var conn;
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  conn = new _events2['default'].EventEmitter();

                  androidBootstrap.socketClient = conn;
                  S.mocks.androidBootstrap.expects('sendCommand').once().withExactArgs('shutdown').returns('');
                  S.mocks.uiAutomator.expects("shutdown").once().returns("");
                  context$3$0.next = 6;
                  return _regeneratorRuntime.awrap(androidBootstrap.shutdown());

                case 6:
                  S.verify();

                case 7:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, this);
          });
        }));

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9ib290c3RyYXAtc3BlY3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7b0JBRWlCLE1BQU07Ozs7OEJBQ0ksa0JBQWtCOzs7O2lCQUNHLE9BQU87O3lCQUN2QyxZQUFZOzs7O2lDQUNBLHFCQUFxQjs7c0JBQzlCLFFBQVE7Ozs7aUNBQ0gsb0JBQW9COzs7O21CQUM1QixLQUFLOzs7O3NDQUNFLDJCQUEyQjs7c0JBQ3BDLFFBQVE7Ozs7QUFHdEIsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDZCxrQkFBSyxHQUFHLDZCQUFnQixDQUFDOztBQUV6QixRQUFRLENBQUMsa0JBQWtCLEVBQUU7TUFDckIsVUFBVSxFQUNaLEdBQUcsRUFDSCxnQkFBZ0IsRUFDaEIsV0FBVzs7OztBQUhULGtCQUFVLEdBQUcsSUFBSTtBQUNuQixXQUFHLEdBQUcsNEJBQVM7QUFDZix3QkFBZ0IsR0FBRyx3QkFBcUIsR0FBRyxFQUFFLFVBQVUsQ0FBQztBQUN4RCxtQkFBVyxHQUFHLG1DQUFnQixHQUFHLENBQUM7O0FBRXRDLGdCQUFRLENBQUMsT0FBTyxFQUFFLG9DQUFZLEVBQUMsS0FBSyxFQUFFLEVBQUMsR0FBRyxFQUFILEdBQUcsRUFBRSxXQUFXLEVBQVgsV0FBVyxFQUFFLEdBQUcsa0JBQUEsRUFBRSxnQkFBZ0IsRUFBaEIsZ0JBQWdCLEVBQUMsRUFBQyxFQUFFLFVBQUMsQ0FBQyxFQUFLO0FBQ3ZGLFlBQUUsQ0FBQyw0QkFBNEIsRUFBRTtnQkFDM0IsSUFBSSxFQUNGLFVBQVUsRUFDVixzQkFBc0I7Ozs7QUFGeEIsc0JBQUksR0FBRyxJQUFJLG9CQUFPLFlBQVksRUFBRTtBQUM5Qiw0QkFBVSxHQUFHLDBCQUEwQixFQUN2QyxzQkFBc0IsR0FBRyxLQUFLOztBQUNwQyxrQ0FBZ0IsQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0FBQzNDLG1CQUFDLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJ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c0JBQUksR0FBRyxJQUFJLG9CQUFPLFlBQVksRUFBRTs7QUFDcEMsa0NBQWdCLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztBQUNyQyxtQkFBQyxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQ25ELGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FDekIsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ2YsbUJBQUMsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FDcEMsSUFBSSxFQUFFLENBQ04sT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDOzttREFDVCxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUU7OztBQUNqQyxtQkFBQyxDQUFDLE1BQU0sRUFBRSxDQUFDOzs7Ozs7O1dBQ1osQ0FBQyxDQUFDO1NBQ0osQ0FBQyxDQUFDLENBQUM7Ozs7Ozs7Q0FDTCxDQUFDLENBQUMiLCJmaWxlIjoidGVzdC91bml0L2Jvb3RzdHJhcC1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZSA6bW9jaGFcblxuaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgeyBBbmRyb2lkQm9vdHN0cmFwLCBDT01NQU5EX1RZUEVTIH0gZnJvbSAnLi4vLi4nO1xuaW1wb3J0IEFEQiBmcm9tICdhcHBpdW0tYWRiJztcbmltcG9ydCB7IHdpdGhTYW5kYm94IH0gZnJvbSAnYXBwaXVtLXRlc3Qtc3VwcG9ydCc7XG5pbXBvcnQgZXZlbnRzIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgVWlBdXRvbWF0b3IgZnJvbSAnYXBwaXVtLXVpYXV0b21hdG9yJztcbmltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ21vYmlsZS1qc29uLXdpcmUtcHJvdG9jb2wnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG5jaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5kZXNjcmliZSgnQW5kcm9pZEJvb3RzdHJhcCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgY29uc3Qgc3lzdGVtUG9ydCA9IDQ3MjQ7XG4gIGxldCBhZGIgPSBuZXcgQURCKCk7XG4gIGxldCBhbmRyb2lkQm9vdHN0cmFwID0gbmV3IEFuZHJvaWRCb290c3RyYXAoYWRiLCBzeXN0ZW1Qb3J0KTtcbiAgbGV0IHVpQXV0b21hdG9yID0gbmV3IFVpQXV0b21hdG9yKGFkYik7XG5cbiAgZGVzY3JpYmUoXCJzdGFydFwiLCB3aXRoU2FuZGJveCh7bW9ja3M6IHthZGIsIHVpQXV0b21hdG9yLCBuZXQsIGFuZHJvaWRCb290c3RyYXB9fSwgKFMpID0+IHtcbiAgICBpdChcInNob3VsZCByZXR1cm4gYSBzdWJQcm9jZXNzXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBjb25uID0gbmV3IGV2ZW50cy5FdmVudEVtaXR0ZXIoKTtcbiAgICAgIGNvbnN0IGFwcFBhY2thZ2UgPSAnY29tLmV4YW1wbGUuYW5kcm9pZC5hcGlzJyxcbiAgICAgICAgICAgIGRpc2FibGVBbmRyb2lkV2F0Y2hlcnMgPSBmYWxzZTtcbiAgICAgIGFuZHJvaWRCb290c3RyYXAudWlBdXRvbWF0b3IgPSB1aUF1dG9tYXRvcjtcbiAgICAgIFMubW9ja3MuYW5kcm9pZEJvb3RzdHJhcC5leHBlY3RzKCdpbml0Jykub25jZSgpXG4gICAgICAgIC5yZXR1cm5zKCcnKTtcbiAgICAgIFMubW9ja3MuYWRiLmV4cGVjdHMoJ2ZvcndhcmRQb3J0Jykub25jZSgpXG4gICAgICAgIC53aXRoRXhhY3RBcmdzKHN5c3RlbVBvcnQsIHN5c3RlbVBvcnQpXG4gICAgICAgIC5yZXR1cm5zKCcnKTtcbiAgICAgIFMubW9ja3MudWlBdXRvbWF0b3IuZXhwZWN0cyhcInN0YXJ0XCIpXG4gICAgICAgIC5vbmNlKClcbiAgICAgICAgLnJldHVybnMoY29ubik7XG4gICAgICBTLm1vY2tzLm5ldC5leHBlY3RzKCdjb25uZWN0Jykub25jZSgpLnJldHVybnMoY29ubik7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgY29ubi5lbWl0KFwiY29ubmVjdFwiKTtcbiAgICAgIH0sIDEpO1xuICAgICAgYXdhaXQgYW5kcm9pZEJvb3RzdHJhcC5zdGFydChhcHBQYWNrYWdlLCBkaXNhYmxlQW5kcm9pZFdhdGNoZXJzKTtcbiAgICAgIFMudmVyaWZ5KCk7XG4gICAgfSk7XG4gIH0pKTtcbiAgZGVzY3JpYmUoXCJzZW5kQ29tbWFuZFwiLCAoKSA9PiB7XG4gICAgaXQoXCJzaG91bGQgc3VjY2Vzc2Z1bGx5IHJldHVybiBhZnRlciByZWNlaXZpbmcgZGF0YSBmcm9tIGJvb3RzdHJhcCBpbiBwYXJ0c1wiLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgY29ubiA9IG5ldyBldmVudHMuRXZlbnRFbWl0dGVyKCk7XG4gICAgICBjb25uLndyaXRlID0gXy5ub29wO1xuICAgICAgY29ubi5zZXRFbmNvZGluZyA9IF8ubm9vcDtcbiAgICAgIGFuZHJvaWRCb290c3RyYXAuc29ja2V0Q2xpZW50ID0gY29ubjtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBjb25uLmVtaXQoXCJkYXRhXCIsICd7XCJzdGF0dXNcIjowLCAnKTtcbiAgICAgICAgY29ubi5lbWl0KFwiZGF0YVwiLCAnXCJ2YWx1ZVwiOiBcImhlbGxvXCJ9Jyk7XG4gICAgICB9LCAxKTtcbiAgICAgIChhd2FpdCBhbmRyb2lkQm9vdHN0cmFwLnNlbmRDb21tYW5kKENPTU1BTkRfVFlQRVMuQUNUSU9OLCB7YWN0aW9uOiAnZ2V0RGF0YURpcid9LCAxMDAwKSlcbiAgICAgICAgLnNob3VsZC5lcXVhbChcImhlbGxvXCIpO1xuICAgIH0pO1xuICAgIGl0KFwic2hvdWxkIHN1Y2Nlc3NmdWxseSByZXR1cm4gYWZ0ZXIgcmVjZWl2aW5nIGRhdGEgZnJvbSBib290c3RyYXBcIiwgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGNvbm4gPSBuZXcgZXZlbnRzLkV2ZW50RW1pdHRlcigpO1xuICAgICAgY29ubi53cml0ZSA9IF8ubm9vcDtcbiAgICAgIGNvbm4uc2V0RW5jb2RpbmcgPSBfLm5vb3A7XG4gICAgICBhbmRyb2lkQm9vdHN0cmFwLnNvY2tldENsaWVudCA9IGNvbm47XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgY29ubi5lbWl0KFwiZGF0YVwiLCAne1wic3RhdHVzXCI6MCwgXCJ2YWx1ZVwiOiBcImhlbGxvXCJ9Jyk7XG4gICAgICB9LCAwKTtcbiAgICAgIChhd2FpdCBhbmRyb2lkQm9vdHN0cmFwLnNlbmRDb21tYW5kKENPTU1BTkRfVFlQRVMuQUNUSU9OLCB7YWN0aW9uOiAnZ2V0RGF0YURpcid9LCAxMDAwKSlcbiAgICAgICAgLnNob3VsZC5lcXVhbChcImhlbGxvXCIpO1xuICAgIH0pO1xuICAgIGl0KFwic2hvdWxkIHRocm93IGNvcnJlY3QgZXJyb3IgaWYgc3RhdHVzIGlzIG5vdCB6ZXJvXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBjb25uID0gbmV3IGV2ZW50cy5FdmVudEVtaXR0ZXIoKTtcbiAgICAgIGNvbm4ud3JpdGUgPSBfLm5vb3A7XG4gICAgICBjb25uLnNldEVuY29kaW5nID0gXy5ub29wO1xuICAgICAgYW5kcm9pZEJvb3RzdHJhcC5zb2NrZXRDbGllbnQgPSBjb25uO1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGNvbm4uZW1pdChcImRhdGFcIiwgJ3tcInN0YXR1c1wiOjcsIFwidmFsdWVcIjogXCJub3QgZm91bmRcIn0nKTtcbiAgICAgIH0sIDApO1xuICAgICAgYXdhaXQgYW5kcm9pZEJvb3RzdHJhcC5zZW5kQ29tbWFuZChDT01NQU5EX1RZUEVTLkFDVElPTiwge2FjdGlvbjogJ2dldERhdGFEaXInfSwgMTAwMClcbiAgICAgICAgLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aChlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKTtcbiAgICB9KTtcbiAgfSk7XG4gIGRlc2NyaWJlKFwic2VuZEFjdGlvblwiLCB3aXRoU2FuZGJveCh7bW9ja3M6IHthbmRyb2lkQm9vdHN0cmFwfX0sIChTKSA9PiB7XG4gICAgaXQoXCJzaG91bGQgY2FsbCBzZW5kQ29tbWFuZFwiLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgZXh0cmEgPSB7YWN0aW9uOiAnd2FrZScsIHBhcmFtczoge319O1xuICAgICAgUy5tb2Nrcy5hbmRyb2lkQm9vdHN0cmFwLmV4cGVjdHMoJ3NlbmRDb21tYW5kJykub25jZSgpXG4gICAgICAgIC53aXRoRXhhY3RBcmdzKCdhY3Rpb24nLCBleHRyYSlcbiAgICAgICAgLnJldHVybnMoJycpO1xuICAgICAgYXdhaXQgYW5kcm9pZEJvb3RzdHJhcC5zZW5kQWN0aW9uKCd3YWtlJyk7XG4gICAgICBTLnZlcmlmeSgpO1xuICAgIH0pO1xuICB9KSk7XG4gIGRlc2NyaWJlKFwic2h1dGRvd25cIiwgd2l0aFNhbmRib3goe21vY2tzOiB7YW5kcm9pZEJvb3RzdHJhcCwgdWlBdXRvbWF0b3J9fSwgKFMpID0+IHtcbiAgICBpdChcInNob3VsZCBjYWxsIHNlbmRDb21tYW5kXCIsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBjb25uID0gbmV3IGV2ZW50cy5FdmVudEVtaXR0ZXIoKTtcbiAgICAgIGFuZHJvaWRCb290c3RyYXAuc29ja2V0Q2xpZW50ID0gY29ubjtcbiAgICAgIFMubW9ja3MuYW5kcm9pZEJvb3RzdHJhcC5leHBlY3RzKCdzZW5kQ29tbWFuZCcpLm9uY2UoKVxuICAgICAgICAud2l0aEV4YWN0QXJncygnc2h1dGRvd24nKVxuICAgICAgICAucmV0dXJucygnJyk7XG4gICAgICBTLm1vY2tzLnVpQXV0b21hdG9yLmV4cGVjdHMoXCJzaHV0ZG93blwiKVxuICAgICAgICAub25jZSgpXG4gICAgICAgIC5yZXR1cm5zKFwiXCIpO1xuICAgICAgYXdhaXQgYW5kcm9pZEJvb3RzdHJhcC5zaHV0ZG93bigpO1xuICAgICAgUy52ZXJpZnkoKTtcbiAgICB9KTtcbiAgfSkpO1xufSk7XG4iXX0=