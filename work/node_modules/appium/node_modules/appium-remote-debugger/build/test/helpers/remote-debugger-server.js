require('source-map-support').install();

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _bplistCreator = require('bplist-creator');

var _bplistCreator2 = _interopRequireDefault(_bplistCreator);

var _bplistParser = require('bplist-parser');

var _bplistParser2 = _interopRequireDefault(_bplistParser);

var _bufferpack = require('bufferpack');

var _bufferpack2 = _interopRequireDefault(_bufferpack);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumLogger = require('appium-logger');

var log = (0, _appiumLogger.getLogger)('RemoteDebugger');

var DEVICE_INFO = {
  name: 'iPhone Simulator',
  build: 'WP42FJ'
};

var APP_INFO = {
  'PID:42': {
    id: 'PID:42',
    name: 'app',
    bundleId: 'io.appium.bundle',
    isProxy: false,
    hostId: ''
  }
};

// a bunch of new app info structures to simulate
// the app getting proxied through other apps
var UPDATED_APP_INFO = [{
  id: 'PID:44',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:42'
}, {
  id: 'PID:46',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:44'
}, {
  id: 'PID:48',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:46'
}, {
  id: 'PID:50',
  name: 'proxy app 1',
  bundleId: 'io.appium.bundle.proxy1',
  isProxy: true,
  hostId: 'PID:48'
}];

/*
 * A fake remote debugger server that can be told to send certain
 * messages back to the client, and to return certain values.
 * Used for testing the client.
 */

var RemoteDebuggerServer = (function () {
  function RemoteDebuggerServer() {
    _classCallCheck(this, RemoteDebuggerServer);

    this.server = null;
    this.client = null;
    this.pendingAppChange = false;
    this.appIdKey = 'PID:42';
    this.destinationKey = '2';
    this.app = 1;
    this.dataResponseValue = [];
  }

  _createClass(RemoteDebuggerServer, [{
    key: '_getConnectedApplicationList',
    value: function _getConnectedApplicationList(num) {
      var data = {
        __selector: '_rpc_reportConnectedApplicationList:',
        __argument: {
          WIRApplicationDictionaryKey: [{
            WIRApplicationIdentifierKey: APP_INFO['PID:42'].id,
            WIRApplicationNameKey: APP_INFO['PID:42'].name,
            WIRApplicationBundleIdentifierKey: APP_INFO['PID:42'].bundleId,
            WIRIsApplicationProxyKey: APP_INFO['PID:42'].isProxy,
            WIRHostApplicationIdentifierKey: APP_INFO['PID:42'].hostId
          }]
        }
      };

      // add more
      if (num > UPDATED_APP_INFO + 1) {
        // we only have so many to give!
        num = UPDATED_APP_INFO + 1;
      }
      for (var i = 0; i < num - 1; i++) {
        var entry = UPDATED_APP_INFO[i];
        data.__argument.WIRApplicationDictionaryKey.push(_defineProperty({}, entry.id, entry));
      }

      return data;
    }
  }, {
    key: 'handleReportIdentifier',
    value: function handleReportIdentifier() {
      var data = {
        __selector: '_rpc_reportSetup:',
        __argument: {
          WIRSimulatorNameKey: DEVICE_INFO.name,
          WIRSimulatorBuildKey: DEVICE_INFO.build
        }
      };
      this.send(data);

      if (this.dataResponseError) {
        data = {
          __selector: '_rpc_reportConnectedApplicationList:',
          __argument: {
            type: 'string',
            value: this.dataResponseError
          },
          wasThrown: true
        };
        this.dataResponseError = null;
      } else {
        data = this._getConnectedApplicationList(1);
      }
      this.send(data);
    }
  }, {
    key: 'handleGetListing',
    value: function handleGetListing() {
      // if we have pending app change events, send them
      if (this.pendingAppChange) {
        this.changeApp(this.pendingAppChange, true);
        this.pendingAppChange = 0;
      }

      // need to send an app dictionary back
      var data = {
        __selector: '_rpc_applicationSentListing:',
        __argument: {
          WIRApplicationIdentifierKey: 'PID:42',
          WIRListingKey: {
            '1': {
              WIRTypeKey: 'WIRTypeWeb',
              WIRPageIdentifierKey: 1,
              WIRTitleKey: '',
              WIRURLKey: ''
            }
          }
        }
      };
      this.send(data);
    }
  }, {
    key: 'handleSocketData',
    value: function handleSocketData(plist) {
      var plistData = JSON.parse(plist.__argument.WIRSocketDataKey.toString('utf8'));

      var result = {};
      if (this.dataResponseError) {
        result = {
          result: {
            type: 'string',
            value: this.dataResponseError
          },
          wasThrown: true
        };
        this.dataResponseError = null;
      } else if (this.dataResponseValue.length > 0) {
        // add the response value
        result = {
          result: {
            type: 'string',
            value: this.dataResponseValue.shift()
          },
          wasThrown: false
        };
      }

      var dataKey = {
        result: result,
        id: plistData.id
      };
      dataKey = new Buffer(JSON.stringify(dataKey));
      var data = {
        __selector: '_rpc_applicationSentData:',
        __argument: {
          WIRDestinationKey: plist.__argument.WIRSenderKey,
          WIRApplicationIdentifierKey: plist.__argument.WIRApplicationIdentifierKey,
          WIRMessageDataKey: dataKey
        }
      };
      this.send(data);
    }
  }, {
    key: 'changeApp',
    value: function changeApp() {
      var num = arguments.length <= 0 || arguments[0] === undefined ? 1 : arguments[0];
      var immediate = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

      if (immediate) {
        if (num > UPDATED_APP_INFO.length - 1) {
          // we only have a certain number of info to send
          num = UPDATED_APP_INFO.length - 1;
        }
        for (var i = 0; i < num; i++) {
          var data = {
            __selector: '_rpc_applicationConnected:',
            __argument: {
              WIRApplicationIdentifierKey: UPDATED_APP_INFO[this.app - 1].id,
              WIRApplicationNameKey: UPDATED_APP_INFO[this.app - 1].name,
              WIRApplicationBundleIdentifierKey: UPDATED_APP_INFO[this.app - 1].bundleId,
              WIRIsApplicationProxyKey: UPDATED_APP_INFO[this.app - 1].isProxy,
              WIRHostApplicationIdentifierKey: UPDATED_APP_INFO[this.app - 1].hostId
            }
          };
          this.send(data);

          this.app++;
        }
      } else {
        this.pendingAppChange = num;
      }
    }
  }, {
    key: 'sendFrameNavigationMessage',
    value: function sendFrameNavigationMessage() {
      var dataKey = {
        method: 'Page.frameNavigated',
        result: {},
        id: 1
      };
      dataKey = new Buffer(JSON.stringify(dataKey));
      var data = {
        __selector: '_rpc_applicationSentData:',
        __argument: {
          WIRDestinationKey: this.destinationKey,
          WIRApplicationIdentifierKey: this.appIdKey,
          WIRMessageDataKey: dataKey
        }
      };
      this.send(data);
    }
  }, {
    key: 'setDataResponseError',
    value: function setDataResponseError(error) {
      this.dataResponseError = error;
    }
  }, {
    key: 'setDataResponseValue',
    value: function setDataResponseValue(value) {
      this.dataResponseValue.push(value);
    }
  }, {
    key: 'start',
    value: function start() {
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              _this.server = _net2['default'].createServer(function (c) {
                _this.client = c;
                c.on('end', function () {
                  log.debug('client disconnected');
                });
                c.on('data', function (data) {
                  var plist = _bplistParser2['default'].parseBuffer(data.slice(4));

                  switch (plist[0].__selector) {
                    case '_rpc_reportIdentifier:':
                      _this.handleReportIdentifier(plist[0]);
                      break;
                    case '_rpc_forwardGetListing:':
                      _this.handleGetListing(plist[0]);
                      break;
                    case '_rpc_forwardSocketSetup:':
                      // do nothing
                      break;
                    case '_rpc_forwardSocketData:':
                      _this.handleSocketData(plist[0]);
                      break;
                    case '_rpc_forwardIndicateWebView:':
                      reject(new Error('NOT YET IMPLEMENTED: ' + plist[0].__selector));
                      break;
                    default:
                      _this.client.write('do not compute');
                  }
                });
              });

              // don't use the real port, or any open sims will break the tests
              _this.server.listen(27754, '::1', function () {
                log.info('server bound: ' + JSON.stringify(_this.server.address()));
                resolve();
              });
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve) {
              if (_this2.server) {
                if (_this2.client) {
                  _this2.client.end();
                }
                _this2.server.close(function (err) {
                  resolve('Stopped listening: ' + err);
                });
              } else {
                resolve('Not listening.');
              }
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'send',
    value: function send(data) {
      var buf = (0, _bplistCreator2['default'])(data);
      var length = _bufferpack2['default'].pack('L', [buf.length]);
      this.client.write(Buffer.concat([length, buf]));
    }
  }]);

  return RemoteDebuggerServer;
})();

exports.RemoteDebuggerServer = RemoteDebuggerServer;
exports.APP_INFO = APP_INFO;
exports.DEVICE_INFO = DEVICE_INFO;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvaGVscGVycy9yZW1vdGUtZGVidWdnZXItc2VydmVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OzttQkFFZ0IsS0FBSzs7Ozs2QkFDSSxnQkFBZ0I7Ozs7NEJBQ2pCLGVBQWU7Ozs7MEJBQ2hCLFlBQVk7Ozs7d0JBQ2YsVUFBVTs7Ozs0QkFDSixlQUFlOztBQUV6QyxJQUFNLEdBQUcsR0FBRyw2QkFBVSxnQkFBZ0IsQ0FBQyxDQUFDOztBQUd4QyxJQUFNLFdBQVcsR0FBRztBQUNsQixNQUFJLEVBQUUsa0JBQWtCO0FBQ3hCLE9BQUssRUFBRSxRQUFRO0NBQ2hCLENBQUM7O0FBRUYsSUFBTSxRQUFRLEdBQUc7QUFDZixVQUFRLEVBQUU7QUFDUixNQUFFLEVBQUUsUUFBUTtBQUNaLFFBQUksRUFBRSxLQUFLO0FBQ1gsWUFBUSxFQUFFLGtCQUFrQjtBQUM1QixXQUFPLEVBQUUsS0FBSztBQUNkLFVBQU0sRUFBRSxFQUFFO0dBQ1g7Q0FDRixDQUFDOzs7O0FBSUYsSUFBTSxnQkFBZ0IsR0FBRyxDQUN2QjtBQUNFLElBQUUsRUFBRSxRQUFRO0FBQ1osTUFBSSxFQUFFLGFBQWE7QUFDbkIsVUFBUSxFQUFFLHlCQUF5QjtBQUNuQyxTQUFPLEVBQUUsSUFBSTtBQUNiLFFBQU0sRUFBRSxRQUFRO0NBQ2pCLEVBQ0Q7QUFDRSxJQUFFLEVBQUUsUUFBUTtBQUNaLE1BQUksRUFBRSxhQUFhO0FBQ25CLFVBQVEsRUFBRSx5QkFBeUI7QUFDbkMsU0FBTyxFQUFFLElBQUk7QUFDYixRQUFNLEVBQUUsUUFBUTtDQUNqQixFQUNEO0FBQ0UsSUFBRSxFQUFFLFFBQVE7QUFDWixNQUFJLEVBQUUsYUFBYTtBQUNuQixVQUFRLEVBQUUseUJBQXlCO0FBQ25DLFNBQU8sRUFBRSxJQUFJO0FBQ2IsUUFBTSxFQUFFLFFBQVE7Q0FDakIsRUFDRDtBQUNFLElBQUUsRUFBRSxRQUFRO0FBQ1osTUFBSSxFQUFFLGFBQWE7QUFDbkIsVUFBUSxFQUFF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T0FBTyxFQUFFLENBQUMsQ0FBRyxDQUFDO0FBQ25FLHVCQUFPLEVBQUUsQ0FBQztlQUNYLENBQUMsQ0FBQzthQUNKLENBQUM7Ozs7Ozs7S0FDSDs7O1dBRVU7Ozs7OztnREFDRiwwQkFBWSxVQUFDLE9BQU8sRUFBSztBQUM5QixrQkFBSSxPQUFLLE1BQU0sRUFBRTtBQUNmLG9CQUFJLE9BQUssTUFBTSxFQUFFO0FBQ2YseUJBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDO2lCQUNuQjtBQUNELHVCQUFLLE1BQU0sQ0FBQyxLQUFLLENBQUMsVUFBQyxHQUFHLEVBQUs7QUFDekIseUJBQU8seUJBQXVCLEdBQUcsQ0FBRyxDQUFDO2lCQUN0QyxDQUFDLENBQUM7ZUFDSixNQUFNO0FBQ0wsdUJBQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO2VBQzNCO2FBQ0YsQ0FBQzs7Ozs7OztLQUNIOzs7V0FFSSxjQUFDLElBQUksRUFBRTtBQUNWLFVBQUksR0FBRyxHQUFHLGdDQUFhLElBQUksQ0FBQyxDQUFDO0FBQzdCLFVBQUksTUFBTSxHQUFHLHdCQUFXLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUNoRCxVQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNqRDs7O1NBaFBHLG9CQUFvQjs7O1FBbVBqQixvQkFBb0IsR0FBcEIsb0JBQW9CO1FBQUUsUUFBUSxHQUFSLFFBQVE7UUFBRSxXQUFXLEdBQVgsV0FBVyIsImZpbGUiOiJ0ZXN0L2hlbHBlcnMvcmVtb3RlLWRlYnVnZ2VyLXNlcnZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptYWluXG5cbmltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCBicGxpc3RDcmVhdGUgZnJvbSAnYnBsaXN0LWNyZWF0b3InO1xuaW1wb3J0IGJwbGlzdFBhcnNlIGZyb20gJ2JwbGlzdC1wYXJzZXInO1xuaW1wb3J0IGJ1ZmZlcnBhY2sgZnJvbSAnYnVmZmVycGFjayc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBnZXRMb2dnZXIgfSBmcm9tICdhcHBpdW0tbG9nZ2VyJztcblxuY29uc3QgbG9nID0gZ2V0TG9nZ2VyKCdSZW1vdGVEZWJ1Z2dlcicpO1xuXG5cbmNvbnN0IERFVklDRV9JTkZPID0ge1xuICBuYW1lOiAnaVBob25lIFNpbXVsYXRvcicsXG4gIGJ1aWxkOiAnV1A0MkZKJ1xufTtcblxuY29uc3QgQVBQX0lORk8gPSB7XG4gICdQSUQ6NDInOiB7XG4gICAgaWQ6ICdQSUQ6NDInLFxuICAgIG5hbWU6ICdhcHAnLFxuICAgIGJ1bmRsZUlkOiAnaW8uYXBwaXVtLmJ1bmRsZScsXG4gICAgaXNQcm94eTogZmFsc2UsXG4gICAgaG9zdElkOiAnJ1xuICB9XG59O1xuXG4vLyBhIGJ1bmNoIG9mIG5ldyBhcHAgaW5mbyBzdHJ1Y3R1cmVzIHRvIHNpbXVsYXRlXG4vLyB0aGUgYXBwIGdldHRpbmcgcHJveGllZCB0aHJvdWdoIG90aGVyIGFwcHNcbmNvbnN0IFVQREFURURfQVBQX0lORk8gPSBbXG4gIHtcbiAgICBpZDogJ1BJRDo0NCcsXG4gICAgbmFtZTogJ3Byb3h5IGFwcCAxJyxcbiAgICBidW5kbGVJZDogJ2lvLmFwcGl1bS5idW5kbGUucHJveHkxJyxcbiAgICBpc1Byb3h5OiB0cnVlLFxuICAgIGhvc3RJZDogJ1BJRDo0MidcbiAgfSxcbiAge1xuICAgIGlkOiAnUElEOjQ2JyxcbiAgICBuYW1lOiAncHJveHkgYXBwIDEnLFxuICAgIGJ1bmRsZUlkOiAnaW8uYXBwaXVtLmJ1bmRsZS5wcm94eTEnLFxuICAgIGlzUHJveHk6IHRydWUsXG4gICAgaG9zdElkOiAnUElEOjQ0J1xuICB9LFxuICB7XG4gICAgaWQ6ICdQSUQ6NDgnLFxuICAgIG5hbWU6ICdwcm94eSBhcHAgMScsXG4gICAgYnVuZGxlSWQ6ICdpby5hcHBpdW0uYnVuZGxlLnByb3h5MScsXG4gICAgaXNQcm94eTogdHJ1ZSxcbiAgICBob3N0SWQ6ICdQSUQ6NDYnXG4gIH0sXG4gIHtcbiAgICBpZDogJ1BJRDo1MCcsXG4gICAgbmFtZTogJ3Byb3h5IGFwcCAxJyxcbiAgICBidW5kbGVJZDogJ2lvLmFwcGl1bS5idW5kbGUucHJveHkxJyxcbiAgICBpc1Byb3h5OiB0cnVlLFxuICAgIGhvc3RJZDogJ1BJRDo0OCdcbiAgfVxuXTtcblxuXG4vKlxuICogQSBmYWtlIHJlbW90ZSBkZWJ1Z2dlciBzZXJ2ZXIgdGhhdCBjYW4gYmUgdG9sZCB0byBzZW5kIGNlcnRhaW5cbiAqIG1lc3NhZ2VzIGJhY2sgdG8gdGhlIGNsaWVudCwgYW5kIHRvIHJldHVybiBjZXJ0YWluIHZhbHVlcy5cbiAqIFVzZWQgZm9yIHRlc3RpbmcgdGhlIGNsaWVudC5cbiAqL1xuY2xhc3MgUmVtb3RlRGVidWdnZXJTZXJ2ZXIge1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgdGhpcy5zZXJ2ZXIgPSBudWxsO1xuICAgIHRoaXMuY2xpZW50ID0gbnVsbDtcbiAgICB0aGlzLnBlbmRpbmdBcHBDaGFuZ2UgPSBmYWxzZTtcbiAgICB0aGlzLmFwcElkS2V5ID0gJ1BJRDo0Mic7XG4gICAgdGhpcy5kZXN0aW5hdGlvbktleSA9ICcyJztcbiAgICB0aGlzLmFwcCA9IDE7XG4gICAgdGhpcy5kYXRhUmVzcG9uc2VWYWx1ZSA9IFtdO1xuICB9XG5cbiAgX2dldENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdCAobnVtKSB7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19yZXBvcnRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3Q6JyxcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5OiBbe1xuICAgICAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogQVBQX0lORk9bJ1BJRDo0MiddLmlkLFxuICAgICAgICAgIFdJUkFwcGxpY2F0aW9uTmFtZUtleTogQVBQX0lORk9bJ1BJRDo0MiddLm5hbWUsXG4gICAgICAgICAgV0lSQXBwbGljYXRpb25CdW5kbGVJZGVudGlmaWVyS2V5OiBBUFBfSU5GT1snUElEOjQyJ10uYnVuZGxlSWQsXG4gICAgICAgICAgV0lSSXNBcHBsaWNhdGlvblByb3h5S2V5OiBBUFBfSU5GT1snUElEOjQyJ10uaXNQcm94eSxcbiAgICAgICAgICBXSVJIb3N0QXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBBUFBfSU5GT1snUElEOjQyJ10uaG9zdElkXG4gICAgICAgIH1dXG4gICAgICB9XG4gICAgfTtcblxuICAgIC8vIGFkZCBtb3JlXG4gICAgaWYgKG51bSA+IFVQREFURURfQVBQX0lORk8rMSkge1xuICAgICAgLy8gd2Ugb25seSBoYXZlIHNvIG1hbnkgdG8gZ2l2ZSFcbiAgICAgIG51bSA9IFVQREFURURfQVBQX0lORk8gKyAxO1xuICAgIH1cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bS0xOyBpKyspIHtcbiAgICAgIGxldCBlbnRyeSA9IFVQREFURURfQVBQX0lORk9baV07XG4gICAgICBkYXRhLl9fYXJndW1lbnQuV0lSQXBwbGljYXRpb25EaWN0aW9uYXJ5S2V5LnB1c2goe1tlbnRyeS5pZF06IGVudHJ5fSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cblxuICBoYW5kbGVSZXBvcnRJZGVudGlmaWVyICgpIHtcbiAgICBsZXQgZGF0YSA9IHtcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX3JlcG9ydFNldHVwOicsXG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUlNpbXVsYXRvck5hbWVLZXk6IERFVklDRV9JTkZPLm5hbWUsXG4gICAgICAgIFdJUlNpbXVsYXRvckJ1aWxkS2V5OiBERVZJQ0VfSU5GTy5idWlsZFxuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5zZW5kKGRhdGEpO1xuXG4gICAgaWYgKHRoaXMuZGF0YVJlc3BvbnNlRXJyb3IpIHtcbiAgICAgIGRhdGEgPSB7XG4gICAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX3JlcG9ydENvbm5lY3RlZEFwcGxpY2F0aW9uTGlzdDonLFxuICAgICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgICAgdmFsdWU6IHRoaXMuZGF0YVJlc3BvbnNlRXJyb3JcbiAgICAgICAgfSxcbiAgICAgICAgd2FzVGhyb3duOiB0cnVlXG4gICAgICB9O1xuICAgICAgdGhpcy5kYXRhUmVzcG9uc2VFcnJvciA9IG51bGw7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRhdGEgPSB0aGlzLl9nZXRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3QoMSk7XG4gICAgfVxuICAgIHRoaXMuc2VuZChkYXRhKTtcbiAgfVxuXG4gIGhhbmRsZUdldExpc3RpbmcgKCkge1xuICAgIC8vIGlmIHdlIGhhdmUgcGVuZGluZyBhcHAgY2hhbmdlIGV2ZW50cywgc2VuZCB0aGVtXG4gICAgaWYgKHRoaXMucGVuZGluZ0FwcENoYW5nZSkge1xuICAgICAgdGhpcy5jaGFuZ2VBcHAodGhpcy5wZW5kaW5nQXBwQ2hhbmdlLCB0cnVlKTtcbiAgICAgIHRoaXMucGVuZGluZ0FwcENoYW5nZSA9IDA7XG4gICAgfVxuXG4gICAgLy8gbmVlZCB0byBzZW5kIGFuIGFwcCBkaWN0aW9uYXJ5IGJhY2tcbiAgICBsZXQgZGF0YSA9IHtcbiAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX2FwcGxpY2F0aW9uU2VudExpc3Rpbmc6JyxcbiAgICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiAnUElEOjQyJyxcbiAgICAgICAgV0lSTGlzdGluZ0tleToge1xuICAgICAgICAgICcxJzoge1xuICAgICAgICAgICAgV0lSVHlwZUtleTogJ1dJUlR5cGVXZWInLFxuICAgICAgICAgICAgV0lSUGFnZUlkZW50aWZpZXJLZXk6IDEsXG4gICAgICAgICAgICBXSVJUaXRsZUtleTogJycsXG4gICAgICAgICAgICBXSVJVUkxLZXk6ICcnXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLnNlbmQoZGF0YSk7XG4gIH1cblxuICBoYW5kbGVTb2NrZXREYXRhIChwbGlzdCkge1xuICAgIGxldCBwbGlzdERhdGEgPSBKU09OLnBhcnNlKHBsaXN0Ll9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS50b1N0cmluZygndXRmOCcpKTtcblxuICAgIGxldCByZXN1bHQgPSB7fTtcbiAgICBpZiAodGhpcy5kYXRhUmVzcG9uc2VFcnJvcikge1xuICAgICAgcmVzdWx0ID0ge1xuICAgICAgICByZXN1bHQ6IHtcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICB2YWx1ZTogdGhpcy5kYXRhUmVzcG9uc2VFcnJvclxuICAgICAgICB9LFxuICAgICAgICB3YXNUaHJvd246IHRydWVcbiAgICAgIH07XG4gICAgICB0aGlzLmRhdGFSZXNwb25zZUVycm9yID0gbnVsbDtcbiAgICB9IGVsc2UgaWYgKHRoaXMuZGF0YVJlc3BvbnNlVmFsdWUubGVuZ3RoID4gMCkge1xuICAgICAgLy8gYWRkIHRoZSByZXNwb25zZSB2YWx1ZVxuICAgICAgcmVzdWx0ID0ge1xuICAgICAgICByZXN1bHQ6IHtcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICB2YWx1ZTogdGhpcy5kYXRhUmVzcG9uc2VWYWx1ZS5zaGlmdCgpXG4gICAgICAgIH0sXG4gICAgICAgIHdhc1Rocm93bjogZmFsc2VcbiAgICAgIH07XG4gICAgfVxuXG4gICAgbGV0IGRhdGFLZXkgPSB7XG4gICAgICByZXN1bHQsXG4gICAgICBpZDogcGxpc3REYXRhLmlkXG4gICAgfTtcbiAgICBkYXRhS2V5ID0gbmV3IEJ1ZmZlcihKU09OLnN0cmluZ2lmeShkYXRhS2V5KSk7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19hcHBsaWNhdGlvblNlbnREYXRhOicsXG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUkRlc3RpbmF0aW9uS2V5OiBwbGlzdC5fX2FyZ3VtZW50LldJUlNlbmRlcktleSxcbiAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBwbGlzdC5fX2FyZ3VtZW50LldJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleSxcbiAgICAgICAgV0lSTWVzc2FnZURhdGFLZXk6IGRhdGFLZXlcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuc2VuZChkYXRhKTtcbiAgfVxuXG4gIGNoYW5nZUFwcCAobnVtID0gMSwgaW1tZWRpYXRlID0gdHJ1ZSkge1xuICAgIGlmIChpbW1lZGlhdGUpIHtcbiAgICAgIGlmIChudW0gPiBVUERBVEVEX0FQUF9JTkZPLmxlbmd0aC0xKSB7XG4gICAgICAgIC8vIHdlIG9ubHkgaGF2ZSBhIGNlcnRhaW4gbnVtYmVyIG9mIGluZm8gdG8gc2VuZFxuICAgICAgICBudW0gPSBVUERBVEVEX0FQUF9JTkZPLmxlbmd0aCAtIDE7XG4gICAgICB9XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG51bTsgaSsrKSB7XG4gICAgICAgIGxldCBkYXRhID0ge1xuICAgICAgICAgIF9fc2VsZWN0b3I6ICdfcnBjX2FwcGxpY2F0aW9uQ29ubmVjdGVkOicsXG4gICAgICAgICAgX19hcmd1bWVudDoge1xuICAgICAgICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBVUERBVEVEX0FQUF9JTkZPW3RoaXMuYXBwLTFdLmlkLFxuICAgICAgICAgICAgV0lSQXBwbGljYXRpb25OYW1lS2V5OiBVUERBVEVEX0FQUF9JTkZPW3RoaXMuYXBwLTFdLm5hbWUsXG4gICAgICAgICAgICBXSVJBcHBsaWNhdGlvbkJ1bmRsZUlkZW50aWZpZXJLZXk6IFVQREFURURfQVBQX0lORk9bdGhpcy5hcHAtMV0uYnVuZGxlSWQsXG4gICAgICAgICAgICBXSVJJc0FwcGxpY2F0aW9uUHJveHlLZXk6IFVQREFURURfQVBQX0lORk9bdGhpcy5hcHAtMV0uaXNQcm94eSxcbiAgICAgICAgICAgIFdJUkhvc3RBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IFVQREFURURfQVBQX0lORk9bdGhpcy5hcHAtMV0uaG9zdElkXG4gICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNlbmQoZGF0YSk7XG5cbiAgICAgICAgdGhpcy5hcHArKztcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wZW5kaW5nQXBwQ2hhbmdlID0gbnVtO1xuICAgIH1cbiAgfVxuXG4gIHNlbmRGcmFtZU5hdmlnYXRpb25NZXNzYWdlICgpIHtcbiAgICBsZXQgZGF0YUtleSA9IHtcbiAgICAgIG1ldGhvZDogJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnLFxuICAgICAgcmVzdWx0OiB7fSxcbiAgICAgIGlkOiAxXG4gICAgfTtcbiAgICBkYXRhS2V5ID0gbmV3IEJ1ZmZlcihKU09OLnN0cmluZ2lmeShkYXRhS2V5KSk7XG4gICAgbGV0IGRhdGEgPSB7XG4gICAgICBfX3NlbGVjdG9yOiAnX3JwY19hcHBsaWNhdGlvblNlbnREYXRhOicsXG4gICAgICBfX2FyZ3VtZW50OiB7XG4gICAgICAgIFdJUkRlc3RpbmF0aW9uS2V5OiB0aGlzLmRlc3RpbmF0aW9uS2V5LFxuICAgICAgICBXSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICAgIFdJUk1lc3NhZ2VEYXRhS2V5OiBkYXRhS2V5XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLnNlbmQoZGF0YSk7XG4gIH1cblxuICBzZXREYXRhUmVzcG9uc2VFcnJvciAoZXJyb3IpIHtcbiAgICB0aGlzLmRhdGFSZXNwb25zZUVycm9yID0gZXJyb3I7XG4gIH1cblxuICBzZXREYXRhUmVzcG9uc2VWYWx1ZSAodmFsdWUpIHtcbiAgICB0aGlzLmRhdGFSZXNwb25zZVZhbHVlLnB1c2godmFsdWUpO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnNlcnZlciA9IG5ldC5jcmVhdGVTZXJ2ZXIoKGMpID0+IHtcbiAgICAgICAgdGhpcy5jbGllbnQgPSBjO1xuICAgICAgICBjLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgICAgbG9nLmRlYnVnKCdjbGllbnQgZGlzY29ubmVjdGVkJyk7XG4gICAgICAgIH0pO1xuICAgICAgICBjLm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgICBsZXQgcGxpc3QgPSBicGxpc3RQYXJzZS5wYXJzZUJ1ZmZlcihkYXRhLnNsaWNlKDQpKTtcblxuICAgICAgICAgIHN3aXRjaCAocGxpc3RbMF0uX19zZWxlY3Rvcikge1xuICAgICAgICAgICAgY2FzZSAnX3JwY19yZXBvcnRJZGVudGlmaWVyOic6XG4gICAgICAgICAgICAgIHRoaXMuaGFuZGxlUmVwb3J0SWRlbnRpZmllcihwbGlzdFswXSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnX3JwY19mb3J3YXJkR2V0TGlzdGluZzonOlxuICAgICAgICAgICAgICB0aGlzLmhhbmRsZUdldExpc3RpbmcocGxpc3RbMF0pO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ19ycGNfZm9yd2FyZFNvY2tldFNldHVwOic6XG4gICAgICAgICAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdfcnBjX2ZvcndhcmRTb2NrZXREYXRhOic6XG4gICAgICAgICAgICAgIHRoaXMuaGFuZGxlU29ja2V0RGF0YShwbGlzdFswXSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnX3JwY19mb3J3YXJkSW5kaWNhdGVXZWJWaWV3Oic6XG4gICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYE5PVCBZRVQgSU1QTEVNRU5URUQ6ICR7cGxpc3RbMF0uX19zZWxlY3Rvcn1gKSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgdGhpcy5jbGllbnQud3JpdGUoJ2RvIG5vdCBjb21wdXRlJyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBkb24ndCB1c2UgdGhlIHJlYWwgcG9ydCwgb3IgYW55IG9wZW4gc2ltcyB3aWxsIGJyZWFrIHRoZSB0ZXN0c1xuICAgICAgdGhpcy5zZXJ2ZXIubGlzdGVuKDI3NzU0LCAnOjoxJywgKCkgPT4ge1xuICAgICAgICBsb2cuaW5mbyhgc2VydmVyIGJvdW5kOiAke0pTT04uc3RyaW5naWZ5KHRoaXMuc2VydmVyLmFkZHJlc3MoKSl9YCk7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICBpZiAodGhpcy5zZXJ2ZXIpIHtcbiAgICAgICAgaWYgKHRoaXMuY2xpZW50KSB7XG4gICAgICAgICAgdGhpcy5jbGllbnQuZW5kKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZXJ2ZXIuY2xvc2UoKGVycikgPT4ge1xuICAgICAgICAgIHJlc29sdmUoYFN0b3BwZWQgbGlzdGVuaW5nOiAke2Vycn1gKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKCdOb3QgbGlzdGVuaW5nLicpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgc2VuZCAoZGF0YSkge1xuICAgIGxldCBidWYgPSBicGxpc3RDcmVhdGUoZGF0YSk7XG4gICAgbGV0IGxlbmd0aCA9IGJ1ZmZlcnBhY2sucGFjaygnTCcsIFtidWYubGVuZ3RoXSk7XG4gICAgdGhpcy5jbGllbnQud3JpdGUoQnVmZmVyLmNvbmNhdChbbGVuZ3RoLCBidWZdKSk7XG4gIH1cbn1cblxuZXhwb3J0IHsgUmVtb3RlRGVidWdnZXJTZXJ2ZXIsIEFQUF9JTkZPLCBERVZJQ0VfSU5GTyB9O1xuIl19