require('source-map-support').install();

'use strict';

var _toConsumableArray = require('babel-runtime/helpers/to-consumable-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this5 = this;

var _indexJs = require('../../index.js');

var _helpersRemoteDebuggerServer = require('../helpers/remote-debugger-server');

var _helpersServerSetup = require('../helpers/server-setup');

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('RemoteDebugger', function () {
  var rd = undefined;
  var rds = [];
  beforeEach(function () {
    var opts = {
      bundleId: _helpersRemoteDebuggerServer.APP_INFO['PID:42'].bundleId,
      platformVersion: '8.3',
      useNewSafari: true,
      pageLoadMs: 5000,
      port: 27754,
      debuggerType: _indexJs.DEBUGGER_TYPES.webinspector };
    rd = new _indexJs.RemoteDebugger(opts);
    rds[0] = rd;
  });

  function requireAppIdKey(fn, args) {
    var _this = this;

    it('should fail if no app selected', function callee$2$0() {
      var _rd;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            // make sure there is no app id key (set during selectApp)
            rd.appIdKey = null;

            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((_rd = rd)[fn].apply(_rd, _toConsumableArray(args)).should.be.rejectedWith('appIdKey'));

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  }
  function requirePageIdKey(fn, args) {
    var _this2 = this;

    it('should fail if no page selected', function callee$2$0() {
      var _rd2;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            // make sure there is no page id key (set during selectPage)
            rd.pageIdKey = null;

            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((_rd2 = rd)[fn].apply(_rd2, _toConsumableArray(args)).should.be.rejectedWith('pageIdKey'));

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this2);
    });
  }
  function confirmRpcSend(fn, args) {
    var _this3 = this;

    var num = arguments.length <= 2 || arguments[2] === undefined ? 1 : arguments[2];

    it('should send an rpc message', function callee$2$0() {
      var _rd3;

      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy(rd.rpcClient, 'send');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((_rd3 = rd)[fn].apply(_rd3, _toConsumableArray(args)));

          case 3:
            spy.callCount.should.equal(num);

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this3);
    });
  }
  function confirmRemoteDebuggerErrorHandling(server, fn, args) {
    var _this4 = this;

    var errText = arguments.length <= 3 || arguments[3] === undefined ? 'remote debugger error' : arguments[3];

    it('should handle error from remote debugger', function callee$2$0() {
      var _rd4;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            server.setDataResponseError(errText);
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((_rd4 = rd)[fn].apply(_rd4, _toConsumableArray(args)).should.be.rejectedWith(errText));

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this4);
    });
  }

  describe('#connect', function () {
    var server = new _helpersRemoteDebuggerServer.RemoteDebuggerServer();

    beforeEach(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(server.start());

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    afterEach(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(server.stop());

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });

    it('should return application information', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(rd.connect());

          case 2:
            context$3$0.t0 = _helpersRemoteDebuggerServer.APP_INFO;
            context$3$0.sent.should.eql(context$3$0.t0);

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should set the connection key', function callee$2$0() {
      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy(rd, 'setConnectionKey');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(rd.connect());

          case 3:
            spy.calledOnce.should.be['true'];

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
  });

  describe('#disconnect', (0, _helpersServerSetup.withConnectedServer)(rds, function () {
    it('should disconnect from the rpc client', function callee$2$0() {
      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy(rd.rpcClient, 'disconnect');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(rd.disconnect());

          case 3:
            spy.calledOnce.should.be['true'];
            rd.rpcClient.disconnect.restore();

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should emit an appropriate event', function callee$2$0() {
      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy();

            rd.on(_indexJs.RemoteDebugger.EVENT_DISCONNECT, spy);
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(rd.disconnect());

          case 4:
            spy.calledOnce.should.be['true'];

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
  }));

  describe('#selectApp', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    confirmRpcSend('selectApp', []);
    it('should be able to handle an app change event before selection', function callee$2$0() {
      var initialIdKey, timeout, start, spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            initialIdKey = rd.appIdKey;

            // change the app immediately
            server.changeApp(1, true);

            // need to wait for the change to have been received
            // wait up to 2 seconds
            timeout = 2000;
            start = Date.now();

          case 4:
            if (!(Date.now() <= start + timeout)) {
              context$3$0.next = 11;
              break;
            }

            if (!(rd.appIdKey !== initialIdKey)) {
              context$3$0.next = 7;
              break;
            }

            return context$3$0.abrupt('break', 11);

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(100));

          case 9:
            context$3$0.next = 4;
            break;

          case 11:
            spy = _sinon2['default'].spy(rd.rpcClient, 'selectApp');
            context$3$0.next = 14;
            return _regeneratorRuntime.awrap(rd.selectApp());

          case 14:
            rd.appIdKey.should.equal('PID:42');
            spy.calledOnce.should.be['true'];

          case 16:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should be able to handle an app change event during selection', function callee$2$0() {
      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            // change the app when the selectApp call gets in
            server.changeApp(1, false);

            spy = _sinon2['default'].spy(rd.rpcClient, 'selectApp');
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(rd.selectApp());

          case 4:
            spy.calledTwice.should.be['true'];

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
  }));

  describe('#selectPage', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    requireAppIdKey('selectPage', []);
    confirmRpcSend('selectPage', [1, true], 3);
    confirmRpcSend('selectPage', [1, false], 4);
    confirmRemoteDebuggerErrorHandling(server, 'selectPage', [1]);
  }));

  describe('#execute', (0, _helpersServerSetup.withConnectedServer)(rds, function () {
    requireAppIdKey('execute', []);
    requirePageIdKey('execute', []);
    confirmRpcSend('execute', ['document.getElementsByTagName("html")[0].outerHTML']);
  }));

  describe('#checkPageIsReady', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    requireAppIdKey('checkPageIsReady', []);
    requirePageIdKey('checkPageIsReady', []);
    confirmRpcSend('checkPageIsReady', []);
    it('should return true when server responds with complete', function callee$2$0() {
      var ready;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            server.setDataResponseValue('complete');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(rd.checkPageIsReady());

          case 3:
            ready = context$3$0.sent;

            ready.should.be['true'];

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should return false when server responds with loading', function callee$2$0() {
      var ready;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            server.setDataResponseValue('loading');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(rd.checkPageIsReady());

          case 3:
            ready = context$3$0.sent;

            ready.should.be['false'];

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    confirmRemoteDebuggerErrorHandling(server, 'checkPageIsReady', []);
  }));

  describe('#executeAtom', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    confirmRpcSend('executeAtom', ['find_element', [], []]);
    it('should execute the atom', function callee$2$0() {
      var sentElement, element;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            sentElement = { ELEMENT: ':wdc:1435784377545' };

            server.setDataResponseValue(sentElement);
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(rd.executeAtom('find_element', [], []));

          case 4:
            element = context$3$0.sent;

            element.should.eql(sentElement);

          case 6:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    confirmRemoteDebuggerErrorHandling(server, 'executeAtom', ['find_element', [], []]);
  }));

  describe('timeline', (0, _helpersServerSetup.withConnectedServer)(rds, function () {
    describe('#startTimeline', function () {
      var timelineCallback = _sinon2['default'].spy();
      confirmRpcSend('startTimeline', [timelineCallback]);
    });

    describe('#stopTimeline', function () {
      confirmRpcSend('stopTimeline', []);
    });
  }));

  describe('#waitForFrameNavigated', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    it('should work when the delay is cancelled but the server sends message', function callee$2$0() {
      var p, source;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            p = rd.waitForFrameNavigated();

            rd.navigationDelay.cancel();

            // make the server send the navigation message
            server.sendFrameNavigationMessage();

            // wait for rd.waitForFrameNavigated() to finish
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(p);

          case 5:
            source = context$3$0.sent;

            source.should.equal('remote-debugger');

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should timeout and finish when server does not send message', function callee$2$0() {
      var source;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(rd.waitForFrameNavigated());

          case 2:
            source = context$3$0.sent;

            source.should.equal('timeout');

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
  }));

  describe('#navToUrl', (0, _helpersServerSetup.withConnectedServer)(rds, function () {
    var url = 'http://appium.io';

    requireAppIdKey('navToUrl', [url]);
    requirePageIdKey('navToUrl', [url]);
    confirmRpcSend('navToUrl', [url], 2);
  }));

  describe('#callFunction', (0, _helpersServerSetup.withConnectedServer)(rds, function () {
    requireAppIdKey('callFunction', []);
    requirePageIdKey('callFunction', []);
    confirmRpcSend('callFunction', []);
  }));

  describe('#pageLoad', (0, _helpersServerSetup.withConnectedServer)(rds, function (server) {
    it('should call #checkPageIsReady', function callee$2$0() {
      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy(rd, 'checkPageIsReady');
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(rd.pageLoad());

          case 3:
            spy.calledOnce.should.be['true'];

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should not call #checkPageIsReady if delay is cancelled', function callee$2$0() {
      var spy, p;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            spy = _sinon2['default'].spy(rd, 'checkPageIsReady');
            p = rd.pageLoad();

            rd.pageLoadDelay.cancel();
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(p);

          case 5:
            spy.called.should.be['false'];

          case 6:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
    it('should retry if page is not ready', function callee$2$0() {
      var spy;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            // give a long timeout so we can get the response from the server
            rd.pageLoadMs = 10000;

            // make the server respond first with random status, then with complete
            server.setDataResponseValue('loading');
            server.setDataResponseValue('complete');

            spy = _sinon2['default'].spy(rd, 'checkPageIsReady');
            context$3$0.next = 6;
            return _regeneratorRuntime.awrap(rd.pageLoad());

          case 6:
            spy.calledTwice.should.be['true'];

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this5);
    });
  }));

  describe('socket errors', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      var _this6 = this;

      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          it('should handle socket connect error', function callee$2$0() {
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  context$3$0.next = 2;
                  return _regeneratorRuntime.awrap(rd.connect().should.be.rejected);

                case 2:
                case 'end':
                  return context$3$0.stop();
              }
            }, null, _this6);
          });

        case 1:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this5);
  });
});

// once the appIdKey has changed, we are good to go
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9yZW1vdGUtZGVidWdnZXItc3BlY3MuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O3VCQUUrQyxnQkFBZ0I7OzJDQUNoQixtQ0FBbUM7O2tDQUM5Qyx5QkFBeUI7O29CQUM1QyxNQUFNOzs7OzhCQUNJLGtCQUFrQjs7OztxQkFDM0IsT0FBTzs7Ozt3QkFDTCxVQUFVOzs7O0FBRzlCLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQ2Qsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFHekIsUUFBUSxDQUFDLGdCQUFnQixFQUFFLFlBQU07QUFDL0IsTUFBSSxFQUFFLFlBQUEsQ0FBQztBQUNQLE1BQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztBQUNiLFlBQVUsQ0FBQyxZQUFNO0FBQ2YsUUFBSSxJQUFJLEdBQUc7QUFDVCxjQUFRLEVBQUUsc0NBQVMsUUFBUSxDQUFDLENBQUMsUUFBUTtBQUNyQyxxQkFBZSxFQUFFLEtBQUs7QUFDdEIsa0JBQVksRUFBRSxJQUFJO0FBQ2xCLGdCQUFVLEVBQUUsSUFBSTtBQUNoQixVQUFJLEVBQUUsS0FBSztBQUNYLGtCQUFZLEVBQUUsd0JBQWUsWUFBWSxFQUFDLENBQUM7QUFDN0MsTUFBRSxHQUFHLDRCQUFtQixJQUFJLENBQUMsQ0FBQztBQUM5QixPQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO0dBQ2IsQ0FBQyxDQUFDOztBQUVILFdBQVMsZUFBZSxDQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUU7OztBQUNsQyxNQUFFLENBQUMsZ0NBQWdDLEVBQUU7Ozs7Ozs7QUFFbkMsY0FBRSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7Ozs2Q0FFYixPQUFBLEVBQUUsRUFBQyxFQUFFLE9BQUMseUJBQUksSUFBSSxFQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDOzs7Ozs7O0tBQ3pELENBQUMsQ0FBQztHQUNKO0FBQ0QsV0FBUyxnQkFBZ0IsQ0FB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QUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsU0FBTSxDQUFDOzs7Ozs7O0tBQzVCLENBQUMsQ0FBQztBQUNILE1BQUUsQ0FBQyxtQ0FBbUMsRUFBRTtVQVFsQyxHQUFHOzs7OztBQU5QLGNBQUUsQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDOzs7QUFHdEIsa0JBQU0sQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUN2QyxrQkFBTSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxDQUFDOztBQUVwQyxlQUFHLEdBQUcsbUJBQU0sR0FBRyxDQUFDLEVBQUUsRUFBRSxrQkFBa0IsQ0FBQzs7NkNBQ3JDLEVBQUUsQ0FBQyxRQUFRLEVBQUU7OztBQUNuQixlQUFHLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxFQUFFLFFBQUssQ0FBQzs7Ozs7OztLQUNoQyxDQUFDLENBQUM7R0FDSixDQUFDLENBQUMsQ0FBQzs7QUFFSixVQUFRLENBQUMsZUFBZSxFQUFFOzs7Ozs7QUFDeEIsWUFBRSxDQUFDLG9DQUFvQyxFQUFFOzs7OzttREFDakMsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsUUFBUTs7Ozs7OztXQUN0QyxDQUFDLENBQUM7Ozs7Ozs7R0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC91bml0L3JlbW90ZS1kZWJ1Z2dlci1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRyYW5zcGlsZTptb2NoYVxuXG5pbXBvcnQgeyBSZW1vdGVEZWJ1Z2dlciwgREVCVUdHRVJfVFlQRVMgfSBmcm9tICcuLi8uLi9pbmRleC5qcyc7XG5pbXBvcnQgeyBSZW1vdGVEZWJ1Z2dlclNlcnZlciwgQVBQX0lORk8gfSBmcm9tICcuLi9oZWxwZXJzL3JlbW90ZS1kZWJ1Z2dlci1zZXJ2ZXInO1xuaW1wb3J0IHsgd2l0aENvbm5lY3RlZFNlcnZlciB9IGZyb20gJy4uL2hlbHBlcnMvc2VydmVyLXNldHVwJztcbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IHNpbm9uIGZyb20gJ3Npbm9uJztcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJztcblxuXG5jaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5cbmRlc2NyaWJlKCdSZW1vdGVEZWJ1Z2dlcicsICgpID0+IHtcbiAgbGV0IHJkO1xuICBsZXQgcmRzID0gW107XG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGxldCBvcHRzID0ge1xuICAgICAgYnVuZGxlSWQ6IEFQUF9JTkZPWydQSUQ6NDInXS5idW5kbGVJZCxcbiAgICAgIHBsYXRmb3JtVmVyc2lvbjogJzguMycsXG4gICAgICB1c2VOZXdTYWZhcmk6IHRydWUsXG4gICAgICBwYWdlTG9hZE1zOiA1MDAwLFxuICAgICAgcG9ydDogMjc3NTQsXG4gICAgICBkZWJ1Z2dlclR5cGU6IERFQlVHR0VSX1RZUEVTLndlYmluc3BlY3Rvcn07XG4gICAgcmQgPSBuZXcgUmVtb3RlRGVidWdnZXIob3B0cyk7XG4gICAgcmRzWzBdID0gcmQ7XG4gIH0pO1xuXG4gIGZ1bmN0aW9uIHJlcXVpcmVBcHBJZEtleSAoZm4sIGFyZ3MpIHtcbiAgICBpdCgnc2hvdWxkIGZhaWwgaWYgbm8gYXBwIHNlbGVjdGVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gbWFrZSBzdXJlIHRoZXJlIGlzIG5vIGFwcCBpZCBrZXkgKHNldCBkdXJpbmcgc2VsZWN0QXBwKVxuICAgICAgcmQuYXBwSWRLZXkgPSBudWxsO1xuXG4gICAgICBhd2FpdCByZFtmbl0oLi4uYXJncykuc2hvdWxkLmJlLnJlamVjdGVkV2l0aCgnYXBwSWRLZXknKTtcbiAgICB9KTtcbiAgfVxuICBmdW5jdGlvbiByZXF1aXJlUGFnZUlkS2V5IChmbiwgYXJncykge1xuICAgIGl0KCdzaG91bGQgZmFpbCBpZiBubyBwYWdlIHNlbGVjdGVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gbWFrZSBzdXJlIHRoZXJlIGlzIG5vIHBhZ2UgaWQga2V5IChzZXQgZHVyaW5nIHNlbGVjdFBhZ2UpXG4gICAgICByZC5wYWdlSWRLZXkgPSBudWxsO1xuXG4gICAgICBhd2FpdCByZFtmbl0oLi4uYXJncykuc2hvdWxkLmJlLnJlamVjdGVkV2l0aCgncGFnZUlkS2V5Jyk7XG4gICAgfSk7XG4gIH1cbiAgZnVuY3Rpb24gY29uZmlybVJwY1NlbmQgKGZuLCBhcmdzLCBudW0gPSAxKSB7XG4gICAgaXQoJ3Nob3VsZCBzZW5kIGFuIHJwYyBtZXNzYWdlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHNweSA9IHNpbm9uLnNweShyZC5ycGNDbGllbnQsICdzZW5kJyk7XG4gICAgICBhd2FpdCByZFtmbl0oLi4uYXJncyk7XG4gICAgICBzcHkuY2FsbENvdW50LnNob3VsZC5lcXVhbChudW0pO1xuICAgIH0pO1xuICB9XG4gIGZ1bmN0aW9uIGNvbmZpcm1SZW1vdGVEZWJ1Z2dlckVycm9ySGFuZGxpbmcgKHNlcnZlciwgZm4sIGFyZ3MsIGVyclRleHQgPSAncmVtb3RlIGRlYnVnZ2VyIGVycm9yJykge1xuICAgIGl0KCdzaG91bGQgaGFuZGxlIGVycm9yIGZyb20gcmVtb3RlIGRlYnVnZ2VyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgc2VydmVyLnNldERhdGFSZXNwb25zZUVycm9yKGVyclRleHQpO1xuICAgICAgYXdhaXQgcmRbZm5dKC4uLmFyZ3MpLnNob3VsZC5iZS5yZWplY3RlZFdpdGgoZXJyVGV4dCk7XG4gICAgfSk7XG4gIH1cblxuICBkZXNjcmliZSgnI2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgbGV0IHNlcnZlciA9IG5ldyBSZW1vdGVEZWJ1Z2dlclNlcnZlcigpO1xuXG4gICAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBzZXJ2ZXIuc3RhcnQoKTtcbiAgICB9KTtcbiAgICBhZnRlckVhY2goYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgc2VydmVyLnN0b3AoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGFwcGxpY2F0aW9uIGluZm9ybWF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgKGF3YWl0IHJkLmNvbm5lY3QoKSkuc2hvdWxkLmVxbChBUFBfSU5GTyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBzZXQgdGhlIGNvbm5lY3Rpb24ga2V5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHNweSA9IHNpbm9uLnNweShyZCwgJ3NldENvbm5lY3Rpb25LZXknKTtcbiAgICAgIGF3YWl0IHJkLmNvbm5lY3QoKTtcbiAgICAgIHNweS5jYWxsZWRPbmNlLnNob3VsZC5iZS50cnVlO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnI2Rpc2Nvbm5lY3QnLCB3aXRoQ29ubmVjdGVkU2VydmVyKHJkcywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZGlzY29ubmVjdCBmcm9tIHRoZSBycGMgY2xpZW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHNweSA9IHNpbm9uLnNweShyZC5ycGNDbGllbnQsICdkaXNjb25uZWN0Jyk7XG4gICAgICBhd2FpdCByZC5kaXNjb25uZWN0KCk7XG4gICAgICBzcHkuY2FsbGVkT25jZS5zaG91bGQuYmUudHJ1ZTtcbiAgICAgIHJkLnJwY0NsaWVudC5kaXNjb25uZWN0LnJlc3RvcmUoKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGVtaXQgYW4gYXBwcm9wcmlhdGUgZXZlbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc3B5ID0gc2lub24uc3B5KCk7XG4gICAgICByZC5vbihSZW1vdGVEZWJ1Z2dlci5FVkVOVF9ESVNDT05ORUNULCBzcHkpO1xuICAgICAgYXdhaXQgcmQuZGlzY29ubmVjdCgpO1xuICAgICAgc3B5LmNhbGxlZE9uY2Uuc2hvdWxkLmJlLnRydWU7XG4gICAgfSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgnI3NlbGVjdEFwcCcsIHdpdGhDb25uZWN0ZWRTZXJ2ZXIocmRzLCAoc2VydmVyKSA9PiB7XG4gICAgY29uZmlybVJwY1NlbmQoJ3NlbGVjdEFwcCcsIFtdKTtcbiAgICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gaGFuZGxlIGFuIGFwcCBjaGFuZ2UgZXZlbnQgYmVmb3JlIHNlbGVjdGlvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBpbml0aWFsSWRLZXkgPSByZC5hcHBJZEtleTtcbiAgICAgIC8vIGNoYW5nZSB0aGUgYXBwIGltbWVkaWF0ZWx5XG4gICAgICBzZXJ2ZXIuY2hhbmdlQXBwKDEsIHRydWUpO1xuXG4gICAgICAvLyBuZWVkIHRvIHdhaXQgZm9yIHRoZSBjaGFuZ2UgdG8gaGF2ZSBiZWVuIHJlY2VpdmVkXG4gICAgICAvLyB3YWl0IHVwIHRvIDIgc2Vjb25kc1xuICAgICAgbGV0IHRpbWVvdXQgPSAyMDAwO1xuICAgICAgbGV0IHN0YXJ0ID0gRGF0ZS5ub3coKTtcbiAgICAgIHdoaWxlIChEYXRlLm5vdygpIDw9IChzdGFydCArIHRpbWVvdXQpKSB7XG4gICAgICAgIC8vIG9uY2UgdGhlIGFwcElkS2V5IGhhcyBjaGFuZ2VkLCB3ZSBhcmUgZ29vZCB0byBnb1xuICAgICAgICBpZiAocmQuYXBwSWRLZXkgIT09IGluaXRpYWxJZEtleSkge1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGF3YWl0IFByb21pc2UuZGVsYXkoMTAwKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHNweSA9IHNpbm9uLnNweShyZC5ycGNDbGllbnQsICdzZWxlY3RBcHAnKTtcbiAgICAgIGF3YWl0IHJkLnNlbGVjdEFwcCgpO1xuICAgICAgcmQuYXBwSWRLZXkuc2hvdWxkLmVxdWFsKCdQSUQ6NDInKTtcbiAgICAgIHNweS5jYWxsZWRPbmNlLnNob3VsZC5iZS50cnVlO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgYmUgYWJsZSB0byBoYW5kbGUgYW4gYXBwIGNoYW5nZSBldmVudCBkdXJpbmcgc2VsZWN0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gY2hhbmdlIHRoZSBhcHAgd2hlbiB0aGUgc2VsZWN0QXBwIGNhbGwgZ2V0cyBpblxuICAgICAgc2VydmVyLmNoYW5nZUFwcCgxLCBmYWxzZSk7XG5cbiAgICAgIGxldCBzcHkgPSBzaW5vbi5zcHkocmQucnBjQ2xpZW50LCAnc2VsZWN0QXBwJyk7XG4gICAgICBhd2FpdCByZC5zZWxlY3RBcHAoKTtcbiAgICAgIHNweS5jYWxsZWRUd2ljZS5zaG91bGQuYmUudHJ1ZTtcbiAgICB9KTtcbiAgfSkpO1xuXG4gIGRlc2NyaWJlKCcjc2VsZWN0UGFnZScsIHdpdGhDb25uZWN0ZWRTZXJ2ZXIocmRzLCAoc2VydmVyKSA9PiB7XG4gICAgcmVxdWlyZUFwcElkS2V5KCdzZWxlY3RQYWdlJywgW10pO1xuICAgIGNvbmZpcm1ScGNTZW5kKCdzZWxlY3RQYWdlJywgWzEsIHRydWVdLCAzKTtcbiAgICBjb25maXJtUnBjU2VuZCgnc2VsZWN0UGFnZScsIFsxLCBmYWxzZV0sIDQpO1xuICAgIGNvbmZpcm1SZW1vdGVEZWJ1Z2dlckVycm9ySGFuZGxpbmcoc2VydmVyLCAnc2VsZWN0UGFnZScsIFsxXSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgnI2V4ZWN1dGUnLCB3aXRoQ29ubmVjdGVkU2VydmVyKHJkcywgKCkgPT4ge1xuICAgIHJlcXVpcmVBcHBJZEtleSgnZXhlY3V0ZScsIFtdKTtcbiAgICByZXF1aXJlUGFnZUlkS2V5KCdleGVjdXRlJywgW10pO1xuICAgIGNvbmZpcm1ScGNTZW5kKCdleGVjdXRlJywgWydkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImh0bWxcIilbMF0ub3V0ZXJIVE1MJ10pO1xuICB9KSk7XG5cbiAgZGVzY3JpYmUoJyNjaGVja1BhZ2VJc1JlYWR5Jywgd2l0aENvbm5lY3RlZFNlcnZlcihyZHMsIChzZXJ2ZXIpID0+IHtcbiAgICByZXF1aXJlQXBwSWRLZXkoJ2NoZWNrUGFnZUlzUmVhZHknLCBbXSk7XG4gICAgcmVxdWlyZVBhZ2VJZEtleSgnY2hlY2tQYWdlSXNSZWFkeScsIFtdKTtcbiAgICBjb25maXJtUnBjU2VuZCgnY2hlY2tQYWdlSXNSZWFkeScsIFtdKTtcbiAgICBpdCgnc2hvdWxkIHJldHVybiB0cnVlIHdoZW4gc2VydmVyIHJlc3BvbmRzIHdpdGggY29tcGxldGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBzZXJ2ZXIuc2V0RGF0YVJlc3BvbnNlVmFsdWUoJ2NvbXBsZXRlJyk7XG4gICAgICBsZXQgcmVhZHkgPSBhd2FpdCByZC5jaGVja1BhZ2VJc1JlYWR5KCk7XG4gICAgICByZWFkeS5zaG91bGQuYmUudHJ1ZTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSB3aGVuIHNlcnZlciByZXNwb25kcyB3aXRoIGxvYWRpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgICBzZXJ2ZXIuc2V0RGF0YVJlc3BvbnNlVmFsdWUoJ2xvYWRpbmcnKTtcbiAgICAgIGxldCByZWFkeSA9IGF3YWl0IHJkLmNoZWNrUGFnZUlzUmVhZHkoKTtcbiAgICAgIHJlYWR5LnNob3VsZC5iZS5mYWxzZTtcbiAgICB9KTtcbiAgICBjb25maXJtUmVtb3RlRGVidWdnZXJFcnJvckhhbmRsaW5nKHNlcnZlciwgJ2NoZWNrUGFnZUlzUmVhZHknLCBbXSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgnI2V4ZWN1dGVBdG9tJywgd2l0aENvbm5lY3RlZFNlcnZlcihyZHMsIChzZXJ2ZXIpID0+IHtcbiAgICBjb25maXJtUnBjU2VuZCgnZXhlY3V0ZUF0b20nLCBbJ2ZpbmRfZWxlbWVudCcsIFtdLCBbXV0pO1xuICAgIGl0KCdzaG91bGQgZXhlY3V0ZSB0aGUgYXRvbScsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBzZW50RWxlbWVudCA9IHtFTEVNRU5UOiAnOndkYzoxNDM1Nzg0Mzc3NTQ1J307XG4gICAgICBzZXJ2ZXIuc2V0RGF0YVJlc3BvbnNlVmFsdWUoc2VudEVsZW1lbnQpO1xuICAgICAgbGV0IGVsZW1lbnQgPSBhd2FpdCByZC5leGVjdXRlQXRvbSgnZmluZF9lbGVtZW50JywgW10sIFtdKTtcbiAgICAgIGVsZW1lbnQuc2hvdWxkLmVxbChzZW50RWxlbWVudCk7XG4gICAgfSk7XG4gICAgY29uZmlybVJlbW90ZURlYnVnZ2VyRXJyb3JIYW5kbGluZyhzZXJ2ZXIsICdleGVjdXRlQXRvbScsIFsnZmluZF9lbGVtZW50JywgW10sIFtdXSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgndGltZWxpbmUnLCB3aXRoQ29ubmVjdGVkU2VydmVyKHJkcywgKCkgPT4ge1xuICAgIGRlc2NyaWJlKCcjc3RhcnRUaW1lbGluZScsICgpID0+IHtcbiAgICAgIGxldCB0aW1lbGluZUNhbGxiYWNrID0gc2lub24uc3B5KCk7XG4gICAgICBjb25maXJtUnBjU2VuZCgnc3RhcnRUaW1lbGluZScsIFt0aW1lbGluZUNhbGxiYWNrXSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnI3N0b3BUaW1lbGluZScsICgpID0+IHtcbiAgICAgIGNvbmZpcm1ScGNTZW5kKCdzdG9wVGltZWxpbmUnLCBbXSk7XG4gICAgfSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgnI3dhaXRGb3JGcmFtZU5hdmlnYXRlZCcsIHdpdGhDb25uZWN0ZWRTZXJ2ZXIocmRzLCAoc2VydmVyKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCB3b3JrIHdoZW4gdGhlIGRlbGF5IGlzIGNhbmNlbGxlZCBidXQgdGhlIHNlcnZlciBzZW5kcyBtZXNzYWdlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHAgPSByZC53YWl0Rm9yRnJhbWVOYXZpZ2F0ZWQoKTtcbiAgICAgIHJkLm5hdmlnYXRpb25EZWxheS5jYW5jZWwoKTtcblxuICAgICAgLy8gbWFrZSB0aGUgc2VydmVyIHNlbmQgdGhlIG5hdmlnYXRpb24gbWVzc2FnZVxuICAgICAgc2VydmVyLnNlbmRGcmFtZU5hdmlnYXRpb25NZXNzYWdlKCk7XG5cbiAgICAgIC8vIHdhaXQgZm9yIHJkLndhaXRGb3JGcmFtZU5hdmlnYXRlZCgpIHRvIGZpbmlzaFxuICAgICAgbGV0IHNvdXJjZSA9IGF3YWl0IHA7XG4gICAgICBzb3VyY2Uuc2hvdWxkLmVxdWFsKCdyZW1vdGUtZGVidWdnZXInKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHRpbWVvdXQgYW5kIGZpbmlzaCB3aGVuIHNlcnZlciBkb2VzIG5vdCBzZW5kIG1lc3NhZ2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc291cmNlID0gYXdhaXQgcmQud2FpdEZvckZyYW1lTmF2aWdhdGVkKCk7XG4gICAgICBzb3VyY2Uuc2hvdWxkLmVxdWFsKCd0aW1lb3V0Jyk7XG4gICAgfSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgnI25hdlRvVXJsJywgd2l0aENvbm5lY3RlZFNlcnZlcihyZHMsICgpID0+IHtcbiAgICBsZXQgdXJsID0gJ2h0dHA6Ly9hcHBpdW0uaW8nO1xuXG4gICAgcmVxdWlyZUFwcElkS2V5KCduYXZUb1VybCcsIFt1cmxdKTtcbiAgICByZXF1aXJlUGFnZUlkS2V5KCduYXZUb1VybCcsIFt1cmxdKTtcbiAgICBjb25maXJtUnBjU2VuZCgnbmF2VG9VcmwnLCBbdXJsXSwgMik7XG4gIH0pKTtcblxuICBkZXNjcmliZSgnI2NhbGxGdW5jdGlvbicsIHdpdGhDb25uZWN0ZWRTZXJ2ZXIocmRzLCAoKSA9PiB7XG4gICAgcmVxdWlyZUFwcElkS2V5KCdjYWxsRnVuY3Rpb24nLCBbXSk7XG4gICAgcmVxdWlyZVBhZ2VJZEtleSgnY2FsbEZ1bmN0aW9uJywgW10pO1xuICAgIGNvbmZpcm1ScGNTZW5kKCdjYWxsRnVuY3Rpb24nLCBbXSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgnI3BhZ2VMb2FkJywgd2l0aENvbm5lY3RlZFNlcnZlcihyZHMsIChzZXJ2ZXIpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNhbGwgI2NoZWNrUGFnZUlzUmVhZHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc3B5ID0gc2lub24uc3B5KHJkLCAnY2hlY2tQYWdlSXNSZWFkeScpO1xuICAgICAgYXdhaXQgcmQucGFnZUxvYWQoKTtcbiAgICAgIHNweS5jYWxsZWRPbmNlLnNob3VsZC5iZS50cnVlO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgbm90IGNhbGwgI2NoZWNrUGFnZUlzUmVhZHkgaWYgZGVsYXkgaXMgY2FuY2VsbGVkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHNweSA9IHNpbm9uLnNweShyZCwgJ2NoZWNrUGFnZUlzUmVhZHknKTtcbiAgICAgIGxldCBwID0gcmQucGFnZUxvYWQoKTtcbiAgICAgIHJkLnBhZ2VMb2FkRGVsYXkuY2FuY2VsKCk7XG4gICAgICBhd2FpdCBwO1xuICAgICAgc3B5LmNhbGxlZC5zaG91bGQuYmUuZmFsc2U7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCByZXRyeSBpZiBwYWdlIGlzIG5vdCByZWFkeScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIGdpdmUgYSBsb25nIHRpbWVvdXQgc28gd2UgY2FuIGdldCB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyXG4gICAgICByZC5wYWdlTG9hZE1zID0gMTAwMDA7XG5cbiAgICAgIC8vIG1ha2UgdGhlIHNlcnZlciByZXNwb25kIGZpcnN0IHdpdGggcmFuZG9tIHN0YXR1cywgdGhlbiB3aXRoIGNvbXBsZXRlXG4gICAgICBzZXJ2ZXIuc2V0RGF0YVJlc3BvbnNlVmFsdWUoJ2xvYWRpbmcnKTtcbiAgICAgIHNlcnZlci5zZXREYXRhUmVzcG9uc2VWYWx1ZSgnY29tcGxldGUnKTtcblxuICAgICAgbGV0IHNweSA9IHNpbm9uLnNweShyZCwgJ2NoZWNrUGFnZUlzUmVhZHknKTtcbiAgICAgIGF3YWl0IHJkLnBhZ2VMb2FkKCk7XG4gICAgICBzcHkuY2FsbGVkVHdpY2Uuc2hvdWxkLmJlLnRydWU7XG4gICAgfSk7XG4gIH0pKTtcblxuICBkZXNjcmliZSgnc29ja2V0IGVycm9ycycsIGFzeW5jICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBzb2NrZXQgY29ubmVjdCBlcnJvcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHJkLmNvbm5lY3QoKS5zaG91bGQuYmUucmVqZWN0ZWQ7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=