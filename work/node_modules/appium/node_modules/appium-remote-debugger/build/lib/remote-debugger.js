require('source-map-support').install();

'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _mobileJsonWireProtocol = require('mobile-json-wire-protocol');

var _remoteDebuggerRpcClient = require('./remote-debugger-rpc-client');

var _remoteDebuggerRpcClient2 = _interopRequireDefault(_remoteDebuggerRpcClient);

var _messageHandlers = require('./message-handlers');

var _messageHandlers2 = _interopRequireDefault(_messageHandlers);

var _helpers = require('./helpers');

var _appiumSupport = require('appium-support');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var DEBUGGER_TYPES = {
  webkit: 1,
  webinspector: 2
};
var SELECT_APP_RETRIES = 20;
var REMOTE_DEBUGGER_PORT = 27753;

var RemoteDebugger = (function (_events$EventEmitter) {
  _inherits(RemoteDebugger, _events$EventEmitter);

  /*
   * The constructor takes an opts hash with the following properties:
   *   - bundleId - id of the app being connected to
   *   - platformVersion - version of iOS
   *   - debuggerType - one of the DEBUGGER_TYPES
   *   - useNewSafari - for web inspector, whether this is a new Safari instance
   *   - pageLoadMs - the time, in ms, that should be waited for page loading
   *   - host - the remote debugger's host address
   *   - port - the remote debugger port through which to communicate
   */

  function RemoteDebugger() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, RemoteDebugger);

    _get(Object.getPrototypeOf(RemoteDebugger.prototype), 'constructor', this).call(this);

    var bundleId = opts.bundleId;
    var platformVersion = opts.platformVersion;
    var debuggerType = opts.debuggerType;
    var useNewSafari = opts.useNewSafari;
    var pageLoadMs = opts.pageLoadMs;
    var host = opts.host;
    var port = opts.port;

    this.bundleId = bundleId;
    this.platformVersion = platformVersion;
    this.debuggerType = debuggerType || DEBUGGER_TYPES.webinspector;
    if (this.debuggerType === DEBUGGER_TYPES.webinspector) {
      this.useNewSafari = useNewSafari || false;
      this.pageLoadMs = pageLoadMs;
      _logger2['default'].debug('useNewSafari --> ' + this.useNewSafari);
    }

    // app handling configuration
    this.appDict = {};
    this.appIdKey = null;
    this.pageIdKey = null;
    this.pageLoading = false;

    // set up the special callbacks for handling rd events
    this.specialCbs = {
      '_rpc_reportIdentifier:': _lodash2['default'].noop,
      '_rpc_forwardGetListing:': _lodash2['default'].noop,
      '_rpc_reportConnectedApplicationList:': _lodash2['default'].noop,
      '_rpc_applicationConnected:': this.onAppConnect.bind(this),
      '_rpc_applicationDisconnected:': this.onAppDisconnect.bind(this)
    };

    this.host = host || 'localhost';
    this.port = port || REMOTE_DEBUGGER_PORT;
    this.rpcClient = null;
  }

  // event emitted publically

  _createClass(RemoteDebugger, [{
    key: 'connect',
    value: function connect() {
      var appInfo;
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // initialize the rpc client for
            this.rpcClient = new _remoteDebuggerRpcClient2['default'](this.host, this.port, this.specialCbs);
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.rpcClient.connect());

          case 3:
            context$2$0.prev = 3;
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.setConnectionKey());

          case 6:
            appInfo = context$2$0.sent;

            _logger2['default'].debug('Connected to application');
            return context$2$0.abrupt('return', appInfo);

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](3);
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.disconnect());

          case 15:
            return context$2$0.abrupt('return', null);

          case 16:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[3, 11]]);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      return _regeneratorRuntime.async(function disconnect$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.rpcClient.disconnect());

          case 2:
            this.emit(RemoteDebugger.EVENT_DISCONNECT, true);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return !!(this.rpcClient && this.rpcClient.isConnected());
    }
  }, {
    key: 'logApplicationDictionary',
    value: function logApplicationDictionary(apps) {
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _getIterator(_lodash2['default'].toPairs(apps)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var _step$value = _slicedToArray(_step.value, 2);

          var app = _step$value[0];
          var info = _step$value[1];

          _logger2['default'].debug('Application: \'' + app + '\'');
          var _iteratorNormalCompletion2 = true;
          var _didIteratorError2 = false;
          var _iteratorError2 = undefined;

          try {
            for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(info)), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              var _step2$value = _slicedToArray(_step2.value, 2);

              var key = _step2$value[0];
              var value = _step2$value[1];

              _logger2['default'].debug('    ' + key + ': \'' + value + '\'');
            }
          } catch (err) {
            _didIteratorError2 = true;
            _iteratorError2 = err;
          } finally {
            try {
              if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                _iterator2['return']();
              }
            } finally {
              if (_didIteratorError2) {
                throw _iteratorError2;
              }
            }
          }
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }
    }
  }, {
    key: 'setConnectionKey',
    value: function setConnectionKey() {
      return _regeneratorRuntime.async(function setConnectionKey$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(new _bluebird2['default'](function callee$2$0(resolve, reject) {
              var connectCb, _ref, _ref2, simNameKey, simBuildKey, simPlatformVersion;

              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    connectCb = function connectCb(apps) {
                      if (_lodash2['default'].isUndefined(apps) || _lodash2['default'].keys(apps).length === 0) {
                        var msg = 'Received no apps from remote debugger. Unable to connect.';
                        _logger2['default'].debug(msg);
                        return resolve(_this.appDict);
                      }
                      var newDict = {};

                      // translate the received information into an easier-to-manage
                      // hash with app id as key, and app info as value
                      var _iteratorNormalCompletion3 = true;
                      var _didIteratorError3 = false;
                      var _iteratorError3 = undefined;

                      try {
                        for (var _iterator3 = _getIterator(_lodash2['default'].values(apps)), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
                          var dict = _step3.value;

                          var _appInfoFromDict = (0, _helpers.appInfoFromDict)(dict);

                          var _appInfoFromDict2 = _slicedToArray(_appInfoFromDict, 2);

                          var id = _appInfoFromDict2[0];
                          var entry = _appInfoFromDict2[1];

                          newDict[id] = entry;
                        }
                        // update the object's list of apps, and return it through the promise
                      } catch (err) {
                        _didIteratorError3 = true;
                        _iteratorError3 = err;
                      } finally {
                        try {
                          if (!_iteratorNormalCompletion3 && _iterator3['return']) {
                            _iterator3['return']();
                          }
                        } finally {
                          if (_didIteratorError3) {
                            throw _iteratorError3;
                          }
                        }
                      }

                      _lodash2['default'].defaults(_this.appDict, newDict);
                      resolve(newDict);
                    };

                    this.rpcClient.setSpecialMessageHandler('_rpc_reportConnectedApplicationList:', reject, connectCb);

                    _logger2['default'].debug('Sending connection key request');
                    context$3$0.next = 5;
                    return _regeneratorRuntime.awrap(this.rpcClient.send('setConnectionKey'));

                  case 5:
                    _ref = context$3$0.sent;
                    _ref2 = _slicedToArray(_ref, 3);
                    simNameKey = _ref2[0];
                    simBuildKey = _ref2[1];
                    simPlatformVersion = _ref2[2];

                    _logger2['default'].debug('Sim name: ' + simNameKey);
                    _logger2['default'].debug('Sim build: ' + simBuildKey);
                    _logger2['default'].debug('Sim platform version: ' + simPlatformVersion);

                  case 13:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            }));

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'updateAppsWithDict',
    value: function updateAppsWithDict(dict) {
      // get the dictionary entry into a nice form, and add it to the
      // application dictionary
      this.appDict = this.appDict || {};

      var _appInfoFromDict3 = (0, _helpers.appInfoFromDict)(dict);

      var _appInfoFromDict32 = _slicedToArray(_appInfoFromDict3, 2);

      var id = _appInfoFromDict32[0];
      var entry = _appInfoFromDict32[1];

      this.appDict[id] = entry;

      _logger2['default'].debug('Current applications available:');
      this.logApplicationDictionary(this.appDict);

      // try to get the app id from our connected apps
      this.appIdKey = (0, _helpers.getDebuggerAppKey)(this.bundleId, this.platformVersion, this.appDict);
    }
  }, {
    key: 'selectApp',
    value: function selectApp() {
      var currentUrl = arguments.length <= 0 || arguments[0] === undefined ? null : arguments[0];
      var maxTries = arguments.length <= 1 || arguments[1] === undefined ? SELECT_APP_RETRIES : arguments[1];

      var pageDict, appIdKey, done, i, possibleAppIds, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _iterator4, _step4, attemptedAppIdKey, _ref3, _ref32, found, pageArray;

      return _regeneratorRuntime.async(function selectApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Selecting application');

            if (!(!this.appDict || _lodash2['default'].keys(this.appDict).length === 0)) {
              context$2$0.next = 4;
              break;
            }

            _logger2['default'].debug('No applications currently connected.');
            return context$2$0.abrupt('return', []);

          case 4:
            pageDict = undefined, appIdKey = undefined;
            done = false;
            i = 0;

          case 7:
            if (!(i < maxTries)) {
              context$2$0.next = 65;
              break;
            }

            if (!done) {
              context$2$0.next = 10;
              break;
            }

            return context$2$0.abrupt('break', 65);

          case 10:
            possibleAppIds = (0, _helpers.getPossibleDebuggerAppKeys)(this.bundleId, this.platformVersion, this.appDict);

            _logger2['default'].debug('Trying out the possible app ids: ' + possibleAppIds.join(', '));
            _iteratorNormalCompletion4 = true;
            _didIteratorError4 = false;
            _iteratorError4 = undefined;
            context$2$0.prev = 15;
            _iterator4 = _getIterator(possibleAppIds);

          case 17:
            if (_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done) {
              context$2$0.next = 48;
              break;
            }

            attemptedAppIdKey = _step4.value;

            if (!done) {
              context$2$0.next = 21;
              break;
            }

            return context$2$0.abrupt('break', 48);

          case 21:
            context$2$0.prev = 21;

            _logger2['default'].debug('Selecting app ' + attemptedAppIdKey + ' (try #' + (i + 1) + ' of ' + maxTries + ')');
            context$2$0.next = 25;
            return _regeneratorRuntime.awrap(this.rpcClient.selectApp(attemptedAppIdKey, this.onAppConnect.bind(this)));

          case 25:
            _ref3 = context$2$0.sent;
            _ref32 = _slicedToArray(_ref3, 2);
            appIdKey = _ref32[0];
            pageDict = _ref32[1];

            if (!_lodash2['default'].isEmpty(pageDict)) {
              context$2$0.next = 32;
              break;
            }

            _logger2['default'].debug('Empty page dictionary received. Trying again.');
            // this.appIdKey = appIdKey;
            return context$2$0.abrupt('continue', 45);

          case 32:
            if (!currentUrl) {
              context$2$0.next = 39;
              break;
            }

            found = undefined;

            _lodash2['default'].each(pageDict, function (record) {
              if (record.WIRURLKey === currentUrl) {
                // this is the page we want
                found = true;
              }
            });

            if (found) {
              context$2$0.next = 39;
              break;
            }

            _logger2['default'].debug('Received app, but expected url (\'' + currentUrl + '\') was not found. Trying again.');
            // this.appIdKey = appIdKey;
            pageDict = null;
            return context$2$0.abrupt('continue', 45);

          case 39:

            // we have gotten the correct application by this point, so short circuit everything
            done = true;
            context$2$0.next = 45;
            break;

          case 42:
            context$2$0.prev = 42;
            context$2$0.t0 = context$2$0['catch'](21);

            _logger2['default'].debug('Retrying connection');

          case 45:
            _iteratorNormalCompletion4 = true;
            context$2$0.next = 17;
            break;

          case 48:
            context$2$0.next = 54;
            break;

          case 50:
            context$2$0.prev = 50;
            context$2$0.t1 = context$2$0['catch'](15);
            _didIteratorError4 = true;
            _iteratorError4 = context$2$0.t1;

          case 54:
            context$2$0.prev = 54;
            context$2$0.prev = 55;

            if (!_iteratorNormalCompletion4 && _iterator4['return']) {
              _iterator4['return']();
            }

          case 57:
            context$2$0.prev = 57;

            if (!_didIteratorError4) {
              context$2$0.next = 60;
              break;
            }

            throw _iteratorError4;

          case 60:
            return context$2$0.finish(57);

          case 61:
            return context$2$0.finish(54);

          case 62:
            i++;
            context$2$0.next = 7;
            break;

          case 65:

            // if, after all this, we have no dictionary, we have failed
            if (!pageDict) {
              _logger2['default'].errorAndThrow('Could not connect to a valid app after ' + maxTries + ' tries.');
            }

            if (this.appIdKey !== appIdKey) {
              _logger2['default'].debug('Received altered app id, updating from \'' + this.appIdKey + '\' to \'' + appIdKey + '\'');
              this.appIdKey = appIdKey;
            }

            // set the callback for getting a listing to the page change callback
            this.rpcClient.setSpecialMessageHandler('_rpc_forwardGetListing:', null, this.onPageChange.bind(this));

            // translate the dictionary into a useful form, and return to sender
            pageArray = (0, _helpers.pageArrayFromDict)(pageDict);

            _logger2['default'].debug('Selecting app ' + this.appIdKey + ': ' + JSON.stringify(pageArray));
            return context$2$0.abrupt('return', pageArray);

          case 71:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[15, 50, 54, 62], [21, 42], [55,, 57, 61]]);
    }
  }, {
    key: 'selectPage',
    value: function selectPage(pageIdKey) {
      var skipReadyCheck = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];
      var errors, ready;
      return _regeneratorRuntime.async(function selectPage$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            errors = (0, _helpers.checkParams)({ appIdKey: this.appIdKey });

            if (!errors) {
              context$2$0.next = 3;
              break;
            }

            throw new Error(errors);

          case 3:

            this.pageIdKey = pageIdKey;

            _logger2['default'].debug('Selecting page ' + pageIdKey + ' and forwarding socket setup');

            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.rpcClient.send('setSenderKey', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey
            }));

          case 7:
            _logger2['default'].debug('Sender key set');

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.rpcClient.send('enablePage', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 10:
            _logger2['default'].debug('Enabled activity on page');

            // make sure everything is ready to go
            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.checkPageIsReady());

          case 13:
            ready = context$2$0.sent;

            if (!(!skipReadyCheck && !ready)) {
              context$2$0.next = 17;
              break;
            }

            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(this.pageUnload());

          case 17:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'executeAtom',
    value: function executeAtom(atom, args, frames) {
      var script, value;
      return _regeneratorRuntime.async(function executeAtom$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.rpcClient.connected) {
              context$2$0.next = 2;
              break;
            }

            throw new Error('Remote debugger is not connected');

          case 2:
            script = (0, _helpers.getScriptForAtom)(atom, args, frames);
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.execute(script, true));

          case 5:
            value = context$2$0.sent;

            _logger2['default'].debug('Received result for atom \'' + atom + '\' execution: ' + JSON.stringify(value));
            return context$2$0.abrupt('return', value);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'executeAtomAsync',
    value: function executeAtomAsync(atom, args, frames, responseUrl) {
      var asyncCallBack, script;
      return _regeneratorRuntime.async(function executeAtomAsync$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            asyncCallBack = 'function (res) { xmlHttp = new XMLHttpRequest(); ' + ('xmlHttp.open(\'POST\', \'' + responseUrl + '\', true);') + 'xmlHttp.setRequestHeader(\'Content-type\',\'application/json\'); ' + 'xmlHttp.send(res); }';
            script = (0, _helpers.getScriptForAtom)(atom, args, frames, asyncCallBack);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.execute(script));

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'pageLoad',
    value: function pageLoad(startPageLoadMs) {
      var timeoutMs, start, verify;
      return _regeneratorRuntime.async(function pageLoad$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            timeoutMs = 500;
            start = startPageLoadMs || Date.now();

            _logger2['default'].debug('Page loaded, verifying whether ready');

            verify = function verify() {
              var ready;
              return _regeneratorRuntime.async(function verify$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    this.pageLoadDelay = _appiumSupport.util.cancellableDelay(timeoutMs);
                    context$3$0.prev = 1;
                    context$3$0.next = 4;
                    return _regeneratorRuntime.awrap(this.pageLoadDelay);

                  case 4:
                    context$3$0.next = 10;
                    break;

                  case 6:
                    context$3$0.prev = 6;
                    context$3$0.t0 = context$3$0['catch'](1);

                    if (!(context$3$0.t0 instanceof _bluebird2['default'].CancellationError)) {
                      context$3$0.next = 10;
                      break;
                    }

                    return context$3$0.abrupt('return');

                  case 10:
                    context$3$0.next = 12;
                    return _regeneratorRuntime.awrap(this.checkPageIsReady());

                  case 12:
                    ready = context$3$0.sent;

                    if (!(ready || this.pageLoadMs > 0 && start + this.pageLoadMs < Date.now())) {
                      context$3$0.next = 18;
                      break;
                    }

                    _logger2['default'].debug('Page is ready');
                    this.pageLoading = false;
                    context$3$0.next = 21;
                    break;

                  case 18:
                    _logger2['default'].debug('Page was not ready, retrying');
                    context$3$0.next = 21;
                    return _regeneratorRuntime.awrap(verify());

                  case 21:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3, [[1, 6]]);
            };

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(verify());

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'cancelPageLoad',
    value: function cancelPageLoad() {
      return _regeneratorRuntime.async(function cancelPageLoad$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Unregistering from page readiness notifications');
            this.pageLoading = false;
            if (this.pageLoadDelay) {
              this.pageLoadDelay.cancel();
            }

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'pageUnload',
    value: function pageUnload() {
      return _regeneratorRuntime.async(function pageUnload$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Page unloading');
            this.pageLoading = true;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.waitForDom());

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForDom',
    value: function waitForDom(startPageLoadMs) {
      return _regeneratorRuntime.async(function waitForDom$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Waiting for dom...');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.pageLoad(startPageLoadMs));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'checkPageIsReady',
    value: function checkPageIsReady() {
      var readyCmd, readyState;
      return _regeneratorRuntime.async(function checkPageIsReady$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Checking document readyState');
            readyCmd = '(function (){ return document.readyState; })()';
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.execute(readyCmd, true));

          case 4:
            readyState = context$2$0.sent;

            _logger2['default'].debug('readyState was ' + JSON.stringify(readyState));

            return context$2$0.abrupt('return', readyState === 'complete');

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'navToUrl',
    value: function navToUrl(url) {
      var _errors;

      return _regeneratorRuntime.async(function navToUrl$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(this.debuggerType === DEBUGGER_TYPES.webinspector)) {
              context$2$0.next = 4;
              break;
            }

            _errors = (0, _helpers.checkParams)({ appIdKey: this.appIdKey, pageIdKey: this.pageIdKey });

            if (!_errors) {
              context$2$0.next = 4;
              break;
            }

            throw new Error(_errors);

          case 4:

            _logger2['default'].debug('Navigating to new URL: ' + url);
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.rpcClient.send('setUrl', {
              url: url,
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 7:
            if (this.useNewSafari) {
              context$2$0.next = 10;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(1000));

          case 10:
            if (!(this.debuggerType === DEBUGGER_TYPES.webinspector)) {
              context$2$0.next = 13;
              break;
            }

            context$2$0.next = 13;
            return _regeneratorRuntime.awrap(this.waitForFrameNavigated());

          case 13:
            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.waitForDom(Date.now()));

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'waitForFrameNavigated',
    value: function waitForFrameNavigated() {
      return _regeneratorRuntime.async(function waitForFrameNavigated$(context$2$0) {
        var _this5 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function callee$2$0(resolve, reject) {
              var startMs, navEventListener, timeout;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this4 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    _logger2['default'].debug('Waiting for frame navigated message...');
                    startMs = Date.now();

                    navEventListener = function navEventListener(value) {
                      _logger2['default'].debug('Frame navigated in ' + (Date.now() - startMs) / 1000 + ' sec from source: ' + value);
                      if (_this4.navigationDelay) {
                        _this4.navigationDelay.cancel();
                      }
                      resolve(value);
                    };

                    this.rpcClient.setSpecialMessageHandler('Page.frameNavigated', reject, navEventListener);

                    // timeout, in case remote debugger doesn't respond,
                    // or takes a long time

                    if (!(!this.useNewSafari || this.pageLoadMs >= 0)) {
                      context$3$0.next = 15;
                      break;
                    }

                    timeout = this.useNewSafari ? this.pageLoadMs : 500;

                    this.navigationDelay = _appiumSupport.util.cancellableDelay(timeout);
                    context$3$0.prev = 7;
                    context$3$0.next = 10;
                    return _regeneratorRuntime.awrap(this.navigationDelay);

                  case 10:
                    navEventListener('timeout');
                    context$3$0.next = 15;
                    break;

                  case 13:
                    context$3$0.prev = 13;
                    context$3$0.t0 = context$3$0['catch'](7);

                  case 15:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this5, [[7, 13]]);
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startTimeline',

    // nothing to do: we only get here if the remote debugger
    // already notified of frame navigation, and the delay
    // was cancelled
    value: function startTimeline(fn) {
      return _regeneratorRuntime.async(function startTimeline$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Starting to record the timeline');
            this.rpcClient.setTimelineEventHandler(fn);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.rpcClient.send('startTimeline', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stopTimeline',
    value: function stopTimeline() {
      return _regeneratorRuntime.async(function stopTimeline$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Stopping to record the timeline');
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.rpcClient.send('stopTimeline', {
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'execute',
    value: function execute(command, override) {
      var _errors2, res;

      return _regeneratorRuntime.async(function execute$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!(this.pageLoading && !override)) {
              context$2$0.next = 4;
              break;
            }

            _logger2['default'].debug('Trying to execute but page is not loaded.');
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.waitForDom());

          case 4:
            if (!(this.debuggerType === DEBUGGER_TYPES.webinspector)) {
              context$2$0.next = 8;
              break;
            }

            _errors2 = (0, _helpers.checkParams)({ appIdKey: this.appIdKey, pageIdKey: this.pageIdKey });

            if (!_errors2) {
              context$2$0.next = 8;
              break;
            }

            throw new Error(_errors2);

          case 8:

            _logger2['default'].debug('Sending javascript command ' + _lodash2['default'].truncate(command, 50));
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.rpcClient.send('sendJSCommand', {
              command: command,
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 11:
            res = context$2$0.sent;
            return context$2$0.abrupt('return', this.convertResult(res));

          case 13:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'callFunction',
    value: function callFunction(objId, fn, args) {
      var errors, res;
      return _regeneratorRuntime.async(function callFunction$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            errors = (0, _helpers.checkParams)({ appIdKey: this.appIdKey, pageIdKey: this.pageIdKey });

            if (!errors) {
              context$2$0.next = 3;
              break;
            }

            throw new Error(errors);

          case 3:

            _logger2['default'].debug('Calling javascript function');
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.rpcClient.send('callJSFunction', {
              objId: objId,
              fn: fn,
              args: args,
              appIdKey: this.appIdKey,
              pageIdKey: this.pageIdKey,
              debuggerType: this.debuggerType
            }));

          case 6:
            res = context$2$0.sent;
            return context$2$0.abrupt('return', this.convertResult(res));

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'convertResult',
    value: function convertResult(res) {
      if (_lodash2['default'].isUndefined(res)) {
        throw new Error('Did not get OK result from remote debugger. Result was: ' + JSON.stringify(res));
      } else if (_lodash2['default'].isString(res)) {
        try {
          res = JSON.parse(res);
        } catch (err) {
          // we might get a serialized object, but we might not
          // if we get here, it is just a value
        }
      } else if (!_lodash2['default'].isObject(res)) {
          throw new Error('Result has unexpected type: (' + typeof res + ').');
        }

      if (res.status && res.status !== 0) {
        // we got some form of error.
        var message = res.value.message || res.value;
        throw new _mobileJsonWireProtocol.errors.JavaScriptError(message + ' (status: ' + res.status + ')');
      }

      // with either have an object with a `value` property (even if `null`),
      // or a plain object
      return res.hasOwnProperty('value') ? res.value : res;
    }
  }, {
    key: 'allowNavigationWithoutReload',
    value: function allowNavigationWithoutReload() {
      var allow = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
      return _regeneratorRuntime.async(function allowNavigationWithoutReload$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.rpcClient.allowNavigationWithoutReload(allow);

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return RemoteDebugger;
})(_events2['default'].EventEmitter);

RemoteDebugger.EVENT_PAGE_CHANGE = 'remote_debugger_page_change';
RemoteDebugger.EVENT_DISCONNECT = 'remote_debugger_disconnect';

// add generic callbacks
var _iteratorNormalCompletion5 = true;
var _didIteratorError5 = false;
var _iteratorError5 = undefined;

try {
  for (var _iterator5 = _getIterator(_lodash2['default'].toPairs(_messageHandlers2['default'])), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
    var _step5$value = _slicedToArray(_step5.value, 2);

    var _name = _step5$value[0];
    var handler = _step5$value[1];

    RemoteDebugger.prototype[_name] = handler;
  }
} catch (err) {
  _didIteratorError5 = true;
  _iteratorError5 = err;
} finally {
  try {
    if (!_iteratorNormalCompletion5 && _iterator5['return']) {
      _iterator5['return']();
    }
  } finally {
    if (_didIteratorError5) {
      throw _iteratorError5;
    }
  }
}

exports.RemoteDebugger = RemoteDebugger;
exports.DEBUGGER_TYPES = DEBUGGER_TYPES;
exports.REMOTE_DEBUGGER_PORT = REMOTE_DEBUGGER_PORT;

// get the connection information about the app

// only resolve when the connection response is received

// local callback, called when the remote debugger has established
// a connection to the app under test
// `app` will be an array of dictionaries of app information

// iterative solution, as recursion was swallowing the promise at some point

// in iOS 8.2 the connect logic happens, but with an empty dictionary
// which leads to the remote debugger getting disconnected, and into a loop

// if we are looking for a particular url, make sure this is the right page

// if the promise has been cancelled
// we want to skip checking the readiness

// if we are ready, or we've spend too much time on this

// no need to do this check when using webkit

// a small pause for the browser to catch up

// add a handler for the `Page.frameNavigated` message
// from the remote debugger

// use pageLoadMs, or a small amount of time

// if the page is not loaded yet, wait for it

// no need to check errors if it is webkit
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtZGVidWdnZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O3NCQUVtQixRQUFROzs7O3NCQUNYLFVBQVU7Ozs7c0NBQ0gsMkJBQTJCOzt1Q0FDZCw4QkFBOEI7Ozs7K0JBQ3RDLG9CQUFvQjs7Ozt1QkFFZixXQUFXOzs2QkFDdkIsZ0JBQWdCOztzQkFDdkIsUUFBUTs7Ozt3QkFDRixVQUFVOzs7O0FBRTlCLElBQU0sY0FBYyxHQUFHO0FBQ3JCLFFBQU0sRUFBRSxDQUFDO0FBQ1QsY0FBWSxFQUFFLENBQUM7Q0FDaEIsQ0FBQztBQUNGLElBQU0sa0JBQWtCLEdBQUcsRUFBRSxDQUFDO0FBQzlCLElBQU0sb0JBQW9CLEdBQUcsS0FBSyxDQUFDOztJQUc3QixjQUFjO1lBQWQsY0FBYzs7Ozs7Ozs7Ozs7OztBQVdOLFdBWFIsY0FBYyxHQVdNO1FBQVgsSUFBSSx5REFBRyxFQUFFOzswQkFYbEIsY0FBYzs7QUFZaEIsK0JBWkUsY0FBYyw2Q0FZUjs7UUFFSCxRQUFRLEdBQ00sSUFBSSxDQURsQixRQUFRO1FBQUUsZUFBZSxHQUNYLElBQUksQ0FEUixlQUFlO1FBQUUsWUFBWSxHQUN6QixJQUFJLENBRFMsWUFBWTtRQUFFLFlBQVksR0FDdkMsSUFBSSxDQUR1QixZQUFZO1FBQUUsVUFBVSxHQUNuRCxJQUFJLENBRHFDLFVBQVU7UUFDakUsSUFBSSxHQUFVLElBQUksQ0FBbEIsSUFBSTtRQUFFLElBQUksR0FBSSxJQUFJLENBQVosSUFBSTs7QUFFZixRQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztBQUN6QixRQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztBQUN2QyxRQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksSUFBSSxjQUFjLENBQUMsWUFBWSxDQUFDO0FBQ2hFLFFBQUksSUFBSSxDQUFDLFlBQVksS0FBSyxjQUFjLENBQUMsWUFBWSxFQUFFO0FBQ3JELFVBQUksQ0FBQyxZQUFZLEdB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LEtBQUssbUNBQWlDLE9BQU8sR0FBRyxRQUFLLENBQUM7U0FDakU7O0FBRUQsVUFBSSxHQUFHLENBQUMsTUFBTSxJQUFJLEdBQUcsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFOztBQUVsQyxZQUFJLE9BQU8sR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDO0FBQzdDLGNBQU0sSUFBSSwrQkFBTyxlQUFlLENBQUksT0FBTyxrQkFBYSxHQUFHLENBQUMsTUFBTSxPQUFJLENBQUM7T0FDeEU7Ozs7QUFJRCxhQUFPLEdBQUcsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLEdBQUcsR0FBRyxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUM7S0FDdEQ7OztXQUVrQztVQUFDLEtBQUsseURBQUcsSUFBSTs7OztBQUM5QyxnQkFBSSxDQUFDLFNBQVMsQ0FBQyw0QkFBNEIsQ0FBQyxLQUFLLENBQUMsQ0FBQzs7Ozs7OztLQUNwRDs7O1NBeGNHLGNBQWM7R0FBUyxvQkFBTyxZQUFZOztBQTRjaEQsY0FBYyxDQUFDLGlCQUFpQixHQUFHLDZCQUE2QixDQUFDO0FBQ2pFLGNBQWMsQ0FBQyxnQkFBZ0IsR0FBRyw0QkFBNEIsQ0FBQzs7Ozs7Ozs7QUFHL0QscUNBQTRCLG9CQUFFLE9BQU8sOEJBQWlCLGlIQUFFOzs7UUFBOUMsS0FBSTtRQUFFLE9BQU87O0FBQ3JCLGtCQUFjLENBQUMsU0FBUyxDQUFDLEtBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQztHQUMxQzs7Ozs7Ozs7Ozs7Ozs7OztRQUVRLGNBQWMsR0FBZCxjQUFjO1FBQUUsY0FBYyxHQUFkLGNBQWM7UUFBRSxvQkFBb0IsR0FBcEIsb0JBQW9CIiwiZmlsZSI6ImxpYi9yZW1vdGUtZGVidWdnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB0cmFuc3BpbGU6bWFpblxuXG5pbXBvcnQgZXZlbnRzIGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ21vYmlsZS1qc29uLXdpcmUtcHJvdG9jb2wnO1xuaW1wb3J0IFJlbW90ZURlYnVnZ2VyUnBjQ2xpZW50IGZyb20gJy4vcmVtb3RlLWRlYnVnZ2VyLXJwYy1jbGllbnQnO1xuaW1wb3J0IG1lc3NhZ2VIYW5kbGVycyBmcm9tICcuL21lc3NhZ2UtaGFuZGxlcnMnO1xuaW1wb3J0IHsgYXBwSW5mb0Zyb21EaWN0LCBwYWdlQXJyYXlGcm9tRGljdCwgZ2V0RGVidWdnZXJBcHBLZXksIGdldFBvc3NpYmxlRGVidWdnZXJBcHBLZXlzLCBjaGVja1BhcmFtcyxcbiAgICAgICAgIGdldFNjcmlwdEZvckF0b20gfSBmcm9tICcuL2hlbHBlcnMnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5cbmNvbnN0IERFQlVHR0VSX1RZUEVTID0ge1xuICB3ZWJraXQ6IDEsXG4gIHdlYmluc3BlY3RvcjogMlxufTtcbmNvbnN0IFNFTEVDVF9BUFBfUkVUUklFUyA9IDIwO1xuY29uc3QgUkVNT1RFX0RFQlVHR0VSX1BPUlQgPSAyNzc1MztcblxuXG5jbGFzcyBSZW1vdGVEZWJ1Z2dlciBleHRlbmRzIGV2ZW50cy5FdmVudEVtaXR0ZXIge1xuICAvKlxuICAgKiBUaGUgY29uc3RydWN0b3IgdGFrZXMgYW4gb3B0cyBoYXNoIHdpdGggdGhlIGZvbGxvd2luZyBwcm9wZXJ0aWVzOlxuICAgKiAgIC0gYnVuZGxlSWQgLSBpZCBvZiB0aGUgYXBwIGJlaW5nIGNvbm5lY3RlZCB0b1xuICAgKiAgIC0gcGxhdGZvcm1WZXJzaW9uIC0gdmVyc2lvbiBvZiBpT1NcbiAgICogICAtIGRlYnVnZ2VyVHlwZSAtIG9uZSBvZiB0aGUgREVCVUdHRVJfVFlQRVNcbiAgICogICAtIHVzZU5ld1NhZmFyaSAtIGZvciB3ZWIgaW5zcGVjdG9yLCB3aGV0aGVyIHRoaXMgaXMgYSBuZXcgU2FmYXJpIGluc3RhbmNlXG4gICAqICAgLSBwYWdlTG9hZE1zIC0gdGhlIHRpbWUsIGluIG1zLCB0aGF0IHNob3VsZCBiZSB3YWl0ZWQgZm9yIHBhZ2UgbG9hZGluZ1xuICAgKiAgIC0gaG9zdCAtIHRoZSByZW1vdGUgZGVidWdnZXIncyBob3N0IGFkZHJlc3NcbiAgICogICAtIHBvcnQgLSB0aGUgcmVtb3RlIGRlYnVnZ2VyIHBvcnQgdGhyb3VnaCB3aGljaCB0byBjb21tdW5pY2F0ZVxuICAgKi9cbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIHN1cGVyKCk7XG5cbiAgICBsZXQge2J1bmRsZUlkLCBwbGF0Zm9ybVZlcnNpb24sIGRlYnVnZ2VyVHlwZSwgdXNlTmV3U2FmYXJpLCBwYWdlTG9hZE1zLFxuICAgICAgICAgaG9zdCwgcG9ydH0gPSBvcHRzO1xuXG4gICAgdGhpcy5idW5kbGVJZCA9IGJ1bmRsZUlkO1xuICAgIHRoaXMucGxhdGZvcm1WZXJzaW9uID0gcGxhdGZvcm1WZXJzaW9uO1xuICAgIHRoaXMuZGVidWdnZXJUeXBlID0gZGVidWdnZXJUeXBlIHx8IERFQlVHR0VSX1RZUEVTLndlYmluc3BlY3RvcjtcbiAgICBpZiAodGhpcy5kZWJ1Z2dlclR5cGUgPT09IERFQlVHR0VSX1RZUEVTLndlYmluc3BlY3Rvcikge1xuICAgICAgdGhpcy51c2VOZXdTYWZhcmkgPSB1c2VOZXdTYWZhcmkgfHwgZmFsc2U7XG4gICAgICB0aGlzLnBhZ2VMb2FkTXMgPSBwYWdlTG9hZE1zO1xuICAgICAgbG9nLmRlYnVnKGB1c2VOZXdTYWZhcmkgLS0+ICR7dGhpcy51c2VOZXdTYWZhcml9YCk7XG4gICAgfVxuXG4gICAgLy8gYXBwIGhhbmRsaW5nIGNvbmZpZ3VyYXRpb25cbiAgICB0aGlzLmFwcERpY3QgPSB7fTtcbiAgICB0aGlzLmFwcElkS2V5ID0gbnVsbDtcbiAgICB0aGlzLnBhZ2VJZEtleSA9IG51bGw7XG4gICAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuXG4gICAgLy8gc2V0IHVwIHRoZSBzcGVjaWFsIGNhbGxiYWNrcyBmb3IgaGFuZGxpbmcgcmQgZXZlbnRzXG4gICAgdGhpcy5zcGVjaWFsQ2JzID0ge1xuICAgICAgJ19ycGNfcmVwb3J0SWRlbnRpZmllcjonOiBfLm5vb3AsXG4gICAgICAnX3JwY19mb3J3YXJkR2V0TGlzdGluZzonOiBfLm5vb3AsXG4gICAgICAnX3JwY19yZXBvcnRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3Q6JzogXy5ub29wLFxuICAgICAgJ19ycGNfYXBwbGljYXRpb25Db25uZWN0ZWQ6JzogdGhpcy5vbkFwcENvbm5lY3QuYmluZCh0aGlzKSxcbiAgICAgICdfcnBjX2FwcGxpY2F0aW9uRGlzY29ubmVjdGVkOic6IHRoaXMub25BcHBEaXNjb25uZWN0LmJpbmQodGhpcyksXG4gICAgfTtcblxuICAgIHRoaXMuaG9zdCA9IGhvc3QgfHwgJ2xvY2FsaG9zdCc7XG4gICAgdGhpcy5wb3J0ID0gcG9ydCB8fCBSRU1PVEVfREVCVUdHRVJfUE9SVDtcbiAgICB0aGlzLnJwY0NsaWVudCA9IG51bGw7XG4gIH1cblxuICBhc3luYyBjb25uZWN0ICgpIHtcbiAgICAvLyBpbml0aWFsaXplIHRoZSBycGMgY2xpZW50IGZvclxuICAgIHRoaXMucnBjQ2xpZW50ID0gbmV3IFJlbW90ZURlYnVnZ2VyUnBjQ2xpZW50KHRoaXMuaG9zdCwgdGhpcy5wb3J0LCB0aGlzLnNwZWNpYWxDYnMpO1xuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LmNvbm5lY3QoKTtcblxuICAgIC8vIGdldCB0aGUgY29ubmVjdGlvbiBpbmZvcm1hdGlvbiBhYm91dCB0aGUgYXBwXG4gICAgdHJ5IHtcbiAgICAgIGxldCBhcHBJbmZvID0gYXdhaXQgdGhpcy5zZXRDb25uZWN0aW9uS2V5KCk7XG4gICAgICBsb2cuZGVidWcoJ0Nvbm5lY3RlZCB0byBhcHBsaWNhdGlvbicpO1xuICAgICAgcmV0dXJuIGFwcEluZm87XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBhd2FpdCB0aGlzLmRpc2Nvbm5lY3QoKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRpc2Nvbm5lY3QgKCkge1xuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LmRpc2Nvbm5lY3QoKTtcbiAgICB0aGlzLmVtaXQoUmVtb3RlRGVidWdnZXIuRVZFTlRfRElTQ09OTkVDVCwgdHJ1ZSk7XG4gIH1cblxuICBpc0Nvbm5lY3RlZCAoKSB7XG4gICAgcmV0dXJuICEhKHRoaXMucnBjQ2xpZW50ICYmIHRoaXMucnBjQ2xpZW50LmlzQ29ubmVjdGVkKCkpO1xuICB9XG5cbiAgbG9nQXBwbGljYXRpb25EaWN0aW9uYXJ5IChhcHBzKSB7XG4gICAgZm9yIChsZXQgW2FwcCwgaW5mb10gb2YgXy50b1BhaXJzKGFwcHMpKSB7XG4gICAgICBsb2cuZGVidWcoYEFwcGxpY2F0aW9uOiAnJHthcHB9J2ApO1xuICAgICAgZm9yIChsZXQgW2tleSwgdmFsdWVdIG9mIF8udG9QYWlycyhpbmZvKSkge1xuICAgICAgICBsb2cuZGVidWcoYCAgICAke2tleX06ICcke3ZhbHVlfSdgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBzZXRDb25uZWN0aW9uS2V5ICgpIHtcbiAgICAvLyBvbmx5IHJlc29sdmUgd2hlbiB0aGUgY29ubmVjdGlvbiByZXNwb25zZSBpcyByZWNlaXZlZFxuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyBsb2NhbCBjYWxsYmFjaywgY2FsbGVkIHdoZW4gdGhlIHJlbW90ZSBkZWJ1Z2dlciBoYXMgZXN0YWJsaXNoZWRcbiAgICAgIC8vIGEgY29ubmVjdGlvbiB0byB0aGUgYXBwIHVuZGVyIHRlc3RcbiAgICAgIC8vIGBhcHBgIHdpbGwgYmUgYW4gYXJyYXkgb2YgZGljdGlvbmFyaWVzIG9mIGFwcCBpbmZvcm1hdGlvblxuICAgICAgbGV0IGNvbm5lY3RDYiA9IChhcHBzKSA9PiB7XG4gICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKGFwcHMpIHx8IF8ua2V5cyhhcHBzKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBsZXQgbXNnID0gJ1JlY2VpdmVkIG5vIGFwcHMgZnJvbSByZW1vdGUgZGVidWdnZXIuIFVuYWJsZSB0byBjb25uZWN0Lic7XG4gICAgICAgICAgbG9nLmRlYnVnKG1zZyk7XG4gICAgICAgICAgcmV0dXJuIHJlc29sdmUodGhpcy5hcHBEaWN0KTtcbiAgICAgICAgfVxuICAgICAgICBsZXQgbmV3RGljdCA9IHt9O1xuXG4gICAgICAgIC8vIHRyYW5zbGF0ZSB0aGUgcmVjZWl2ZWQgaW5mb3JtYXRpb24gaW50byBhbiBlYXNpZXItdG8tbWFuYWdlXG4gICAgICAgIC8vIGhhc2ggd2l0aCBhcHAgaWQgYXMga2V5LCBhbmQgYXBwIGluZm8gYXMgdmFsdWVcbiAgICAgICAgZm9yIChsZXQgZGljdCBvZiBfLnZhbHVlcyhhcHBzKSkge1xuICAgICAgICAgIGxldCBbaWQsIGVudHJ5XSA9IGFwcEluZm9Gcm9tRGljdChkaWN0KTtcbiAgICAgICAgICBuZXdEaWN0W2lkXSA9IGVudHJ5O1xuICAgICAgICB9XG4gICAgICAgIC8vIHVwZGF0ZSB0aGUgb2JqZWN0J3MgbGlzdCBvZiBhcHBzLCBhbmQgcmV0dXJuIGl0IHRocm91Z2ggdGhlIHByb21pc2VcbiAgICAgICAgXy5kZWZhdWx0cyh0aGlzLmFwcERpY3QsIG5ld0RpY3QpO1xuICAgICAgICByZXNvbHZlKG5ld0RpY3QpO1xuICAgICAgfTtcbiAgICAgIHRoaXMucnBjQ2xpZW50LnNldFNwZWNpYWxNZXNzYWdlSGFuZGxlcignX3JwY19yZXBvcnRDb25uZWN0ZWRBcHBsaWNhdGlvbkxpc3Q6JywgcmVqZWN0LCBjb25uZWN0Q2IpO1xuXG4gICAgICBsb2cuZGVidWcoJ1NlbmRpbmcgY29ubmVjdGlvbiBrZXkgcmVxdWVzdCcpO1xuICAgICAgbGV0IFtzaW1OYW1lS2V5LCBzaW1CdWlsZEtleSwgc2ltUGxhdGZvcm1WZXJzaW9uXSA9IGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ3NldENvbm5lY3Rpb25LZXknKTtcbiAgICAgIGxvZy5kZWJ1ZyhgU2ltIG5hbWU6ICR7c2ltTmFtZUtleX1gKTtcbiAgICAgIGxvZy5kZWJ1ZyhgU2ltIGJ1aWxkOiAke3NpbUJ1aWxkS2V5fWApO1xuICAgICAgbG9nLmRlYnVnKGBTaW0gcGxhdGZvcm0gdmVyc2lvbjogJHtzaW1QbGF0Zm9ybVZlcnNpb259YCk7XG4gICAgfSk7XG4gIH1cblxuICB1cGRhdGVBcHBzV2l0aERpY3QgKGRpY3QpIHtcbiAgICAvLyBnZXQgdGhlIGRpY3Rpb25hcnkgZW50cnkgaW50byBhIG5pY2UgZm9ybSwgYW5kIGFkZCBpdCB0byB0aGVcbiAgICAvLyBhcHBsaWNhdGlvbiBkaWN0aW9uYXJ5XG4gICAgdGhpcy5hcHBEaWN0ID0gdGhpcy5hcHBEaWN0IHx8IHt9O1xuICAgIGxldCBbaWQsIGVudHJ5XSA9IGFwcEluZm9Gcm9tRGljdChkaWN0KTtcbiAgICB0aGlzLmFwcERpY3RbaWRdID0gZW50cnk7XG5cbiAgICBsb2cuZGVidWcoJ0N1cnJlbnQgYXBwbGljYXRpb25zIGF2YWlsYWJsZTonKTtcbiAgICB0aGlzLmxvZ0FwcGxpY2F0aW9uRGljdGlvbmFyeSh0aGlzLmFwcERpY3QpO1xuXG4gICAgLy8gdHJ5IHRvIGdldCB0aGUgYXBwIGlkIGZyb20gb3VyIGNvbm5lY3RlZCBhcHBzXG4gICAgdGhpcy5hcHBJZEtleSA9IGdldERlYnVnZ2VyQXBwS2V5KHRoaXMuYnVuZGxlSWQsIHRoaXMucGxhdGZvcm1WZXJzaW9uLCB0aGlzLmFwcERpY3QpO1xuICB9XG5cbiAgYXN5bmMgc2VsZWN0QXBwIChjdXJyZW50VXJsID0gbnVsbCwgbWF4VHJpZXMgPSBTRUxFQ1RfQVBQX1JFVFJJRVMpIHtcbiAgICBsb2cuZGVidWcoJ1NlbGVjdGluZyBhcHBsaWNhdGlvbicpO1xuICAgIGlmICghdGhpcy5hcHBEaWN0IHx8IF8ua2V5cyh0aGlzLmFwcERpY3QpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgbG9nLmRlYnVnKCdObyBhcHBsaWNhdGlvbnMgY3VycmVudGx5IGNvbm5lY3RlZC4nKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICAvLyBpdGVyYXRpdmUgc29sdXRpb24sIGFzIHJlY3Vyc2lvbiB3YXMgc3dhbGxvd2luZyB0aGUgcHJvbWlzZSBhdCBzb21lIHBvaW50XG4gICAgbGV0IHBhZ2VEaWN0LCBhcHBJZEtleTtcbiAgICBsZXQgZG9uZSA9IGZhbHNlO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWF4VHJpZXM7IGkrKykge1xuICAgICAgaWYgKGRvbmUpIGJyZWFrO1xuXG4gICAgICBsZXQgcG9zc2libGVBcHBJZHMgPSBnZXRQb3NzaWJsZURlYnVnZ2VyQXBwS2V5cyh0aGlzLmJ1bmRsZUlkLCB0aGlzLnBsYXRmb3JtVmVyc2lvbiwgdGhpcy5hcHBEaWN0KTtcbiAgICAgIGxvZy5kZWJ1ZyhgVHJ5aW5nIG91dCB0aGUgcG9zc2libGUgYXBwIGlkczogJHtwb3NzaWJsZUFwcElkcy5qb2luKCcsICcpfWApO1xuICAgICAgZm9yIChsZXQgYXR0ZW1wdGVkQXBwSWRLZXkgb2YgcG9zc2libGVBcHBJZHMpIHtcbiAgICAgICAgaWYgKGRvbmUpIGJyZWFrO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBTZWxlY3RpbmcgYXBwICR7YXR0ZW1wdGVkQXBwSWRLZXl9ICh0cnkgIyR7aSsxfSBvZiAke21heFRyaWVzfSlgKTtcbiAgICAgICAgICBbYXBwSWRLZXksIHBhZ2VEaWN0XSA9IGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbGVjdEFwcChhdHRlbXB0ZWRBcHBJZEtleSwgdGhpcy5vbkFwcENvbm5lY3QuYmluZCh0aGlzKSk7XG5cbiAgICAgICAgICAvLyBpbiBpT1MgOC4yIHRoZSBjb25uZWN0IGxvZ2ljIGhhcHBlbnMsIGJ1dCB3aXRoIGFuIGVtcHR5IGRpY3Rpb25hcnlcbiAgICAgICAgICAvLyB3aGljaCBsZWFkcyB0byB0aGUgcmVtb3RlIGRlYnVnZ2VyIGdldHRpbmcgZGlzY29ubmVjdGVkLCBhbmQgaW50byBhIGxvb3BcbiAgICAgICAgICBpZiAoXy5pc0VtcHR5KHBhZ2VEaWN0KSkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKCdFbXB0eSBwYWdlIGRpY3Rpb25hcnkgcmVjZWl2ZWQuIFRyeWluZyBhZ2Fpbi4nKTtcbiAgICAgICAgICAgIC8vIHRoaXMuYXBwSWRLZXkgPSBhcHBJZEtleTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIGlmIHdlIGFyZSBsb29raW5nIGZvciBhIHBhcnRpY3VsYXIgdXJsLCBtYWtlIHN1cmUgdGhpcyBpcyB0aGUgcmlnaHQgcGFnZVxuICAgICAgICAgIGlmIChjdXJyZW50VXJsKSB7XG4gICAgICAgICAgICBsZXQgZm91bmQ7XG4gICAgICAgICAgICBfLmVhY2gocGFnZURpY3QsIChyZWNvcmQpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHJlY29yZC5XSVJVUkxLZXkgPT09IGN1cnJlbnRVcmwpIHtcbiAgICAgICAgICAgICAgICAvLyB0aGlzIGlzIHRoZSBwYWdlIHdlIHdhbnRcbiAgICAgICAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoIWZvdW5kKSB7XG4gICAgICAgICAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgYXBwLCBidXQgZXhwZWN0ZWQgdXJsICgnJHtjdXJyZW50VXJsfScpIHdhcyBub3QgZm91bmQuIFRyeWluZyBhZ2Fpbi5gKTtcbiAgICAgICAgICAgICAgLy8gdGhpcy5hcHBJZEtleSA9IGFwcElkS2V5O1xuICAgICAgICAgICAgICBwYWdlRGljdCA9IG51bGw7XG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIHdlIGhhdmUgZ290dGVuIHRoZSBjb3JyZWN0IGFwcGxpY2F0aW9uIGJ5IHRoaXMgcG9pbnQsIHNvIHNob3J0IGNpcmN1aXQgZXZlcnl0aGluZ1xuICAgICAgICAgIGRvbmUgPSB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYFJldHJ5aW5nIGNvbm5lY3Rpb25gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGlmLCBhZnRlciBhbGwgdGhpcywgd2UgaGF2ZSBubyBkaWN0aW9uYXJ5LCB3ZSBoYXZlIGZhaWxlZFxuICAgIGlmICghcGFnZURpY3QpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgY29ubmVjdCB0byBhIHZhbGlkIGFwcCBhZnRlciAke21heFRyaWVzfSB0cmllcy5gKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5hcHBJZEtleSAhPT0gYXBwSWRLZXkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgYWx0ZXJlZCBhcHAgaWQsIHVwZGF0aW5nIGZyb20gJyR7dGhpcy5hcHBJZEtleX0nIHRvICcke2FwcElkS2V5fSdgKTtcbiAgICAgIHRoaXMuYXBwSWRLZXkgPSBhcHBJZEtleTtcbiAgICB9XG5cbiAgICAvLyBzZXQgdGhlIGNhbGxiYWNrIGZvciBnZXR0aW5nIGEgbGlzdGluZyB0byB0aGUgcGFnZSBjaGFuZ2UgY2FsbGJhY2tcbiAgICB0aGlzLnJwY0NsaWVudC5zZXRTcGVjaWFsTWVzc2FnZUhhbmRsZXIoJ19ycGNfZm9yd2FyZEdldExpc3Rpbmc6JywgbnVsbCxcbiAgICAgICAgICAgdGhpcy5vblBhZ2VDaGFuZ2UuYmluZCh0aGlzKSk7XG5cbiAgICAvLyB0cmFuc2xhdGUgdGhlIGRpY3Rpb25hcnkgaW50byBhIHVzZWZ1bCBmb3JtLCBhbmQgcmV0dXJuIHRvIHNlbmRlclxuICAgIGxldCBwYWdlQXJyYXkgPSBwYWdlQXJyYXlGcm9tRGljdChwYWdlRGljdCk7XG4gICAgbG9nLmRlYnVnKGBTZWxlY3RpbmcgYXBwICR7dGhpcy5hcHBJZEtleX06ICR7SlNPTi5zdHJpbmdpZnkocGFnZUFycmF5KX1gKTtcbiAgICByZXR1cm4gcGFnZUFycmF5O1xuICB9XG5cbiAgYXN5bmMgc2VsZWN0UGFnZSAocGFnZUlkS2V5LCBza2lwUmVhZHlDaGVjayA9IGZhbHNlKSB7XG4gICAgbGV0IGVycm9ycyA9IGNoZWNrUGFyYW1zKHthcHBJZEtleTogdGhpcy5hcHBJZEtleX0pO1xuICAgIGlmIChlcnJvcnMpIHRocm93IG5ldyBFcnJvcihlcnJvcnMpO1xuXG4gICAgdGhpcy5wYWdlSWRLZXkgPSBwYWdlSWRLZXk7XG5cbiAgICBsb2cuZGVidWcoYFNlbGVjdGluZyBwYWdlICR7cGFnZUlkS2V5fSBhbmQgZm9yd2FyZGluZyBzb2NrZXQgc2V0dXBgKTtcblxuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ3NldFNlbmRlcktleScsIHtcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleVxuICAgIH0pO1xuICAgIGxvZy5kZWJ1ZygnU2VuZGVyIGtleSBzZXQnKTtcblxuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ2VuYWJsZVBhZ2UnLCB7XG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgICBkZWJ1Z2dlclR5cGU6IHRoaXMuZGVidWdnZXJUeXBlXG4gICAgfSk7XG4gICAgbG9nLmRlYnVnKCdFbmFibGVkIGFjdGl2aXR5IG9uIHBhZ2UnKTtcblxuICAgIC8vIG1ha2Ugc3VyZSBldmVyeXRoaW5nIGlzIHJlYWR5IHRvIGdvXG4gICAgbGV0IHJlYWR5ID0gYXdhaXQgdGhpcy5jaGVja1BhZ2VJc1JlYWR5KCk7XG4gICAgaWYgKCFza2lwUmVhZHlDaGVjayAmJiAhcmVhZHkpIHtcbiAgICAgIGF3YWl0IHRoaXMucGFnZVVubG9hZCgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVBdG9tIChhdG9tLCBhcmdzLCBmcmFtZXMpIHtcbiAgICBpZiAoIXRoaXMucnBjQ2xpZW50LmNvbm5lY3RlZCkgdGhyb3cgbmV3IEVycm9yKCdSZW1vdGUgZGVidWdnZXIgaXMgbm90IGNvbm5lY3RlZCcpO1xuXG4gICAgbGV0IHNjcmlwdCA9IGdldFNjcmlwdEZvckF0b20oYXRvbSwgYXJncywgZnJhbWVzKTtcblxuICAgIGxldCB2YWx1ZSA9IGF3YWl0IHRoaXMuZXhlY3V0ZShzY3JpcHQsIHRydWUpO1xuICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgcmVzdWx0IGZvciBhdG9tICcke2F0b219JyBleGVjdXRpb246ICR7SlNPTi5zdHJpbmdpZnkodmFsdWUpfWApO1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIGFzeW5jIGV4ZWN1dGVBdG9tQXN5bmMgKGF0b20sIGFyZ3MsIGZyYW1lcywgcmVzcG9uc2VVcmwpIHtcbiAgICBsZXQgYXN5bmNDYWxsQmFjayA9IGBmdW5jdGlvbiAocmVzKSB7IHhtbEh0dHAgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgeG1sSHR0cC5vcGVuKCdQT1NUJywgJyR7cmVzcG9uc2VVcmx9JywgdHJ1ZSk7YCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgeG1sSHR0cC5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LXR5cGUnLCdhcHBsaWNhdGlvbi9qc29uJyk7IGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgYHhtbEh0dHAuc2VuZChyZXMpOyB9YDtcbiAgICBsZXQgc2NyaXB0ID0gZ2V0U2NyaXB0Rm9yQXRvbShhdG9tLCBhcmdzLCBmcmFtZXMsIGFzeW5jQ2FsbEJhY2spO1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZShzY3JpcHQpO1xuICB9XG5cbiAgYXN5bmMgcGFnZUxvYWQgKHN0YXJ0UGFnZUxvYWRNcykge1xuICAgIGxldCB0aW1lb3V0TXMgPSA1MDA7XG4gICAgbGV0IHN0YXJ0ID0gc3RhcnRQYWdlTG9hZE1zIHx8IERhdGUubm93KCk7XG4gICAgbG9nLmRlYnVnKCdQYWdlIGxvYWRlZCwgdmVyaWZ5aW5nIHdoZXRoZXIgcmVhZHknKTtcblxuICAgIGxldCB2ZXJpZnkgPSBhc3luYyAoKSA9PiB7XG4gICAgICB0aGlzLnBhZ2VMb2FkRGVsYXkgPSB1dGlsLmNhbmNlbGxhYmxlRGVsYXkodGltZW91dE1zKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucGFnZUxvYWREZWxheTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgUHJvbWlzZS5DYW5jZWxsYXRpb25FcnJvcikge1xuICAgICAgICAgIC8vIGlmIHRoZSBwcm9taXNlIGhhcyBiZWVuIGNhbmNlbGxlZFxuICAgICAgICAgIC8vIHdlIHdhbnQgdG8gc2tpcCBjaGVja2luZyB0aGUgcmVhZGluZXNzXG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGxldCByZWFkeSA9IGF3YWl0IHRoaXMuY2hlY2tQYWdlSXNSZWFkeSgpO1xuICAgICAgLy8gaWYgd2UgYXJlIHJlYWR5LCBvciB3ZSd2ZSBzcGVuZCB0b28gbXVjaCB0aW1lIG9uIHRoaXNcbiAgICAgIGlmIChyZWFkeSB8fCAodGhpcy5wYWdlTG9hZE1zID4gMCAmJiAoc3RhcnQgKyB0aGlzLnBhZ2VMb2FkTXMpIDwgRGF0ZS5ub3coKSkpIHtcbiAgICAgICAgbG9nLmRlYnVnKCdQYWdlIGlzIHJlYWR5Jyk7XG4gICAgICAgIHRoaXMucGFnZUxvYWRpbmcgPSBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5kZWJ1ZygnUGFnZSB3YXMgbm90IHJlYWR5LCByZXRyeWluZycpO1xuICAgICAgICBhd2FpdCB2ZXJpZnkoKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIGF3YWl0IHZlcmlmeSgpO1xuICB9XG5cbiAgYXN5bmMgY2FuY2VsUGFnZUxvYWQgKCkge1xuICAgIGxvZy5kZWJ1ZygnVW5yZWdpc3RlcmluZyBmcm9tIHBhZ2UgcmVhZGluZXNzIG5vdGlmaWNhdGlvbnMnKTtcbiAgICB0aGlzLnBhZ2VMb2FkaW5nID0gZmFsc2U7XG4gICAgaWYgKHRoaXMucGFnZUxvYWREZWxheSkge1xuICAgICAgdGhpcy5wYWdlTG9hZERlbGF5LmNhbmNlbCgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHBhZ2VVbmxvYWQgKCkge1xuICAgIGxvZy5kZWJ1ZygnUGFnZSB1bmxvYWRpbmcnKTtcbiAgICB0aGlzLnBhZ2VMb2FkaW5nID0gdHJ1ZTtcbiAgICBhd2FpdCB0aGlzLndhaXRGb3JEb20oKTtcbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JEb20gKHN0YXJ0UGFnZUxvYWRNcykge1xuICAgIGxvZy5kZWJ1ZygnV2FpdGluZyBmb3IgZG9tLi4uJyk7XG4gICAgYXdhaXQgdGhpcy5wYWdlTG9hZChzdGFydFBhZ2VMb2FkTXMpO1xuICB9XG5cbiAgYXN5bmMgY2hlY2tQYWdlSXNSZWFkeSAoKSB7XG4gICAgbG9nLmRlYnVnKCdDaGVja2luZyBkb2N1bWVudCByZWFkeVN0YXRlJyk7XG4gICAgbGV0IHJlYWR5Q21kID0gJyhmdW5jdGlvbiAoKXsgcmV0dXJuIGRvY3VtZW50LnJlYWR5U3RhdGU7IH0pKCknO1xuICAgIGxldCByZWFkeVN0YXRlID0gYXdhaXQgdGhpcy5leGVjdXRlKHJlYWR5Q21kLCB0cnVlKTtcbiAgICBsb2cuZGVidWcoYHJlYWR5U3RhdGUgd2FzICR7SlNPTi5zdHJpbmdpZnkocmVhZHlTdGF0ZSl9YCk7XG5cbiAgICByZXR1cm4gcmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJztcbiAgfVxuXG4gIGFzeW5jIG5hdlRvVXJsICh1cmwpIHtcbiAgICAvLyBubyBuZWVkIHRvIGRvIHRoaXMgY2hlY2sgd2hlbiB1c2luZyB3ZWJraXRcbiAgICBpZiAodGhpcy5kZWJ1Z2dlclR5cGUgPT09IERFQlVHR0VSX1RZUEVTLndlYmluc3BlY3Rvcikge1xuICAgICAgbGV0IGVycm9ycyA9IGNoZWNrUGFyYW1zKHthcHBJZEtleTogdGhpcy5hcHBJZEtleSwgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleX0pO1xuICAgICAgaWYgKGVycm9ycykgdGhyb3cgbmV3IEVycm9yKGVycm9ycyk7XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBOYXZpZ2F0aW5nIHRvIG5ldyBVUkw6ICR7dXJsfWApO1xuICAgIGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ3NldFVybCcsIHtcbiAgICAgIHVybDogdXJsLFxuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgICAgZGVidWdnZXJUeXBlOiB0aGlzLmRlYnVnZ2VyVHlwZVxuICAgIH0pO1xuXG4gICAgaWYgKCF0aGlzLnVzZU5ld1NhZmFyaSkge1xuICAgICAgLy8gYSBzbWFsbCBwYXVzZSBmb3IgdGhlIGJyb3dzZXIgdG8gY2F0Y2ggdXBcbiAgICAgIGF3YWl0IFByb21pc2UuZGVsYXkoMTAwMCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZGVidWdnZXJUeXBlID09PSBERUJVR0dFUl9UWVBFUy53ZWJpbnNwZWN0b3IpIHtcbiAgICAgIGF3YWl0IHRoaXMud2FpdEZvckZyYW1lTmF2aWdhdGVkKCk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMud2FpdEZvckRvbShEYXRlLm5vdygpKTtcbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JGcmFtZU5hdmlnYXRlZCAoKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGxvZy5kZWJ1ZygnV2FpdGluZyBmb3IgZnJhbWUgbmF2aWdhdGVkIG1lc3NhZ2UuLi4nKTtcbiAgICAgIHZhciBzdGFydE1zID0gRGF0ZS5ub3coKTtcblxuICAgICAgLy8gYWRkIGEgaGFuZGxlciBmb3IgdGhlIGBQYWdlLmZyYW1lTmF2aWdhdGVkYCBtZXNzYWdlXG4gICAgICAvLyBmcm9tIHRoZSByZW1vdGUgZGVidWdnZXJcbiAgICAgIGxldCBuYXZFdmVudExpc3RlbmVyID0gKHZhbHVlKSA9PiB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgRnJhbWUgbmF2aWdhdGVkIGluICR7KChEYXRlLm5vdygpIC0gc3RhcnRNcykvMTAwMCl9IHNlYyBmcm9tIHNvdXJjZTogJHt2YWx1ZX1gKTtcbiAgICAgICAgaWYgKHRoaXMubmF2aWdhdGlvbkRlbGF5KSB7XG4gICAgICAgICAgdGhpcy5uYXZpZ2F0aW9uRGVsYXkuY2FuY2VsKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICB9O1xuICAgICAgdGhpcy5ycGNDbGllbnQuc2V0U3BlY2lhbE1lc3NhZ2VIYW5kbGVyKCdQYWdlLmZyYW1lTmF2aWdhdGVkJywgcmVqZWN0LCBuYXZFdmVudExpc3RlbmVyKTtcblxuICAgICAgLy8gdGltZW91dCwgaW4gY2FzZSByZW1vdGUgZGVidWdnZXIgZG9lc24ndCByZXNwb25kLFxuICAgICAgLy8gb3IgdGFrZXMgYSBsb25nIHRpbWVcbiAgICAgIGlmICghdGhpcy51c2VOZXdTYWZhcmkgfHwgdGhpcy5wYWdlTG9hZE1zID49IDApIHtcbiAgICAgICAgLy8gdXNlIHBhZ2VMb2FkTXMsIG9yIGEgc21hbGwgYW1vdW50IG9mIHRpbWVcbiAgICAgICAgbGV0IHRpbWVvdXQgPSB0aGlzLnVzZU5ld1NhZmFyaSA/IHRoaXMucGFnZUxvYWRNcyA6IDUwMDtcbiAgICAgICAgdGhpcy5uYXZpZ2F0aW9uRGVsYXkgPSB1dGlsLmNhbmNlbGxhYmxlRGVsYXkodGltZW91dCk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5uYXZpZ2F0aW9uRGVsYXk7XG4gICAgICAgICAgbmF2RXZlbnRMaXN0ZW5lcigndGltZW91dCcpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAvLyBub3RoaW5nIHRvIGRvOiB3ZSBvbmx5IGdldCBoZXJlIGlmIHRoZSByZW1vdGUgZGVidWdnZXJcbiAgICAgICAgICAvLyBhbHJlYWR5IG5vdGlmaWVkIG9mIGZyYW1lIG5hdmlnYXRpb24sIGFuZCB0aGUgZGVsYXlcbiAgICAgICAgICAvLyB3YXMgY2FuY2VsbGVkXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0VGltZWxpbmUgKGZuKSB7XG4gICAgbG9nLmRlYnVnKCdTdGFydGluZyB0byByZWNvcmQgdGhlIHRpbWVsaW5lJyk7XG4gICAgdGhpcy5ycGNDbGllbnQuc2V0VGltZWxpbmVFdmVudEhhbmRsZXIoZm4pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdzdGFydFRpbWVsaW5lJywge1xuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgICAgZGVidWdnZXJUeXBlOiB0aGlzLmRlYnVnZ2VyVHlwZVxuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc3RvcFRpbWVsaW5lICgpIHtcbiAgICBsb2cuZGVidWcoJ1N0b3BwaW5nIHRvIHJlY29yZCB0aGUgdGltZWxpbmUnKTtcbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdzdG9wVGltZWxpbmUnLCB7XG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgICBkZWJ1Z2dlclR5cGU6IHRoaXMuZGVidWdnZXJUeXBlXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBleGVjdXRlIChjb21tYW5kLCBvdmVycmlkZSkge1xuICAgIC8vIGlmIHRoZSBwYWdlIGlzIG5vdCBsb2FkZWQgeWV0LCB3YWl0IGZvciBpdFxuICAgIGlmICh0aGlzLnBhZ2VMb2FkaW5nICYmICFvdmVycmlkZSkge1xuICAgICAgbG9nLmRlYnVnKCdUcnlpbmcgdG8gZXhlY3V0ZSBidXQgcGFnZSBpcyBub3QgbG9hZGVkLicpO1xuICAgICAgYXdhaXQgdGhpcy53YWl0Rm9yRG9tKCk7XG4gICAgfVxuXG4gICAgLy8gbm8gbmVlZCB0byBjaGVjayBlcnJvcnMgaWYgaXQgaXMgd2Via2l0XG4gICAgaWYgKHRoaXMuZGVidWdnZXJUeXBlID09PSBERUJVR0dFUl9UWVBFUy53ZWJpbnNwZWN0b3IpIHtcbiAgICAgIGxldCBlcnJvcnMgPSBjaGVja1BhcmFtcyh7YXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXl9KTtcbiAgICAgIGlmIChlcnJvcnMpIHRocm93IG5ldyBFcnJvcihlcnJvcnMpO1xuICAgIH1cblxuICAgIGxvZy5kZWJ1ZyhgU2VuZGluZyBqYXZhc2NyaXB0IGNvbW1hbmQgJHtfLnRydW5jYXRlKGNvbW1hbmQsIDUwKX1gKTtcbiAgICBsZXQgcmVzID0gYXdhaXQgdGhpcy5ycGNDbGllbnQuc2VuZCgnc2VuZEpTQ29tbWFuZCcsIHtcbiAgICAgIGNvbW1hbmQ6IGNvbW1hbmQsXG4gICAgICBhcHBJZEtleTogdGhpcy5hcHBJZEtleSxcbiAgICAgIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXksXG4gICAgICBkZWJ1Z2dlclR5cGU6IHRoaXMuZGVidWdnZXJUeXBlXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5jb252ZXJ0UmVzdWx0KHJlcyk7XG4gIH1cblxuICBhc3luYyBjYWxsRnVuY3Rpb24gKG9iaklkLCBmbiwgYXJncykge1xuICAgIGxldCBlcnJvcnMgPSBjaGVja1BhcmFtcyh7YXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksIHBhZ2VJZEtleTogdGhpcy5wYWdlSWRLZXl9KTtcbiAgICBpZiAoZXJyb3JzKSB0aHJvdyBuZXcgRXJyb3IoZXJyb3JzKTtcblxuICAgIGxvZy5kZWJ1ZygnQ2FsbGluZyBqYXZhc2NyaXB0IGZ1bmN0aW9uJyk7XG4gICAgbGV0IHJlcyA9IGF3YWl0IHRoaXMucnBjQ2xpZW50LnNlbmQoJ2NhbGxKU0Z1bmN0aW9uJywge1xuICAgICAgb2JqSWQ6IG9iaklkLFxuICAgICAgZm46IGZuLFxuICAgICAgYXJnczogYXJncyxcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICAgIGRlYnVnZ2VyVHlwZTogdGhpcy5kZWJ1Z2dlclR5cGVcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLmNvbnZlcnRSZXN1bHQocmVzKTtcbiAgfVxuXG4gIGNvbnZlcnRSZXN1bHQgKHJlcykge1xuICAgIGlmIChfLmlzVW5kZWZpbmVkKHJlcykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRGlkIG5vdCBnZXQgT0sgcmVzdWx0IGZyb20gcmVtb3RlIGRlYnVnZ2VyLiBSZXN1bHQgd2FzOiAke0pTT04uc3RyaW5naWZ5KHJlcyl9YCk7XG4gICAgfSBlbHNlIGlmIChfLmlzU3RyaW5nKHJlcykpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJlcyA9IEpTT04ucGFyc2UocmVzKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyB3ZSBtaWdodCBnZXQgYSBzZXJpYWxpemVkIG9iamVjdCwgYnV0IHdlIG1pZ2h0IG5vdFxuICAgICAgICAvLyBpZiB3ZSBnZXQgaGVyZSwgaXQgaXMganVzdCBhIHZhbHVlXG4gICAgICB9XG4gICAgfSBlbHNlIGlmICghXy5pc09iamVjdChyZXMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlc3VsdCBoYXMgdW5leHBlY3RlZCB0eXBlOiAoJHt0eXBlb2YgcmVzfSkuYCk7XG4gICAgfVxuXG4gICAgaWYgKHJlcy5zdGF0dXMgJiYgcmVzLnN0YXR1cyAhPT0gMCkge1xuICAgICAgLy8gd2UgZ290IHNvbWUgZm9ybSBvZiBlcnJvci5cbiAgICAgIGxldCBtZXNzYWdlID0gcmVzLnZhbHVlLm1lc3NhZ2UgfHwgcmVzLnZhbHVlO1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5KYXZhU2NyaXB0RXJyb3IoYCR7bWVzc2FnZX0gKHN0YXR1czogJHtyZXMuc3RhdHVzfSlgKTtcbiAgICB9XG5cbiAgICAvLyB3aXRoIGVpdGhlciBoYXZlIGFuIG9iamVjdCB3aXRoIGEgYHZhbHVlYCBwcm9wZXJ0eSAoZXZlbiBpZiBgbnVsbGApLFxuICAgIC8vIG9yIGEgcGxhaW4gb2JqZWN0XG4gICAgcmV0dXJuIHJlcy5oYXNPd25Qcm9wZXJ0eSgndmFsdWUnKSA/IHJlcy52YWx1ZSA6IHJlcztcbiAgfVxuXG4gIGFzeW5jIGFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgKGFsbG93ID0gdHJ1ZSkge1xuICAgIHRoaXMucnBjQ2xpZW50LmFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQoYWxsb3cpO1xuICB9XG59XG5cbi8vIGV2ZW50IGVtaXR0ZWQgcHVibGljYWxseVxuUmVtb3RlRGVidWdnZXIuRVZFTlRfUEFHRV9DSEFOR0UgPSAncmVtb3RlX2RlYnVnZ2VyX3BhZ2VfY2hhbmdlJztcblJlbW90ZURlYnVnZ2VyLkVWRU5UX0RJU0NPTk5FQ1QgPSAncmVtb3RlX2RlYnVnZ2VyX2Rpc2Nvbm5lY3QnO1xuXG4vLyBhZGQgZ2VuZXJpYyBjYWxsYmFja3NcbmZvciAobGV0IFtuYW1lLCBoYW5kbGVyXSBvZiBfLnRvUGFpcnMobWVzc2FnZUhhbmRsZXJzKSkge1xuICBSZW1vdGVEZWJ1Z2dlci5wcm90b3R5cGVbbmFtZV0gPSBoYW5kbGVyO1xufVxuXG5leHBvcnQgeyBSZW1vdGVEZWJ1Z2dlciwgREVCVUdHRVJfVFlQRVMsIFJFTU9URV9ERUJVR0dFUl9QT1JUIH07XG4iXX0=