'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumAtoms = require('appium-atoms');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

/*
 * Takes a dictionary from the remote debugger and makes a more manageable
 * dictionary whose keys are understandable
 */
function appInfoFromDict(dict) {
  var id = dict.WIRApplicationIdentifierKey;
  var isProxy = _lodash2['default'].isString(dict.WIRIsApplicationProxyKey) ? dict.WIRIsApplicationProxyKey.toLowerCase() === 'true' : dict.WIRIsApplicationProxyKey;
  var entry = {
    id: id,
    name: dict.WIRApplicationNameKey,
    bundleId: dict.WIRApplicationBundleIdentifierKey,
    isProxy: isProxy,
    hostId: dict.WIRHostApplicationIdentifierKey
  };

  return [id, entry];
}

/*
 * Take a dictionary from the remote debugger and makes a more manageable
 * dictionary of pages available.
 */
function pageArrayFromDict(pageDict) {
  var newPageArray = [];
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(_lodash2['default'].values(pageDict)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var dict = _step.value;

      // count only WIRTypeWeb pages and ignore all others (WIRTypeJavaScript etc)
      if (_lodash2['default'].isUndefined(dict.WIRTypeKey) || dict.WIRTypeKey === 'WIRTypeWeb') {
        newPageArray.push({
          id: dict.WIRPageIdentifierKey,
          title: dict.WIRTitleKey,
          url: dict.WIRURLKey,
          isKey: !_lodash2['default'].isUndefined(dict.WIRConnectionIdentifierKey)
        });
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return newPageArray;
}

/*
 * Given a bundle id, finds the correct remote debugger app that is
 * connected.
 */
function getDebuggerAppKey(bundleId, platformVersion, appDict) {
  var appId = undefined;
  if (parseFloat(platformVersion) >= 8) {
    var _iteratorNormalCompletion2 = true;
    var _didIteratorError2 = false;
    var _iteratorError2 = undefined;

    try {
      for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(appDict)), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
        var _step2$value = _slicedToArray(_step2.value, 2);

        var key = _step2$value[0];
        var data = _step2$value[1];

        if (data.bundleId === bundleId) {
          appId = key;
          break;
        }
      }
      // now we need to determine if we should pick a proxy for this instead
    } catch (err) {
      _didIteratorError2 = true;
      _iteratorError2 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }
      } finally {
        if (_didIteratorError2) {
          throw _iteratorError2;
        }
      }
    }

    if (appId) {
      _logger2['default'].debug('Found app id key \'' + appId + '\' for bundle \'' + bundleId + '\'');
      var proxiedAppIds = [];
      var _iteratorNormalCompletion3 = true;
      var _didIteratorError3 = false;
      var _iteratorError3 = undefined;

      try {
        for (var _iterator3 = _getIterator(_lodash2['default'].toPairs(appDict)), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
          var _step3$value = _slicedToArray(_step3.value, 2);

          var key = _step3$value[0];
          var data = _step3$value[1];

          if (data.isProxy && data.hostId === appId) {
            _logger2['default'].debug('Found separate bundleId \'' + data.bundleId + '\' ' + ('acting as proxy for \'' + bundleId + '\', with app id \'' + key + '\''));
            proxiedAppIds.push(key);
          }
        }
      } catch (err) {
        _didIteratorError3 = true;
        _iteratorError3 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion3 && _iterator3['return']) {
            _iterator3['return']();
          }
        } finally {
          if (_didIteratorError3) {
            throw _iteratorError3;
          }
        }
      }

      if (proxiedAppIds.length) {
        // use the last app being proxied
        appId = _lodash2['default'].last(proxiedAppIds);
        _logger2['default'].debug('Using proxied app id \'' + appId + '\'');
      }
    }
  } else {
    if (_lodash2['default'].has(appDict, bundleId)) {
      appId = bundleId;
    }
  }

  return appId;
}

function getPossibleDebuggerAppKeys(bundleId, platformVersion, appDict) {
  var proxiedAppIds = [];
  if (parseFloat(platformVersion) >= 8) {
    var appId = undefined;
    var _iteratorNormalCompletion4 = true;
    var _didIteratorError4 = false;
    var _iteratorError4 = undefined;

    try {
      for (var _iterator4 = _getIterator(_lodash2['default'].toPairs(appDict)), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
        var _step4$value = _slicedToArray(_step4.value, 2);

        var key = _step4$value[0];
        var data = _step4$value[1];

        if (data.bundleId === bundleId) {
          appId = key;
          break;
        }
      }
      // now we need to determine if we should pick a proxy for this instead
    } catch (err) {
      _didIteratorError4 = true;
      _iteratorError4 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion4 && _iterator4['return']) {
          _iterator4['return']();
        }
      } finally {
        if (_didIteratorError4) {
          throw _iteratorError4;
        }
      }
    }

    if (appId) {
      _logger2['default'].debug('Found app id key \'' + appId + '\' for bundle \'' + bundleId + '\'');
      var _iteratorNormalCompletion5 = true;
      var _didIteratorError5 = false;
      var _iteratorError5 = undefined;

      try {
        for (var _iterator5 = _getIterator(_lodash2['default'].toPairs(appDict)), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
          var _step5$value = _slicedToArray(_step5.value, 2);

          var key = _step5$value[0];
          var data = _step5$value[1];

          if (data.isProxy && data.hostId === appId) {
            _logger2['default'].debug('Found separate bundleId \'' + data.bundleId + '\' ' + ('acting as proxy for \'' + bundleId + '\', with app id \'' + key + '\''));
            proxiedAppIds.push(key);
          }
        }
      } catch (err) {
        _didIteratorError5 = true;
        _iteratorError5 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion5 && _iterator5['return']) {
            _iterator5['return']();
          }
        } finally {
          if (_didIteratorError5) {
            throw _iteratorError5;
          }
        }
      }

      if (proxiedAppIds.length === 0) {
        proxiedAppIds = [appId];
      }
    }
  } else {
    if (_lodash2['default'].has(appDict, bundleId)) {
      proxiedAppIds = [bundleId];
    }
  }

  return proxiedAppIds;
}

function checkParams(params) {
  var errors = [];
  var _iteratorNormalCompletion6 = true;
  var _didIteratorError6 = false;
  var _iteratorError6 = undefined;

  try {
    for (var _iterator6 = _getIterator(_lodash2['default'].toPairs(params)), _step6; !(_iteratorNormalCompletion6 = (_step6 = _iterator6.next()).done); _iteratorNormalCompletion6 = true) {
      var _step6$value = _slicedToArray(_step6.value, 2);

      var param = _step6$value[0];
      var value = _step6$value[1];

      try {
        _assert2['default'].ok(value);
      } catch (err) {
        errors.push(param);
      }
    }
  } catch (err) {
    _didIteratorError6 = true;
    _iteratorError6 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion6 && _iterator6['return']) {
        _iterator6['return']();
      }
    } finally {
      if (_didIteratorError6) {
        throw _iteratorError6;
      }
    }
  }

  if (errors.length) {
    return errors;
  }
}

function wrapScriptForFrame(script, frame) {
  _logger2['default'].debug('Wrapping script for frame \'' + frame + '\'');
  var elFromCache = (0, _appiumAtoms.get)('get_element_from_cache');
  return '(function (window) { var document = window.document; ' + ('return (' + script + '); })((' + elFromCache.toString('utf8') + ')(' + JSON.stringify(frame) + '))');
}

function getScriptForAtom(atom, args, frames) {
  var asyncCallBack = arguments.length <= 3 || arguments[3] === undefined ? null : arguments[3];

  var atomSrc = (0, _appiumAtoms.get)(atom);
  var script = undefined;
  if (frames.length > 0) {
    script = atomSrc;
    var _iteratorNormalCompletion7 = true;
    var _didIteratorError7 = false;
    var _iteratorError7 = undefined;

    try {
      for (var _iterator7 = _getIterator(frames), _step7; !(_iteratorNormalCompletion7 = (_step7 = _iterator7.next()).done); _iteratorNormalCompletion7 = true) {
        var frame = _step7.value;

        script = wrapScriptForFrame(script, frame);
      }
    } catch (err) {
      _didIteratorError7 = true;
      _iteratorError7 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion7 && _iterator7['return']) {
          _iterator7['return']();
        }
      } finally {
        if (_didIteratorError7) {
          throw _iteratorError7;
        }
      }
    }
  } else {
    _logger2['default'].debug('Executing \'' + atom + '\' atom in default context');
    script = '(' + atomSrc + ')';
  }

  // add the arguments, as strings
  args = args.map(JSON.stringify);
  if (asyncCallBack) {
    script += '(' + args.join(',') + ', ' + asyncCallBack + ', true )';
  } else {
    script += '(' + args.join(',') + ')';
  }

  return script;
}

exports.appInfoFromDict = appInfoFromDict;
exports.pageArrayFromDict = pageArrayFromDict;
exports.getDebuggerAppKey = getDebuggerAppKey;
exports.getPossibleDebuggerAppKeys = getPossibleDebuggerAppKeys;
exports.checkParams = checkParams;
exports.wrapScriptForFrame = wrapScriptForFrame;
exports.getScriptForAtom = getScriptForAtom;
//# sourceMappingURL=data:application/json;base64,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LE1BQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7QUFDckIsVUFBTSxHQUFHLE9BQU8sQ0FBQzs7Ozs7O0FBQ2pCLHlDQUFrQixNQUFNLGlIQUFFO1lBQWpCLEtBQUs7O0FBQ1osY0FBTSxHQUFHLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztPQUM1Qzs7Ozs7Ozs7Ozs7Ozs7O0dBQ0YsTUFBTTtBQUNMLHdCQUFJLEtBQUssa0JBQWUsSUFBSSxnQ0FBNEIsQ0FBQztBQUN6RCxVQUFNLFNBQU8sT0FBTyxNQUFHLENBQUM7R0FDekI7OztBQUdELE1BQUksR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUNoQyxNQUFJLGFBQWEsRUFBRTtBQUNqQixVQUFNLFVBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBSyxhQUFhLGFBQVUsQ0FBQztHQUMxRCxNQUFNO0FBQ0wsVUFBTSxVQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQUcsQ0FBQztHQUNqQzs7QUFFRCxTQUFPLE1BQU0sQ0FBQztDQUNmOztRQUVRLGVBQWUsR0FBZixlQUFlO1FBQUUsaUJBQWlCLEdBQWpCLGlCQUFpQjtRQUFFLGlCQUFpQixHQUFqQixpQkFBaUI7UUFBRSwwQkFBMEIsR0FBMUIsMEJBQTBCO1FBQUUsV0FBVyxHQUFYLFdBQVc7UUFDOUYsa0JBQWtCLEdBQWxCLGtCQUFrQjtRQUFFLGdCQUFnQixHQUFoQixnQkFBZ0IiLCJmaWxlIjoibGliL2hlbHBlcnMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGdldCBhcyBnZXRBdG9tIH0gZnJvbSAnYXBwaXVtLWF0b21zJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XG5cbi8qXG4gKiBUYWtlcyBhIGRpY3Rpb25hcnkgZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyIGFuZCBtYWtlcyBhIG1vcmUgbWFuYWdlYWJsZVxuICogZGljdGlvbmFyeSB3aG9zZSBrZXlzIGFyZSB1bmRlcnN0YW5kYWJsZVxuICovXG5mdW5jdGlvbiBhcHBJbmZvRnJvbURpY3QgKGRpY3QpIHtcbiAgbGV0IGlkID0gZGljdC5XSVJBcHBsaWNhdGlvbklkZW50aWZpZXJLZXk7XG4gIGxldCBpc1Byb3h5ID0gXy5pc1N0cmluZyhkaWN0LldJUklzQXBwbGljYXRpb25Qcm94eUtleSkgP1xuICAgICAgICAgICAgICAgICAgZGljdC5XSVJJc0FwcGxpY2F0aW9uUHJveHlLZXkudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnIDogZGljdC5XSVJJc0FwcGxpY2F0aW9uUHJveHlLZXk7XG4gIGxldCBlbnRyeSA9IHtcbiAgICBpZDogaWQsXG4gICAgbmFtZTogZGljdC5XSVJBcHBsaWNhdGlvbk5hbWVLZXksXG4gICAgYnVuZGxlSWQ6IGRpY3QuV0lSQXBwbGljYXRpb25CdW5kbGVJZGVudGlmaWVyS2V5LFxuICAgIGlzUHJveHk6IGlzUHJveHksXG4gICAgaG9zdElkOiBkaWN0LldJUkhvc3RBcHBsaWNhdGlvbklkZW50aWZpZXJLZXlcbiAgfTtcblxuICByZXR1cm4gW2lkLCBlbnRyeV07XG59XG5cbi8qXG4gKiBUYWtlIGEgZGljdGlvbmFyeSBmcm9tIHRoZSByZW1vdGUgZGVidWdnZXIgYW5kIG1ha2VzIGEgbW9yZSBtYW5hZ2VhYmxlXG4gKiBkaWN0aW9uYXJ5IG9mIHBhZ2VzIGF2YWlsYWJsZS5cbiAqL1xuZnVuY3Rpb24gcGFnZUFycmF5RnJvbURpY3QgKHBhZ2VEaWN0KSB7XG4gIGxldCBuZXdQYWdlQXJyYXkgPSBbXTtcbiAgZm9yIChsZXQgZGljdCBvZiBfLnZhbHVlcyhwYWdlRGljdCkpIHtcbiAgICAvLyBjb3VudCBvbmx5IFdJUlR5cGVXZWIgcGFnZXMgYW5kIGlnbm9yZSBhbGwgb3RoZXJzIChXSVJUeXBlSmF2YVNjcmlwdCBldGMpXG4gICAgaWYgKF8uaXNVbmRlZmluZWQoZGljdC5XSVJUeXBlS2V5KSB8fCBkaWN0LldJUlR5cGVLZXkgPT09ICdXSVJUeXBlV2ViJykge1xuICAgICAgbmV3UGFnZUFycmF5LnB1c2goe1xuICAgICAgICBpZDogZGljdC5XSVJQYWdlSWRlbnRpZmllcktleSxcbiAgICAgICAgdGl0bGU6IGRpY3QuV0lSVGl0bGVLZXksXG4gICAgICAgIHVybDogZGljdC5XSVJVUkxLZXksXG4gICAgICAgIGlzS2V5OiAhXy5pc1VuZGVmaW5lZChkaWN0LldJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5KSxcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICByZXR1cm4gbmV3UGFnZUFycmF5O1xufVxuXG4vKlxuICogR2l2ZW4gYSBidW5kbGUgaWQsIGZpbmRzIHRoZSBjb3JyZWN0IHJlbW90ZSBkZWJ1Z2dlciBhcHAgdGhhdCBpc1xuICogY29ubmVjdGVkLlxuICovXG5mdW5jdGlvbiBnZXREZWJ1Z2dlckFwcEtleSAoYnVuZGxlSWQsIHBsYXRmb3JtVmVyc2lvbiwgYXBwRGljdCkge1xuICBsZXQgYXBwSWQ7XG4gIGlmIChwYXJzZUZsb2F0KHBsYXRmb3JtVmVyc2lvbikgPj0gOCkge1xuICAgIGZvciAobGV0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgICAgaWYgKGRhdGEuYnVuZGxlSWQgPT09IGJ1bmRsZUlkKSB7XG4gICAgICAgIGFwcElkID0ga2V5O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gbm93IHdlIG5lZWQgdG8gZGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBwaWNrIGEgcHJveHkgZm9yIHRoaXMgaW5zdGVhZFxuICAgIGlmIChhcHBJZCkge1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCBhcHAgaWQga2V5ICcke2FwcElkfScgZm9yIGJ1bmRsZSAnJHtidW5kbGVJZH0nYCk7XG4gICAgICBsZXQgcHJveGllZEFwcElkcyA9IFtdO1xuICAgICAgZm9yIChsZXQgW2tleSwgZGF0YV0gb2YgXy50b1BhaXJzKGFwcERpY3QpKSB7XG4gICAgICAgIGlmIChkYXRhLmlzUHJveHkgJiYgZGF0YS5ob3N0SWQgPT09IGFwcElkKSB7XG4gICAgICAgICAgbG9nLmRlYnVnKGBGb3VuZCBzZXBhcmF0ZSBidW5kbGVJZCAnJHtkYXRhLmJ1bmRsZUlkfScgYCArXG4gICAgICAgICAgICAgICAgICAgIGBhY3RpbmcgYXMgcHJveHkgZm9yICcke2J1bmRsZUlkfScsIHdpdGggYXBwIGlkICcke2tleX0nYCk7XG4gICAgICAgICAgcHJveGllZEFwcElkcy5wdXNoKGtleSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlmIChwcm94aWVkQXBwSWRzLmxlbmd0aCkge1xuICAgICAgICAvLyB1c2UgdGhlIGxhc3QgYXBwIGJlaW5nIHByb3hpZWRcbiAgICAgICAgYXBwSWQgPSBfLmxhc3QocHJveGllZEFwcElkcyk7XG4gICAgICAgIGxvZy5kZWJ1ZyhgVXNpbmcgcHJveGllZCBhcHAgaWQgJyR7YXBwSWR9J2ApO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAoXy5oYXMoYXBwRGljdCwgYnVuZGxlSWQpKSB7XG4gICAgICBhcHBJZCA9IGJ1bmRsZUlkO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBhcHBJZDtcbn1cblxuZnVuY3Rpb24gZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMgKGJ1bmRsZUlkLCBwbGF0Zm9ybVZlcnNpb24sIGFwcERpY3QpIHtcbiAgbGV0IHByb3hpZWRBcHBJZHMgPSBbXTtcbiAgaWYgKHBhcnNlRmxvYXQocGxhdGZvcm1WZXJzaW9uKSA+PSA4KSB7XG4gICAgbGV0IGFwcElkO1xuICAgIGZvciAobGV0IFtrZXksIGRhdGFdIG9mIF8udG9QYWlycyhhcHBEaWN0KSkge1xuICAgICAgaWYgKGRhdGEuYnVuZGxlSWQgPT09IGJ1bmRsZUlkKSB7XG4gICAgICAgIGFwcElkID0ga2V5O1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gbm93IHdlIG5lZWQgdG8gZGV0ZXJtaW5lIGlmIHdlIHNob3VsZCBwaWNrIGEgcHJveHkgZm9yIHRoaXMgaW5zdGVhZFxuICAgIGlmIChhcHBJZCkge1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCBhcHAgaWQga2V5ICcke2FwcElkfScgZm9yIGJ1bmRsZSAnJHtidW5kbGVJZH0nYCk7XG4gICAgICBmb3IgKGxldCBba2V5LCBkYXRhXSBvZiBfLnRvUGFpcnMoYXBwRGljdCkpIHtcbiAgICAgICAgaWYgKGRhdGEuaXNQcm94eSAmJiBkYXRhLmhvc3RJZCA9PT0gYXBwSWQpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYEZvdW5kIHNlcGFyYXRlIGJ1bmRsZUlkICcke2RhdGEuYnVuZGxlSWR9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgYGFjdGluZyBhcyBwcm94eSBmb3IgJyR7YnVuZGxlSWR9Jywgd2l0aCBhcHAgaWQgJyR7a2V5fSdgKTtcbiAgICAgICAgICBwcm94aWVkQXBwSWRzLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHByb3hpZWRBcHBJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHByb3hpZWRBcHBJZHMgPSBbYXBwSWRdO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBpZiAoXy5oYXMoYXBwRGljdCwgYnVuZGxlSWQpKSB7XG4gICAgICBwcm94aWVkQXBwSWRzID0gW2J1bmRsZUlkXTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcHJveGllZEFwcElkcztcbn1cblxuZnVuY3Rpb24gY2hlY2tQYXJhbXMgKHBhcmFtcykge1xuICBsZXQgZXJyb3JzID0gW107XG4gIGZvciAobGV0IFtwYXJhbSwgdmFsdWVdIG9mIF8udG9QYWlycyhwYXJhbXMpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGFzc2VydC5vayh2YWx1ZSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBlcnJvcnMucHVzaChwYXJhbSk7XG4gICAgfVxuICB9XG4gIGlmIChlcnJvcnMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIGVycm9ycztcbiAgfVxufVxuXG5mdW5jdGlvbiB3cmFwU2NyaXB0Rm9yRnJhbWUgKHNjcmlwdCwgZnJhbWUpIHtcbiAgbG9nLmRlYnVnKGBXcmFwcGluZyBzY3JpcHQgZm9yIGZyYW1lICcke2ZyYW1lfSdgKTtcbiAgbGV0IGVsRnJvbUNhY2hlID0gZ2V0QXRvbSgnZ2V0X2VsZW1lbnRfZnJvbV9jYWNoZScpO1xuICByZXR1cm4gYChmdW5jdGlvbiAod2luZG93KSB7IHZhciBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDsgYCArXG4gICAgICAgICBgcmV0dXJuICgke3NjcmlwdH0pOyB9KSgoJHtlbEZyb21DYWNoZS50b1N0cmluZygndXRmOCcpfSkoJHtKU09OLnN0cmluZ2lmeShmcmFtZSl9KSlgO1xufVxuXG5mdW5jdGlvbiBnZXRTY3JpcHRGb3JBdG9tIChhdG9tLCBhcmdzLCBmcmFtZXMsIGFzeW5jQ2FsbEJhY2sgPSBudWxsKSB7XG4gIGxldCBhdG9tU3JjID0gZ2V0QXRvbShhdG9tKTtcbiAgbGV0IHNjcmlwdDtcbiAgaWYgKGZyYW1lcy5sZW5ndGggPiAwKSB7XG4gICAgc2NyaXB0ID0gYXRvbVNyYztcbiAgICBmb3IgKGxldCBmcmFtZSBvZiBmcmFtZXMpIHtcbiAgICAgIHNjcmlwdCA9IHdyYXBTY3JpcHRGb3JGcmFtZShzY3JpcHQsIGZyYW1lKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nLmRlYnVnKGBFeGVjdXRpbmcgJyR7YXRvbX0nIGF0b20gaW4gZGVmYXVsdCBjb250ZXh0YCk7XG4gICAgc2NyaXB0ID0gYCgke2F0b21TcmN9KWA7XG4gIH1cblxuICAvLyBhZGQgdGhlIGFyZ3VtZW50cywgYXMgc3RyaW5nc1xuICBhcmdzID0gYXJncy5tYXAoSlNPTi5zdHJpbmdpZnkpO1xuICBpZiAoYXN5bmNDYWxsQmFjaykge1xuICAgIHNjcmlwdCArPSBgKCR7YXJncy5qb2luKCcsJyl9LCAke2FzeW5jQ2FsbEJhY2t9LCB0cnVlIClgO1xuICB9IGVsc2Uge1xuICAgIHNjcmlwdCArPSBgKCR7YXJncy5qb2luKCcsJyl9KWA7XG4gIH1cblxuICByZXR1cm4gc2NyaXB0O1xufVxuXG5leHBvcnQgeyBhcHBJbmZvRnJvbURpY3QsIHBhZ2VBcnJheUZyb21EaWN0LCBnZXREZWJ1Z2dlckFwcEtleSwgZ2V0UG9zc2libGVEZWJ1Z2dlckFwcEtleXMsIGNoZWNrUGFyYW1zLFxuICAgICAgICAgd3JhcFNjcmlwdEZvckZyYW1lLCBnZXRTY3JpcHRGb3JBdG9tIH07XG4iXX0=