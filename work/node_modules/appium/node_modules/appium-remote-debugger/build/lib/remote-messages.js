"use strict";

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});
exports['default'] = getRemoteCommand;

var _remoteDebugger = require('./remote-debugger');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

/*
 * Connection functions
 */

function setConnectionKey(connId) {
  return {
    __argument: {
      WIRConnectionIdentifierKey: connId
    },
    __selector: '_rpc_reportIdentifier:'
  };
}

function connectToApp(connId, appIdKey) {
  return {
    __argument: {
      WIRConnectionIdentifierKey: connId,
      WIRApplicationIdentifierKey: appIdKey
    },
    __selector: '_rpc_forwardGetListing:'
  };
}

function setSenderKey(connId, senderId, appIdKey, pageIdKey) {
  return {
    __argument: {
      WIRApplicationIdentifierKey: appIdKey,
      WIRConnectionIdentifierKey: connId,
      WIRSenderKey: senderId,
      WIRPageIdentifierKey: pageIdKey
    },
    __selector: '_rpc_forwardSocketSetup:'
  };
}

/*
 * Action functions
 */

function indicateWebView(connId, appIdKey, pageIdKey, enabled) {
  return {
    __argument: {
      WIRApplicationIdentifierKey: appIdKey,
      WIRIndicateEnabledKey: _lodash2['default'].isUndefined(enabled) ? true : enabled,
      WIRConnectionIdentifierKey: connId,
      WIRPageIdentifierKey: pageIdKey
    },
    __selector: '_rpc_forwardIndicateWebView:'
  };
}

function sendJSCommand(connId, senderId, appIdKey, pageIdKey, debuggerType, js) {
  return command('Runtime.evaluate', { expression: js, returnByValue: true }, appIdKey, connId, senderId, pageIdKey, debuggerType);
}

function callJSFunction(connId, senderId, appIdKey, pageIdKey, debuggerType, objId, fn, args) {
  return command('Runtime.callFunctionOn', { objectId: objId, functionDeclaration: fn, arguments: args, returnByValue: true }, appIdKey, connId, senderId, pageIdKey, debuggerType);
}

function setUrl(connId, senderId, appIdKey, pageIdKey, debuggerType, url) {
  return command('Page.navigate', { url: url }, appIdKey, connId, senderId, pageIdKey, debuggerType);
}

function enablePage(connId, senderId, appIdKey, pageIdKey, debuggerType) {
  return command('Page.enable', {}, appIdKey, connId, senderId, pageIdKey, debuggerType);
}

function startTimeline(connId, senderId, appIdKey, pageIdKey, debuggerType) {
  return command('Timeline.start', {}, appIdKey, connId, senderId, pageIdKey, debuggerType);
}

function stopTimeline(connId, senderId, appIdKey, pageIdKey, debuggerType) {
  return command('Timeline.stop', {}, appIdKey, connId, senderId, pageIdKey, debuggerType);
}

/*
 * Internal functions
 */

function command(method, params, appIdKey, connId, senderId, pageIdKey, debuggerType) {
  if (debuggerType !== null && debuggerType === _remoteDebugger.DEBUGGER_TYPES.webkit) {
    return commandWebKit(method, params);
  } else {
    return commandWebInspector(method, params, appIdKey, connId, senderId, pageIdKey);
  }
}

function commandWebInspector(method, params, appIdKey, connId, senderId, pageIdKey) {
  var plist = {
    __argument: {
      WIRApplicationIdentifierKey: appIdKey,
      WIRSocketDataKey: {
        method: method,
        params: {
          objectGroup: 'console',
          includeCommandLineAPI: true,
          doNotPauseOnExceptionsAndMuteConsole: true
        }
      },
      WIRConnectionIdentifierKey: connId,
      WIRSenderKey: senderId,
      WIRPageIdentifierKey: pageIdKey
    },
    __selector: '_rpc_forwardSocketData:'
  };
  if (params) {
    plist.__argument.WIRSocketDataKey.params = _lodash2['default'].extend(plist.__argument.WIRSocketDataKey.params, params);
  }
  return plist;
}

//generate a json request using the webkit protocol
function commandWebKit(method, params) {
  var jsonRequest = {
    method: method,
    params: {
      objectGroup: 'console',
      includeCommandLineAPI: true,
      doNotPauseOnExceptionsAndMuteConsole: true
    }
  };
  if (params) {
    //if there any parameters add them
    jsonRequest.params = _lodash2['default'].extend(jsonRequest.params, params);
  }
  return jsonRequest;
}

function getRemoteCommand(command, opts) {
  var cmd = undefined;

  switch (command) {
    case 'setConnectionKey':
      cmd = setConnectionKey(opts.connId);
      break;
    case 'connectToApp':
      cmd = connectToApp(opts.connId, opts.appIdKey);
      break;
    case 'setSenderKey':
      cmd = setSenderKey(opts.connId, opts.senderId, opts.appIdKey, opts.pageIdKey);
      break;
    case 'indicateWebView':
      cmd = indicateWebView(opts.connId, opts.appIdKey, opts.pageIdKey, opts.enabled);
      break;
    case 'sendJSCommand':
      cmd = sendJSCommand(opts.connId, opts.senderId, opts.appIdKey, opts.pageIdKey, opts.debuggerType, opts.command);
      break;
    case 'callJSFunction':
      cmd = callJSFunction(opts.connId, opts.senderId, opts.appIdKey, opts.pageIdKey, opts.debuggerType, opts.objId, opts.fn, opts.args);
      break;
    case 'setUrl':
      cmd = setUrl(opts.connId, opts.senderId, opts.appIdKey, opts.pageIdKey, opts.debuggerType, opts.url);
      break;
    case 'enablePage':
      cmd = enablePage(opts.connId, opts.senderId, opts.appIdKey, opts.pageIdKey, opts.debuggerType);
      break;
    case 'startTimeline':
      cmd = startTimeline(opts.connId, opts.senderId, opts.appIdKey, opts.pageIdKey, opts.debuggerType);
      break;
    case 'stopTimeline':
      cmd = stopTimeline(opts.connId, opts.senderId, opts.appIdKey, opts.pageIdKey, opts.debuggerType);
      break;
    default:
      throw new Error('Unknown command: ' + command);
  }

  return cmd;
}

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9yZW1vdGUtbWVzc2FnZXMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7Ozs7O3FCQStJVyxnQkFBZ0I7OzhCQTdJVCxtQkFBbUI7O3NCQUNwQyxRQUFROzs7Ozs7OztBQU10QixTQUFTLGdCQUFnQixDQUFFLE1BQU0sRUFBRTtBQUNqQyxTQUFPO0FBQ0wsY0FBVSxFQUFFO0FBQ1YsZ0NBQTBCLEVBQUUsTUFBTTtLQUNuQztBQUNELGNBQVUsRUFBRyx3QkFBd0I7R0FDdEMsQ0FBQztDQUNIOztBQUVELFNBQVMsWUFBWSxDQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUU7QUFDdkMsU0FBTztBQUNMLGNBQVUsRUFBRTtBQUNWLGdDQUEwQixFQUFFLE1BQU07QUFDbEMsaUNBQTJCLEVBQUUsUUFBUTtLQUN0QztBQUNELGNBQVUsRUFBRyx5QkFBeUI7R0FDdkMsQ0FBQztDQUNIOztBQUVELFNBQVMsWUFBWSxDQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRTtBQUM1RCxTQUFPO0FBQ0wsY0FBVSxFQUFFO0FBQ1YsaUNBQTJCLEVBQUUsUUFBUTtBQUNyQyxnQ0FBMEIsRUFBRSxNQUFNO0FBQ2xDLGtCQUFZLEVBQUUsUUFBUTtBQUN0QiwwQkFBb0IsRUFBRSxTQUFTO0tBQ2hDO0FBQ0QsY0FBVSxFQUFFLDBCQUEwQjtHQUN2QyxDQUFDO0NBQ0g7Ozs7OztBQU9ELFNBQVMsZUFBZSxDQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRTtBQUM5RCxTQUFPO0FBQ0wsY0FBVSxFQUFFO0FBQ1YsaUNBQTJCLEVBQUUsUUFBUTtBQUNyQywyQkFBcUIsRUFBRSxvQkFBRSxXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxHQUFHLE9BQU87QUFDOUQsZ0NBQTBCLEVBQUUsTUFBTTtBQUNsQywwQkFBb0IsRUFBRSxTQUFTO0tBQ2hDO0FBQ0QsY0FBVSxFQUFFLDhCQUE4QjtHQUMzQyxDQUFDO0NBQ0g7O0FBRUQsU0FBUyxhQUFhLENBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxFQUFFLEVBQUU7QUFDL0UsU0FBTyxPQUFPLENBQUMsa0JBQWtCLEVBQzdCLEVBQUMsVUFBVSxFQUFFLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFDLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO0NBQ2pHOztBQUVELFNBQVMsY0FBYyxDQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUU7QUFDN0YsU0FBTyxPQUFPLENBQUMsd0JBQXdCLEVBQ25DLEVBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxtQkFBbUIsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFDLEVBQ2hGLFFBQVEsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztDQUMxRDs7QUFFRCxTQUFTLE1BQU0sQ0FBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLEdBQUcsRUFBRTtBQUN6RSxTQUFPLE9BQU8sQ0FBQyxlQUFlLEVBQUUsRUFBQyxHQUFHLEVBQUUsR0FBRyxFQUFDLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFDeEQsUUFBUSxFQUFFLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztDQUN4Qzs7QUFFRCxTQUFTLFVBQVUsQ0FBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFO0FBQ3hFLFNBQU8sT0FBTyxDQUFDLGFBQWEsRUFBRSxFQUFFLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQ3JDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztDQUNqRDs7QUFFRCxTQUFTLGFBQWEsQ0FBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFO0FBQzNFLFNBQU8sT0FBTyxDQUFDLGdCQUFnQixFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFDeEMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO0NBQ2pEOztBQUVELFNBQVMsWUFBWSxDQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUU7QUFDMUUsU0FBTyxPQUFPLENBQUMsZUFBZSxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFDdkMsU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO0NBQ2pEOzs7Ozs7QUFPRCxTQUFTLE9BQU8sQ0FBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUU7QUFDckYsTUFBSSxZQUFZLEtBQUssSUFBSSxJQUFJLFlBQVksS0FBSywrQkFBZSxNQUFNLEVBQUU7QUFDbkUsV0FBTyxhQUFhLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0dBQ3RDLE1BQU07QUFDTCxXQUFPLG1CQUFtQixDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsU0FBUyxDQUFDLENBQUM7R0FDbkY7Q0FDRjs7QUFFRCxTQUFTLG1CQUFtQixDQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFO0FBQ25GLE1BQUksS0FBSyxHQUFHO0FBQ1YsY0FBVSxFQUFFO0FBQ1YsaUNBQTJCLEVBQUUsUUFBUTtBQUNyQyxzQkFBZ0IsRUFBRTtBQUNoQixjQUFNLEVBQUUsTUFBTTtBQUNkLGNBQU0sRUFBRTtBQUNOLHFCQUFXLEVBQUUsU0FBUztBQUN0QiwrQkFBcUIsRUFBRSxJQUFJO0FBQzNCLDhDQUFvQyxFQUFFLElBQUk7U0FDM0M7T0FDRjtBQUNELGdDQUEwQixFQUFFLE1BQU07QUFDbEMsa0JBQVksRUFBRSxRQUFRO0FBQ3RCLDBCQUFvQixFQUFFLFNBQVM7S0FDaEM7QUFDRCxjQUFVLEVBQUUseUJBQXlCO0dBQ3RDLENBQUM7QUFDRixNQUFJLE1BQU0sRUFBRTtBQUNWLFNBQUssQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxHQUN0QyxvQkFBRSxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7R0FDOUQ7QUFDRCxTQUFPLEtBQUssQ0FBQztDQUNkOzs7QUFHRCxTQUFTLGFBQWEsQ0FBRSxNQUFNLEVBQUUsTUFBTSxFQUFFO0FBQ3RDLE1BQUksV0FBVyxHQUFHO0FBQ2hCLFVBQU0sRUFBRSxNQUFNO0FBQ2QsVUFBTSxFQUFFO0FBQ04saUJBQVcsRUFBRSxTQUFTO0FBQ3RCLDJCQUFxQixFQUFFLElBQUk7QUFDM0IsMENBQW9DLEVBQUUsSUFBSTtLQUMzQztHQUNGLENBQUM7QUFDRixNQUFJLE1BQU0sRUFBRTs7QUFFVixlQUFXLENBQUMsTUFBTSxHQUFHLG9CQUFFLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0dBQzNEO0FBQ0QsU0FBTyxXQUFXLENBQUM7Q0FDcEI7O0FBRWMsU0FBUyxnQkFBZ0IsQ0FBRSxPQUFPLEVBQUUsSUFBSSxFQUFFO0FBQ3ZELE1BQUksR0FBRyxZQUFBLENBQUM7O0FBRVIsVUFBUSxPQUFPO0FBQ2IsU0FBSyxrQkFBa0I7QUFDckIsU0FBRyxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNwQyxZQUFNO0FBQUEsQUFDUixTQUFLLGNBQWM7QUFDakIsU0FBRyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQyxZQUFNO0FBQUEsQUFDUixTQUFLLGNBQWM7QUFDakIsU0FBRyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFDcEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3hCLFlBQU07QUFBQSxBQUNSLFNBQUssaUJBQWlCO0FBQ3BCLFNBQUcsR0FBRyxlQUFlLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQ3hELElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN0QixZQUFNO0FBQUEsQUFDUixTQUFLLGVBQWU7QUFDbEIsU0FBRyxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFDckQsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN6RCxZQUFNO0FBQUEsQUFDUixTQUFLLGdCQUFnQjtBQUNuQixTQUFHLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUN0RCxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUN0RCxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDbkIsWUFBTTtBQUFBLEFBQ1IsU0FBSyxRQUFRO0FBQ1gsU0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUM5RCxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNyQyxZQUFNO0FBQUEsQUFDUixTQUFLLFlBQVk7QUFDZixTQUFHLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUNsRCxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUMzQyxZQUFNO0FBQUEsQUFDUixTQUFLLGVBQWU7QUFDbEIsU0FBRyxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFDckQsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDM0MsWUFBTTtBQUFBLEFBQ1IsU0FBSyxjQUFjO0FBQ2pCLFNBQUcsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQ3BELElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQzNDLFlBQU07QUFBQSxBQUNSO0FBQ0UsWUFBTSxJQUFJLEtBQUssdUJBQXFCLE9BQU8sQ0FBRyxDQUFDO0FBQUEsR0FDbEQ7O0FBRUQsU0FBTyxHQUFHLENBQUM7Q0FDWiIsImZpbGUiOiJsaWIvcmVtb3RlLW1lc3NhZ2VzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7IERFQlVHR0VSX1RZUEVTIH0gZnJvbSAnLi9yZW1vdGUtZGVidWdnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuLypcbiAqIENvbm5lY3Rpb24gZnVuY3Rpb25zXG4gKi9cblxuZnVuY3Rpb24gc2V0Q29ubmVjdGlvbktleSAoY29ubklkKSB7XG4gIHJldHVybiB7XG4gICAgX19hcmd1bWVudDoge1xuICAgICAgV0lSQ29ubmVjdGlvbklkZW50aWZpZXJLZXk6IGNvbm5JZFxuICAgIH0sXG4gICAgX19zZWxlY3RvciA6ICdfcnBjX3JlcG9ydElkZW50aWZpZXI6J1xuICB9O1xufVxuXG5mdW5jdGlvbiBjb25uZWN0VG9BcHAgKGNvbm5JZCwgYXBwSWRLZXkpIHtcbiAgcmV0dXJuIHtcbiAgICBfX2FyZ3VtZW50OiB7XG4gICAgICBXSVJDb25uZWN0aW9uSWRlbnRpZmllcktleTogY29ubklkLFxuICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBhcHBJZEtleVxuICAgIH0sXG4gICAgX19zZWxlY3RvciA6ICdfcnBjX2ZvcndhcmRHZXRMaXN0aW5nOidcbiAgfTtcbn1cblxuZnVuY3Rpb24gc2V0U2VuZGVyS2V5IChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5KSB7XG4gIHJldHVybiB7XG4gICAgX19hcmd1bWVudDoge1xuICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBhcHBJZEtleSxcbiAgICAgIFdJUkNvbm5lY3Rpb25JZGVudGlmaWVyS2V5OiBjb25uSWQsXG4gICAgICBXSVJTZW5kZXJLZXk6IHNlbmRlcklkLFxuICAgICAgV0lSUGFnZUlkZW50aWZpZXJLZXk6IHBhZ2VJZEtleVxuICAgIH0sXG4gICAgX19zZWxlY3RvcjogJ19ycGNfZm9yd2FyZFNvY2tldFNldHVwOidcbiAgfTtcbn1cblxuXG4vKlxuICogQWN0aW9uIGZ1bmN0aW9uc1xuICovXG5cbmZ1bmN0aW9uIGluZGljYXRlV2ViVmlldyAoY29ubklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBlbmFibGVkKSB7XG4gIHJldHVybiB7XG4gICAgX19hcmd1bWVudDoge1xuICAgICAgV0lSQXBwbGljYXRpb25JZGVudGlmaWVyS2V5OiBhcHBJZEtleSxcbiAgICAgIFdJUkluZGljYXRlRW5hYmxlZEtleTogXy5pc1VuZGVmaW5lZChlbmFibGVkKSA/IHRydWUgOiBlbmFibGVkLFxuICAgICAgV0lSQ29ubmVjdGlvbklkZW50aWZpZXJLZXk6IGNvbm5JZCxcbiAgICAgIFdJUlBhZ2VJZGVudGlmaWVyS2V5OiBwYWdlSWRLZXlcbiAgICB9LFxuICAgIF9fc2VsZWN0b3I6ICdfcnBjX2ZvcndhcmRJbmRpY2F0ZVdlYlZpZXc6J1xuICB9O1xufVxuXG5mdW5jdGlvbiBzZW5kSlNDb21tYW5kIChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIGpzKSB7XG4gIHJldHVybiBjb21tYW5kKCdSdW50aW1lLmV2YWx1YXRlJyxcbiAgICAgIHtleHByZXNzaW9uOiBqcywgcmV0dXJuQnlWYWx1ZTogdHJ1ZX0sIGFwcElkS2V5LCBjb25uSWQsIHNlbmRlcklkLCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSk7XG59XG5cbmZ1bmN0aW9uIGNhbGxKU0Z1bmN0aW9uIChjb25uSWQsIHNlbmRlcklkLCBhcHBJZEtleSwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUsIG9iaklkLCBmbiwgYXJncykge1xuICByZXR1cm4gY29tbWFuZCgnUnVudGltZS5jYWxsRnVuY3Rpb25PbicsXG4gICAgICB7b2JqZWN0SWQ6IG9iaklkLCBmdW5jdGlvbkRlY2xhcmF0aW9uOiBmbiwgYXJndW1lbnRzOiBhcmdzLCByZXR1cm5CeVZhbHVlOiB0cnVlfSxcbiAgICAgIGFwcElkS2V5LCBjb25uSWQsIHNlbmRlcklkLCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSk7XG59XG5cbmZ1bmN0aW9uIHNldFVybCAoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlLCB1cmwpIHtcbiAgcmV0dXJuIGNvbW1hbmQoJ1BhZ2UubmF2aWdhdGUnLCB7dXJsOiB1cmx9LCBhcHBJZEtleSwgY29ubklkLFxuICAgICAgc2VuZGVySWQsIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlKTtcbn1cblxuZnVuY3Rpb24gZW5hYmxlUGFnZSAoY29ubklkLCBzZW5kZXJJZCwgYXBwSWRLZXksIHBhZ2VJZEtleSwgZGVidWdnZXJUeXBlKSB7XG4gIHJldHVybiBjb21tYW5kKCdQYWdlLmVuYWJsZScsIHt9LCBhcHBJZEtleSwgY29ubklkLCBzZW5kZXJJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSk7XG59XG5cbmZ1bmN0aW9uIHN0YXJ0VGltZWxpbmUgKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSkge1xuICByZXR1cm4gY29tbWFuZCgnVGltZWxpbmUuc3RhcnQnLCB7fSwgYXBwSWRLZXksIGNvbm5JZCwgc2VuZGVySWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUpO1xufVxuXG5mdW5jdGlvbiBzdG9wVGltZWxpbmUgKGNvbm5JZCwgc2VuZGVySWQsIGFwcElkS2V5LCBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSkge1xuICByZXR1cm4gY29tbWFuZCgnVGltZWxpbmUuc3RvcCcsIHt9LCBhcHBJZEtleSwgY29ubklkLCBzZW5kZXJJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlSWRLZXksIGRlYnVnZ2VyVHlwZSk7XG59XG5cblxuLypcbiAqIEludGVybmFsIGZ1bmN0aW9uc1xuICovXG5cbmZ1bmN0aW9uIGNvbW1hbmQgKG1ldGhvZCwgcGFyYW1zLCBhcHBJZEtleSwgY29ubklkLCBzZW5kZXJJZCwgcGFnZUlkS2V5LCBkZWJ1Z2dlclR5cGUpIHtcbiAgaWYgKGRlYnVnZ2VyVHlwZSAhPT0gbnVsbCAmJiBkZWJ1Z2dlclR5cGUgPT09IERFQlVHR0VSX1RZUEVTLndlYmtpdCkge1xuICAgIHJldHVybiBjb21tYW5kV2ViS2l0KG1ldGhvZCwgcGFyYW1zKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gY29tbWFuZFdlYkluc3BlY3RvcihtZXRob2QsIHBhcmFtcywgYXBwSWRLZXksIGNvbm5JZCwgc2VuZGVySWQsIHBhZ2VJZEtleSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY29tbWFuZFdlYkluc3BlY3RvciAobWV0aG9kLCBwYXJhbXMsIGFwcElkS2V5LCBjb25uSWQsIHNlbmRlcklkLCBwYWdlSWRLZXkpIHtcbiAgbGV0IHBsaXN0ID0ge1xuICAgIF9fYXJndW1lbnQ6IHtcbiAgICAgIFdJUkFwcGxpY2F0aW9uSWRlbnRpZmllcktleTogYXBwSWRLZXksXG4gICAgICBXSVJTb2NrZXREYXRhS2V5OiB7XG4gICAgICAgIG1ldGhvZDogbWV0aG9kLFxuICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICBvYmplY3RHcm91cDogJ2NvbnNvbGUnLFxuICAgICAgICAgIGluY2x1ZGVDb21tYW5kTGluZUFQSTogdHJ1ZSxcbiAgICAgICAgICBkb05vdFBhdXNlT25FeGNlcHRpb25zQW5kTXV0ZUNvbnNvbGU6IHRydWUsXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBXSVJDb25uZWN0aW9uSWRlbnRpZmllcktleTogY29ubklkLFxuICAgICAgV0lSU2VuZGVyS2V5OiBzZW5kZXJJZCxcbiAgICAgIFdJUlBhZ2VJZGVudGlmaWVyS2V5OiBwYWdlSWRLZXlcbiAgICB9LFxuICAgIF9fc2VsZWN0b3I6ICdfcnBjX2ZvcndhcmRTb2NrZXREYXRhOidcbiAgfTtcbiAgaWYgKHBhcmFtcykge1xuICAgIHBsaXN0Ll9fYXJndW1lbnQuV0lSU29ja2V0RGF0YUtleS5wYXJhbXMgPVxuICAgICAgXy5leHRlbmQocGxpc3QuX19hcmd1bWVudC5XSVJTb2NrZXREYXRhS2V5LnBhcmFtcywgcGFyYW1zKTtcbiAgfVxuICByZXR1cm4gcGxpc3Q7XG59XG5cbi8vZ2VuZXJhdGUgYSBqc29uIHJlcXVlc3QgdXNpbmcgdGhlIHdlYmtpdCBwcm90b2NvbFxuZnVuY3Rpb24gY29tbWFuZFdlYktpdCAobWV0aG9kLCBwYXJhbXMpIHtcbiAgbGV0IGpzb25SZXF1ZXN0ID0ge1xuICAgIG1ldGhvZDogbWV0aG9kLFxuICAgIHBhcmFtczoge1xuICAgICAgb2JqZWN0R3JvdXA6ICdjb25zb2xlJyxcbiAgICAgIGluY2x1ZGVDb21tYW5kTGluZUFQSTogdHJ1ZSxcbiAgICAgIGRvTm90UGF1c2VPbkV4Y2VwdGlvbnNBbmRNdXRlQ29uc29sZTogdHJ1ZVxuICAgIH1cbiAgfTtcbiAgaWYgKHBhcmFtcykge1xuICAgIC8vaWYgdGhlcmUgYW55IHBhcmFtZXRlcnMgYWRkIHRoZW1cbiAgICBqc29uUmVxdWVzdC5wYXJhbXMgPSBfLmV4dGVuZChqc29uUmVxdWVzdC5wYXJhbXMsIHBhcmFtcyk7XG4gIH1cbiAgcmV0dXJuIGpzb25SZXF1ZXN0O1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBnZXRSZW1vdGVDb21tYW5kIChjb21tYW5kLCBvcHRzKSB7XG4gIGxldCBjbWQ7XG5cbiAgc3dpdGNoIChjb21tYW5kKSB7XG4gICAgY2FzZSAnc2V0Q29ubmVjdGlvbktleSc6XG4gICAgICBjbWQgPSBzZXRDb25uZWN0aW9uS2V5KG9wdHMuY29ubklkKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2Nvbm5lY3RUb0FwcCc6XG4gICAgICBjbWQgPSBjb25uZWN0VG9BcHAob3B0cy5jb25uSWQsIG9wdHMuYXBwSWRLZXkpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnc2V0U2VuZGVyS2V5JzpcbiAgICAgIGNtZCA9IHNldFNlbmRlcktleShvcHRzLmNvbm5JZCwgb3B0cy5zZW5kZXJJZCwgb3B0cy5hcHBJZEtleSxcbiAgICAgICAgICAgICAgb3B0cy5wYWdlSWRLZXkpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnaW5kaWNhdGVXZWJWaWV3JzpcbiAgICAgIGNtZCA9IGluZGljYXRlV2ViVmlldyhvcHRzLmNvbm5JZCwgb3B0cy5hcHBJZEtleSwgb3B0cy5wYWdlSWRLZXksXG4gICAgICAgICAgICAgIG9wdHMuZW5hYmxlZCk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdzZW5kSlNDb21tYW5kJzpcbiAgICAgIGNtZCA9IHNlbmRKU0NvbW1hbmQob3B0cy5jb25uSWQsIG9wdHMuc2VuZGVySWQsIG9wdHMuYXBwSWRLZXksXG4gICAgICAgICAgICAgIG9wdHMucGFnZUlkS2V5LCBvcHRzLmRlYnVnZ2VyVHlwZSwgb3B0cy5jb21tYW5kKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2NhbGxKU0Z1bmN0aW9uJzpcbiAgICAgIGNtZCA9IGNhbGxKU0Z1bmN0aW9uKG9wdHMuY29ubklkLCBvcHRzLnNlbmRlcklkLCBvcHRzLmFwcElkS2V5LFxuICAgICAgICAgICAgICBvcHRzLnBhZ2VJZEtleSwgb3B0cy5kZWJ1Z2dlclR5cGUsIG9wdHMub2JqSWQsIG9wdHMuZm4sXG4gICAgICAgICAgICAgIG9wdHMuYXJncyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlICdzZXRVcmwnOlxuICAgICAgY21kID0gc2V0VXJsKG9wdHMuY29ubklkLCBvcHRzLnNlbmRlcklkLCBvcHRzLmFwcElkS2V5LCBvcHRzLnBhZ2VJZEtleSxcbiAgICAgICAgICAgICAgb3B0cy5kZWJ1Z2dlclR5cGUsIG9wdHMudXJsKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2VuYWJsZVBhZ2UnOlxuICAgICAgY21kID0gZW5hYmxlUGFnZShvcHRzLmNvbm5JZCwgb3B0cy5zZW5kZXJJZCwgb3B0cy5hcHBJZEtleSxcbiAgICAgICAgICAgICAgb3B0cy5wYWdlSWRLZXksIG9wdHMuZGVidWdnZXJUeXBlKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3N0YXJ0VGltZWxpbmUnOlxuICAgICAgY21kID0gc3RhcnRUaW1lbGluZShvcHRzLmNvbm5JZCwgb3B0cy5zZW5kZXJJZCwgb3B0cy5hcHBJZEtleSxcbiAgICAgICAgICAgICAgb3B0cy5wYWdlSWRLZXksIG9wdHMuZGVidWdnZXJUeXBlKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ3N0b3BUaW1lbGluZSc6XG4gICAgICBjbWQgPSBzdG9wVGltZWxpbmUob3B0cy5jb25uSWQsIG9wdHMuc2VuZGVySWQsIG9wdHMuYXBwSWRLZXksXG4gICAgICAgICAgICAgIG9wdHMucGFnZUlkS2V5LCBvcHRzLmRlYnVnZ2VyVHlwZSk7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGNvbW1hbmQ6ICR7Y29tbWFuZH1gKTtcbiAgfVxuXG4gIHJldHVybiBjbWQ7XG59XG4iXX0=