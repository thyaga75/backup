'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _remoteDebugger = require('./remote-debugger');

var _remoteMessages = require('./remote-messages');

var _remoteMessages2 = _interopRequireDefault(_remoteMessages);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var WebKitRpcClient = (function (_events$EventEmitter) {
  _inherits(WebKitRpcClient, _events$EventEmitter);

  function WebKitRpcClient(host) {
    var port = arguments.length <= 1 || arguments[1] === undefined ? _remoteDebugger.REMOTE_DEBUGGER_PORT : arguments[1];

    _classCallCheck(this, WebKitRpcClient);

    _get(Object.getPrototypeOf(WebKitRpcClient.prototype), 'constructor', this).call(this);

    this.host = host;
    this.port = port;

    this.curMsgId = 0;

    this.dataHandlers = {};
    this.dataMethods = {};
    this.errorHandlers = {};

    this.setHandlers();
  }

  _createClass(WebKitRpcClient, [{
    key: 'connect',
    value: function connect(pageId) {
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function callee$2$0(resolve, reject) {
              var url;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    url = 'ws://' + this.host + ':' + this.port + '/devtools/page/' + pageId;

                    this.pageIdKey = pageId;

                    // create and set up socket with appropriate event handlers
                    this.socket = new _ws2['default'](url);
                    this.socket.on('open', function () {
                      _logger2['default'].debug('WebKit debugger web socket connected to url: ' + url);
                      _this.connected = true;
                      resolve();
                    });
                    this.socket.on('close', function () {
                      _logger2['default'].debug('WebKit remote debugger socket disconnected');
                      _this.connected = false;
                    });
                    this.socket.on('error', function (exception) {
                      if (_this.connected) {
                        _logger2['default'].debug('WebKit debugger web socket error: ' + exception.message);
                        _this.connected = false;
                      }

                      reject(exception);
                    });
                    this.socket.on('message', this.receive.bind(this));

                  case 7:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      _logger2['default'].debug('Disconnecting from WebKit remote debugger');
      if (this.isConnected()) {
        this.socket.close(1001);
      }
      this.connected = false;
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return this.socket !== null && this.connected;
    }
  }, {
    key: 'send',
    value: function send(command) {
      var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var data, id;
      return _regeneratorRuntime.async(function send$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            data = (0, _remoteMessages2['default'])(command, _lodash2['default'].defaults({ connId: this.connId, senderId: this.senderId }, opts));

            _logger2['default'].debug('Sending WebKit data: ' + _lodash2['default'].truncate(JSON.stringify(data), 50));

            this.curMsgId++;
            data.id = this.curMsgId;

            id = this.curMsgId.toString();
            return context$2$0.abrupt('return', new _bluebird2['default'](function callee$2$0(resolve, reject) {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    // only resolve the send command when WebKit returns a response
                    // store the handler and the data sent
                    this.dataHandlers[id] = resolve;
                    this.dataMethods[id] = data.method;
                    this.errorHandlers[id] = reject;

                    // send the data
                    data = JSON.stringify(data);
                    this.socket.send(data, function (error) {
                      if (!_lodash2['default'].isUndefined(error) && !_lodash2['default'].isNull(error)) {
                        _logger2['default'].debug('WebKit socket error occurred: ' + error);
                        reject(new Error(error));
                      }
                    });

                  case 5:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3);
            }).then(function (res) {
              // no need to hold onto anything
              delete _this3.dataHandlers[id];
              delete _this3.dataMethods[id];
              delete _this3.errorHandlers[id];

              // and pass along the result
              return res;
            }));

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'receive',
    value: function receive(data) {
      _logger2['default'].debug('Receiving WebKit data: ' + _lodash2['default'].truncate(data, 50));

      data = JSON.parse(data);

      // we can get an error, or we can get a response that is an error
      if (data.wasThrown) {
        var message = data.result.value || data.result.description;
        var error = new Error(message);
        if (data.id && this.errorHandlers[data.id]) {
          this.errorHandlers[data.id](error);
          return;
        } else {
          // this should never happen, but log at least
          _logger2['default'].errorAndThrow(error);
        }
      }

      // when sending we set a data method and associated callback.
      // get that, or the generic (automatically sent, not associated
      // with a particular request) method
      var handlerFor = undefined;
      if (data.id && this.dataMethods[data.id]) {
        _logger2['default'].debug('Found handler for message \'' + data.id + '\'');
        handlerFor = this.dataMethods[data.id];
      } else {
        _logger2['default'].debug('Did not find handler for message');
        handlerFor = data.method;
      }

      if (!handlerFor) {
        _logger2['default'].debug('Received an invalid method: ' + data.method);
        return;
      }
      if (_lodash2['default'].has(this.handlers, handlerFor)) {
        this.handlers[handlerFor](data);
      } else {
        _logger2['default'].debug('WebKit debugger got a message for \'' + handlerFor + '\' ' + 'and have no handler, doing nothing.');
      }
    }
  }, {
    key: 'setHandlers',
    value: function setHandlers() {
      var _this4 = this;

      this.handlers = {
        'Runtime.evaluate': function RuntimeEvaluate(data) {
          var msgId = data.id;
          if (data.error) {
            _this4.errorHandlers[msgId](data.error);
          }

          _this4.dataHandlers[msgId](data.result);
        },
        'Page.navigate': function PageNavigate(data) {
          _logger2['default'].debug('Received page navigated message: ' + JSON.stringify(data));
          var msgId = data.id;
          if (data.error) {
            _this4.errorHandlers[msgId](data.error);
          }

          _this4.dataHandlers[msgId](data.result);
        },
        'Profiler.resetProfiles': function ProfilerResetProfiles() {
          _logger2['default'].debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');
        },
        'Timeline.eventRecorded': function TimelineEventRecorded(data) {
          _this4.timelineEventHandler(data.result);
        }
      };
    }
  }, {
    key: 'setTimelineEventHandler',
    value: function setTimelineEventHandler(timelineEventHandler) {
      this.timelineEventHandler = timelineEventHandler;
      this.messageHandler.setTimelineEventHandler(timelineEventHandler);
    }
  }]);

  return WebKitRpcClient;
})(_events2['default'].EventEmitter);

exports['default'] = WebKitRpcClient;
module.exports = exports['default'];

// we will only resolve this call when the socket is open
// WebKit url
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBQWdCLFVBQVU7Ozs7OEJBQ1csbUJBQW1COzs4QkFDM0IsbUJBQW1COzs7O2tCQUMxQixJQUFJOzs7O3dCQUNOLFVBQVU7Ozs7c0JBQ2hCLFFBQVE7Ozs7c0JBQ0gsUUFBUTs7OztJQUdOLGVBQWU7WUFBZixlQUFlOztBQUN0QixXQURPLGVBQWUsQ0FDckIsSUFBSSxFQUErQjtRQUE3QixJQUFJOzswQkFESixlQUFlOztBQUVoQywrQkFGaUIsZUFBZSw2Q0FFeEI7O0FBRVIsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7O0FBRWpCLFFBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDOztBQUVsQixRQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztBQUN2QixRQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQztBQUN0QixRQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQzs7QUFFeEIsUUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0dBQ3BCOztlQWRrQixlQUFlOztXQWdCcEIsaUJBQUMsTUFBTTs7Ozs7O2dEQUNaLDBCQUFZLG9CQUFPLE9BQU8sRUFBRSxNQUFNO2tCQUduQyxHQUFHOzs7Ozs7QUFBSCx1QkFBRyxhQUFXLElBQUksQ0FBQyxJQUFJLFNBQUksSUFBSSxDQUFDLElBQUksdUJBQWtCLE1BQU07O0FBQ2hFLHdCQUFJLENBQUMsU0FBUyxHQUFHLE1BQU0sQ0FBQzs7O0FBR3hCLHdCQUFJLENBQUMsTUFBTSxHQUFHLG9CQUFjLEdBQUcsQ0FBQyxDQUFDO0FBQ2pDLHdCQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsWUFBTTtBQUMzQiwwQ0FBSSxLQUFLLG1EQUFpRCxHQUFHLENBQUcsQ0FBQztBQUNqRSw0QkFBSyxTQUFT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LENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDdkM7QUFDRCxnQ0FBd0IsRUFBRSxpQ0FBTTtBQUM5Qiw4QkFBSSxLQUFLLENBQUMsMERBQTBELEdBQzFELCtCQUErQixDQUFDLENBQUM7U0FDNUM7QUFDRCxnQ0FBd0IsRUFBRSwrQkFBQyxJQUFJLEVBQUs7QUFDbEMsaUJBQUssb0JBQW9CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3hDO09BQ0YsQ0FBQztLQUNIOzs7V0FHdUIsaUNBQUMsb0JBQW9CLEVBQUU7QUFDN0MsVUFBSSxDQUFDLG9CQUFvQixHQUFHLG9CQUFvQixDQUFDO0FBQ2pELFVBQUksQ0FBQyxjQUFjLENBQUMsdUJBQXVCLENBQUMsb0JBQW9CLENBQUMsQ0FBQztLQUNuRTs7O1NBMUtrQixlQUFlO0dBQVMsb0JBQU8sWUFBWTs7cUJBQTNDLGVBQWUiLCJmaWxlIjoibGliL3dlYmtpdC1ycGMtY2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBSRU1PVEVfREVCVUdHRVJfUE9SVCB9IGZyb20gJy4vcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCBnZXRSZW1vdGVDb21tYW5kIGZyb20gJy4vcmVtb3RlLW1lc3NhZ2VzJztcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnd3MnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBldmVudHMgZnJvbSAnZXZlbnRzJztcblxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXZWJLaXRScGNDbGllbnQgZXh0ZW5kcyBldmVudHMuRXZlbnRFbWl0dGVyIHtcbiAgY29uc3RydWN0b3IgKGhvc3QsIHBvcnQgPSBSRU1PVEVfREVCVUdHRVJfUE9SVCkge1xuICAgIHN1cGVyKCk7XG5cbiAgICB0aGlzLmhvc3QgPSBob3N0O1xuICAgIHRoaXMucG9ydCA9IHBvcnQ7XG5cbiAgICB0aGlzLmN1ck1zZ0lkID0gMDtcblxuICAgIHRoaXMuZGF0YUhhbmRsZXJzID0ge307XG4gICAgdGhpcy5kYXRhTWV0aG9kcyA9IHt9O1xuICAgIHRoaXMuZXJyb3JIYW5kbGVycyA9IHt9O1xuXG4gICAgdGhpcy5zZXRIYW5kbGVycygpO1xuICB9XG5cbiAgYXN5bmMgY29ubmVjdCAocGFnZUlkKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIHdlIHdpbGwgb25seSByZXNvbHZlIHRoaXMgY2FsbCB3aGVuIHRoZSBzb2NrZXQgaXMgb3BlblxuICAgICAgLy8gV2ViS2l0IHVybFxuICAgICAgbGV0IHVybCA9IGB3czovLyR7dGhpcy5ob3N0fToke3RoaXMucG9ydH0vZGV2dG9vbHMvcGFnZS8ke3BhZ2VJZH1gO1xuICAgICAgdGhpcy5wYWdlSWRLZXkgPSBwYWdlSWQ7XG5cbiAgICAgIC8vIGNyZWF0ZSBhbmQgc2V0IHVwIHNvY2tldCB3aXRoIGFwcHJvcHJpYXRlIGV2ZW50IGhhbmRsZXJzXG4gICAgICB0aGlzLnNvY2tldCA9IG5ldyBXZWJTb2NrZXQodXJsKTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdvcGVuJywgKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoYFdlYktpdCBkZWJ1Z2dlciB3ZWIgc29ja2V0IGNvbm5lY3RlZCB0byB1cmw6ICR7dXJsfWApO1xuICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IHRydWU7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoJ1dlYktpdCByZW1vdGUgZGVidWdnZXIgc29ja2V0IGRpc2Nvbm5lY3RlZCcpO1xuICAgICAgICB0aGlzLmNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignZXJyb3InLCAoZXhjZXB0aW9uKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmNvbm5lY3RlZCkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2ViS2l0IGRlYnVnZ2VyIHdlYiBzb2NrZXQgZXJyb3I6ICR7ZXhjZXB0aW9uLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlamVjdChleGNlcHRpb24pO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnNvY2tldC5vbignbWVzc2FnZScsIHRoaXMucmVjZWl2ZS5iaW5kKHRoaXMpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGRpc2Nvbm5lY3QgKCkge1xuICAgIGxvZy5kZWJ1ZygnRGlzY29ubmVjdGluZyBmcm9tIFdlYktpdCByZW1vdGUgZGVidWdnZXInKTtcbiAgICBpZiAodGhpcy5pc0Nvbm5lY3RlZCgpKSB7XG4gICAgICB0aGlzLnNvY2tldC5jbG9zZSgxMDAxKTtcbiAgICB9XG4gICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIGlzQ29ubmVjdGVkICgpIHtcbiAgICByZXR1cm4gKHRoaXMuc29ja2V0ICE9PSBudWxsICYmIHRoaXMuY29ubmVjdGVkKTtcbiAgfVxuXG5cbiAgYXN5bmMgc2VuZCAoY29tbWFuZCwgb3B0cyA9IHt9KSB7XG4gICAgbGV0IGRhdGEgPSBnZXRSZW1vdGVDb21tYW5kKGNvbW1hbmQsIF8uZGVmYXVsdHMoe2Nvbm5JZDogdGhpcy5jb25uSWQsIHNlbmRlcklkOiB0aGlzLnNlbmRlcklkfSwgb3B0cykpO1xuXG4gICAgbG9nLmRlYnVnKGBTZW5kaW5nIFdlYktpdCBkYXRhOiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoZGF0YSksIDUwKX1gKTtcblxuICAgIHRoaXMuY3VyTXNnSWQrKztcbiAgICBkYXRhLmlkID0gdGhpcy5jdXJNc2dJZDtcblxuICAgIGxldCBpZCA9IHRoaXMuY3VyTXNnSWQudG9TdHJpbmcoKTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgLy8gb25seSByZXNvbHZlIHRoZSBzZW5kIGNvbW1hbmQgd2hlbiBXZWJLaXQgcmV0dXJucyBhIHJlc3BvbnNlXG4gICAgICAvLyBzdG9yZSB0aGUgaGFuZGxlciBhbmQgdGhlIGRhdGEgc2VudFxuICAgICAgdGhpcy5kYXRhSGFuZGxlcnNbaWRdID0gcmVzb2x2ZTtcbiAgICAgIHRoaXMuZGF0YU1ldGhvZHNbaWRdID0gZGF0YS5tZXRob2Q7XG4gICAgICB0aGlzLmVycm9ySGFuZGxlcnNbaWRdID0gcmVqZWN0O1xuXG4gICAgICAvLyBzZW5kIHRoZSBkYXRhXG4gICAgICBkYXRhID0gSlNPTi5zdHJpbmdpZnkoZGF0YSk7XG4gICAgICB0aGlzLnNvY2tldC5zZW5kKGRhdGEsIGZ1bmN0aW9uIChlcnJvcikge1xuICAgICAgICBpZiAoIV8uaXNVbmRlZmluZWQoZXJyb3IpICYmICFfLmlzTnVsbChlcnJvcikpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYFdlYktpdCBzb2NrZXQgZXJyb3Igb2NjdXJyZWQ6ICR7ZXJyb3J9YCk7XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihlcnJvcikpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KS50aGVuKChyZXMpID0+IHtcbiAgICAgIC8vIG5vIG5lZWQgdG8gaG9sZCBvbnRvIGFueXRoaW5nXG4gICAgICBkZWxldGUgdGhpcy5kYXRhSGFuZGxlcnNbaWRdO1xuICAgICAgZGVsZXRlIHRoaXMuZGF0YU1ldGhvZHNbaWRdO1xuICAgICAgZGVsZXRlIHRoaXMuZXJyb3JIYW5kbGVyc1tpZF07XG5cbiAgICAgIC8vIGFuZCBwYXNzIGFsb25nIHRoZSByZXN1bHRcbiAgICAgIHJldHVybiByZXM7XG4gICAgfSk7XG4gIH1cblxuXG4gIHJlY2VpdmUgKGRhdGEpIHtcbiAgICBsb2cuZGVidWcoYFJlY2VpdmluZyBXZWJLaXQgZGF0YTogJHtfLnRydW5jYXRlKGRhdGEsIDUwKX1gKTtcblxuICAgIGRhdGEgPSBKU09OLnBhcnNlKGRhdGEpO1xuXG4gICAgLy8gd2UgY2FuIGdldCBhbiBlcnJvciwgb3Igd2UgY2FuIGdldCBhIHJlc3BvbnNlIHRoYXQgaXMgYW4gZXJyb3JcbiAgICBpZiAoZGF0YS53YXNUaHJvd24pIHtcbiAgICAgIGxldCBtZXNzYWdlID0gZGF0YS5yZXN1bHQudmFsdWUgfHwgZGF0YS5yZXN1bHQuZGVzY3JpcHRpb247XG4gICAgICBsZXQgZXJyb3IgPSBuZXcgRXJyb3IobWVzc2FnZSk7XG4gICAgICBpZiAoZGF0YS5pZCAmJiB0aGlzLmVycm9ySGFuZGxlcnNbZGF0YS5pZF0pIHtcbiAgICAgICAgdGhpcy5lcnJvckhhbmRsZXJzW2RhdGEuaWRdKGVycm9yKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gdGhpcyBzaG91bGQgbmV2ZXIgaGFwcGVuLCBidXQgbG9nIGF0IGxlYXN0XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGVycm9yKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB3aGVuIHNlbmRpbmcgd2Ugc2V0IGEgZGF0YSBtZXRob2QgYW5kIGFzc29jaWF0ZWQgY2FsbGJhY2suXG4gICAgLy8gZ2V0IHRoYXQsIG9yIHRoZSBnZW5lcmljIChhdXRvbWF0aWNhbGx5IHNlbnQsIG5vdCBhc3NvY2lhdGVkXG4gICAgLy8gd2l0aCBhIHBhcnRpY3VsYXIgcmVxdWVzdCkgbWV0aG9kXG4gICAgbGV0IGhhbmRsZXJGb3I7XG4gICAgaWYgKGRhdGEuaWQgJiYgdGhpcy5kYXRhTWV0aG9kc1tkYXRhLmlkXSkge1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCBoYW5kbGVyIGZvciBtZXNzYWdlICcke2RhdGEuaWR9J2ApO1xuICAgICAgaGFuZGxlckZvciA9IHRoaXMuZGF0YU1ldGhvZHNbZGF0YS5pZF07XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZyhgRGlkIG5vdCBmaW5kIGhhbmRsZXIgZm9yIG1lc3NhZ2VgKTtcbiAgICAgIGhhbmRsZXJGb3IgPSBkYXRhLm1ldGhvZDtcbiAgICB9XG5cbiAgICBpZiAoIWhhbmRsZXJGb3IpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgYW4gaW52YWxpZCBtZXRob2Q6ICR7ZGF0YS5tZXRob2R9YCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChfLmhhcyh0aGlzLmhhbmRsZXJzLCBoYW5kbGVyRm9yKSkge1xuICAgICAgdGhpcy5oYW5kbGVyc1toYW5kbGVyRm9yXShkYXRhKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKGBXZWJLaXQgZGVidWdnZXIgZ290IGEgbWVzc2FnZSBmb3IgJyR7aGFuZGxlckZvcn0nIGAgK1xuICAgICAgICAgICAgICAgIGBhbmQgaGF2ZSBubyBoYW5kbGVyLCBkb2luZyBub3RoaW5nLmApO1xuICAgIH1cbiAgfVxuXG4gIHNldEhhbmRsZXJzICgpIHtcbiAgICB0aGlzLmhhbmRsZXJzID0ge1xuICAgICAgJ1J1bnRpbWUuZXZhbHVhdGUnOiAoZGF0YSkgPT4ge1xuICAgICAgICBsZXQgbXNnSWQgPSBkYXRhLmlkO1xuICAgICAgICBpZiAoZGF0YS5lcnJvcikge1xuICAgICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyc1ttc2dJZF0oZGF0YS5lcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmRhdGFIYW5kbGVyc1ttc2dJZF0oZGF0YS5yZXN1bHQpO1xuICAgICAgfSxcbiAgICAgICdQYWdlLm5hdmlnYXRlJzogKGRhdGEpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKGBSZWNlaXZlZCBwYWdlIG5hdmlnYXRlZCBtZXNzYWdlOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgICAgICBsZXQgbXNnSWQgPSBkYXRhLmlkO1xuICAgICAgICBpZiAoZGF0YS5lcnJvcikge1xuICAgICAgICAgIHRoaXMuZXJyb3JIYW5kbGVyc1ttc2dJZF0oZGF0YS5lcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmRhdGFIYW5kbGVyc1ttc2dJZF0oZGF0YS5yZXN1bHQpO1xuICAgICAgfSxcbiAgICAgICdQcm9maWxlci5yZXNldFByb2ZpbGVzJzogKCkgPT4ge1xuICAgICAgICBsb2cuZGVidWcoJ0RldmljZSBpcyB0ZWxsaW5nIHVzIHRvIHJlc2V0IHByb2ZpbGVzLiBTaG91bGQgcHJvYmFibHkgJyArXG4gICAgICAgICAgICAgICAgICAnZG8gc29tZSBraW5kIG9mIGNhbGxiYWNrIGhlcmUnKTtcbiAgICAgIH0sXG4gICAgICAnVGltZWxpbmUuZXZlbnRSZWNvcmRlZCc6IChkYXRhKSA9PiB7XG4gICAgICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIoZGF0YS5yZXN1bHQpO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuXG4gIHNldFRpbWVsaW5lRXZlbnRIYW5kbGVyICh0aW1lbGluZUV2ZW50SGFuZGxlcikge1xuICAgIHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIgPSB0aW1lbGluZUV2ZW50SGFuZGxlcjtcbiAgICB0aGlzLm1lc3NhZ2VIYW5kbGVyLnNldFRpbWVsaW5lRXZlbnRIYW5kbGVyKHRpbWVsaW5lRXZlbnRIYW5kbGVyKTtcbiAgfVxufVxuIl19