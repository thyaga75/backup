// The Command Proxy relays UIAuto message to and from Appium. It is also the
// UIAuto facade for Appium.
//
// The message route is the following:
// Appium <--> Command Proxy <--> Instruments
// The medium between Instruments and Command Proxy is the command-proxy-client
// script.
//
// Command Proxy --> Instruments message format: {cmd:"<CMD>"}
//
// Instruments --> Command Proxy message format:
// <one char message type>,<stringified json data>
// <stringified json data> format:
// {status:<status>, value:<result>}

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _uiautoResponse = require('./uiauto-response');

var _uiautoResponse2 = _interopRequireDefault(_uiautoResponse);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _through = require('through');

var _through2 = _interopRequireDefault(_through);

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _appiumSupport = require('appium-support');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _mobileJsonWireProtocol = require('mobile-json-wire-protocol');

var MORE_COMMAND = '#more';
var DEFAULT_INSTRUMENTS_SOCKET = '/tmp/instruments_sock';

var UIAutoClient = (function () {
  function UIAutoClient() {
    var sock = arguments.length <= 0 || arguments[0] === undefined ? '/tmp/instruments_sock' : arguments[0];

    _classCallCheck(this, UIAutoClient);

    this.curCommand = null;
    this.onReceiveCommand = null;
    this.commandQueue = [];
    this.sock = sock;
    this.socketServer = null;
    this.hasConnected = false;
    this.currentSocket = null;
  }

  _createClass(UIAutoClient, [{
    key: 'sendCommand',
    value: function sendCommand(cmd) {
      var cmdPromise;
      return _regeneratorRuntime.async(function sendCommand$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmdPromise = new _bluebird2['default'](function (resolve, reject) {
              var cb = function cb(result) {
                // get back a JSONWP object, so decode and
                // just return the value
                if (result.status === 0) {
                  resolve(result.value);
                } else if (result.status) {
                  var jsonwpError = (0, _mobileJsonWireProtocol.errorFromCode)(result.status, result.value);
                  reject(jsonwpError);
                } else {
                  reject(new Error(result.value));
                }
              };
              _this.commandQueue.push({ cmd: cmd, cb: cb });
              if (_lodash2['default'].isFunction(_this.onReceiveCommand)) {
                _this.onReceiveCommand();
              }
            });
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(cmdPromise);

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /*
     * Returns true if the resulting connecting is the first
     * socket connection for this proxy session
     */
  }, {
    key: 'start',
    value: function start() {
      var connectedPromise;
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            connectedPromise = new _bluebird2['default'](function (resolve) {
              var response = new _uiautoResponse2['default']();
              _this2.socketServer = _net2['default'].createServer({ allowHalfOpen: true }, function (conn) {
                if (!_this2.hasConnected) {
                  _this2.hasConnected = true;
                  _logger2['default'].info('Instruments is ready to receive commands');
                  resolve(true);
                }
                // up with strings! down with buffers!
                conn.setEncoding('utf8');

                // keep track of this so that we can destroy the socket
                // when shutting down
                _this2.currentSocket = conn;

                conn.on('close', function () {
                  _this2.currentSocket = null;
                });

                // all data goes into buffer
                conn.pipe((0, _through2['default'])(function (data) {
                  _logger2['default'].debug('Socket data received (' + data.length + ' bytes)');
                  response.addData(data);
                }));

                // when all data is in, deal with it
                conn.on('end', function () {
                  // if we are midway through handling a command
                  // we want to try out the data, getting more if necessary
                  if (_this2.curCommand) {
                    var result = response.getResult();
                    if (result && !result.needsMoreData) {
                      // if we're done altogether, call the callback associated with the command
                      _this2.curCommand.cb(result);
                      _this2.curCommand = null;
                    } else {
                      if (result) {
                        _logger2['default'].debug('Not the last chunk, trying to get more');
                      } else {
                        _logger2['default'].debug('No result received. Continuing to try to get more');
                      }
                      // add a command to the queue, to request more data
                      _this2.commandQueue.unshift({ cmd: MORE_COMMAND, cb: _this2.curCommand.cb });
                    }
                  } else {
                    _logger2['default'].debug('Got a result when we were not expecting one! Ignoring it');
                    response.resetBuffer();
                  }

                  // set up a callback to handle the next command
                  var onReceiveCommand = function onReceiveCommand() {
                    _this2.onReceiveCommand = null;
                    _this2.curCommand = _this2.commandQueue.shift();
                    _logger2['default'].debug('Sending command to instruments: ' + _this2.curCommand.cmd);
                    conn.write(JSON.stringify({ cmd: _this2.curCommand.cmd }));
                    conn.end();
                  };
                  if (_this2.commandQueue.length) {
                    onReceiveCommand();
                  } else {
                    _this2.onReceiveCommand = onReceiveCommand;
                  }
                });
              });

              _this2.socketServer.on('close', function () {
                _logger2['default'].debug('Instruments socket server was closed');
              });
            });
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(this.sock));

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].dirname(this.sock)));

          case 5:

            this.socketServer.listen(this.sock);
            _logger2['default'].debug('Instruments socket server started at ' + this.sock);

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(connectedPromise);

          case 9:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'shutdown',
    value: function shutdown() {
      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // make sure clear out command cbs so we can't have any lingering cbs
            // if a socket request makes it through after exit somehow
            this.curCommand = null;
            this.onReceiveCommand = null;

            if (this.currentSocket) {
              _logger2['default'].debug('Destroying instruments client socket.');
              this.currentSocket.end();
              this.currentSocket.destroy();
              this.currentSocket = null;
            }

            if (!this.socketServer) {
              context$2$0.next = 8;
              break;
            }

            _logger2['default'].debug('Closing socket server.');
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(_bluebird2['default'].promisify(this.socketServer.close, this.socketServer)());

          case 7:
            this.socketServer = null;

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'safeShutdown',
    value: function safeShutdown() {
      return _regeneratorRuntime.async(function safeShutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Shutting down command proxy and ignoring any errors');
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.shutdown());

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].debug('Ignoring error: ' + context$2$0.t0);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }]);

  return UIAutoClient;
})();

exports.UIAutoClient = UIAutoClient;
exports.DEFAULT_INSTRUMENTS_SOCKET = DEFAULT_INSTRUMENTS_SOCKET;
exports['default'] = UIAutoClient;

// only resolve the promise when the server that is created actually connects

// remove socket file if it currently exists

// create the new socket file
//# sourceMappingURL=data:application/json;base64,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QUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO2FBQzNCOztpQkFDRyxJQUFJLENBQUMsWUFBWTs7Ozs7QUFDbkIsZ0NBQUksS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUM7OzZDQUM5QixBQUFDLHNCQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUc7OztBQUNqRSxnQkFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7Ozs7Ozs7S0FFNUI7OztXQUVrQjs7OztBQUNqQixnQ0FBSSxLQUFLLENBQUMscURBQXFELENBQUMsQ0FBQzs7OzZDQUV6RCxJQUFJLENBQUMsUUFBUSxFQUFFOzs7Ozs7Ozs7O0FBRXJCLGdDQUFJLEtBQUsscUNBQTBCLENBQUM7Ozs7Ozs7S0FFdkM7OztTQW5KRyxZQUFZOzs7UUFzSlQsWUFBWSxHQUFaLFlBQVk7UUFBRSwwQkFBMEIsR0FBMUIsMEJBQTBCO3FCQUNsQyxZQUFZIiwiZmlsZSI6ImxpYi91aWF1dG8tY2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVGhlIENvbW1hbmQgUHJveHkgcmVsYXlzIFVJQXV0byBtZXNzYWdlIHRvIGFuZCBmcm9tIEFwcGl1bS4gSXQgaXMgYWxzbyB0aGVcbi8vIFVJQXV0byBmYWNhZGUgZm9yIEFwcGl1bS5cbi8vXG4vLyBUaGUgbWVzc2FnZSByb3V0ZSBpcyB0aGUgZm9sbG93aW5nOlxuLy8gQXBwaXVtIDwtLT4gQ29tbWFuZCBQcm94eSA8LS0+IEluc3RydW1lbnRzXG4vLyBUaGUgbWVkaXVtIGJldHdlZW4gSW5zdHJ1bWVudHMgYW5kIENvbW1hbmQgUHJveHkgaXMgdGhlIGNvbW1hbmQtcHJveHktY2xpZW50XG4vLyBzY3JpcHQuXG4vL1xuLy8gQ29tbWFuZCBQcm94eSAtLT4gSW5zdHJ1bWVudHMgbWVzc2FnZSBmb3JtYXQ6IHtjbWQ6XCI8Q01EPlwifVxuLy9cbi8vIEluc3RydW1lbnRzIC0tPiBDb21tYW5kIFByb3h5IG1lc3NhZ2UgZm9ybWF0OlxuLy8gPG9uZSBjaGFyIG1lc3NhZ2UgdHlwZT4sPHN0cmluZ2lmaWVkIGpzb24gZGF0YT5cbi8vIDxzdHJpbmdpZmllZCBqc29uIGRhdGE+IGZvcm1hdDpcbi8vIHtzdGF0dXM6PHN0YXR1cz4sIHZhbHVlOjxyZXN1bHQ+fVxuXG5pbXBvcnQgVUlBdXRvUmVzcG9uc2UgZnJvbSAnLi91aWF1dG8tcmVzcG9uc2UnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgdGhyb3VnaCBmcm9tICd0aHJvdWdoJztcbmltcG9ydCBuZXQgZnJvbSAnbmV0JztcbmltcG9ydCB7IG1rZGlycCwgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvckZyb21Db2RlIH0gZnJvbSAnbW9iaWxlLWpzb24td2lyZS1wcm90b2NvbCc7XG5cblxuY29uc3QgTU9SRV9DT01NQU5EID0gJyNtb3JlJztcbmNvbnN0IERFRkFVTFRfSU5TVFJVTUVOVFNfU09DS0VUID0gJy90bXAvaW5zdHJ1bWVudHNfc29jayc7XG5cbmNsYXNzIFVJQXV0b0NsaWVudCB7XG4gIGNvbnN0cnVjdG9yIChzb2NrID0gJy90bXAvaW5zdHJ1bWVudHNfc29jaycpIHtcbiAgICB0aGlzLmN1ckNvbW1hbmQgPSBudWxsO1xuICAgIHRoaXMub25SZWNlaXZlQ29tbWFuZCA9IG51bGw7XG4gICAgdGhpcy5jb21tYW5kUXVldWUgPSBbXTtcbiAgICB0aGlzLnNvY2sgPSBzb2NrO1xuICAgIHRoaXMuc29ja2V0U2VydmVyID0gbnVsbDtcbiAgICB0aGlzLmhhc0Nvbm5lY3RlZCA9IGZhbHNlO1xuICAgIHRoaXMuY3VycmVudFNvY2tldCA9IG51bGw7XG4gIH1cblxuICBhc3luYyBzZW5kQ29tbWFuZCAoY21kKSB7XG4gICAgbGV0IGNtZFByb21pc2UgPSBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBsZXQgY2IgPSAocmVzdWx0KSA9PiB7XG4gICAgICAgIC8vIGdldCBiYWNrIGEgSlNPTldQIG9iamVjdCwgc28gZGVjb2RlIGFuZFxuICAgICAgICAvLyBqdXN0IHJldHVybiB0aGUgdmFsdWVcbiAgICAgICAgaWYgKHJlc3VsdC5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdC52YWx1ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzdWx0LnN0YXR1cykge1xuICAgICAgICAgIGxldCBqc29ud3BFcnJvciA9IGVycm9yRnJvbUNvZGUocmVzdWx0LnN0YXR1cywgcmVzdWx0LnZhbHVlKTtcbiAgICAgICAgICByZWplY3QoanNvbndwRXJyb3IpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IocmVzdWx0LnZhbHVlKSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICB0aGlzLmNvbW1hbmRRdWV1ZS5wdXNoKHtjbWQsIGNifSk7XG4gICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMub25SZWNlaXZlQ29tbWFuZCkpIHtcbiAgICAgICAgdGhpcy5vblJlY2VpdmVDb21tYW5kKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGF3YWl0IGNtZFByb21pc2U7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHJlc3VsdGluZyBjb25uZWN0aW5nIGlzIHRoZSBmaXJzdFxuICAgKiBzb2NrZXQgY29ubmVjdGlvbiBmb3IgdGhpcyBwcm94eSBzZXNzaW9uXG4gICAqL1xuICBhc3luYyBzdGFydCAoKSB7XG4gICAgLy8gb25seSByZXNvbHZlIHRoZSBwcm9taXNlIHdoZW4gdGhlIHNlcnZlciB0aGF0IGlzIGNyZWF0ZWQgYWN0dWFsbHkgY29ubmVjdHNcbiAgICBsZXQgY29ubmVjdGVkUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlKSA9PiB7XG4gICAgICBsZXQgcmVzcG9uc2UgPSBuZXcgVUlBdXRvUmVzcG9uc2UoKTtcbiAgICAgIHRoaXMuc29ja2V0U2VydmVyID0gbmV0LmNyZWF0ZVNlcnZlcih7YWxsb3dIYWxmT3BlbjogdHJ1ZX0sIChjb25uKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5oYXNDb25uZWN0ZWQpIHtcbiAgICAgICAgICB0aGlzLmhhc0Nvbm5lY3RlZCA9IHRydWU7XG4gICAgICAgICAgbG9nLmluZm8oJ0luc3RydW1lbnRzIGlzIHJlYWR5IHRvIHJlY2VpdmUgY29tbWFuZHMnKTtcbiAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIC8vIHVwIHdpdGggc3RyaW5ncyEgZG93biB3aXRoIGJ1ZmZlcnMhXG4gICAgICAgIGNvbm4uc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcblxuICAgICAgICAvLyBrZWVwIHRyYWNrIG9mIHRoaXMgc28gdGhhdCB3ZSBjYW4gZGVzdHJveSB0aGUgc29ja2V0XG4gICAgICAgIC8vIHdoZW4gc2h1dHRpbmcgZG93blxuICAgICAgICB0aGlzLmN1cnJlbnRTb2NrZXQgPSBjb25uO1xuXG4gICAgICAgIGNvbm4ub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgIHRoaXMuY3VycmVudFNvY2tldCA9IG51bGw7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIGFsbCBkYXRhIGdvZXMgaW50byBidWZmZXJcbiAgICAgICAgY29ubi5waXBlKHRocm91Z2goKGRhdGEpID0+IHtcbiAgICAgICAgICBsb2cuZGVidWcoYFNvY2tldCBkYXRhIHJlY2VpdmVkICgke2RhdGEubGVuZ3RofSBieXRlcylgKTtcbiAgICAgICAgICByZXNwb25zZS5hZGREYXRhKGRhdGEpO1xuICAgICAgICB9KSk7XG5cbiAgICAgICAgLy8gd2hlbiBhbGwgZGF0YSBpcyBpbiwgZGVhbCB3aXRoIGl0XG4gICAgICAgIGNvbm4ub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAvLyBpZiB3ZSBhcmUgbWlkd2F5IHRocm91Z2ggaGFuZGxpbmcgYSBjb21tYW5kXG4gICAgICAgICAgLy8gd2Ugd2FudCB0byB0cnkgb3V0IHRoZSBkYXRhLCBnZXR0aW5nIG1vcmUgaWYgbmVjZXNzYXJ5XG4gICAgICAgICAgaWYgKHRoaXMuY3VyQ29tbWFuZCkge1xuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHJlc3BvbnNlLmdldFJlc3VsdCgpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCAmJiAhcmVzdWx0Lm5lZWRzTW9yZURhdGEpIHtcbiAgICAgICAgICAgICAgLy8gaWYgd2UncmUgZG9uZSBhbHRvZ2V0aGVyLCBjYWxsIHRoZSBjYWxsYmFjayBhc3NvY2lhdGVkIHdpdGggdGhlIGNvbW1hbmRcbiAgICAgICAgICAgICAgdGhpcy5jdXJDb21tYW5kLmNiKHJlc3VsdCk7XG4gICAgICAgICAgICAgIHRoaXMuY3VyQ29tbWFuZCA9IG51bGw7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgbG9nLmRlYnVnKCdOb3QgdGhlIGxhc3QgY2h1bmssIHRyeWluZyB0byBnZXQgbW9yZScpO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZygnTm8gcmVzdWx0IHJlY2VpdmVkLiBDb250aW51aW5nIHRvIHRyeSB0byBnZXQgbW9yZScpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIC8vIGFkZCBhIGNvbW1hbmQgdG8gdGhlIHF1ZXVlLCB0byByZXF1ZXN0IG1vcmUgZGF0YVxuICAgICAgICAgICAgICB0aGlzLmNvbW1hbmRRdWV1ZS51bnNoaWZ0KHtjbWQ6IE1PUkVfQ09NTUFORCwgY2I6IHRoaXMuY3VyQ29tbWFuZC5jYn0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoJ0dvdCBhIHJlc3VsdCB3aGVuIHdlIHdlcmUgbm90IGV4cGVjdGluZyBvbmUhIElnbm9yaW5nIGl0Jyk7XG4gICAgICAgICAgICByZXNwb25zZS5yZXNldEJ1ZmZlcigpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIHNldCB1cCBhIGNhbGxiYWNrIHRvIGhhbmRsZSB0aGUgbmV4dCBjb21tYW5kXG4gICAgICAgICAgbGV0IG9uUmVjZWl2ZUNvbW1hbmQgPSAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm9uUmVjZWl2ZUNvbW1hbmQgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy5jdXJDb21tYW5kID0gdGhpcy5jb21tYW5kUXVldWUuc2hpZnQoKTtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhgU2VuZGluZyBjb21tYW5kIHRvIGluc3RydW1lbnRzOiAke3RoaXMuY3VyQ29tbWFuZC5jbWR9YCk7XG4gICAgICAgICAgICBjb25uLndyaXRlKEpTT04uc3RyaW5naWZ5KHtjbWQ6IHRoaXMuY3VyQ29tbWFuZC5jbWR9KSk7XG4gICAgICAgICAgICBjb25uLmVuZCgpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgaWYgKHRoaXMuY29tbWFuZFF1ZXVlLmxlbmd0aCkge1xuICAgICAgICAgICAgb25SZWNlaXZlQ29tbWFuZCgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm9uUmVjZWl2ZUNvbW1hbmQgPSBvblJlY2VpdmVDb21tYW5kO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5zb2NrZXRTZXJ2ZXIub24oJ2Nsb3NlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICBsb2cuZGVidWcoJ0luc3RydW1lbnRzIHNvY2tldCBzZXJ2ZXIgd2FzIGNsb3NlZCcpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyByZW1vdmUgc29ja2V0IGZpbGUgaWYgaXQgY3VycmVudGx5IGV4aXN0c1xuICAgIGF3YWl0IGZzLnJpbXJhZih0aGlzLnNvY2spO1xuXG4gICAgLy8gY3JlYXRlIHRoZSBuZXcgc29ja2V0IGZpbGVcbiAgICBhd2FpdCBta2RpcnAocGF0aC5kaXJuYW1lKHRoaXMuc29jaykpO1xuXG4gICAgdGhpcy5zb2NrZXRTZXJ2ZXIubGlzdGVuKHRoaXMuc29jayk7XG4gICAgbG9nLmRlYnVnKGBJbnN0cnVtZW50cyBzb2NrZXQgc2VydmVyIHN0YXJ0ZWQgYXQgJHt0aGlzLnNvY2t9YCk7XG5cbiAgICByZXR1cm4gYXdhaXQgY29ubmVjdGVkUHJvbWlzZTtcbiAgfVxuXG4gIGFzeW5jIHNodXRkb3duICgpIHtcbiAgICAvLyBtYWtlIHN1cmUgY2xlYXIgb3V0IGNvbW1hbmQgY2JzIHNvIHdlIGNhbid0IGhhdmUgYW55IGxpbmdlcmluZyBjYnNcbiAgICAvLyBpZiBhIHNvY2tldCByZXF1ZXN0IG1ha2VzIGl0IHRocm91Z2ggYWZ0ZXIgZXhpdCBzb21laG93XG4gICAgdGhpcy5jdXJDb21tYW5kID0gbnVsbDtcbiAgICB0aGlzLm9uUmVjZWl2ZUNvbW1hbmQgPSBudWxsO1xuXG4gICAgaWYgKHRoaXMuY3VycmVudFNvY2tldCkge1xuICAgICAgbG9nLmRlYnVnKCdEZXN0cm95aW5nIGluc3RydW1lbnRzIGNsaWVudCBzb2NrZXQuJyk7XG4gICAgICB0aGlzLmN1cnJlbnRTb2NrZXQuZW5kKCk7XG4gICAgICB0aGlzLmN1cnJlbnRTb2NrZXQuZGVzdHJveSgpO1xuICAgICAgdGhpcy5jdXJyZW50U29ja2V0ID0gbnVsbDtcbiAgICB9XG4gICAgaWYgKHRoaXMuc29ja2V0U2VydmVyKSB7XG4gICAgICBsb2cuZGVidWcoJ0Nsb3Npbmcgc29ja2V0IHNlcnZlci4nKTtcbiAgICAgIGF3YWl0IChCLnByb21pc2lmeSh0aGlzLnNvY2tldFNlcnZlci5jbG9zZSwgdGhpcy5zb2NrZXRTZXJ2ZXIpKSgpO1xuICAgICAgdGhpcy5zb2NrZXRTZXJ2ZXIgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNhZmVTaHV0ZG93biAoKSB7XG4gICAgbG9nLmRlYnVnKCdTaHV0dGluZyBkb3duIGNvbW1hbmQgcHJveHkgYW5kIGlnbm9yaW5nIGFueSBlcnJvcnMnKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5zaHV0ZG93bigpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmRlYnVnKGBJZ25vcmluZyBlcnJvcjogJHtlcnJ9YCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IFVJQXV0b0NsaWVudCwgREVGQVVMVF9JTlNUUlVNRU5UU19TT0NLRVQgfTtcbmV4cG9ydCBkZWZhdWx0IFVJQXV0b0NsaWVudDtcbiJdfQ==