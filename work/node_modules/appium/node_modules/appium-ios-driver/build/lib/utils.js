'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumSupport = require('appium-support');

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _iosAppUtils = require('ios-app-utils');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _teen_process = require('teen_process');

var _commandsSafari = require('./commands/safari');

var _safariLauncher = require('./safari-launcher');

var rootDir = _path2['default'].resolve(__dirname, '..', '..');

function prepareIosOpts(opts) {
  var pv;
  return _regeneratorRuntime.async(function prepareIosOpts$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        opts.backendRetries = 4;
        opts.withoutDelay = !opts.nativeInstrumentsLib;
        opts.reset = !opts.noReset;
        opts.initialOrientation = opts.deviceOrientation || opts.orientation || "PORTRAIT";
        opts.useRobot = opts.robotPort > 0;
        opts.robotUrl = opts.useRobot ? 'http://' + opts.robotAddress + ':' + opts.robotPort : null;

        if (!(opts.locationServicesAuthorized && !opts.bundleId)) {
          context$1$0.next = 8;
          break;
        }

        throw new Error("You must set the bundleId cap if using locationServicesEnabled");

      case 8:
        context$1$0.t0 = opts.platformVersion;

        if (context$1$0.t0) {
          context$1$0.next = 13;
          break;
        }

        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getMaxIOSSDK());

      case 12:
        context$1$0.t0 = context$1$0.sent;

      case 13:
        opts.platformVersion = context$1$0.t0;
        pv = parseFloat(opts.platformVersion);

        if (pv < 8) {
          _logger2['default'].warn('iOS version ' + opts.platformVersion + ' support has been ' + 'deprecated and will be removed in a future version of ' + 'Appium.');
        }
        opts.localizableStringsDir = opts.localizableStringsDir || 'en.lproj';
        opts.autoAcceptAlerts = _lodash2['default'].isNull(opts.autoAcceptAlerts) || _lodash2['default'].isUndefined(opts.autoAcceptAlerts) ? false : opts.autoAcceptAlerts;
        opts.autoDismissAlerts = _lodash2['default'].isNull(opts.autoDismissAlerts) || _lodash2['default'].isUndefined(opts.autoDismissAlerts) ? false : opts.autoDismissAlerts;

        if ((opts.browserName || '').toLowerCase() === 'safari' || (opts.app || '').toLowerCase() === 'safari' || (opts.bundleId || '').toLowerCase() === _commandsSafari.SAFARI_BUNDLE) {
          // preparing a safari session
          if (opts.udid) {
            opts.app = _safariLauncher.SAFARI_LAUNCHER_APP_FILE;
            opts.bundleId = _safariLauncher.SAFARI_LAUNCHER_BUNDLE;
          } else {
            if (parseFloat(opts.platformVersion) <= 8) {
              // make sure args.app has something in it so we get to the right spots
              // in moveBuiltInApp()
              opts.app = 'safari';
              opts.bundleId = null;
            } else {
              opts.app = null;
              opts.bundleId = _commandsSafari.SAFARI_BUNDLE;
            }
          }
          opts.safari = true;
        }

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function appIsPackageOrBundle(app) {
  return (/^([a-zA-Z0-9\-_]+\.[a-zA-Z0-9\-_]+)+$/.test(app)
  );
}

function removeInstrumentsSocket(sock) {
  return _regeneratorRuntime.async(function removeInstrumentsSocket$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug("Removing any remaining instruments sockets");
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(sock));

      case 3:
        _logger2['default'].debug('Cleaned up instruments socket ' + sock);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getAndCheckXcodeVersion(caps) {
  var versionNumber, minorVersion, pv;
  return _regeneratorRuntime.async(function getAndCheckXcodeVersion$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        versionNumber = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getVersion());

      case 4:
        versionNumber = context$1$0.sent;
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].error("Could not determine Xcode version.");
        throw context$1$0.t0;

      case 11:
        minorVersion = parseFloat(versionNumber.slice(0, 3));
        pv = parseFloat(caps.platformVersion);

        // we deprecate Xcodes < 6.3, except for iOS 8.0 in which case we
        // support Xcode 6.0 as well
        if (minorVersion < 6.3 && !(minorVersion === 6.0 && pv === 8.0)) {
          _logger2['default'].warn('Xcode version \'' + versionNumber + '\'. Support for Xcode ' + (versionNumber + ' has been deprecated and will be removed ') + 'in a future version. Please upgrade to version 6.3 or ' + 'higher (or version 6.0.1 for iOS 8.0)');
        }
        return context$1$0.abrupt('return', versionNumber);

      case 15:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
}

function getAndCheckIosSdkVersion() {
  var versionNumber;
  return _regeneratorRuntime.async(function getAndCheckIosSdkVersion$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        versionNumber = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getMaxIOSSDK());

      case 4:
        versionNumber = context$1$0.sent;
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].error("Could not determine iOS SDK version");
        throw context$1$0.t0;

      case 11:
        return context$1$0.abrupt('return', versionNumber);

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
}

function getSimForDeviceString(dString, availDevices) {
  var matchedDevice = null;
  var matchedUdid = null;
  _lodash2['default'].each(availDevices, function (device) {
    if (device.indexOf(dString) !== -1) {
      matchedDevice = device;
      try {
        matchedUdid = /.+\[([^\]]+)\]/.exec(device)[1];
      } catch (e) {
        matchedUdid = null;
      }
    }
  });
  return [matchedDevice, matchedUdid];
}

function detectUdid(caps) {
  var cmd, args, udid, _ref, stdout;

  return _regeneratorRuntime.async(function detectUdid$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(caps.udid !== null && caps.udid === "auto")) {
          context$1$0.next = 34;
          break;
        }

        _logger2['default'].debug("Auto-detecting iOS udid...");
        cmd = undefined, args = [];
        context$1$0.prev = 3;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('idevice_id'));

      case 6:
        cmd = context$1$0.sent;

        args.push('-l');
        context$1$0.next = 13;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](3);

        cmd = require.resolve('udidetect');

      case 13:
        udid = undefined;
        context$1$0.prev = 14;
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(cmd, args, { timeout: 3000 }));

      case 17:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;

        udid = stdout.split("\n")[0];
        context$1$0.next = 26;
        break;

      case 22:
        context$1$0.prev = 22;
        context$1$0.t1 = context$1$0['catch'](14);

        _logger2['default'].error("Error detecting udid");
        throw context$1$0.t1;

      case 26:
        if (!(udid && udid.length > 2)) {
          context$1$0.next = 31;
          break;
        }

        caps.udid = udid;
        _logger2['default'].debug('Detected udid as \'' + caps.udid + '\'');
        context$1$0.next = 32;
        break;

      case 31:
        throw new Error("Could not detect udid.");

      case 32:
        context$1$0.next = 35;
        break;

      case 34:
        _logger2['default'].debug("Not auto-detecting udid.");

      case 35:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 10], [14, 22]]);
}

function parseLocalizableStrings(opts) {
  var language, stringFile, strings, obj;
  return _regeneratorRuntime.async(function parseLocalizableStrings$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(_lodash2['default'].isNull(opts.app) || _lodash2['default'].isUndefined(opts.app))) {
          context$1$0.next = 3;
          break;
        }

        _logger2['default'].debug("Localizable.strings is not currently supported when using real devices.");
        return context$1$0.abrupt('return');

      case 3:
        language = opts.language;
        stringFile = opts.stringFile || "Localizable.strings";
        strings = null;

        if (!language) {
          context$1$0.next = 15;
          break;
        }

        strings = _path2['default'].resolve(opts.app, language + '.lproj', stringFile);
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(strings));

      case 10:
        if (context$1$0.sent) {
          context$1$0.next = 13;
          break;
        }

        _logger2['default'].debug('No strings file \'' + stringFile + '\' for language \'' + language + '\', getting default strings');
        strings = _path2['default'].resolve(opts.app, stringFile);

      case 13:
        context$1$0.next = 17;
        break;

      case 15:
        _logger2['default'].debug('No language specified. Using default strings');
        strings = _path2['default'].resolve(opts.app, stringFile);

      case 17:
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(strings));

      case 19:
        if (context$1$0.sent) {
          context$1$0.next = 21;
          break;
        }

        if (opts.localizableStringsDir) {
          _logger2['default'].debug('Strings file not found. Looking in \'' + opts.localizableStringsDir + '\' directory');
          strings = _path2['default'].resolve(opts.app, opts.localizableStringsDir, stringFile);
        } else {
          strings = null;
        }

      case 21:
        context$1$0.t0 = !strings;

        if (context$1$0.t0) {
          context$1$0.next = 26;
          break;
        }

        context$1$0.next = 25;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(strings));

      case 25:
        context$1$0.t0 = !context$1$0.sent;

      case 26:
        if (!context$1$0.t0) {
          context$1$0.next = 29;
          break;
        }

        _logger2['default'].warn('Could not file localizable strings file \'' + stringFile + '\'!');
        return context$1$0.abrupt('return');

      case 29:
        obj = undefined;
        context$1$0.prev = 30;
        context$1$0.next = 33;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.parsePlistFile(strings));

      case 33:
        obj = context$1$0.sent;

        _logger2['default'].debug('Parsed app \'' + stringFile + '\'');
        opts.localizableStrings = obj;
        return context$1$0.abrupt('return', obj);

      case 39:
        context$1$0.prev = 39;
        context$1$0.t1 = context$1$0['catch'](30);

        _logger2['default'].warn('Could not parse app \'' + stringFile + '\' assuming it does not exist');

      case 42:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[30, 39]]);
}

function setBundleIdFromApp(caps) {
  return _regeneratorRuntime.async(function setBundleIdFromApp$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (caps.bundleId) {
          context$1$0.next = 12;
          break;
        }

        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _iosAppUtils.extractBundleId)(caps.app));

      case 4:
        caps.bundleId = context$1$0.sent;

        _logger2['default'].info('Extracted bundleID: ' + caps.bundleId + ' from app: ' + caps.app);
        context$1$0.next = 12;
        break;

      case 8:
        context$1$0.prev = 8;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].error("Could not set the bundleId from app.");
        throw context$1$0.t0;

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 8]]);
}

function shouldPrelaunchSimulator(caps, iosSdkVersion) {
  var shouldPrelaunch = false;

  if (caps.defaultDevice || iosSdkVersion >= 7.1) {
    if (this.iosSdkVersion >= 7.1) {
      _logger2['default'].debug("We're on iOS7.1+ so forcing defaultDevice on");
    } else {
      _logger2['default'].debug("User specified default device, letting instruments launch it");
    }
  } else {
    shouldPrelaunch = true;
  }
  return shouldPrelaunch;
}

function setDeviceTypeInInfoPlist(app, deviceString) {
  var plistFile, isiPhone, deviceTypeCode;
  return _regeneratorRuntime.async(function setDeviceTypeInInfoPlist$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(_lodash2['default'].isNull(app) || _lodash2['default'].isUndefined(app))) {
          context$1$0.next = 2;
          break;
        }

        return context$1$0.abrupt('return');

      case 2:
        plistFile = _path2['default'].resolve(app, "Info.plist");
        isiPhone = deviceString.toLowerCase().indexOf("ipad") === -1;
        deviceTypeCode = isiPhone ? 1 : 2;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.updatePlistFile(plistFile, { UIDeviceFamily: [deviceTypeCode] }));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function unwrapEl(el) {
  if (typeof el === 'object' && el.ELEMENT) {
    return el.ELEMENT;
  }
  return el;
}

exports['default'] = { rootDir: rootDir, removeInstrumentsSocket: removeInstrumentsSocket, getAndCheckXcodeVersion: getAndCheckXcodeVersion, prepareIosOpts: prepareIosOpts,
  appIsPackageOrBundle: appIsPackageOrBundle, getAndCheckIosSdkVersion: getAndCheckIosSdkVersion, detectUdid: detectUdid, parseLocalizableStrings: parseLocalizableStrings,
  setBundleIdFromApp: setBundleIdFromApp, shouldPrelaunchSimulator: shouldPrelaunchSimulator, setDeviceTypeInInfoPlist: setDeviceTypeInInfoPlist,
  getSimForDeviceString: getSimForDeviceString, unwrapEl: unwrapEl };
module.exports = exports['default'];

// This method will try to extract the bundleId from the app
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OzZCQUEwQixnQkFBZ0I7OzJCQUN4QixjQUFjOzs7OzJCQUNBLGVBQWU7O3NCQUM1QixVQUFVOzs7O29CQUNaLE1BQU07Ozs7c0JBQ1QsUUFBUTs7Ozs0QkFDRCxjQUFjOzs4QkFDTCxtQkFBbUI7OzhCQUNnQixtQkFBbUI7O0FBR3BGLElBQU0sT0FBTyxHQUFHLGtCQUFLLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDOztBQUVwRCxTQUFlLGNBQWMsQ0FBRSxJQUFJO01BZTdCLEVBQUU7Ozs7QUFkTixZQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQztBQUN4QixZQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDO0FBQy9DLFlBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO0FBQzNCLFlBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsaUJBQWlCLElBQ3RCLElBQUksQ0FBQyxXQUFXLElBQ2hCLFVBQVUsQ0FBQztBQUNyQyxZQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO0FBQ25DLFlBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsZUFDakIsSUFBSSxDQUFDLFlBQVksU0FBSSxJQUFJLENBQUMsU0FBUyxHQUFLLElBQUksQ0FBQzs7Y0FDckQsSUFBSSxDQUFDLDBCQUEwQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQTs7Ozs7Y0FDN0MsSUFBSSxLQUFLLENBQUMsZ0VBQWdFLENBQUM7Ozt5QkFHNUQsSUFBSSxDQUFDLGVBQWU7Ozs7Ozs7O3lDQUFVLHlCQUFNLFlBQVksRUFBRTs7Ozs7O0FBQXpFLFlBQUksQ0FBQyxlQUFlO0FBQ2hCLFVBQUUsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQzs7QUFDekMsWUFBSSxFQUFFLEdBQUcsQ0FBQyxFQUFFO0FBQ1YsOEJBQU8sSUFBSSxDQUFDLGlCQUFlLElBQUksQ0FBQyxlQUFlLGtGQUNxQixZQUMvQyxDQUFDLENBQUM7U0FDeEI7QUFDRCxZQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixJQUFJLFVBQVUsQ0FBQztBQUN0RSxZQUFJLENBQUMsZ0JBQWdCLEdBQUcsb0JBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLG9CQUFFLFdBQVcsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDO0FBQ2hJLFlBQUksQ0FBQyxpQkFBaUIsR0FBRyxvQkFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksb0JBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEtBQUssR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUM7O0FBRXBJLFlBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQSxDQUFFLFdBQVcsRUFBRSxLQUFLLFFBQVEsSUFDbkQsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQSxDQUFFLFdBQVcsRUFBRSxLQUFLLFFBQVEsSUFDM0MsQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQSxDQUFFLFdBQVcsRUFBRSxrQ0FBa0IsRUFBRTs7QUFFekQsY0FBSSxJQUFJLENBQUMsSUFBSSxFQUFFO0FBQ2IsZ0JBQUksQ0FBQyxHQUFHLDJDQUEyQixDQUFDO0FBQ3BDLGdCQUFJLENBQUMsUUFBUSx5Q0FBeUIsQ0FBQztXQUN4QyxNQUFNO0FBQ0wsZ0JBQUksVUFBVSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEVBQUU7OztBQUd6QyxrQkFBSSxDQUFDLEdBQUcsR0FBRyxRQUFRLENBQUM7QUFDcEIsa0JBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO2FBQ3RCLE1BQU07QUFDTCxrQkFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUM7QUFDaEIsa0JBQUksQ0FBQyxRQUFRLGdDQUFnQixDQUFDO2FBQy9CO1dBQ0Y7QUFDRCxjQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztTQUNwQjs7Ozs7OztDQUNGOztBQUVELFNBQVMsb0JBQW9CLENBQUUsR0FBRyxFQUFFO0FBQ2xDLFNBQU8sQUFBQyx3Q0FBdUMsQ0FBRSxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQUM7Q0FDNUQ7O0FBRUQsU0FBZSx1QkFBdUIsQ0FBRSxJQUFJOzs7O0FBQzFDLDRCQUFPLEtBQUssQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDOzt5Q0FDckQsa0JBQUcsTUFBTSxDQUFDLElBQUksQ0FBQzs7O0FBQ3JCLDRCQUFPLEtBQUssb0NBQWtDLElBQUksQ0FBRyxDQUFDOzs7Ozs7O0NBQ3ZEOztBQUVELFNBQWUsdUJBQXVCLENBQUUsSUFBSTtNQUN0QyxhQUFhLEVBT2IsWUFBWSxFQUNaLEVBQUU7Ozs7QUFSRixxQkFBYTs7O3lDQUVPLHlCQUFNLFVBQVUsRUFBRTs7O0FBQXhDLHFCQUFhOzs7Ozs7OztBQUViLDRCQUFPLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDOzs7O0FBR2pELG9CQUFZLEdBQUcsVUFBVSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQ3BELFVBQUUsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQzs7OztBQUd6QyxZQUFJLFlBQVksR0FBRyxHQUFHLElBQUssRUFBRSxZQUFZLEtBQUssR0FBRyxJQUFJLEVBQUUsS0FBSyxHQUFHLENBQUEsQUFBQyxBQUFDLEVBQUU7QUFDakUsOEJBQU8sSUFBSSxDQUFFLHFCQUFrQixhQUFhLCtCQUM1QixhQUFhLCtDQUEyQywyREFDSCwwQ0FDakIsQ0FBQyxDQUFDO1NBQ3ZEOzRDQUNNLGFBQWE7Ozs7Ozs7Q0FDckI7O0FBRUQsU0FBZSx3QkFBd0I7TUFDakMsYUFBYTs7OztBQUFiLHFCQUFhOzs7eUNBRU8seUJBQU0sWUFBWSxFQUFFOzs7QUFBMUMscUJBQWE7Ozs7Ozs7O0FBRWIsNEJBQU8sS0FBSyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7Ozs7NENBRy9DLGFBQWE7Ozs7Ozs7Q0FDckI7O0FBRUQsU0FBUyxxQkFBcUIsQ0FBRSxPQUFPLEVBQUUsWUFBWSxFQUFFO0FBQ3JELE1BQUksYUFBYSxHQUFHLElBQUksQ0FBQztBQUN6QixNQUFJLFdBQVcsR0FBRyxJQUFJLENBQUM7QUFDdkIsc0JBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxVQUFVLE1BQU0sRUFBRTtBQUNyQyxRQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7QUFDbEMsbUJBQWEsR0FBRyxNQUFNLENBQUM7QUFDdkIsVUFBSTtBQUNGLG1CQUFXLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO09BQ2hELENBQUMsT0FBTyxDQUFDLEVBQUU7QUFDVixtQkFBVyxHQUFHLElBQUksQ0FBQztPQUNwQjtLQUNGO0dBQ0YsQ0FBQyxDQUFDO0FBQ0gsU0FBTyxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztDQUNyQzs7QUFFRCxTQUFlLFVBQVUsQ0FBRSxJQUFJO01BR3RCLEdBQUcsRUFBRSxJQUFJLEVBT1YsSUFBSSxRQUVELE1BQU07Ozs7O2NBWFgsSUFBSSxDQUFDLElBQUksS0FBSyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxNQUFNLENBQUE7Ozs7O0FBQzVDLDRCQUFPLEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBQ3RDLFdBQUcsY0FBRSxJQUFJLEdBQUcsRUFBRTs7O3lDQUVMLGtCQUFHLEtBQUssQ0FBQyxZQUFZLENBQUM7OztBQUFsQyxXQUFHOztBQUNILFlBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Ozs7Ozs7O0FBRWhCLFdBQUcsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDOzs7QUFFakMsWUFBSTs7O3lDQUVlLHdCQUFLLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFDLENBQUM7Ozs7QUFBaEQsY0FBTSxRQUFOLE1BQU07O0FBQ1gsWUFBSSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Ozs7Ozs7O0FBRTdCLDRCQUFPLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDOzs7O2NBR25DLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTs7Ozs7QUFDekIsWUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsNEJBQU8sS0FBSyx5QkFBc0IsSUFBSSxDQUFDLElBQUksUUFBSSxDQUFDOzs7OztjQUUxQyxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQzs7Ozs7OztBQUczQyw0QkFBTyxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQzs7Ozs7OztDQUU1Qzs7QUFFRCxTQUFlLHVCQUF1QixDQUFFLElBQUk7TUFLdEMsUUFBUSxFQUNSLFVBQVUsRUFDVixPQUFPLEVBMEJQLEdBQUc7Ozs7Y0FoQ0gsb0JBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxvQkFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBOzs7OztBQUMvQyw0QkFBTyxLQUFLLENBQUMseUVBQXlFLENBQUMsQ0FBQzs7OztBQUd0RixnQkFBUSxHQUFHLElBQUksQ0FBQyxRQUFRO0FBQ3hCLGtCQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxxQkFBcUI7QUFDckQsZUFBTyxHQUFHLElBQUk7O2FBRWQsUUFBUTs7Ozs7QUFDVixlQUFPLEdBQUcsa0JBQUssT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUssUUFBUSxhQUFVLFVBQVUsQ0FBQyxDQUFDOzt5Q0FDdkQsa0JBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQzs7Ozs7Ozs7QUFDM0IsNEJBQU8sS0FBSyx3QkFBcUIsVUFBVSwwQkFBbUIsUUFBUSxpQ0FBNkIsQ0FBQztBQUNwRyxlQUFPLEdBQUcsa0JBQUssT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLENBQUM7Ozs7Ozs7QUFHL0MsNEJBQU8sS0FBSyxDQUFDLDhDQUE4QyxDQUFDLENBQUM7QUFDN0QsZUFBTyxHQUFHLGtCQUFLLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDOzs7O3lDQUdwQyxrQkFBRyxNQUFNLENBQUMsT0FBTyxDQUFDOzs7Ozs7OztBQUMzQixZQUFJLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtBQUM5Qiw4QkFBTyxLQUFLLDJDQUF3QyxJQUFJLENBQUMscUJBQXFCLGtCQUFjLENBQUM7QUFDN0YsaUJBQU8sR0FBRyxrQkFBSyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMscUJBQXFCLEVBQUUsVUFBVSxDQUFDLENBQUM7U0FDMUUsTUFBTTtBQUNMLGlCQUFPLEdBQUcsSUFBSSxDQUFDO1NBQ2hCOzs7eUJBRUMsQ0FBQyxPQUFPOzs7Ozs7Ozt5Q0FBVyxrQkFBRyxNQUFNLENBQUMsT0FBTyxDQUFDOzs7Ozs7Ozs7OztBQUN2Qyw0QkFBTyxJQUFJLGdEQUE2QyxVQUFVLFNBQUssQ0FBQzs7OztBQUl0RSxXQUFHOzs7eUNBRU8scUJBQU0sY0FBYyxDQUFDLE9BQU8sQ0FBQzs7O0FBQXpDLFdBQUc7O0FBQ0gsNEJBQU8sS0FBSyxtQkFBZ0IsVUFBVSxRQUFJLENBQUM7QUFDM0MsWUFBSSxDQUFDLGtCQUFrQixHQUFHLEdBQUcsQ0FBQzs0Q0FDdkIsR0FBRzs7Ozs7O0FBRVYsNEJBQU8sSUFBSSw0QkFBeUIsVUFBVSxtQ0FBK0IsQ0FBQzs7Ozs7OztDQUVqRjs7QUFFRCxTQUFlLGtCQUFrQixDQUFFLElBQUk7Ozs7WUFFaEMsSUFBSSxDQUFDLFFBQVE7Ozs7Ozs7eUNBRVEsa0NBQWdCLElBQUksQ0FBQyxHQUFHLENBQUM7OztBQUEvQyxZQUFJLENBQUMsUUFBUTs7QUFDYiw0QkFBTyxJQUFJLDBCQUF3QixJQUFJLENBQUMsUUFBUSxtQkFBYyxJQUFJLENBQUMsR0FBRyxDQUFHLENBQUM7Ozs7Ozs7O0FBRTFFLDRCQUFPLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDOzs7Ozs7OztDQUkxRDs7QUFFRCxTQUFTLHdCQUF3QixDQUFFLElBQUksRUFBRSxhQUFhLEVBQUU7QUFDdEQsTUFBSSxlQUFlLEdBQUcsS0FBSyxDQUFDOztBQUU1QixNQUFJLElBQUksQ0FBQyxhQUFhLElBQUksYUFBYSxJQUFJLEdBQUcsRUFBRTtBQUM5QyxRQUFJLElBQUksQ0FBQyxhQUFhLElBQUksR0FBRyxFQUFFO0FBQzdCLDBCQUFPLEtBQUssQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO0tBQzlELE1BQU07QUFDTCwwQkFBTyxLQUFLLENBQUMsOERBQThELENBQUMsQ0FBQztLQUM5RTtHQUNGLE1BQU07QUFDTCxtQkFBZSxHQUFHLElBQUksQ0FBQztHQUN4QjtBQUNELFNBQU8sZUFBZSxDQUFDO0NBQ3hCOztBQUVELFNBQWUsd0JBQXdCLENBQUUsR0FBRyxFQUFFLFlBQVk7TUFFcEQsU0FBUyxFQUNULFFBQVEsRUFDUixjQUFjOzs7O2NBSGQsb0JBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLG9CQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQTs7Ozs7Ozs7QUFDbkMsaUJBQVMsR0FBRyxrQkFBSyxPQUFPLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQztBQUMzQyxnQkFBUSxHQUFHLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzVELHNCQUFjLEdBQUcsUUFBUSxHQUFHLENBQUMsR0FBRyxDQUFDOzt5Q0FDL0IscUJBQU0sZUFBZSxDQUFDLFNBQVMsRUFBRSxFQUFDLGNBQWMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxFQUFDLENBQUM7Ozs7Ozs7Q0FDM0U7O0FBRUQsU0FBUyxRQUFRLENBQUUsRUFBRSxFQUFFO0FBQ3JCLE1BQUksT0FBTyxFQUFFLEtBQUssUUFBUSxJQUFJLEVBQUUsQ0FBQyxPQUFPLEVBQUU7QUFDeEMsV0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDO0dBQ25CO0FBQ0QsU0FBTyxFQUFFLENBQUM7Q0FDWDs7cUJBRWMsRUFBRSxPQUFPLEVBQVAsT0FBTyxFQUFFLHVCQUF1QixFQUF2Qix1QkFBdUIsRUFBRSx1QkFBdUIsRUFBdkIsdUJBQXVCLEVBQUUsY0FBYyxFQUFkLGNBQWM7QUFDeEYsc0JBQW9CLEVBQXBCLG9CQUFvQixFQUFFLHdCQUF3QixFQUF4Qix3QkFBd0IsRUFBRyxVQUFVLEVBQVYsVUFBVSxFQUFFLHVCQUF1QixFQUF2Qix1QkFBdUI7QUFDcEYsb0JBQWtCLEVBQWxCLGtCQUFrQixFQUFFLHdCQUF3QixFQUF4Qix3QkFBd0IsRUFBRSx3QkFBd0IsRUFBeEIsd0JBQXdCO0FBQ3RFLHVCQUFxQixFQUFyQixxQkFBcUIsRUFBRSxRQUFRLEVBQVIsUUFBUSxFQUFFIiwiZmlsZSI6ImxpYi91dGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZzLCBwbGlzdCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB4Y29kZSBmcm9tICdhcHBpdW0teGNvZGUnO1xuaW1wb3J0IHsgZXh0cmFjdEJ1bmRsZUlkIH0gZnJvbSAnaW9zLWFwcC11dGlscyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgU0FGQVJJX0JVTkRMRSB9IGZyb20gJy4vY29tbWFuZHMvc2FmYXJpJztcbmltcG9ydCB7IFNBRkFSSV9MQVVOQ0hFUl9BUFBfRklMRSwgU0FGQVJJX0xBVU5DSEVSX0JVTkRMRSB9IGZyb20gJy4vc2FmYXJpLWxhdW5jaGVyJztcblxuXG5jb25zdCByb290RGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJyk7XG5cbmFzeW5jIGZ1bmN0aW9uIHByZXBhcmVJb3NPcHRzIChvcHRzKSB7XG4gIG9wdHMuYmFja2VuZFJldHJpZXMgPSA0O1xuICBvcHRzLndpdGhvdXREZWxheSA9ICFvcHRzLm5hdGl2ZUluc3RydW1lbnRzTGliO1xuICBvcHRzLnJlc2V0ID0gIW9wdHMubm9SZXNldDtcbiAgb3B0cy5pbml0aWFsT3JpZW50YXRpb24gPSBvcHRzLmRldmljZU9yaWVudGF0aW9uIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0cy5vcmllbnRhdGlvbiB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiUE9SVFJBSVRcIjtcbiAgb3B0cy51c2VSb2JvdCA9IG9wdHMucm9ib3RQb3J0ID4gMDtcbiAgb3B0cy5yb2JvdFVybCA9IG9wdHMudXNlUm9ib3QgP1xuICAgIGBodHRwOi8vJHtvcHRzLnJvYm90QWRkcmVzc306JHtvcHRzLnJvYm90UG9ydH1gIDogbnVsbDtcbiAgaWYgKG9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQgJiYgIW9wdHMuYnVuZGxlSWQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJZb3UgbXVzdCBzZXQgdGhlIGJ1bmRsZUlkIGNhcCBpZiB1c2luZyBsb2NhdGlvblNlcnZpY2VzRW5hYmxlZFwiKTtcbiAgfVxuXG4gIG9wdHMucGxhdGZvcm1WZXJzaW9uID0gb3B0cy5wbGF0Zm9ybVZlcnNpb24gfHwgYXdhaXQgeGNvZGUuZ2V0TWF4SU9TU0RLKCk7XG4gIGxldCBwdiA9IHBhcnNlRmxvYXQob3B0cy5wbGF0Zm9ybVZlcnNpb24pO1xuICBpZiAocHYgPCA4KSB7XG4gICAgbG9nZ2VyLndhcm4oYGlPUyB2ZXJzaW9uICR7b3B0cy5wbGF0Zm9ybVZlcnNpb259IHN1cHBvcnQgaGFzIGJlZW4gYCArXG4gICAgICAgICAgICAgICAgYGRlcHJlY2F0ZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiBhIGZ1dHVyZSB2ZXJzaW9uIG9mIGAgK1xuICAgICAgICAgICAgICAgIGBBcHBpdW0uYCk7XG4gIH1cbiAgb3B0cy5sb2NhbGl6YWJsZVN0cmluZ3NEaXIgPSBvcHRzLmxvY2FsaXphYmxlU3RyaW5nc0RpciB8fCAnZW4ubHByb2onO1xuICBvcHRzLmF1dG9BY2NlcHRBbGVydHMgPSBfLmlzTnVsbChvcHRzLmF1dG9BY2NlcHRBbGVydHMpIHx8IF8uaXNVbmRlZmluZWQob3B0cy5hdXRvQWNjZXB0QWxlcnRzKSA/IGZhbHNlIDogb3B0cy5hdXRvQWNjZXB0QWxlcnRzO1xuICBvcHRzLmF1dG9EaXNtaXNzQWxlcnRzID0gXy5pc051bGwob3B0cy5hdXRvRGlzbWlzc0FsZXJ0cykgfHwgXy5pc1VuZGVmaW5lZChvcHRzLmF1dG9EaXNtaXNzQWxlcnRzKSA/IGZhbHNlIDogb3B0cy5hdXRvRGlzbWlzc0FsZXJ0cztcblxuICBpZiAoKG9wdHMuYnJvd3Nlck5hbWUgfHwgJycpLnRvTG93ZXJDYXNlKCkgPT09ICdzYWZhcmknIHx8XG4gICAgICAob3B0cy5hcHAgfHwgJycpLnRvTG93ZXJDYXNlKCkgPT09ICdzYWZhcmknIHx8XG4gICAgICAob3B0cy5idW5kbGVJZCB8fCAnJykudG9Mb3dlckNhc2UoKSA9PT0gU0FGQVJJX0JVTkRMRSkge1xuICAgIC8vIHByZXBhcmluZyBhIHNhZmFyaSBzZXNzaW9uXG4gICAgaWYgKG9wdHMudWRpZCkge1xuICAgICAgb3B0cy5hcHAgPSBTQUZBUklfTEFVTkNIRVJfQVBQX0ZJTEU7XG4gICAgICBvcHRzLmJ1bmRsZUlkID0gU0FGQVJJX0xBVU5DSEVSX0JVTkRMRTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHBhcnNlRmxvYXQob3B0cy5wbGF0Zm9ybVZlcnNpb24pIDw9IDgpIHtcbiAgICAgICAgLy8gbWFrZSBzdXJlIGFyZ3MuYXBwIGhhcyBzb21ldGhpbmcgaW4gaXQgc28gd2UgZ2V0IHRvIHRoZSByaWdodCBzcG90c1xuICAgICAgICAvLyBpbiBtb3ZlQnVpbHRJbkFwcCgpXG4gICAgICAgIG9wdHMuYXBwID0gJ3NhZmFyaSc7XG4gICAgICAgIG9wdHMuYnVuZGxlSWQgPSBudWxsO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3B0cy5hcHAgPSBudWxsO1xuICAgICAgICBvcHRzLmJ1bmRsZUlkID0gU0FGQVJJX0JVTkRMRTtcbiAgICAgIH1cbiAgICB9XG4gICAgb3B0cy5zYWZhcmkgPSB0cnVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFwcElzUGFja2FnZU9yQnVuZGxlIChhcHApIHtcbiAgcmV0dXJuICgvXihbYS16QS1aMC05XFwtX10rXFwuW2EtekEtWjAtOVxcLV9dKykrJC8pLnRlc3QoYXBwKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVtb3ZlSW5zdHJ1bWVudHNTb2NrZXQgKHNvY2spIHtcbiAgbG9nZ2VyLmRlYnVnKFwiUmVtb3ZpbmcgYW55IHJlbWFpbmluZyBpbnN0cnVtZW50cyBzb2NrZXRzXCIpO1xuICBhd2FpdCBmcy5yaW1yYWYoc29jayk7XG4gIGxvZ2dlci5kZWJ1ZyhgQ2xlYW5lZCB1cCBpbnN0cnVtZW50cyBzb2NrZXQgJHtzb2NrfWApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBbmRDaGVja1hjb2RlVmVyc2lvbiAoY2Fwcykge1xuICBsZXQgdmVyc2lvbk51bWJlcjtcbiAgdHJ5IHtcbiAgICB2ZXJzaW9uTnVtYmVyID0gYXdhaXQgeGNvZGUuZ2V0VmVyc2lvbigpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIuZXJyb3IoXCJDb3VsZCBub3QgZGV0ZXJtaW5lIFhjb2RlIHZlcnNpb24uXCIpO1xuICAgIHRocm93IGVycjtcbiAgfVxuICBsZXQgbWlub3JWZXJzaW9uID0gcGFyc2VGbG9hdCh2ZXJzaW9uTnVtYmVyLnNsaWNlKDAsIDMpKTtcbiAgbGV0IHB2ID0gcGFyc2VGbG9hdChjYXBzLnBsYXRmb3JtVmVyc2lvbik7XG4gIC8vIHdlIGRlcHJlY2F0ZSBYY29kZXMgPCA2LjMsIGV4Y2VwdCBmb3IgaU9TIDguMCBpbiB3aGljaCBjYXNlIHdlXG4gIC8vIHN1cHBvcnQgWGNvZGUgNi4wIGFzIHdlbGxcbiAgaWYgKG1pbm9yVmVyc2lvbiA8IDYuMyAmJiAoIShtaW5vclZlcnNpb24gPT09IDYuMCAmJiBwdiA9PT0gOC4wKSkpIHtcbiAgICBsb2dnZXIud2FybiggYFhjb2RlIHZlcnNpb24gJyR7dmVyc2lvbk51bWJlcn0nLiBTdXBwb3J0IGZvciBYY29kZSBgICtcbiAgICAgICAgICAgICAgICAgYCR7dmVyc2lvbk51bWJlcn0gaGFzIGJlZW4gZGVwcmVjYXRlZCBhbmQgd2lsbCBiZSByZW1vdmVkIGAgK1xuICAgICAgICAgICAgICAgICBgaW4gYSBmdXR1cmUgdmVyc2lvbi4gUGxlYXNlIHVwZ3JhZGUgdG8gdmVyc2lvbiA2LjMgb3IgYCArXG4gICAgICAgICAgICAgICAgIGBoaWdoZXIgKG9yIHZlcnNpb24gNi4wLjEgZm9yIGlPUyA4LjApYCk7XG4gIH1cbiAgcmV0dXJuIHZlcnNpb25OdW1iZXI7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFuZENoZWNrSW9zU2RrVmVyc2lvbiAoKSB7XG4gIGxldCB2ZXJzaW9uTnVtYmVyO1xuICB0cnkge1xuICAgIHZlcnNpb25OdW1iZXIgPSBhd2FpdCB4Y29kZS5nZXRNYXhJT1NTREsoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmVycm9yKFwiQ291bGQgbm90IGRldGVybWluZSBpT1MgU0RLIHZlcnNpb25cIik7XG4gICAgdGhyb3cgZXJyO1xuICB9XG4gIHJldHVybiB2ZXJzaW9uTnVtYmVyO1xufVxuXG5mdW5jdGlvbiBnZXRTaW1Gb3JEZXZpY2VTdHJpbmcgKGRTdHJpbmcsIGF2YWlsRGV2aWNlcykge1xuICBsZXQgbWF0Y2hlZERldmljZSA9IG51bGw7XG4gIGxldCBtYXRjaGVkVWRpZCA9IG51bGw7XG4gIF8uZWFjaChhdmFpbERldmljZXMsIGZ1bmN0aW9uIChkZXZpY2UpIHtcbiAgICBpZiAoZGV2aWNlLmluZGV4T2YoZFN0cmluZykgIT09IC0xKSB7XG4gICAgICBtYXRjaGVkRGV2aWNlID0gZGV2aWNlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgbWF0Y2hlZFVkaWQgPSAvLitcXFsoW15cXF1dKylcXF0vLmV4ZWMoZGV2aWNlKVsxXTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbWF0Y2hlZFVkaWQgPSBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIHJldHVybiBbbWF0Y2hlZERldmljZSwgbWF0Y2hlZFVkaWRdO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZXRlY3RVZGlkIChjYXBzKSB7XG4gIGlmIChjYXBzLnVkaWQgIT09IG51bGwgJiYgY2Fwcy51ZGlkID09PSBcImF1dG9cIikge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIkF1dG8tZGV0ZWN0aW5nIGlPUyB1ZGlkLi4uXCIpO1xuICAgIGxldCAgY21kLCBhcmdzID0gW107XG4gICAgdHJ5IHtcbiAgICAgIGNtZCA9IGF3YWl0IGZzLndoaWNoKCdpZGV2aWNlX2lkJyk7XG4gICAgICBhcmdzLnB1c2goJy1sJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjbWQgPSByZXF1aXJlLnJlc29sdmUoJ3VkaWRldGVjdCcpO1xuICAgIH1cbiAgICBsZXQgdWRpZDtcbiAgICB0cnkge1xuICAgICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhjbWQsIGFyZ3MsIHt0aW1lb3V0OiAzMDAwfSk7XG4gICAgICB1ZGlkID0gc3Rkb3V0LnNwbGl0KFwiXFxuXCIpWzBdO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmVycm9yKFwiRXJyb3IgZGV0ZWN0aW5nIHVkaWRcIik7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICAgIGlmICh1ZGlkICYmIHVkaWQubGVuZ3RoID4gMikge1xuICAgICAgY2Fwcy51ZGlkID0gdWRpZDtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgRGV0ZWN0ZWQgdWRpZCBhcyAnJHtjYXBzLnVkaWR9J2ApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZCBub3QgZGV0ZWN0IHVkaWQuXCIpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIuZGVidWcoXCJOb3QgYXV0by1kZXRlY3RpbmcgdWRpZC5cIik7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcGFyc2VMb2NhbGl6YWJsZVN0cmluZ3MgKG9wdHMpIHtcbiAgaWYgKF8uaXNOdWxsKG9wdHMuYXBwKSB8fCBfLmlzVW5kZWZpbmVkKG9wdHMuYXBwKSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIkxvY2FsaXphYmxlLnN0cmluZ3MgaXMgbm90IGN1cnJlbnRseSBzdXBwb3J0ZWQgd2hlbiB1c2luZyByZWFsIGRldmljZXMuXCIpO1xuICAgIHJldHVybjtcbiAgfVxuICBsZXQgbGFuZ3VhZ2UgPSBvcHRzLmxhbmd1YWdlO1xuICBsZXQgc3RyaW5nRmlsZSA9IG9wdHMuc3RyaW5nRmlsZSB8fCBcIkxvY2FsaXphYmxlLnN0cmluZ3NcIjtcbiAgbGV0IHN0cmluZ3MgPSBudWxsO1xuXG4gIGlmIChsYW5ndWFnZSkge1xuICAgIHN0cmluZ3MgPSBwYXRoLnJlc29sdmUob3B0cy5hcHAsIGAke2xhbmd1YWdlfS5scHJvamAsIHN0cmluZ0ZpbGUpO1xuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHN0cmluZ3MpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYE5vIHN0cmluZ3MgZmlsZSAnJHtzdHJpbmdGaWxlfScgZm9yIGxhbmd1YWdlICcke2xhbmd1YWdlfScsIGdldHRpbmcgZGVmYXVsdCBzdHJpbmdzYCk7XG4gICAgICBzdHJpbmdzID0gcGF0aC5yZXNvbHZlKG9wdHMuYXBwLCBzdHJpbmdGaWxlKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdObyBsYW5ndWFnZSBzcGVjaWZpZWQuIFVzaW5nIGRlZmF1bHQgc3RyaW5ncycpO1xuICAgIHN0cmluZ3MgPSBwYXRoLnJlc29sdmUob3B0cy5hcHAsIHN0cmluZ0ZpbGUpO1xuICB9XG5cbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMoc3RyaW5ncykpIHtcbiAgICBpZiAob3B0cy5sb2NhbGl6YWJsZVN0cmluZ3NEaXIpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgU3RyaW5ncyBmaWxlIG5vdCBmb3VuZC4gTG9va2luZyBpbiAnJHtvcHRzLmxvY2FsaXphYmxlU3RyaW5nc0Rpcn0nIGRpcmVjdG9yeWApO1xuICAgICAgc3RyaW5ncyA9IHBhdGgucmVzb2x2ZShvcHRzLmFwcCwgb3B0cy5sb2NhbGl6YWJsZVN0cmluZ3NEaXIsIHN0cmluZ0ZpbGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdHJpbmdzID0gbnVsbDtcbiAgICB9XG4gIH1cbiAgaWYgKCFzdHJpbmdzIHx8ICFhd2FpdCBmcy5leGlzdHMoc3RyaW5ncykpIHtcbiAgICBsb2dnZXIud2FybihgQ291bGQgbm90IGZpbGUgbG9jYWxpemFibGUgc3RyaW5ncyBmaWxlICcke3N0cmluZ0ZpbGV9JyFgKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBsZXQgb2JqO1xuICB0cnkge1xuICAgIG9iaiA9IGF3YWl0IHBsaXN0LnBhcnNlUGxpc3RGaWxlKHN0cmluZ3MpO1xuICAgIGxvZ2dlci5kZWJ1ZyhgUGFyc2VkIGFwcCAnJHtzdHJpbmdGaWxlfSdgKTtcbiAgICBvcHRzLmxvY2FsaXphYmxlU3RyaW5ncyA9IG9iajtcbiAgICByZXR1cm4gb2JqO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIud2FybihgQ291bGQgbm90IHBhcnNlIGFwcCAnJHtzdHJpbmdGaWxlfScgYXNzdW1pbmcgaXQgZG9lcyBub3QgZXhpc3RgKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRCdW5kbGVJZEZyb21BcHAgKGNhcHMpIHtcbiAgLy8gVGhpcyBtZXRob2Qgd2lsbCB0cnkgdG8gZXh0cmFjdCB0aGUgYnVuZGxlSWQgZnJvbSB0aGUgYXBwXG4gIGlmICghY2Fwcy5idW5kbGVJZCkge1xuICAgIHRyeSB7XG4gICAgICBjYXBzLmJ1bmRsZUlkID0gYXdhaXQgZXh0cmFjdEJ1bmRsZUlkKGNhcHMuYXBwKTtcbiAgICAgIGxvZ2dlci5pbmZvKGBFeHRyYWN0ZWQgYnVuZGxlSUQ6ICR7Y2Fwcy5idW5kbGVJZH0gZnJvbSBhcHA6ICR7Y2Fwcy5hcHB9YCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoXCJDb3VsZCBub3Qgc2V0IHRoZSBidW5kbGVJZCBmcm9tIGFwcC5cIik7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHNob3VsZFByZWxhdW5jaFNpbXVsYXRvciAoY2FwcywgaW9zU2RrVmVyc2lvbikge1xuICBsZXQgc2hvdWxkUHJlbGF1bmNoID0gZmFsc2U7XG5cbiAgaWYgKGNhcHMuZGVmYXVsdERldmljZSB8fCBpb3NTZGtWZXJzaW9uID49IDcuMSkge1xuICAgIGlmICh0aGlzLmlvc1Nka1ZlcnNpb24gPj0gNy4xKSB7XG4gICAgICBsb2dnZXIuZGVidWcoXCJXZSdyZSBvbiBpT1M3LjErIHNvIGZvcmNpbmcgZGVmYXVsdERldmljZSBvblwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nZ2VyLmRlYnVnKFwiVXNlciBzcGVjaWZpZWQgZGVmYXVsdCBkZXZpY2UsIGxldHRpbmcgaW5zdHJ1bWVudHMgbGF1bmNoIGl0XCIpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBzaG91bGRQcmVsYXVuY2ggPSB0cnVlO1xuICB9XG4gIHJldHVybiBzaG91bGRQcmVsYXVuY2g7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldERldmljZVR5cGVJbkluZm9QbGlzdCAoYXBwLCBkZXZpY2VTdHJpbmcpIHtcbiAgaWYgKF8uaXNOdWxsKGFwcCkgfHwgXy5pc1VuZGVmaW5lZChhcHApKSB7IHJldHVybjsgfVxuICBsZXQgcGxpc3RGaWxlID0gcGF0aC5yZXNvbHZlKGFwcCwgXCJJbmZvLnBsaXN0XCIpO1xuICBsZXQgaXNpUGhvbmUgPSBkZXZpY2VTdHJpbmcudG9Mb3dlckNhc2UoKS5pbmRleE9mKFwiaXBhZFwiKSA9PT0gLTE7XG4gIGxldCBkZXZpY2VUeXBlQ29kZSA9IGlzaVBob25lID8gMSA6IDI7XG4gIGF3YWl0IHBsaXN0LnVwZGF0ZVBsaXN0RmlsZShwbGlzdEZpbGUsIHtVSURldmljZUZhbWlseTogW2RldmljZVR5cGVDb2RlXX0pO1xufVxuXG5mdW5jdGlvbiB1bndyYXBFbCAoZWwpIHtcbiAgaWYgKHR5cGVvZiBlbCA9PT0gJ29iamVjdCcgJiYgZWwuRUxFTUVOVCkge1xuICAgIHJldHVybiBlbC5FTEVNRU5UO1xuICB9XG4gIHJldHVybiBlbDtcbn1cblxuZXhwb3J0IGRlZmF1bHQgeyByb290RGlyLCByZW1vdmVJbnN0cnVtZW50c1NvY2tldCwgZ2V0QW5kQ2hlY2tYY29kZVZlcnNpb24sIHByZXBhcmVJb3NPcHRzLFxuICBhcHBJc1BhY2thZ2VPckJ1bmRsZSwgZ2V0QW5kQ2hlY2tJb3NTZGtWZXJzaW9uLCAgZGV0ZWN0VWRpZCwgcGFyc2VMb2NhbGl6YWJsZVN0cmluZ3MsXG4gIHNldEJ1bmRsZUlkRnJvbUFwcCwgc2hvdWxkUHJlbGF1bmNoU2ltdWxhdG9yLCBzZXREZXZpY2VUeXBlSW5JbmZvUGxpc3QsXG4gIGdldFNpbUZvckRldmljZVN0cmluZywgdW53cmFwRWwgfTtcbiJdfQ==