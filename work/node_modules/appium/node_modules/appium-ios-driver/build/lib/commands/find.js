'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _mobileJsonWireProtocol = require('mobile-json-wire-protocol');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _js2xmlparser2 = require('js2xmlparser2');

var _js2xmlparser22 = _interopRequireDefault(_js2xmlparser2);

var _xmldom = require('xmldom');

var _xmldom2 = _interopRequireDefault(_xmldom);

var _xpath = require('xpath');

var _xpath2 = _interopRequireDefault(_xpath);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _utils = require('../utils');

var commands = {},
    helpers = {},
    extensions = {};

helpers.findElOrEls = function callee$0$0(strategy, selector, mult, context) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context = (0, _utils.unwrapEl)(context);

        if (!this.isWebContext()) {
          context$1$0.next = 7;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.findWebElementOrElements(strategy, selector, mult, context));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.findUIElementOrElements(strategy, selector, mult, context));

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.findUIElementOrElements = function callee$0$0(strategy, selector, mult, context) {
  var createGetElementCommand, getLocalizedStringForSelector, res, doFind;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (strategy !== "xpath") {
          selector = _appiumSupport.util.escapeSpecialChars(selector, "'");
        }
        if (typeof context === "undefined" || !context) {
          context = '';
        } else if (typeof context === "string") {
          context = _appiumSupport.util.escapeSpecialChars(context, "'");
        }

        // previously getSelectorForStrategy

        if (!(strategy === 'class name' && selector.indexOf('UIA') !== 0)) {
          context$1$0.next = 4;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.InvalidSelectorError('The class name selector must use full UIA class names. Try \'UIA' + selector + '\' instead.');

      case 4:

        if (!selector) new _mobileJsonWireProtocol.errors.InvalidSelectorError('Missing selector');

        createGetElementCommand = function createGetElementCommand(strategy, selector, mult, context) {
          var ext = mult ? 's' : '';
          var command = "";
          context = !context ? context : ', \'' + context + '\'';
          switch (strategy) {
            case "name":
              command = 'au.getElement' + ext + 'ByName(\'' + selector + '\'' + context + ')';
              break;
            case "accessibility id":
              command = 'au.getElement' + ext + 'ByAccessibilityId(\'' + selector + '\'' + context + ')';
              break;
            case "id":
              command = 'au.getElement' + ext + 'ById(\'' + selector + '\')';
              break;
            case "-ios uiautomation":
              command = 'au.getElement' + ext + 'ByUIAutomation(\'' + selector + '\'' + context + ')';
              break;
            default:
              command = 'au.getElement' + ext + 'ByType(\'' + selector + '\'' + context + ')';
          }

          return command;
        };

        getLocalizedStringForSelector = function getLocalizedStringForSelector(selector, strings) {
          var newSelector = selector;
          if (strings) {
            var localizedSelector = strings[selector];
            if (localizedSelector) {
              newSelector = localizedSelector;
            } else {
              _logger2['default'].debug('Id selector, \'' + selector + '\', not found in Localizable.strings.');
            }
          }

          return newSelector;
        };

        res = undefined;

        doFind = function doFind() {
          var findByAxIdCmd, findByIdCmd, command;
          return _regeneratorRuntime.async(function doFind$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                if (!(strategy === "xpath")) {
                  context$2$0.next = 6;
                  break;
                }

                context$2$0.next = 3;
                return _regeneratorRuntime.awrap(this.findUIElementsByXpath(selector, mult, context));

              case 3:
                res = context$2$0.sent;
                context$2$0.next = 22;
                break;

              case 6:
                if (!(strategy === "id")) {
                  context$2$0.next = 18;
                  break;
                }

                findByAxIdCmd = createGetElementCommand("accessibility id", selector, mult, context);
                context$2$0.next = 10;
                return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(findByAxIdCmd));

              case 10:
                res = context$2$0.sent;

                if (res && _lodash2['default'].size(res) > 0) {
                  context$2$0.next = 16;
                  break;
                }

                findByIdCmd = createGetElementCommand("id", getLocalizedStringForSelector(selector, this.opts.localizableStrings), mult, context);
                context$2$0.next = 15;
                return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(findByIdCmd));

              case 15:
                res = context$2$0.sent;

              case 16:
                context$2$0.next = 22;
                break;

              case 18:
                command = createGetElementCommand(strategy, selector, mult, context);
                context$2$0.next = 21;
                return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

              case 21:
                res = context$2$0.sent;

              case 22:
                return context$2$0.abrupt('return', _lodash2['default'].size(res) > 0);

              case 23:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.prev = 9;
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.implicitWaitForCondition(doFind));

      case 12:
        context$1$0.next = 21;
        break;

      case 14:
        context$1$0.prev = 14;
        context$1$0.t0 = context$1$0['catch'](9);

        if (!(context$1$0.t0.message && context$1$0.t0.message.match(/Condition unmet/))) {
          context$1$0.next = 20;
          break;
        }

        // condition was not met setting res to empty array
        res = [];
        context$1$0.next = 21;
        break;

      case 20:
        throw context$1$0.t0;

      case 21:
        if (!mult) {
          context$1$0.next = 25;
          break;
        }

        return context$1$0.abrupt('return', res);

      case 25:
        if (!(!res || _lodash2['default'].size(res) === 0)) {
          context$1$0.next = 27;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NoSuchElementError();

      case 27:
        return context$1$0.abrupt('return', res);

      case 28:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[9, 14]]);
};

var _pathFromDomNode = function _pathFromDomNode(node) {
  var path = null;
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(_lodash2['default'].values(node.attributes)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var attrObj = _step.value;

      if (attrObj.name === "path") {
        path = attrObj.value;
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return path;
};

var _xmlSourceFromJson = function _xmlSourceFromJson(jsonSource) {
  if (typeof jsonSource === "string") {
    jsonSource = JSON.parse(jsonSource);
  }
  return (0, _js2xmlparser22['default'])("AppiumAUT", jsonSource, {
    wrapArray: { enabled: false, elementName: "element" },
    declaration: { include: true },
    prettyPrinting: { indentString: "    " }
  });
};

var _performXpathQueryOnJson = function _performXpathQueryOnJson(selector, jsonSource) {
  var xmlSource = _xmlSourceFromJson(jsonSource);
  var dom = new _xmldom2['default'].DOMParser().parseFromString(xmlSource);
  return _xpath2['default'].select(selector, dom);
};

commands.findUIElementsByXpath = function callee$0$0(selector, mult) {
  var context = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];
  var curRetry = arguments.length <= 3 || arguments[3] === undefined ? 1 : arguments[3];

  var sourceXml, selectedNodes, indexPaths, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, node, ip, proxyCmd, ipArrString, res;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        sourceXml = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.getSourceForElementForXML(context));

      case 4:
        sourceXml = context$1$0.sent;
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn("Error getting source, can't continue finding element by XPath");
        throw context$1$0.t0;

      case 11:
        selectedNodes = _performXpathQueryOnJson(selector, sourceXml);

        if (!mult) selectedNodes = selectedNodes.slice(0, 1);
        indexPaths = [];
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 17;

        // filter out elements without 'path' attribute
        for (_iterator2 = _getIterator(selectedNodes); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          node = _step2.value;
          ip = _pathFromDomNode(node);

          if (ip !== null) {
            indexPaths.push(ip);
          }
        }
        context$1$0.next = 25;
        break;

      case 21:
        context$1$0.prev = 21;
        context$1$0.t1 = context$1$0['catch'](17);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t1;

      case 25:
        context$1$0.prev = 25;
        context$1$0.prev = 26;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 28:
        context$1$0.prev = 28;

        if (!_didIteratorError2) {
          context$1$0.next = 31;
          break;
        }

        throw _iteratorError2;

      case 31:
        return context$1$0.finish(28);

      case 32:
        return context$1$0.finish(25);

      case 33:
        if (!(!mult && indexPaths.length < 1)) {
          context$1$0.next = 37;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NoSuchElementError();

      case 37:
        if (!(indexPaths.length < 1)) {
          context$1$0.next = 39;
          break;
        }

        return context$1$0.abrupt('return', []);

      case 39:
        proxyCmd = undefined;

        if (!mult) {
          proxyCmd = 'au.getElementByIndexPath(\'' + indexPaths[0] + '\')';
        } else {
          ipArrString = JSON.stringify(indexPaths);

          proxyCmd = 'au.getElementsByIndexPaths(' + ipArrString + ')';
        }
        // having index paths means we think elements should be there. Sometimes
        // uiauto lags in enabling us to get elements, so we retry a few times if
        // it can't find elements we know should be there. see uiauto code
        // for more logic
        res = undefined;
        context$1$0.prev = 42;
        context$1$0.next = 45;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(proxyCmd));

      case 45:
        res = context$1$0.sent;
        context$1$0.next = 58;
        break;

      case 48:
        context$1$0.prev = 48;
        context$1$0.t2 = context$1$0['catch'](42);

        if (!(curRetry < 3)) {
          context$1$0.next = 57;
          break;
        }

        _logger2['default'].debug("Got a warning from uiauto that some index paths " + "could not be resolved, trying again");
        context$1$0.next = 54;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(300));

      case 54:
        context$1$0.next = 56;
        return _regeneratorRuntime.awrap(this.findUIElementsByXpath(selector, mult, context, curRetry + 1));

      case 56:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 57:
        throw context$1$0.t2;

      case 58:
        return context$1$0.abrupt('return', res);

      case 59:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7], [17, 21, 25, 33], [26,, 28, 32], [42, 48]]);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// For the ID strategy, we first want to handle the selector as an
// accessibility id. If no element is found by that strategy, we fall
// back to searching for the string.

// Since no element was found using the accessibility id, we fall
// back to search by string.

// if we don't have any matching nodes, and we wanted at least one, fail

// and if we don't have any matching nodes, return the empty array

// otherwise look up the actual element by its index path

// we get a StaleElementReference if uiauto can't find an element
// by the path we mentioned
//# sourceMappingURL=data:application/json;base64,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QUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLFFBQVEsR0FBUixRQUFRO1FBQUUsT0FBTyxHQUFQLE9BQU87cUJBQ1gsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvZmluZC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdtb2JpbGUtanNvbi13aXJlLXByb3RvY29sJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQganMyeG1sIGZyb20gJ2pzMnhtbHBhcnNlcjInO1xuaW1wb3J0IFhNTERvbSBmcm9tICd4bWxkb20nO1xuaW1wb3J0IHhwYXRoIGZyb20gJ3hwYXRoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHVud3JhcEVsIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmhlbHBlcnMuZmluZEVsT3JFbHMgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gIGNvbnRleHQgPSB1bndyYXBFbChjb250ZXh0KTtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kV2ViRWxlbWVudE9yRWxlbWVudHMoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kVUlFbGVtZW50T3JFbGVtZW50cyhzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICB9XG59O1xuXG5oZWxwZXJzLmZpbmRVSUVsZW1lbnRPckVsZW1lbnRzID0gYXN5bmMgZnVuY3Rpb24gIChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpIHtcbiAgaWYgKHN0cmF0ZWd5ICE9PSBcInhwYXRoXCIpIHtcbiAgICBzZWxlY3RvciA9IHV0aWwuZXNjYXBlU3BlY2lhbENoYXJzKHNlbGVjdG9yLCBcIidcIik7XG4gIH1cbiAgaWYgKHR5cGVvZiBjb250ZXh0ID09PSBcInVuZGVmaW5lZFwiIHx8ICFjb250ZXh0KSB7XG4gICAgY29udGV4dCA9ICcnO1xuICB9IGVsc2UgaWYgKHR5cGVvZiBjb250ZXh0ID09PSBcInN0cmluZ1wiKSB7XG4gICAgY29udGV4dCA9IHV0aWwuZXNjYXBlU3BlY2lhbENoYXJzKGNvbnRleHQsIFwiJ1wiKTtcbiAgfVxuXG4gIC8vIHByZXZpb3VzbHkgZ2V0U2VsZWN0b3JGb3JTdHJhdGVneVxuICBpZiAoc3RyYXRlZ3kgPT09ICdjbGFzcyBuYW1lJyAmJiBzZWxlY3Rvci5pbmRleE9mKCdVSUEnKSAhPT0gMCkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuSW52YWxpZFNlbGVjdG9yRXJyb3IoXG4gICAgICBgVGhlIGNsYXNzIG5hbWUgc2VsZWN0b3IgbXVzdCB1c2UgZnVsbCBVSUEgY2xhc3MgbmFtZXMuIFRyeSAnVUlBJHtzZWxlY3Rvcn0nIGluc3RlYWQuYCk7XG4gIH1cblxuICBpZiAoIXNlbGVjdG9yKSBuZXcgZXJyb3JzLkludmFsaWRTZWxlY3RvckVycm9yKCdNaXNzaW5nIHNlbGVjdG9yJyk7XG5cbiAgbGV0IGNyZWF0ZUdldEVsZW1lbnRDb21tYW5kID0gZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICAgIGxldCBleHQgPSBtdWx0ID8gJ3MnIDogJyc7XG4gICAgbGV0IGNvbW1hbmQgPSBcIlwiO1xuICAgIGNvbnRleHQgPSAhY29udGV4dCA/IGNvbnRleHQgOiBgLCAnJHtjb250ZXh0fSdgIDtcbiAgICBzd2l0Y2ggKHN0cmF0ZWd5KSB7XG4gICAgICBjYXNlIFwibmFtZVwiOlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeU5hbWUoJyR7c2VsZWN0b3J9JyR7Y29udGV4dH0pYDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiYWNjZXNzaWJpbGl0eSBpZFwiOlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeUFjY2Vzc2liaWxpdHlJZCgnJHtzZWxlY3Rvcn0nJHtjb250ZXh0fSlgO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJpZFwiOlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeUlkKCcke3NlbGVjdG9yfScpYDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiLWlvcyB1aWF1dG9tYXRpb25cIjpcbiAgICAgICAgY29tbWFuZCA9IGBhdS5nZXRFbGVtZW50JHtleHR9QnlVSUF1dG9tYXRpb24oJyR7c2VsZWN0b3J9JyR7Y29udGV4dH0pYDtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBjb21tYW5kID0gYGF1LmdldEVsZW1lbnQke2V4dH1CeVR5cGUoJyR7c2VsZWN0b3J9JyR7Y29udGV4dH0pYDtcbiAgICB9XG5cbiAgICByZXR1cm4gY29tbWFuZDtcbiAgfTtcblxuICBsZXQgZ2V0TG9jYWxpemVkU3RyaW5nRm9yU2VsZWN0b3IgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIHN0cmluZ3MpIHtcbiAgICBsZXQgbmV3U2VsZWN0b3IgPSBzZWxlY3RvcjtcbiAgICBpZiAoc3RyaW5ncykge1xuICAgICAgbGV0IGxvY2FsaXplZFNlbGVjdG9yID0gc3RyaW5nc1tzZWxlY3Rvcl07XG4gICAgICBpZiAobG9jYWxpemVkU2VsZWN0b3IpIHtcbiAgICAgICAgbmV3U2VsZWN0b3IgPSBsb2NhbGl6ZWRTZWxlY3RvcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICBgSWQgc2VsZWN0b3IsICcke3NlbGVjdG9yfScsIG5vdCBmb3VuZCBpbiBMb2NhbGl6YWJsZS5zdHJpbmdzLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXdTZWxlY3RvcjtcbiAgfTtcblxuICBsZXQgcmVzO1xuICBsZXQgZG9GaW5kID0gYXN5bmMgKCkgPT4ge1xuICAgIGlmIChzdHJhdGVneSA9PT0gXCJ4cGF0aFwiKSB7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLmZpbmRVSUVsZW1lbnRzQnlYcGF0aChzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gICAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gXCJpZFwiKSB7XG4gICAgICAvLyBGb3IgdGhlIElEIHN0cmF0ZWd5LCB3ZSBmaXJzdCB3YW50IHRvIGhhbmRsZSB0aGUgc2VsZWN0b3IgYXMgYW5cbiAgICAgIC8vIGFjY2Vzc2liaWxpdHkgaWQuIElmIG5vIGVsZW1lbnQgaXMgZm91bmQgYnkgdGhhdCBzdHJhdGVneSwgd2UgZmFsbFxuICAgICAgLy8gYmFjayB0byBzZWFyY2hpbmcgZm9yIHRoZSBzdHJpbmcuXG4gICAgICBsZXQgZmluZEJ5QXhJZENtZCA9IGNyZWF0ZUdldEVsZW1lbnRDb21tYW5kKFwiYWNjZXNzaWJpbGl0eSBpZFwiLCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChmaW5kQnlBeElkQ21kKTtcbiAgICAgIGlmICghKHJlcyAmJiBfLnNpemUocmVzKSA+IDApKSB7XG4gICAgICAgIC8vIFNpbmNlIG5vIGVsZW1lbnQgd2FzIGZvdW5kIHVzaW5nIHRoZSBhY2Nlc3NpYmlsaXR5IGlkLCB3ZSBmYWxsXG4gICAgICAgIC8vIGJhY2sgdG8gc2VhcmNoIGJ5IHN0cmluZy5cbiAgICAgICAgbGV0IGZpbmRCeUlkQ21kID0gY3JlYXRlR2V0RWxlbWVudENvbW1hbmQoXCJpZFwiLCBnZXRMb2NhbGl6ZWRTdHJpbmdGb3JTZWxlY3RvcihzZWxlY3RvcixcbiAgICAgICAgICB0aGlzLm9wdHMubG9jYWxpemFibGVTdHJpbmdzKSwgbXVsdCwgY29udGV4dCk7XG4gICAgICAgIHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGZpbmRCeUlkQ21kKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGNvbW1hbmQgPSBjcmVhdGVHZXRFbGVtZW50Q29tbWFuZChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY29tbWFuZCk7XG4gICAgfVxuICAgIHJldHVybiBfLnNpemUocmVzKSA+IDA7XG4gIH07XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmltcGxpY2l0V2FpdEZvckNvbmRpdGlvbihkb0ZpbmQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyLm1lc3NhZ2UgJiYgZXJyLm1lc3NhZ2UubWF0Y2goL0NvbmRpdGlvbiB1bm1ldC8pKXtcbiAgICAgIC8vIGNvbmRpdGlvbiB3YXMgbm90IG1ldCBzZXR0aW5nIHJlcyB0byBlbXB0eSBhcnJheVxuICAgICAgcmVzID0gW107XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cbiAgaWYgKG11bHQpIHtcbiAgICByZXR1cm4gcmVzO1xuICB9IGVsc2Uge1xuICAgIGlmICghcmVzIHx8IF8uc2l6ZShyZXMpID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzO1xuICB9XG59O1xuXG5sZXQgX3BhdGhGcm9tRG9tTm9kZSA9IGZ1bmN0aW9uIChub2RlKSB7XG4gIGxldCBwYXRoID0gbnVsbDtcbiAgZm9yIChsZXQgYXR0ck9iaiBvZiBfLnZhbHVlcyhub2RlLmF0dHJpYnV0ZXMpKSB7XG4gICAgaWYgKGF0dHJPYmoubmFtZSA9PT0gXCJwYXRoXCIpIHtcbiAgICAgIHBhdGggPSBhdHRyT2JqLnZhbHVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcGF0aDtcbn07XG5cbmxldCBfeG1sU291cmNlRnJvbUpzb24gPSBmdW5jdGlvbiAoanNvblNvdXJjZSkge1xuICBpZiAodHlwZW9mIGpzb25Tb3VyY2UgPT09IFwic3RyaW5nXCIpIHtcbiAgICBqc29uU291cmNlID0gSlNPTi5wYXJzZShqc29uU291cmNlKTtcbiAgfVxuICByZXR1cm4ganMyeG1sKFwiQXBwaXVtQVVUXCIsIGpzb25Tb3VyY2UsIHtcbiAgICB3cmFwQXJyYXk6IHtlbmFibGVkOiBmYWxzZSwgZWxlbWVudE5hbWU6IFwiZWxlbWVudFwifSxcbiAgICBkZWNsYXJhdGlvbjoge2luY2x1ZGU6IHRydWV9LFxuICAgIHByZXR0eVByaW50aW5nOiB7aW5kZW50U3RyaW5nOiBcIiAgICBcIn1cbiAgfSk7XG59O1xuXG5sZXQgX3BlcmZvcm1YcGF0aFF1ZXJ5T25Kc29uID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBqc29uU291cmNlKSB7XG4gIGxldCB4bWxTb3VyY2UgPSBfeG1sU291cmNlRnJvbUpzb24oanNvblNvdXJjZSk7XG4gIGxldCBkb20gPSBuZXcgWE1MRG9tLkRPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyh4bWxTb3VyY2UpO1xuICByZXR1cm4geHBhdGguc2VsZWN0KHNlbGVjdG9yLCBkb20pO1xufTtcblxuY29tbWFuZHMuZmluZFVJRWxlbWVudHNCeVhwYXRoID0gYXN5bmMgZnVuY3Rpb24gKHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0PW51bGwsIGN1clJldHJ5PTEpIHtcbiAgbGV0IHNvdXJjZVhtbDtcbiAgdHJ5IHtcbiAgICBzb3VyY2VYbWwgPSBhd2FpdCB0aGlzLmdldFNvdXJjZUZvckVsZW1lbnRGb3JYTUwoY29udGV4dCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci53YXJuKFwiRXJyb3IgZ2V0dGluZyBzb3VyY2UsIGNhbid0IGNvbnRpbnVlIGZpbmRpbmcgZWxlbWVudCBieSBYUGF0aFwiKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbiAgbGV0IHNlbGVjdGVkTm9kZXMgPSBfcGVyZm9ybVhwYXRoUXVlcnlPbkpzb24oc2VsZWN0b3IsIHNvdXJjZVhtbCk7XG5cbiAgaWYgKCFtdWx0KSBzZWxlY3RlZE5vZGVzID0gc2VsZWN0ZWROb2Rlcy5zbGljZSgwLCAxKTtcbiAgbGV0IGluZGV4UGF0aHMgPSBbXTtcbiAgLy8gZmlsdGVyIG91dCBlbGVtZW50cyB3aXRob3V0ICdwYXRoJyBhdHRyaWJ1dGVcbiAgZm9yIChsZXQgbm9kZSBvZiBzZWxlY3RlZE5vZGVzKSB7XG4gICAgbGV0IGlwID0gX3BhdGhGcm9tRG9tTm9kZShub2RlKTtcbiAgICBpZiAoaXAgIT09IG51bGwpIHtcbiAgICAgIGluZGV4UGF0aHMucHVzaChpcCk7XG4gICAgfVxuICB9XG4gIGlmICghbXVsdCAmJiBpbmRleFBhdGhzLmxlbmd0aCA8IDEpIHtcbiAgICAvLyBpZiB3ZSBkb24ndCBoYXZlIGFueSBtYXRjaGluZyBub2RlcywgYW5kIHdlIHdhbnRlZCBhdCBsZWFzdCBvbmUsIGZhaWxcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICB9IGVsc2UgaWYgKGluZGV4UGF0aHMubGVuZ3RoIDwgMSkge1xuICAgIC8vIGFuZCBpZiB3ZSBkb24ndCBoYXZlIGFueSBtYXRjaGluZyBub2RlcywgcmV0dXJuIHRoZSBlbXB0eSBhcnJheVxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSBsb29rIHVwIHRoZSBhY3R1YWwgZWxlbWVudCBieSBpdHMgaW5kZXggcGF0aFxuICBsZXQgcHJveHlDbWQ7XG4gIGlmICghbXVsdCkge1xuICAgIHByb3h5Q21kID0gYGF1LmdldEVsZW1lbnRCeUluZGV4UGF0aCgnJHtpbmRleFBhdGhzWzBdfScpYDtcbiAgfSBlbHNlIHtcbiAgICBsZXQgaXBBcnJTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShpbmRleFBhdGhzKTtcbiAgICBwcm94eUNtZCA9IGBhdS5nZXRFbGVtZW50c0J5SW5kZXhQYXRocygke2lwQXJyU3RyaW5nfSlgO1xuICB9XG4gIC8vIGhhdmluZyBpbmRleCBwYXRocyBtZWFucyB3ZSB0aGluayBlbGVtZW50cyBzaG91bGQgYmUgdGhlcmUuIFNvbWV0aW1lc1xuICAvLyB1aWF1dG8gbGFncyBpbiBlbmFibGluZyB1cyB0byBnZXQgZWxlbWVudHMsIHNvIHdlIHJldHJ5IGEgZmV3IHRpbWVzIGlmXG4gIC8vIGl0IGNhbid0IGZpbmQgZWxlbWVudHMgd2Uga25vdyBzaG91bGQgYmUgdGhlcmUuIHNlZSB1aWF1dG8gY29kZVxuICAvLyBmb3IgbW9yZSBsb2dpY1xuICBsZXQgcmVzO1xuICB0cnkge1xuICAgIHJlcyA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKHByb3h5Q21kKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgLy8gd2UgZ2V0IGEgU3RhbGVFbGVtZW50UmVmZXJlbmNlIGlmIHVpYXV0byBjYW4ndCBmaW5kIGFuIGVsZW1lbnRcbiAgICAvLyBieSB0aGUgcGF0aCB3ZSBtZW50aW9uZWRcbiAgICBpZiAoY3VyUmV0cnkgPCAzKSB7XG4gICAgICBsb2dnZXIuZGVidWcoXCJHb3QgYSB3YXJuaW5nIGZyb20gdWlhdXRvIHRoYXQgc29tZSBpbmRleCBwYXRocyBcIiArXG4gICAgICAgICAgICAgICAgICAgXCJjb3VsZCBub3QgYmUgcmVzb2x2ZWQsIHRyeWluZyBhZ2FpblwiKTtcbiAgICAgIGF3YWl0IEIuZGVsYXkoMzAwKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRVSUVsZW1lbnRzQnlYcGF0aChzZWxlY3RvciwgbXVsdCwgY29udGV4dCwgY3VyUmV0cnkgKyAxKTtcbiAgICB9XG4gICAgdGhyb3cgZXJyO1xuICB9XG4gIHJldHVybiByZXM7XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXX0=