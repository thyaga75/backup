'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _mobileJsonWireProtocol = require('mobile-json-wire-protocol');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _js2xmlparser2 = require("js2xmlparser2");

var _js2xmlparser22 = _interopRequireDefault(_js2xmlparser2);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _utils = require('../utils');

var _utils2 = _interopRequireDefault(_utils);

var commands = {},
    helpers = {},
    extensions = {};

commands.active = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('active_element', []));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getActiveElement()"));

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getDeviceTime = function callee$0$0() {
  var idevicedate, _ref, stdout, date;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info('Attempting to capture iOS device date and time');

        if (!this.isRealDevice()) {
          context$1$0.next = 20;
          break;
        }

        context$1$0.prev = 2;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('idevicedate'));

      case 5:
        idevicedate = context$1$0.sent;

        _logger2['default'].info('Found idevicedate: \'' + idevicedate + '\'');
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(idevicedate, ['-u', this.opts.udid]));

      case 9:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        date = new Date(stdout.trim());
        return context$1$0.abrupt('return', date.toString());

      case 15:
        context$1$0.prev = 15;
        context$1$0.t0 = context$1$0['catch'](2);

        _logger2['default'].errorAndThrow('Could not capture device date and time using libimobiledevice idevicedate. ' + 'Libimobiledevice is probably not installed');

      case 18:
        context$1$0.next = 22;
        break;

      case 20:
        _logger2['default'].warn('On simulator. Assuming device time is the same as host time');
        return context$1$0.abrupt('return', new Date().toString());

      case 22:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 15]]);
};

commands.hideKeyboard = function callee$0$0(strategy) {
  for (var _len = arguments.length, possibleKeys = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    possibleKeys[_key - 1] = arguments[_key];
  }

  var cmd, key;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        possibleKeys.pop(); // last parameter is the session id
        cmd = undefined;
        key = _lodash2['default'].find(possibleKeys, function (k) {
          return k;
        });

        if (key) {
          strategy = strategy || 'pressKey';
          cmd = 'au.hideKeyboard(\'' + strategy + '\', \'' + key + '\')';
        } else {
          strategy = strategy || 'default';
          cmd = 'au.hideKeyboard(\'' + strategy + '\')';
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(cmd));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getPageSource = function callee$0$0() {
  var cmd, jsonSource, xmlSource;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 7;
          break;
        }

        cmd = 'document.getElementsByTagName("html")[0].outerHTML';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.remote.execute(cmd));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getSourceForElementForXML());

      case 9:
        jsonSource = context$1$0.sent;

        if (typeof jsonSource === "string") {
          jsonSource = JSON.parse(jsonSource);
        }
        xmlSource = (0, _js2xmlparser22['default'])("AppiumAUT", jsonSource, {
          wrapArray: { enabled: false, elementName: "element" },
          declaration: { include: true },
          prettyPrinting: { indentString: "    " }
        });
        return context$1$0.abrupt('return', xmlSource);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.background = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.background(' + secs + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.lock = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!secs) {
          _logger2['default'].debug('No seconds parameter. Using 0 seconds');
          secs = 0;
        }
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.lock(' + secs + ')'));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.closeApp = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.stop());

      case 3:
        _logger2['default'].info('Successfully closed the [' + this.opts.app + '] app.');
        context$1$0.next = 10;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](0);

        _logger2['default'].warn('Something went wrong whilst closing the [' + this.opts.app + '] app.');
        throw context$1$0.t0;

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 6]]);
};

commands.launchApp = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.start());

      case 3:
        _logger2['default'].info('Successfully launched the [' + this.opts.app + '] app.');
        context$1$0.next = 10;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](0);

        _logger2['default'].warn('Something went wrong whilst launching the [' + this.opts.app + '] app.');
        throw context$1$0.t0;

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 6]]);
};

commands.keys = function callee$0$0(keys) {
  var el, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.active());

      case 3:
        el = context$1$0.sent;

        if (!_lodash2['default'].isUndefined(el.ELEMENT)) {
          context$1$0.next = 6;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NoSuchElementError();

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.setValue(keys, el.ELEMENT));

      case 8:
        context$1$0.next = 13;
        break;

      case 10:
        command = 'au.sendKeysToActiveElement(\'' + keys + '\')';
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setGeoLocation = function callee$0$0(location) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('target.setLocation(' + JSON.stringify(location) + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

//}
commands.getWindowSize = function callee$0$0() {
  var windowHandle = arguments.length <= 0 || arguments[0] === undefined ? "current" : arguments[0];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(windowHandle !== "current")) {
          context$1$0.next = 2;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotYetImplementedError("Currently only getting current window size is supported.");

      case 2:
        if (!this.isWebContext()) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('get_window_size', []));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getWindowSize()"));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getStrings = function callee$0$0(language) {
  var stringFile = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];
  var strings;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Gettings strings for language \'' + language + '\' and string file \'' + stringFile + '\'');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_utils2['default'].parseLocalizableStrings(_lodash2['default'].defaults({ language: language, stringFile: stringFile }, this.opts)));

      case 3:
        strings = context$1$0.sent;

        if (strings && strings.length >= 1) {
          strings = strings[0];
        }
        return context$1$0.abrupt('return', strings);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// TODO: should not be needed -> keys = util.escapeSpecialChars(keys, "'");

// TODO: check the hasOptions bit, the method signature should be location, option

//let hasOptions = altitude !== null || horizontalAccuracy !== null || verticalAccuracy !== null || course !== null || speed !== null;
//if (hasOptions) {
//let options = {};
//if (altitude !== null) {
//options.altitude = altitude;
//}
//if (horizontalAccuracy !== null) {
//options.horizontalAccuracy = horizontalAccuracy;
//}
//if (verticalAccuracy !== null) {
//options.verticalAccuracy = verticalAccuracy;
//}
//if (course !== null) {
//options.course = course;
//}
//if (speed !== null) {
//options.speed = speed;
//}
//await this.uiAutoClient.sendCommand(
//`target.setLocationWithOptions(${JSON.stringify(coordinates)}, ${JSON.stringify(options)})`);
//} else {
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztzQ0FBdUIsMkJBQTJCOztzQkFDcEMsUUFBUTs7Ozs2QkFDSCxlQUFlOzs7O3NCQUNsQixXQUFXOzs7OzZCQUNSLGdCQUFnQjs7NEJBQ2QsY0FBYzs7cUJBQ2pCLFVBQVU7Ozs7QUFHNUIsSUFBSSxRQUFRLEdBQUcsRUFBRTtJQUFFLE9BQU8sR0FBRyxFQUFFO0lBQUUsVUFBVSxHQUFHLEVBQUUsQ0FBQzs7QUFFakQsUUFBUSxDQUFDLE1BQU0sR0FBRzs7OzthQUNaLElBQUksQ0FBQyxZQUFZLEVBQUU7Ozs7Ozt5Q0FDUixJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLEVBQUUsQ0FBQzs7Ozs7Ozt5Q0FFdEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsdUJBQXVCLENBQUM7Ozs7Ozs7Ozs7Q0FFdEUsQ0FBQzs7QUFFRixRQUFRLENBQUMsYUFBYSxHQUFHO01BSWYsV0FBVyxRQUVWLE1BQU0sRUFDUCxJQUFJOzs7OztBQU5aLDRCQUFJLElBQUksQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDOzthQUN2RCxJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7O3lDQUVLLGtCQUFHLEtBQUssQ0FBQyxhQUFhLENBQUM7OztBQUEzQyxtQkFBVzs7QUFDZiw0QkFBSSxJQUFJLDJCQUF3QixXQUFXLFFBQUksQ0FBQzs7eUNBQzNCLHdCQUFLLFdBQVcsRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDOzs7O0FBQXpELGNBQU0sUUFBTixNQUFNO0FBQ1AsWUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQzs0Q0FDM0IsSUFBSSxDQUFDLFFBQVEsRUFBRTs7Ozs7O0FBRXRCLDRCQUFJLGFBQWEsQ0FBQyw2RUFBNkUsR0FDaEYsNENBQTRDLENBQUMsQ0FBQzs7Ozs7OztB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RSxtQkFBTSx1QkFBdUIsQ0FBQyxvQkFBRSxRQUFRLENBQUMsRUFBQyxRQUFRLEVBQVIsUUFBUSxFQUFFLFVBQVUsRUFBVixVQUFVLEVBQUMsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7OztBQUE1RixlQUFPOztBQUNYLFlBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO0FBQ2xDLGlCQUFPLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3RCOzRDQUNNLE9BQU87Ozs7Ozs7Q0FDZixDQUFDOztBQUdGLGVBQWMsVUFBVSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNwQyxRQUFRLEdBQVIsUUFBUTtRQUFFLE9BQU8sR0FBUCxPQUFPO3FCQUNYLFVBQVUiLCJmaWxlIjoibGliL2NvbW1hbmRzL2dlbmVyYWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdtb2JpbGUtanNvbi13aXJlLXByb3RvY29sJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQganMyeG1sIGZyb20gXCJqczJ4bWxwYXJzZXIyXCI7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHV0aWxzIGZyb20gJy4uL3V0aWxzJztcblxuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbW1hbmRzLmFjdGl2ZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnYWN0aXZlX2VsZW1lbnQnLCBbXSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKFwiYXUuZ2V0QWN0aXZlRWxlbWVudCgpXCIpO1xuICB9XG59O1xuXG5jb21tYW5kcy5nZXREZXZpY2VUaW1lID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsb2cuaW5mbygnQXR0ZW1wdGluZyB0byBjYXB0dXJlIGlPUyBkZXZpY2UgZGF0ZSBhbmQgdGltZScpO1xuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIHRyeSB7XG4gICAgICBsZXQgaWRldmljZWRhdGUgPSBhd2FpdCBmcy53aGljaCgnaWRldmljZWRhdGUnKTtcbiAgICAgIGxvZy5pbmZvKGBGb3VuZCBpZGV2aWNlZGF0ZTogJyR7aWRldmljZWRhdGV9J2ApO1xuICAgICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhpZGV2aWNlZGF0ZSwgWyctdScsIHRoaXMub3B0cy51ZGlkXSk7XG4gICAgICBsZXQgZGF0ZSA9IG5ldyBEYXRlKHN0ZG91dC50cmltKCkpO1xuICAgICAgcmV0dXJuIGRhdGUudG9TdHJpbmcoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KCdDb3VsZCBub3QgY2FwdHVyZSBkZXZpY2UgZGF0ZSBhbmQgdGltZSB1c2luZyBsaWJpbW9iaWxlZGV2aWNlIGlkZXZpY2VkYXRlLiAnICtcbiAgICAgICAgICAgICAgICAgICAgICdMaWJpbW9iaWxlZGV2aWNlIGlzIHByb2JhYmx5IG5vdCBpbnN0YWxsZWQnKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nLndhcm4oJ09uIHNpbXVsYXRvci4gQXNzdW1pbmcgZGV2aWNlIHRpbWUgaXMgdGhlIHNhbWUgYXMgaG9zdCB0aW1lJyk7XG4gICAgcmV0dXJuIG5ldyBEYXRlKCkudG9TdHJpbmcoKTtcbiAgfVxufTtcblxuY29tbWFuZHMuaGlkZUtleWJvYXJkID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCAuLi5wb3NzaWJsZUtleXMpIHtcbiAgcG9zc2libGVLZXlzLnBvcCgpOyAvLyBsYXN0IHBhcmFtZXRlciBpcyB0aGUgc2Vzc2lvbiBpZFxuICBsZXQgY21kO1xuICBsZXQga2V5ID0gXy5maW5kKHBvc3NpYmxlS2V5cywgKGspID0+IHtyZXR1cm4gazt9KTtcbiAgaWYgKGtleSkge1xuICAgIHN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgJ3ByZXNzS2V5JztcbiAgICBjbWQgPSBgYXUuaGlkZUtleWJvYXJkKCcke3N0cmF0ZWd5fScsICcke2tleX0nKWA7XG4gIH0gZWxzZSB7XG4gICAgc3RyYXRlZ3kgPSBzdHJhdGVneSB8fCAnZGVmYXVsdCc7XG4gICAgY21kID0gYGF1LmhpZGVLZXlib2FyZCgnJHtzdHJhdGVneX0nKWA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY21kKTtcbn07XG5cbmNvbW1hbmRzLmdldFBhZ2VTb3VyY2UgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgbGV0IGNtZCA9ICdkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImh0bWxcIilbMF0ub3V0ZXJIVE1MJztcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5yZW1vdGUuZXhlY3V0ZShjbWQpO1xuICB9IGVsc2Uge1xuICAgIGxldCBqc29uU291cmNlID0gYXdhaXQgdGhpcy5nZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MKCk7XG4gICAgaWYgKHR5cGVvZiBqc29uU291cmNlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBqc29uU291cmNlID0gSlNPTi5wYXJzZShqc29uU291cmNlKTtcbiAgICB9XG4gICAgbGV0IHhtbFNvdXJjZSA9IGpzMnhtbChcIkFwcGl1bUFVVFwiLCBqc29uU291cmNlLCB7XG4gICAgICB3cmFwQXJyYXk6IHtlbmFibGVkOiBmYWxzZSwgZWxlbWVudE5hbWU6IFwiZWxlbWVudFwifSxcbiAgICAgIGRlY2xhcmF0aW9uOiB7aW5jbHVkZTogdHJ1ZX0sXG4gICAgICBwcmV0dHlQcmludGluZzoge2luZGVudFN0cmluZzogXCIgICAgXCJ9XG4gICAgfSk7XG4gICAgcmV0dXJuIHhtbFNvdXJjZTtcbiAgfVxufTtcblxuY29tbWFuZHMuYmFja2dyb3VuZCA9IGFzeW5jIGZ1bmN0aW9uIChzZWNzKSB7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGBhdS5iYWNrZ3JvdW5kKCR7c2Vjc30pYCk7XG59O1xuXG5jb21tYW5kcy5sb2NrID0gYXN5bmMgZnVuY3Rpb24gKHNlY3MpIHtcbiAgaWYgKCFzZWNzKSB7XG4gICAgbG9nLmRlYnVnKCdObyBzZWNvbmRzIHBhcmFtZXRlci4gVXNpbmcgMCBzZWNvbmRzJyk7XG4gICAgc2VjcyA9IDA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoYGF1LmxvY2soJHtzZWNzfSlgKTtcbn07XG5cbmNvbW1hbmRzLmNsb3NlQXBwID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuc3RvcCgpO1xuICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgY2xvc2VkIHRoZSBbJHt0aGlzLm9wdHMuYXBwfV0gYXBwLmApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbHN0IGNsb3NpbmcgdGhlIFske3RoaXMub3B0cy5hcHB9XSBhcHAuYCk7XG4gICAgdGhyb3cgZXJyO1xuICB9XG59O1xuXG5jb21tYW5kcy5sYXVuY2hBcHAgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5zdGFydCgpO1xuICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgbGF1bmNoZWQgdGhlIFske3RoaXMub3B0cy5hcHB9XSBhcHAuYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aGlsc3QgbGF1bmNoaW5nIHRoZSBbJHt0aGlzLm9wdHMuYXBwfV0gYXBwLmApO1xuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMua2V5cyA9IGFzeW5jIGZ1bmN0aW9uIChrZXlzKSB7XG4gIC8vIFRPRE86IHNob3VsZCBub3QgYmUgbmVlZGVkIC0+IGtleXMgPSB1dGlsLmVzY2FwZVNwZWNpYWxDaGFycyhrZXlzLCBcIidcIik7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgbGV0IGVsID0gYXdhaXQgdGhpcy5hY3RpdmUoKTtcbiAgICBpZiAoXy5pc1VuZGVmaW5lZChlbC5FTEVNRU5UKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5zZXRWYWx1ZShrZXlzLCBlbC5FTEVNRU5UKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQgY29tbWFuZCA9IGBhdS5zZW5kS2V5c1RvQWN0aXZlRWxlbWVudCgnJHtrZXlzfScpYDtcbiAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0R2VvTG9jYXRpb24gPSBhc3luYyBmdW5jdGlvbiAobG9jYXRpb24pIHtcbiAgLy8gVE9ETzogY2hlY2sgdGhlIGhhc09wdGlvbnMgYml0LCB0aGUgbWV0aG9kIHNpZ25hdHVyZSBzaG91bGQgYmUgbG9jYXRpb24sIG9wdGlvblxuXG4gIC8vbGV0IGhhc09wdGlvbnMgPSBhbHRpdHVkZSAhPT0gbnVsbCB8fCBob3Jpem9udGFsQWNjdXJhY3kgIT09IG51bGwgfHwgdmVydGljYWxBY2N1cmFjeSAhPT0gbnVsbCB8fCBjb3Vyc2UgIT09IG51bGwgfHwgc3BlZWQgIT09IG51bGw7XG4gIC8vaWYgKGhhc09wdGlvbnMpIHtcbiAgICAvL2xldCBvcHRpb25zID0ge307XG4gICAgLy9pZiAoYWx0aXR1ZGUgIT09IG51bGwpIHtcbiAgICAgIC8vb3B0aW9ucy5hbHRpdHVkZSA9IGFsdGl0dWRlO1xuICAgIC8vfVxuICAgIC8vaWYgKGhvcml6b250YWxBY2N1cmFjeSAhPT0gbnVsbCkge1xuICAgICAgLy9vcHRpb25zLmhvcml6b250YWxBY2N1cmFjeSA9IGhvcml6b250YWxBY2N1cmFjeTtcbiAgICAvL31cbiAgICAvL2lmICh2ZXJ0aWNhbEFjY3VyYWN5ICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMudmVydGljYWxBY2N1cmFjeSA9IHZlcnRpY2FsQWNjdXJhY3k7XG4gICAgLy99XG4gICAgLy9pZiAoY291cnNlICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMuY291cnNlID0gY291cnNlO1xuICAgIC8vfVxuICAgIC8vaWYgKHNwZWVkICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMuc3BlZWQgPSBzcGVlZDtcbiAgICAvL31cbiAgICAvL2F3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKFxuICAgICAgLy9gdGFyZ2V0LnNldExvY2F0aW9uV2l0aE9wdGlvbnMoJHtKU09OLnN0cmluZ2lmeShjb29yZGluYXRlcyl9LCAke0pTT04uc3RyaW5naWZ5KG9wdGlvbnMpfSlgKTtcbiAgLy99IGVsc2Uge1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgdGFyZ2V0LnNldExvY2F0aW9uKCR7SlNPTi5zdHJpbmdpZnkobG9jYXRpb24pfSlgKTtcbiAgLy99XG59O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dTaXplID0gYXN5bmMgZnVuY3Rpb24gKHdpbmRvd0hhbmRsZT1cImN1cnJlbnRcIikge1xuICBpZiAod2luZG93SGFuZGxlICE9PSBcImN1cnJlbnRcIikge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcihcIkN1cnJlbnRseSBvbmx5IGdldHRpbmcgY3VycmVudCB3aW5kb3cgc2l6ZSBpcyBzdXBwb3J0ZWQuXCIpO1xuICB9XG5cbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3dpbmRvd19zaXplJywgW10pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcImF1LmdldFdpbmRvd1NpemUoKVwiKTtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0U3RyaW5ncyA9IGFzeW5jIGZ1bmN0aW9uIChsYW5ndWFnZSwgc3RyaW5nRmlsZSA9IG51bGwpIHtcbiAgbG9nLmRlYnVnKGBHZXR0aW5ncyBzdHJpbmdzIGZvciBsYW5ndWFnZSAnJHtsYW5ndWFnZX0nIGFuZCBzdHJpbmcgZmlsZSAnJHtzdHJpbmdGaWxlfSdgKTtcbiAgbGV0IHN0cmluZ3MgPSBhd2FpdCB1dGlscy5wYXJzZUxvY2FsaXphYmxlU3RyaW5ncyhfLmRlZmF1bHRzKHtsYW5ndWFnZSwgc3RyaW5nRmlsZX0sIHRoaXMub3B0cykpO1xuICBpZiAoc3RyaW5ncyAmJiBzdHJpbmdzLmxlbmd0aCA+PSAxKSB7XG4gICAgc3RyaW5ncyA9IHN0cmluZ3NbMF07XG4gIH1cbiAgcmV0dXJuIHN0cmluZ3M7XG59O1xuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXX0=