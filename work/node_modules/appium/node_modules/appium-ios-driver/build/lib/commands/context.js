'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _asyncbox = require('asyncbox');

var _appiumRemoteDebugger = require('appium-remote-debugger');

var _appiumIosLog = require('appium-ios-log');

var _mobileJsonWireProtocol = require('mobile-json-wire-protocol');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var NATIVE_WIN = 'NATIVE_APP';
var WEBVIEW_WIN = 'WEBVIEW';
var WEBVIEW_BASE = WEBVIEW_WIN + '_';

var commands = {},
    helpers = {},
    extensions = {};

commands.getCurrentContext = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(this.curContext && this.curContext !== NATIVE_WIN)) {
          context$1$0.next = 4;
          break;
        }

        return context$1$0.abrupt('return', '' + WEBVIEW_BASE + this.curContext);

      case 4:
        return context$1$0.abrupt('return', NATIVE_WIN);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getContexts = function callee$0$0() {
  var contexts;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Getting list of available contexts');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.getContextsAndViews(false));

      case 3:
        contexts = context$1$0.sent;
        return context$1$0.abrupt('return', contexts.map(function (context) {
          return context.id;
        }));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setContext = function callee$0$0(name, callback, skipReadyCheck) {
  var alreadyInContext, idx, pageIdKey;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        alreadyInContext = function alreadyInContext(desired, current) {
          return desired === current || desired === null && current === NATIVE_WIN || desired === NATIVE_WIN && current === null;
        };

        _logger2['default'].debug('Attempting to set context to \'' + name + '\'');

        if (!alreadyInContext(name, this.curContext)) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 30;
        break;

      case 5:
        if (!(name === NATIVE_WIN || name === null)) {
          context$1$0.next = 10;
          break;
        }

        // switching into the native context
        this.curContext = null;
        if (this.isRealDevice()) {
          this.remote.disconnect();
        }
        context$1$0.next = 30;
        break;

      case 10:
        idx = name.replace(WEBVIEW_BASE, '');

        if (idx === WEBVIEW_WIN) {
          // allow user to pass in "WEBVIEW" without an index
          idx = '1';
        }

        // if contexts have not already been retrieved, get them

        if (!_lodash2['default'].isUndefined(this.contexts)) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(this.getContexts());

      case 15:
        if (_lodash2['default'].includes(this.contexts, idx)) {
          context$1$0.next = 17;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NoSuchContextError();

      case 17:
        pageIdKey = parseInt(idx, 10);

        if (this.isRealDevice()) {
          context$1$0.next = 24;
          break;
        }

        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.remote.selectPage(pageIdKey, skipReadyCheck));

      case 21:
        this.curContext = idx;
        context$1$0.next = 30;
        break;

      case 24:
        if (!this.remote) {
          context$1$0.next = 27;
          break;
        }

        context$1$0.next = 27;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 27:
        this.curContext = idx;
        context$1$0.next = 30;
        return _regeneratorRuntime.awrap(this.remote.connect(idx));

      case 30:

        // attempt to start performance logging, if requested
        if (this.perfLogEnabled && this.remote) {
          _logger2['default'].debug('Starting performance log on \'' + this.curContext + '\'');
          this.logs.performance = new _appiumIosLog.IOSPerformanceLog(this.remote);
          this.logs.performance.startCapture();
        }

      case 31:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getWindowHandle = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 2:
        return context$1$0.abrupt('return', this.curContext);

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getWindowHandles = function callee$0$0() {
  var pageArray, idArray;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.listWebFrames());

      case 4:
        pageArray = context$1$0.sent;

        this.windowHandleCache = _lodash2['default'].map(pageArray, this.massagePage);
        idArray = _lodash2['default'].map(this.windowHandleCache, 'id');

        // since we use this.contexts to manage selecting debugger pages, make
        // sure it gets populated even if someone did not use the
        // getContexts method
        if (!this.contexts) {
          this.contexts = idArray;
        }
        return context$1$0.abrupt('return', idArray);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setWindow = function callee$0$0(name, skipReadyCheck) {
  var pageIdKey;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 2:
        if (_lodash2['default'].includes(_lodash2['default'].map(this.windowHandleCache, 'id'), name)) {
          context$1$0.next = 4;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NoSuchWindowError();

      case 4:
        pageIdKey = parseInt(name, 10);

        if (this.isRealDevice()) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.remote.selectPage(pageIdKey, skipReadyCheck));

      case 8:
        this.curContext = this.curWindowHandle = name;
        context$1$0.next = 24;
        break;

      case 11:
        if (!(name === this.curWindowHandle)) {
          context$1$0.next = 15;
          break;
        }

        _logger2['default'].debug('Remote debugger is already connected to window \'' + name + '\'');
        context$1$0.next = 24;
        break;

      case 15:
        if (_lodash2['default'].includes(_lodash2['default'].map(this.windowHandleCache, 'id'), name)) {
          context$1$0.next = 19;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NoSuchWindowError();

      case 19:
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 21:
        this.curContext = this.curWindowHandle = name;
        context$1$0.next = 24;
        return _regeneratorRuntime.awrap(this.remote.connect(name));

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.webContextIndex = function () {
  return this.curContext.replace(WEBVIEW_BASE, '') - 1;
};

extensions.initAutoWebview = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.opts.autoWebview) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug('Setting auto webview');
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.navToInitialWebview(this));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.getContextsAndViews = function callee$0$0() {
  var useUrl = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];

  var webviews, ctxs, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, view;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Retrieving contexts and views');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.listWebFrames(useUrl));

      case 3:
        webviews = context$1$0.sent;
        ctxs = [{ id: NATIVE_WIN }];

        this.contexts = [NATIVE_WIN];
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 9;
        for (_iterator = _getIterator(webviews); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          view = _step.value;

          ctxs.push({ id: '' + WEBVIEW_BASE + view.id, view: view });
          this.contexts.push(view.id.toString());
        }
        context$1$0.next = 17;
        break;

      case 13:
        context$1$0.prev = 13;
        context$1$0.t0 = context$1$0['catch'](9);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 17:
        context$1$0.prev = 17;
        context$1$0.prev = 18;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 20:
        context$1$0.prev = 20;

        if (!_didIteratorError) {
          context$1$0.next = 23;
          break;
        }

        throw _iteratorError;

      case 23:
        return context$1$0.finish(20);

      case 24:
        return context$1$0.finish(17);

      case 25:
        return context$1$0.abrupt('return', ctxs);

      case 26:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[9, 13, 17, 25], [18,, 20, 24]]);
};

extensions.listWebFrames = function callee$0$0() {
  var useUrl = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
  var currentUrl, pageArray, appInfo, tryClosingAlert;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.opts.bundleId) {
          _logger2['default'].errorAndThrow('Cannot enter web frame without a bundle ID');
        }

        /* jshint ignore:start */
        _logger2['default'].debug('Selecting by url: ' + useUrl + ' ' + (useUrl ? '(expected url: \'' + this.getCurrentUrl() + '\')' : ''));
        /* jshint ignore:end */

        currentUrl = useUrl ? this.getCurrentUrl() : undefined;
        pageArray = undefined;

        if (!(this.remote !== null && this.remote.appIdKey && this.opts.bundleId !== null)) {
          context$1$0.next = 16;
          break;
        }

        if (!this.isRealDevice()) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.remote.pageArrayFromJson());

      case 8:
        pageArray = context$1$0.sent;
        context$1$0.next = 14;
        break;

      case 11:
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.remote.selectApp(currentUrl, this.opts.webviewConnectRetries));

      case 13:
        pageArray = context$1$0.sent;

      case 14:
        context$1$0.next = 39;
        break;

      case 16:
        if (!this.isRealDevice()) {
          context$1$0.next = 19;
          break;
        }

        this.remote = new _appiumRemoteDebugger.WebKitRemoteDebugger({ port: this.opts.webkitDebugProxyPort });
        return context$1$0.abrupt('return', this.remote.pageArrayFromJson());

      case 19:
        this.remote = new _appiumRemoteDebugger.RemoteDebugger({
          bundleId: this.opts.bundleId,
          useNewSafari: this.useNewSafari(),
          pageLoadMs: this.pageLoadMs,
          platformVersion: this.opts.platformVersion
        });

        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(this.remote.connect());

      case 22:
        appInfo = context$1$0.sent;

        if (appInfo) {
          context$1$0.next = 26;
          break;
        }

        _logger2['default'].debug('Unable to connect to the remote debugger.');
        return context$1$0.abrupt('return', []);

      case 26:
        context$1$0.next = 28;
        return _regeneratorRuntime.awrap(this.remote.selectApp(currentUrl, this.opts.webviewConnectRetries));

      case 28:
        pageArray = context$1$0.sent;

        this.remote.on(_appiumRemoteDebugger.RemoteDebugger.EVENT_PAGE_CHANGE, this.onPageChange.bind(this));

        tryClosingAlert = function tryClosingAlert() {
          var didDismiss;
          return _regeneratorRuntime.async(function tryClosingAlert$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.closeAlertBeforeTest());

              case 2:
                didDismiss = context$2$0.sent;

                if (didDismiss) {
                  context$2$0.next = 5;
                  break;
                }

                throw new Error('Close alert failed. Retry.');

              case 5:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.prev = 31;
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(3, 4000, tryClosingAlert));

      case 34:
        context$1$0.next = 39;
        break;

      case 36:
        context$1$0.prev = 36;
        context$1$0.t0 = context$1$0['catch'](31);

        // if the loop to close alerts failed to dismiss, ignore,
        // otherwise log and throw the error
        if (context$1$0.t0.message !== 'Close alert failed. Retry.') {
          _logger2['default'].errorAndThrow(context$1$0.t0);
        }

      case 39:

        if (pageArray.length === 0) {
          // we have no web frames, but continue anyway
          _logger2['default'].debug('No web frames found.');
        }
        return context$1$0.abrupt('return', pageArray);

      case 41:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[31, 36]]);
};

extensions.onPageChange = function callee$0$0(pageArray) {
  var newIds, newPages, keyId, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, page, id, newPage, needsPageLoad;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Remote debugger notified us of a new page listing: ' + JSON.stringify(pageArray));

        if (!this.selectingNewPage) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug('We are in the middle of selecting a page, ignoring');
        return context$1$0.abrupt('return');

      case 4:
        newIds = [];
        newPages = [];
        keyId = null;
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 10;

        for (_iterator2 = _getIterator(pageArray); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          page = _step2.value;
          id = page.id.toString();

          newIds.push(id);
          if (page.isKey) {
            keyId = id;
          }
          if (!_lodash2['default'].includes(this.contexts, id)) {
            newPages.push(id);
            this.contexts.push(id);
          }
        }

        context$1$0.next = 18;
        break;

      case 14:
        context$1$0.prev = 14;
        context$1$0.t0 = context$1$0['catch'](10);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t0;

      case 18:
        context$1$0.prev = 18;
        context$1$0.prev = 19;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 21:
        context$1$0.prev = 21;

        if (!_didIteratorError2) {
          context$1$0.next = 24;
          break;
        }

        throw _iteratorError2;

      case 24:
        return context$1$0.finish(21);

      case 25:
        return context$1$0.finish(18);

      case 26:
        newPage = null;

        if (!(this.curContext === null)) {
          context$1$0.next = 31;
          break;
        }

        _logger2['default'].debug('We do not appear to have window set yet, ignoring');
        context$1$0.next = 54;
        break;

      case 31:
        if (!newPages.length) {
          context$1$0.next = 36;
          break;
        }

        _logger2['default'].debug('We have new pages, going to select page \'' + newPages[0] + '\'');
        newPage = newPages[0];
        context$1$0.next = 54;
        break;

      case 36:
        if (_lodash2['default'].includes(newIds, this.curContext.toString())) {
          context$1$0.next = 49;
          break;
        }

        _logger2['default'].debug('New page listing from remote debugger does not contain ' + 'current window; assuming it is closed');

        if (!(keyId !== null)) {
          context$1$0.next = 42;
          break;
        }

        _logger2['default'].debug('Debugger already selected page \'' + keyId + '\', ' + 'confirming that choice.');
        context$1$0.next = 45;
        break;

      case 42:
        _logger2['default'].error('Do not have our current window anymore, and there ' + 'are not any more to load! Doing nothing...');
        this.setCurrentUrl(undefined);
        return context$1$0.abrupt('return');

      case 45:
        this.curContext = keyId;
        newPage = keyId;
        context$1$0.next = 54;
        break;

      case 49:
        needsPageLoad = (function () {
          var item = function item(arr) {
            return _lodash2['default'].filter(arr, function (obj) {
              return obj.id === _this2.curContext;
            })[0];
          };

          return !_lodash2['default'].isEqual(item(_this2.contexts), item(pageArray));
        })();

        if (!needsPageLoad) {
          context$1$0.next = 53;
          break;
        }

        context$1$0.next = 53;
        return _regeneratorRuntime.awrap(this.remote.pageLoad());

      case 53:

        _logger2['default'].debug('New page listing is same as old, doing nothing');

      case 54:

        // make sure that the page listing isn't indicating a redirect
        if (_appiumSupport.util.hasValue(this.curContext)) {
          page = _lodash2['default'].find(pageArray, function (p) {
            return parseInt(p.id, 10) === parseInt(_this2.curContext, 10);
          });

          if (page && page.url !== this.getCurrentUrl()) {
            _logger2['default'].debug('Redirected from \'' + this.getCurrentUrl() + '\' to \'' + page.url + '\'');
            this.setCurrentUrl(page.url);
          }
        }

        if (!_appiumSupport.util.hasValue(newPage)) {
          context$1$0.next = 61;
          break;
        }

        this.selectingNewPage = true;
        context$1$0.next = 59;
        return _regeneratorRuntime.awrap(this.remote.selectPage(parseInt(newPage, 10)));

      case 59:
        this.selectingNewPage = false;
        this.curContext = newPage;

      case 61:
        this.windowHandleCache = _lodash2['default'].map(pageArray, this.massagePage);

      case 62:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[10, 14, 18, 26], [19,, 21, 25]]);
};

extensions.getLatestWebviewContextForTitle = function callee$0$0(titleRegex) {
  var contexts, matchingCtx, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, ctx;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getContextsAndViews());

      case 2:
        contexts = context$1$0.sent;
        matchingCtx = undefined;
        _iteratorNormalCompletion3 = true;
        _didIteratorError3 = false;
        _iteratorError3 = undefined;
        context$1$0.prev = 7;

        for (_iterator3 = _getIterator(contexts); !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
          ctx = _step3.value;

          if (ctx.view && (ctx.view.title || '').match(titleRegex)) {
            if (ctx.view.url !== 'about:blank') {
              matchingCtx = ctx;
            } else {
              // in the cases of Xcode < 5 (i.e., iOS SDK Version less than 7)
              // iOS 7.1, iOS 9.0 & iOS 9.1 in a webview (not in Safari)
              // we can have the url be `about:blank`
              if (parseFloat(this.iOSSDKVersion) < 7 || parseFloat(this.iOSSDKVersion) >= 9 || this.opts.platformVersion === '7.1' && this.opts.app && this.opts.app.toLowerCase() !== 'safari') {
                matchingCtx = ctx;
              }
            }
          }
        }
        context$1$0.next = 15;
        break;

      case 11:
        context$1$0.prev = 11;
        context$1$0.t0 = context$1$0['catch'](7);
        _didIteratorError3 = true;
        _iteratorError3 = context$1$0.t0;

      case 15:
        context$1$0.prev = 15;
        context$1$0.prev = 16;

        if (!_iteratorNormalCompletion3 && _iterator3['return']) {
          _iterator3['return']();
        }

      case 18:
        context$1$0.prev = 18;

        if (!_didIteratorError3) {
          context$1$0.next = 21;
          break;
        }

        throw _iteratorError3;

      case 21:
        return context$1$0.finish(18);

      case 22:
        return context$1$0.finish(15);

      case 23:
        return context$1$0.abrupt('return', matchingCtx ? matchingCtx.id : undefined);

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 11, 15, 23], [16,, 18, 22]]);
};

// Right now we don't necessarily wait for webview
// and frame to load, which leads to race conditions and flakiness,
// let's see if we can transition to something better
extensions.useNewSafari = function () {
  return parseFloat(this.iosSdkVersion) >= 8.1 && parseFloat(this.opts.platformVersion) >= 8.1 && !this.isRealDevice() && this.opts.safari;
};

extensions.navToInitialWebview = function callee$0$0() {
  var timeout;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        timeout = 0;

        if (this.isRealDevice()) {
          timeout = 3000;
          _logger2['default'].debug('Waiting for ' + timeout + ' ms before navigating to view.');
        }
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(timeout));

      case 4:
        if (!this.useNewSafari()) {
          context$1$0.next = 9;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.typeAndNavToUrl());

      case 7:
        context$1$0.next = 16;
        break;

      case 9:
        if (!(parseInt(this.iosSdkVersion, 10) >= 7 && !this.isRealDevice() && this.opts.safari)) {
          context$1$0.next = 14;
          break;
        }

        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(this.navToViewThroughFavorites());

      case 12:
        context$1$0.next = 16;
        break;

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/.*/));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.typeAndNavToUrl = function callee$0$0() {
  var oldImpWait, el, elId;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this3 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        this.setCurrentUrl(this.caps.safariInitialUrl || 'http://127.0.0.1:' + this.opts.port + '/welcome');

        oldImpWait = this.implicitWaitMs;

        this.implicitWaitMs = 7000;

        // find the url bar, and tap on it. retry to make sure we don't try
        // too soon while the view is still loading
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(3, 1000, function callee$1$0() {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.findElement('accessibility id', 'URL'));

              case 2:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 3:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this3);
        }));

      case 5:
        el = context$1$0.sent;

        this.implicitWaitMs = oldImpWait;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

      case 9:
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(5, 1000, function callee$1$0() {
          var el;
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.t0 = _lodash2['default'];
                context$2$0.next = 3;
                return _regeneratorRuntime.awrap(this.findElements('class name', 'UIATextField'));

              case 3:
                context$2$0.t1 = context$2$0.sent;
                el = context$2$0.t0.last.call(context$2$0.t0, context$2$0.t1);
                return context$2$0.abrupt('return', el.ELEMENT);

              case 6:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this3);
        }));

      case 11:
        elId = context$1$0.sent;
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(this.setValueImmediate(this.getCurrentUrl(), elId));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.findElement('accessibility id', 'Go'));

      case 16:
        el = context$1$0.sent;
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

      case 19:
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/.*/i));

      case 21:
        context$1$0.next = 23;
        return _regeneratorRuntime.awrap(this.remote.pageUnload());

      case 23:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.navToViewThroughFavorites = function callee$0$0() {
  var oldImpWait, el, msg;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('We are on iOS7+ simulator: clicking apple button to get into a webview');
        oldImpWait = this.implicitWaitMs;

        this.implicitWaitMs = 7000; // wait 7s for apple button to exist

        el = undefined;
        context$1$0.prev = 4;
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.findElement('xpath', '//UIAScrollView[1]/UIAButton[1]'));

      case 7:
        el = context$1$0.sent;
        context$1$0.next = 18;
        break;

      case 10:
        context$1$0.prev = 10;
        context$1$0.t0 = context$1$0['catch'](4);
        msg = 'Could not find button to click to get into webview. ' + 'Proceeding on the assumption we have a working one.';

        _logger2['default'].error(msg);
        this.implicitWaitMs = oldImpWait;
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/.*/i));

      case 17:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 18:
        this.implicitWaitMs = oldImpWait;
        context$1$0.prev = 19;
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(this.nativeTap(el.ELEMENT));

      case 22:
        context$1$0.next = 28;
        break;

      case 24:
        context$1$0.prev = 24;
        context$1$0.t1 = context$1$0['catch'](19);
        msg = 'Could not click button to get into webview. ' + 'Proceeding on the assumption we have a working one.';

        _logger2['default'].error(msg);

      case 28:
        context$1$0.next = 30;
        return _regeneratorRuntime.awrap(this.navToViewWithTitle(/apple/i));

      case 30:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[4, 10], [19, 24]]);
};

extensions.navToViewWithTitle = function callee$0$0(titleRegex) {
  var start, spinTime, spinHandles;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this4 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Navigating to most recently opened webview');
        start = Date.now();
        spinTime = 500;

        spinHandles = function spinHandles() {
          var res, latestWindow, element;
          return _regeneratorRuntime.async(function spinHandles$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                res = undefined;
                context$2$0.prev = 1;
                context$2$0.next = 4;
                return _regeneratorRuntime.awrap(this.getLatestWebviewContextForTitle(titleRegex));

              case 4:
                res = context$2$0.sent;
                context$2$0.next = 12;
                break;

              case 7:
                context$2$0.prev = 7;
                context$2$0.t0 = context$2$0['catch'](1);

                if (!(context$2$0.t0.message.indexOf('Could not connect to a valid app after') === -1)) {
                  context$2$0.next = 11;
                  break;
                }

                throw new Error('Could not navigate to webview! Err: ' + context$2$0.t0.message);

              case 11:
                _logger2['default'].debug('Could not navigate to webview. Retrying if possible.');

              case 12:
                if (!res) {
                  context$2$0.next = 20;
                  break;
                }

                latestWindow = res;

                _logger2['default'].debug('Picking webview \'' + latestWindow + '\'');
                context$2$0.next = 17;
                return _regeneratorRuntime.awrap(this.setContext(latestWindow));

              case 17:
                context$2$0.next = 19;
                return _regeneratorRuntime.awrap(this.remote.cancelPageLoad());

              case 19:
                return context$2$0.abrupt('return');

              case 20:
                if (!(Date.now() - start >= 90000)) {
                  context$2$0.next = 22;
                  break;
                }

                throw new Error('Could not navigate to webview; there are none!');

              case 22:

                _logger2['default'].warn("Could not find any webviews yet, refreshing/retrying");

                if (!(this.isRealDevice() || !this.opts.safari)) {
                  context$2$0.next = 29;
                  break;
                }

                context$2$0.next = 26;
                return _regeneratorRuntime.awrap(_bluebird2['default'].delay(spinTime));

              case 26:
                context$2$0.next = 28;
                return _regeneratorRuntime.awrap(spinHandles());

              case 28:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 29:
                element = undefined;
                context$2$0.prev = 30;

                _logger2['default'].debug('Finding and tapping reload button');
                context$2$0.next = 34;
                return _regeneratorRuntime.awrap(this.findUIElementOrElements('accessibility id', 'ReloadButton', '', false));

              case 34:
                element = context$2$0.sent;
                context$2$0.next = 37;
                return _regeneratorRuntime.awrap(this.nativeTap(element.ELEMENT));

              case 37:
                context$2$0.next = 45;
                break;

              case 39:
                context$2$0.prev = 39;
                context$2$0.t1 = context$2$0['catch'](30);

                _logger2['default'].warn('Error finding and tapping reload button: ' + context$2$0.t1.message);
                _logger2['default'].warn('Retrying.');
                context$2$0.next = 45;
                return _regeneratorRuntime.awrap(_bluebird2['default'].delay(spinTime));

              case 45:
                context$2$0.next = 47;
                return _regeneratorRuntime.awrap(spinHandles());

              case 47:
                return context$2$0.abrupt('return', context$2$0.sent);

              case 48:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this4, [[1, 7], [30, 39]]);
        };

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(spinHandles());

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.closeAlertBeforeTest = function callee$0$0() {
  var present;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.alertIsPresent()'));

      case 2:
        present = context$1$0.sent;

        if (present) {
          context$1$0.next = 5;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 5:

        _logger2['default'].debug('Alert present before starting test, let us banish it');
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.dismissAlert()'));

      case 8:
        _logger2['default'].debug('Alert banished!');
        return context$1$0.abrupt('return', true);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.stopRemote = function callee$0$0() {
  var closeWindowBeforeDisconnecting = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.remote) {
          _logger2['default'].errorAndThrow('Tried to leave a web frame but were not in one');
        }

        if (!closeWindowBeforeDisconnecting) {
          context$1$0.next = 4;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.closeWindow());

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.remote.disconnect());

      case 6:
        this.curContext = null;
        this.curWebFrames = [];
        this.curWebCoords = null;
        this.remote = null;

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.isWebContext = function () {
  return !!this.curContext && this.curContext !== NATIVE_WIN;
};

helpers.setCurrentUrl = function (url) {
  this._currentUrl = url;
};

helpers.getCurrentUrl = function () {
  return this._currentUrl;
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports.NATIVE_WIN = NATIVE_WIN;
exports.WEBVIEW_WIN = WEBVIEW_WIN;
exports.WEBVIEW_BASE = WEBVIEW_BASE;
exports['default'] = extensions;

// already in the named context, no need to do anything

// switching into a webview context

// If a window navigates to an anchor it doesn't always fire a page
// callback event. Let's check if we wound up in such a situation.

// get the last address element and set the url
// this is flakey on certain systems so we retry until we get something

// make it happen

// wait for page to finish loading.

// no webview was found

// too slow, get out

// on a real device, when not using Safari, we just want to try again

// find the reload button and tap it, if possible

// try it all again
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O3NCQUFjLFFBQVE7Ozs7d0JBQ1IsVUFBVTs7Ozt3QkFDTSxVQUFVOztvQ0FDYSx3QkFBd0I7OzRCQUMzQyxnQkFBZ0I7O3NDQUMzQiwyQkFBMkI7O3NCQUMvQixXQUFXOzs7OzZCQUNULGdCQUFnQjs7QUFHckMsSUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDO0FBQ2hDLElBQU0sV0FBVyxHQUFHLFNBQVMsQ0FBQztBQUM5QixJQUFNLFlBQVksR0FBTSxXQUFXLE1BQUcsQ0FBQzs7QUFFdkMsSUFBSSxRQUFRLEdBQUcsRUFBRTtJQUFFLE9BQU8sR0FBRyxFQUFFO0lBQUUsVUFBVSxHQUFHLEVBQUUsQ0FBQzs7QUFFakQsUUFBUSxDQUFDLGlCQUFpQixHQUFHOzs7O2NBQ3ZCLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxVQUFVLENBQUE7Ozs7O2lEQUN6QyxZQUFZLEdBQUcsSUFBSSxDQUFDLFVBQVU7Ozs0Q0FFakMsVUFBVTs7Ozs7OztDQUVwQixDQUFDOztBQUVGLFFBQVEsQ0FBQyxXQUFXLEdBQUc7TUFFakIsUUFBUTs7OztBQURaLDRCQUFPLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDOzt5Q0FDOUIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEtBQUssQ0FBQzs7O0FBQWhELGdCQUFROzRDQUNMLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBQyxPQUFPO2lCQUFLLE9BQU8sQ0FBQyxFQUFFO1NBQUEsQ0FBQzs7Ozs7OztDQUM3QyxDQUFDOztBQUVGLFFBQVEsQ0FBQyxVQUFVLEdBQUcsb0JBQWdCLElBQUksRUFBRSxRQUFRLEVBQUUsY0FBYztNQUN6RCxnQkFBZ0IsRUFpQm5CLEdBQUcsRUFjSCxTQUFTOzs7O0FBL0JOLHdCQUFnQixZQUFoQixnQkFBZ0IsQ0FBRSxPQUFPLEVBQUUsT0FBTyxFQUFFO0FBQzNDLGlCQUFR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QUM7Q0FDNUQsQ0FBQzs7QUFFRixPQUFPLENBQUMsYUFBYSxHQUFHLFVBQVUsR0FBRyxFQUFFO0FBQ3JDLE1BQUksQ0FBQyxXQUFXLEdBQUcsR0FBRyxDQUFDO0NBQ3hCLENBQUM7O0FBRUYsT0FBTyxDQUFDLGFBQWEsR0FBRyxZQUFZO0FBQ2xDLFNBQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQztDQUN6QixDQUFDOztBQUdGLGVBQWMsVUFBVSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNwQyxRQUFRLEdBQVIsUUFBUTtRQUFFLE9BQU8sR0FBUCxPQUFPO1FBQUUsVUFBVSxHQUFWLFVBQVU7UUFBRSxXQUFXLEdBQVgsV0FBVztRQUFFLFlBQVksR0FBWixZQUFZO3FCQUNsRCxVQUFVIiwiZmlsZSI6ImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBSZW1vdGVEZWJ1Z2dlciwgV2ViS2l0UmVtb3RlRGVidWdnZXIgfSBmcm9tICdhcHBpdW0tcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCB7IElPU1BlcmZvcm1hbmNlTG9nIH0gZnJvbSAnYXBwaXVtLWlvcy1sb2cnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnbW9iaWxlLWpzb24td2lyZS1wcm90b2NvbCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuXG5cbmNvbnN0IE5BVElWRV9XSU4gPSAnTkFUSVZFX0FQUCc7XG5jb25zdCBXRUJWSUVXX1dJTiA9ICdXRUJWSUVXJztcbmNvbnN0IFdFQlZJRVdfQkFTRSA9IGAke1dFQlZJRVdfV0lOfV9gO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbW1hbmRzLmdldEN1cnJlbnRDb250ZXh0ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5jdXJDb250ZXh0ICYmIHRoaXMuY3VyQ29udGV4dCAhPT0gTkFUSVZFX1dJTikge1xuICAgIHJldHVybiBgJHtXRUJWSUVXX0JBU0V9JHt0aGlzLmN1ckNvbnRleHR9YDtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gTkFUSVZFX1dJTjtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0Q29udGV4dHMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxvZ2dlci5kZWJ1ZygnR2V0dGluZyBsaXN0IG9mIGF2YWlsYWJsZSBjb250ZXh0cycpO1xuICBsZXQgY29udGV4dHMgPSBhd2FpdCB0aGlzLmdldENvbnRleHRzQW5kVmlld3MoZmFsc2UpO1xuICByZXR1cm4gY29udGV4dHMubWFwKChjb250ZXh0KSA9PiBjb250ZXh0LmlkKTtcbn07XG5cbmNvbW1hbmRzLnNldENvbnRleHQgPSBhc3luYyBmdW5jdGlvbiAobmFtZSwgY2FsbGJhY2ssIHNraXBSZWFkeUNoZWNrKSB7XG4gIGZ1bmN0aW9uIGFscmVhZHlJbkNvbnRleHQgKGRlc2lyZWQsIGN1cnJlbnQpIHtcbiAgICByZXR1cm4gKGRlc2lyZWQgPT09IGN1cnJlbnQgfHxcbiAgICAgICAgICAgKGRlc2lyZWQgPT09IG51bGwgJiYgY3VycmVudCA9PT0gTkFUSVZFX1dJTikgfHxcbiAgICAgICAgICAgKGRlc2lyZWQgPT09IE5BVElWRV9XSU4gJiYgY3VycmVudCA9PT0gbnVsbCkpO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHNldCBjb250ZXh0IHRvICcke25hbWV9J2ApO1xuICBpZiAoYWxyZWFkeUluQ29udGV4dChuYW1lLCB0aGlzLmN1ckNvbnRleHQpKSB7XG4gICAgLy8gYWxyZWFkeSBpbiB0aGUgbmFtZWQgY29udGV4dCwgbm8gbmVlZCB0byBkbyBhbnl0aGluZ1xuICB9IGVsc2UgaWYgKG5hbWUgPT09IE5BVElWRV9XSU4gfHwgbmFtZSA9PT0gbnVsbCkge1xuICAgIC8vIHN3aXRjaGluZyBpbnRvIHRoZSBuYXRpdmUgY29udGV4dFxuICAgIHRoaXMuY3VyQ29udGV4dCA9IG51bGw7XG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIHRoaXMucmVtb3RlLmRpc2Nvbm5lY3QoKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgLy8gc3dpdGNoaW5nIGludG8gYSB3ZWJ2aWV3IGNvbnRleHRcbiAgICBsZXQgaWR4ID0gbmFtZS5yZXBsYWNlKFdFQlZJRVdfQkFTRSwgJycpO1xuICAgIGlmIChpZHggPT09IFdFQlZJRVdfV0lOKSB7XG4gICAgICAvLyBhbGxvdyB1c2VyIHRvIHBhc3MgaW4gXCJXRUJWSUVXXCIgd2l0aG91dCBhbiBpbmRleFxuICAgICAgaWR4ID0gJzEnO1xuICAgIH1cblxuICAgIC8vIGlmIGNvbnRleHRzIGhhdmUgbm90IGFscmVhZHkgYmVlbiByZXRyaWV2ZWQsIGdldCB0aGVtXG4gICAgaWYgKF8uaXNVbmRlZmluZWQodGhpcy5jb250ZXh0cykpIHtcbiAgICAgIGF3YWl0IHRoaXMuZ2V0Q29udGV4dHMoKTtcbiAgICB9XG5cbiAgICBpZiAoIV8uaW5jbHVkZXModGhpcy5jb250ZXh0cywgaWR4KSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hDb250ZXh0RXJyb3IoKTtcbiAgICB9XG4gICAgbGV0IHBhZ2VJZEtleSA9IHBhcnNlSW50KGlkeCwgMTApO1xuXG4gICAgaWYgKCF0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICBhd2FpdCB0aGlzLnJlbW90ZS5zZWxlY3RQYWdlKHBhZ2VJZEtleSwgc2tpcFJlYWR5Q2hlY2spO1xuICAgICAgdGhpcy5jdXJDb250ZXh0ID0gaWR4O1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodGhpcy5yZW1vdGUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5yZW1vdGUuZGlzY29ubmVjdCgpO1xuICAgICAgfVxuICAgICAgdGhpcy5jdXJDb250ZXh0ID0gaWR4O1xuICAgICAgYXdhaXQgdGhpcy5yZW1vdGUuY29ubmVjdChpZHgpO1xuICAgIH1cbiAgfVxuXG4gIC8vIGF0dGVtcHQgdG8gc3RhcnQgcGVyZm9ybWFuY2UgbG9nZ2luZywgaWYgcmVxdWVzdGVkXG4gIGlmICh0aGlzLnBlcmZMb2dFbmFibGVkICYmIHRoaXMucmVtb3RlKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBTdGFydGluZyBwZXJmb3JtYW5jZSBsb2cgb24gJyR7dGhpcy5jdXJDb250ZXh0fSdgKTtcbiAgICB0aGlzLmxvZ3MucGVyZm9ybWFuY2UgPSBuZXcgSU9TUGVyZm9ybWFuY2VMb2codGhpcy5yZW1vdGUpO1xuICAgIHRoaXMubG9ncy5wZXJmb3JtYW5jZS5zdGFydENhcHR1cmUoKTtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0V2luZG93SGFuZGxlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuICByZXR1cm4gdGhpcy5jdXJDb250ZXh0O1xufTtcblxuY29tbWFuZHMuZ2V0V2luZG93SGFuZGxlcyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBsZXQgcGFnZUFycmF5ID0gYXdhaXQgdGhpcy5saXN0V2ViRnJhbWVzKCk7XG4gIHRoaXMud2luZG93SGFuZGxlQ2FjaGUgPSBfLm1hcChwYWdlQXJyYXksIHRoaXMubWFzc2FnZVBhZ2UpO1xuICBsZXQgaWRBcnJheSA9IF8ubWFwKHRoaXMud2luZG93SGFuZGxlQ2FjaGUsICdpZCcpO1xuICAvLyBzaW5jZSB3ZSB1c2UgdGhpcy5jb250ZXh0cyB0byBtYW5hZ2Ugc2VsZWN0aW5nIGRlYnVnZ2VyIHBhZ2VzLCBtYWtlXG4gIC8vIHN1cmUgaXQgZ2V0cyBwb3B1bGF0ZWQgZXZlbiBpZiBzb21lb25lIGRpZCBub3QgdXNlIHRoZVxuICAvLyBnZXRDb250ZXh0cyBtZXRob2RcbiAgaWYgKCF0aGlzLmNvbnRleHRzKSB7XG4gICAgdGhpcy5jb250ZXh0cyA9IGlkQXJyYXk7XG4gIH1cbiAgcmV0dXJuIGlkQXJyYXk7XG59O1xuXG5jb21tYW5kcy5zZXRXaW5kb3cgPSBhc3luYyBmdW5jdGlvbiAobmFtZSwgc2tpcFJlYWR5Q2hlY2spIHtcbiAgaWYgKCF0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBpZiAoIV8uaW5jbHVkZXMoXy5tYXAodGhpcy53aW5kb3dIYW5kbGVDYWNoZSwgJ2lkJyksIG5hbWUpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hXaW5kb3dFcnJvcigpO1xuICB9XG4gIGxldCBwYWdlSWRLZXkgPSBwYXJzZUludChuYW1lLCAxMCk7XG4gIGlmICghdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGF3YWl0IHRoaXMucmVtb3RlLnNlbGVjdFBhZ2UocGFnZUlkS2V5LCBza2lwUmVhZHlDaGVjayk7XG4gICAgdGhpcy5jdXJDb250ZXh0ID0gdGhpcy5jdXJXaW5kb3dIYW5kbGUgPSBuYW1lO1xuICB9IGVsc2Uge1xuICAgIGlmIChuYW1lID09PSB0aGlzLmN1cldpbmRvd0hhbmRsZSkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBSZW1vdGUgZGVidWdnZXIgaXMgYWxyZWFkeSBjb25uZWN0ZWQgdG8gd2luZG93ICcke25hbWV9J2ApO1xuICAgIH0gZWxzZSBpZiAoIV8uaW5jbHVkZXMoXy5tYXAodGhpcy53aW5kb3dIYW5kbGVDYWNoZSwgJ2lkJyksIG5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaFdpbmRvd0Vycm9yKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3RlLmRpc2Nvbm5lY3QoKTtcbiAgICAgIHRoaXMuY3VyQ29udGV4dCA9IHRoaXMuY3VyV2luZG93SGFuZGxlID0gbmFtZTtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3RlLmNvbm5lY3QobmFtZSk7XG4gICAgfVxuICB9XG59O1xuXG5oZWxwZXJzLndlYkNvbnRleHRJbmRleCA9IGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIHRoaXMuY3VyQ29udGV4dC5yZXBsYWNlKFdFQlZJRVdfQkFTRSwgJycpIC0gMTtcbn07XG5cbmV4dGVuc2lvbnMuaW5pdEF1dG9XZWJ2aWV3ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5vcHRzLmF1dG9XZWJ2aWV3KSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdTZXR0aW5nIGF1dG8gd2VidmlldycpO1xuICAgIGF3YWl0IHRoaXMubmF2VG9Jbml0aWFsV2Vidmlldyh0aGlzKTtcbiAgfVxufTtcblxuZXh0ZW5zaW9ucy5nZXRDb250ZXh0c0FuZFZpZXdzID0gYXN5bmMgZnVuY3Rpb24gKHVzZVVybCA9IHRydWUpIHtcbiAgbG9nZ2VyLmRlYnVnKCdSZXRyaWV2aW5nIGNvbnRleHRzIGFuZCB2aWV3cycpO1xuICBsZXQgd2Vidmlld3MgPSBhd2FpdCB0aGlzLmxpc3RXZWJGcmFtZXModXNlVXJsKTtcbiAgbGV0IGN0eHMgPSBbe2lkOiBOQVRJVkVfV0lOfV07XG4gIHRoaXMuY29udGV4dHMgPSBbTkFUSVZFX1dJTl07XG4gIGZvciAobGV0IHZpZXcgb2Ygd2Vidmlld3MpIHtcbiAgICBjdHhzLnB1c2goe2lkOiBgJHtXRUJWSUVXX0JBU0V9JHt2aWV3LmlkfWAsIHZpZXd9KTtcbiAgICB0aGlzLmNvbnRleHRzLnB1c2godmlldy5pZC50b1N0cmluZygpKTtcbiAgfVxuICByZXR1cm4gY3R4cztcbn07XG5cbmV4dGVuc2lvbnMubGlzdFdlYkZyYW1lcyA9IGFzeW5jIGZ1bmN0aW9uICh1c2VVcmwgPSB0cnVlKSB7XG4gIGlmICghdGhpcy5vcHRzLmJ1bmRsZUlkKSB7XG4gICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coJ0Nhbm5vdCBlbnRlciB3ZWIgZnJhbWUgd2l0aG91dCBhIGJ1bmRsZSBJRCcpO1xuICB9XG5cbiAgLyoganNoaW50IGlnbm9yZTpzdGFydCAqL1xuICBsb2dnZXIuZGVidWcoYFNlbGVjdGluZyBieSB1cmw6ICR7dXNlVXJsfSAke3VzZVVybCA/IGAoZXhwZWN0ZWQgdXJsOiAnJHt0aGlzLmdldEN1cnJlbnRVcmwoKX0nKWAgOiAnJ31gKTtcbiAgLyoganNoaW50IGlnbm9yZTplbmQgKi9cblxuICBsZXQgY3VycmVudFVybCA9IHVzZVVybCA/IHRoaXMuZ2V0Q3VycmVudFVybCgpIDogdW5kZWZpbmVkO1xuICBsZXQgcGFnZUFycmF5O1xuICBpZiAodGhpcy5yZW1vdGUgIT09IG51bGwgJiYgdGhpcy5yZW1vdGUuYXBwSWRLZXkgJiYgdGhpcy5vcHRzLmJ1bmRsZUlkICE9PSBudWxsKSB7XG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIHBhZ2VBcnJheSA9IGF3YWl0IHRoaXMucmVtb3RlLnBhZ2VBcnJheUZyb21Kc29uKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhZ2VBcnJheSA9IGF3YWl0IHRoaXMucmVtb3RlLnNlbGVjdEFwcChjdXJyZW50VXJsLCB0aGlzLm9wdHMud2Vidmlld0Nvbm5lY3RSZXRyaWVzKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICAgIHRoaXMucmVtb3RlID0gbmV3IFdlYktpdFJlbW90ZURlYnVnZ2VyKHtwb3J0OiB0aGlzLm9wdHMud2Via2l0RGVidWdQcm94eVBvcnR9KTtcbiAgICAgIHJldHVybiB0aGlzLnJlbW90ZS5wYWdlQXJyYXlGcm9tSnNvbigpO1xuICAgIH1cbiAgICB0aGlzLnJlbW90ZSA9IG5ldyBSZW1vdGVEZWJ1Z2dlcih7XG4gICAgICBidW5kbGVJZDogdGhpcy5vcHRzLmJ1bmRsZUlkLFxuICAgICAgdXNlTmV3U2FmYXJpOiB0aGlzLnVzZU5ld1NhZmFyaSgpLFxuICAgICAgcGFnZUxvYWRNczogdGhpcy5wYWdlTG9hZE1zLFxuICAgICAgcGxhdGZvcm1WZXJzaW9uOiB0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uXG4gICAgfSk7XG5cbiAgICBsZXQgYXBwSW5mbyA9IGF3YWl0IHRoaXMucmVtb3RlLmNvbm5lY3QoKTtcbiAgICBpZiAoIWFwcEluZm8pIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnVW5hYmxlIHRvIGNvbm5lY3QgdG8gdGhlIHJlbW90ZSBkZWJ1Z2dlci4nKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gICAgcGFnZUFycmF5ID0gYXdhaXQgdGhpcy5yZW1vdGUuc2VsZWN0QXBwKGN1cnJlbnRVcmwsIHRoaXMub3B0cy53ZWJ2aWV3Q29ubmVjdFJldHJpZXMpO1xuICAgIHRoaXMucmVtb3RlLm9uKFJlbW90ZURlYnVnZ2VyLkVWRU5UX1BBR0VfQ0hBTkdFLCB0aGlzLm9uUGFnZUNoYW5nZS5iaW5kKHRoaXMpKTtcblxuICAgIGxldCB0cnlDbG9zaW5nQWxlcnQgPSBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgZGlkRGlzbWlzcyA9IGF3YWl0IHRoaXMuY2xvc2VBbGVydEJlZm9yZVRlc3QoKTtcbiAgICAgIGlmICghZGlkRGlzbWlzcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nsb3NlIGFsZXJ0IGZhaWxlZC4gUmV0cnkuJyk7XG4gICAgICB9XG4gICAgfTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgzLCA0MDAwLCB0cnlDbG9zaW5nQWxlcnQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gaWYgdGhlIGxvb3AgdG8gY2xvc2UgYWxlcnRzIGZhaWxlZCB0byBkaXNtaXNzLCBpZ25vcmUsXG4gICAgICAvLyBvdGhlcndpc2UgbG9nIGFuZCB0aHJvdyB0aGUgZXJyb3JcbiAgICAgIGlmIChlcnIubWVzc2FnZSAhPT0gJ0Nsb3NlIGFsZXJ0IGZhaWxlZC4gUmV0cnkuJykge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhlcnIpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChwYWdlQXJyYXkubGVuZ3RoID09PSAwKSB7XG4gICAgLy8gd2UgaGF2ZSBubyB3ZWIgZnJhbWVzLCBidXQgY29udGludWUgYW55d2F5XG4gICAgbG9nZ2VyLmRlYnVnKCdObyB3ZWIgZnJhbWVzIGZvdW5kLicpO1xuICB9XG4gIHJldHVybiBwYWdlQXJyYXk7XG59O1xuXG5leHRlbnNpb25zLm9uUGFnZUNoYW5nZSA9IGFzeW5jIGZ1bmN0aW9uIChwYWdlQXJyYXkpIHtcbiAgbG9nZ2VyLmRlYnVnKGBSZW1vdGUgZGVidWdnZXIgbm90aWZpZWQgdXMgb2YgYSBuZXcgcGFnZSBsaXN0aW5nOiAke0pTT04uc3RyaW5naWZ5KHBhZ2VBcnJheSl9YCk7XG4gIGlmICh0aGlzLnNlbGVjdGluZ05ld1BhZ2UpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1dlIGFyZSBpbiB0aGUgbWlkZGxlIG9mIHNlbGVjdGluZyBhIHBhZ2UsIGlnbm9yaW5nJyk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxldCBuZXdJZHMgPSBbXTtcbiAgbGV0IG5ld1BhZ2VzID0gW107XG4gIGxldCBrZXlJZCA9IG51bGw7XG4gIGZvciAobGV0IHBhZ2Ugb2YgcGFnZUFycmF5KSB7XG4gICAgbGV0IGlkID0gcGFnZS5pZC50b1N0cmluZygpO1xuICAgIG5ld0lkcy5wdXNoKGlkKTtcbiAgICBpZiAocGFnZS5pc0tleSkge1xuICAgICAga2V5SWQgPSBpZDtcbiAgICB9XG4gICAgaWYgKCFfLmluY2x1ZGVzKHRoaXMuY29udGV4dHMsIGlkKSkge1xuICAgICAgbmV3UGFnZXMucHVzaChpZCk7XG4gICAgICB0aGlzLmNvbnRleHRzLnB1c2goaWQpO1xuICAgIH1cbiAgfVxuXG4gIGxldCBuZXdQYWdlID0gbnVsbDtcbiAgaWYgKHRoaXMuY3VyQ29udGV4dCA9PT0gbnVsbCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnV2UgZG8gbm90IGFwcGVhciB0byBoYXZlIHdpbmRvdyBzZXQgeWV0LCBpZ25vcmluZycpO1xuICB9IGVsc2UgaWYgKG5ld1BhZ2VzLmxlbmd0aCkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgV2UgaGF2ZSBuZXcgcGFnZXMsIGdvaW5nIHRvIHNlbGVjdCBwYWdlICcke25ld1BhZ2VzWzBdfSdgKTtcbiAgICBuZXdQYWdlID0gbmV3UGFnZXNbMF07XG4gIH0gZWxzZSBpZiAoIV8uaW5jbHVkZXMobmV3SWRzLCB0aGlzLmN1ckNvbnRleHQudG9TdHJpbmcoKSkpIHtcbiAgICBsb2dnZXIuZGVidWcoJ05ldyBwYWdlIGxpc3RpbmcgZnJvbSByZW1vdGUgZGVidWdnZXIgZG9lcyBub3QgY29udGFpbiAnICtcbiAgICAgICAgICAgICAgICAgJ2N1cnJlbnQgd2luZG93OyBhc3N1bWluZyBpdCBpcyBjbG9zZWQnKTtcbiAgICBpZiAoa2V5SWQgIT09IG51bGwpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgRGVidWdnZXIgYWxyZWFkeSBzZWxlY3RlZCBwYWdlICcke2tleUlkfScsIGAgK1xuICAgICAgICAgICAgICAgICAgIGBjb25maXJtaW5nIHRoYXQgY2hvaWNlLmApO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIuZXJyb3IoJ0RvIG5vdCBoYXZlIG91ciBjdXJyZW50IHdpbmRvdyBhbnltb3JlLCBhbmQgdGhlcmUgJyArXG4gICAgICAgICAgICAgICAgICAgJ2FyZSBub3QgYW55IG1vcmUgdG8gbG9hZCEgRG9pbmcgbm90aGluZy4uLicpO1xuICAgICAgdGhpcy5zZXRDdXJyZW50VXJsKHVuZGVmaW5lZCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuY3VyQ29udGV4dCA9IGtleUlkO1xuICAgIG5ld1BhZ2UgPSBrZXlJZDtcbiAgfSBlbHNlIHtcbiAgICAvLyBJZiBhIHdpbmRvdyBuYXZpZ2F0ZXMgdG8gYW4gYW5jaG9yIGl0IGRvZXNuJ3QgYWx3YXlzIGZpcmUgYSBwYWdlXG4gICAgLy8gY2FsbGJhY2sgZXZlbnQuIExldCdzIGNoZWNrIGlmIHdlIHdvdW5kIHVwIGluIHN1Y2ggYSBzaXR1YXRpb24uXG4gICAgbGV0IG5lZWRzUGFnZUxvYWQgPSAoKCkgPT4ge1xuICAgICAgbGV0IGl0ZW0gPSAoYXJyKSA9PiB7XG4gICAgICAgIHJldHVybiBfLmZpbHRlcihhcnIsIChvYmopID0+IHtcbiAgICAgICAgICByZXR1cm4gb2JqLmlkID09PSB0aGlzLmN1ckNvbnRleHQ7XG4gICAgICAgIH0pWzBdO1xuICAgICAgfTtcblxuICAgICAgcmV0dXJuICFfLmlzRXF1YWwoaXRlbSh0aGlzLmNvbnRleHRzKSwgaXRlbShwYWdlQXJyYXkpKTtcbiAgICB9KSgpO1xuXG4gICAgaWYgKG5lZWRzUGFnZUxvYWQpIHtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3RlLnBhZ2VMb2FkKCk7XG4gICAgfVxuXG4gICAgbG9nZ2VyLmRlYnVnKCdOZXcgcGFnZSBsaXN0aW5nIGlzIHNhbWUgYXMgb2xkLCBkb2luZyBub3RoaW5nJyk7XG4gIH1cblxuICAvLyBtYWtlIHN1cmUgdGhhdCB0aGUgcGFnZSBsaXN0aW5nIGlzbid0IGluZGljYXRpbmcgYSByZWRpcmVjdFxuICBpZiAodXRpbC5oYXNWYWx1ZSh0aGlzLmN1ckNvbnRleHQpKSB7XG4gICAgbGV0IHBhZ2UgPSBfLmZpbmQocGFnZUFycmF5LCAocCkgPT4ge1xuICAgICAgcmV0dXJuIHBhcnNlSW50KHAuaWQsIDEwKSA9PT0gcGFyc2VJbnQodGhpcy5jdXJDb250ZXh0LCAxMCk7XG4gICAgfSk7XG4gICAgaWYgKHBhZ2UgJiYgcGFnZS51cmwgIT09IHRoaXMuZ2V0Q3VycmVudFVybCgpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYFJlZGlyZWN0ZWQgZnJvbSAnJHt0aGlzLmdldEN1cnJlbnRVcmwoKX0nIHRvICcke3BhZ2UudXJsfSdgKTtcbiAgICAgIHRoaXMuc2V0Q3VycmVudFVybChwYWdlLnVybCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHV0aWwuaGFzVmFsdWUobmV3UGFnZSkpIHtcbiAgICB0aGlzLnNlbGVjdGluZ05ld1BhZ2UgPSB0cnVlO1xuICAgIGF3YWl0IHRoaXMucmVtb3RlLnNlbGVjdFBhZ2UocGFyc2VJbnQobmV3UGFnZSwgMTApKTtcbiAgICB0aGlzLnNlbGVjdGluZ05ld1BhZ2UgPSBmYWxzZTtcbiAgICB0aGlzLmN1ckNvbnRleHQgPSBuZXdQYWdlO1xuICB9XG4gIHRoaXMud2luZG93SGFuZGxlQ2FjaGUgPSBfLm1hcChwYWdlQXJyYXksIHRoaXMubWFzc2FnZVBhZ2UpO1xufTtcblxuZXh0ZW5zaW9ucy5nZXRMYXRlc3RXZWJ2aWV3Q29udGV4dEZvclRpdGxlID0gYXN5bmMgZnVuY3Rpb24gKHRpdGxlUmVnZXgpIHtcbiAgbGV0IGNvbnRleHRzID0gYXdhaXQgdGhpcy5nZXRDb250ZXh0c0FuZFZpZXdzKCk7XG4gIGxldCBtYXRjaGluZ0N0eDtcbiAgZm9yIChsZXQgY3R4IG9mIGNvbnRleHRzKSB7XG4gICAgaWYgKGN0eC52aWV3ICYmIChjdHgudmlldy50aXRsZSB8fCAnJykubWF0Y2godGl0bGVSZWdleCkpIHtcbiAgICAgIGlmIChjdHgudmlldy51cmwgIT09ICdhYm91dDpibGFuaycpIHtcbiAgICAgICAgbWF0Y2hpbmdDdHggPSBjdHg7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBpbiB0aGUgY2FzZXMgb2YgWGNvZGUgPCA1IChpLmUuLCBpT1MgU0RLIFZlcnNpb24gbGVzcyB0aGFuIDcpXG4gICAgICAgIC8vIGlPUyA3LjEsIGlPUyA5LjAgJiBpT1MgOS4xIGluIGEgd2VidmlldyAobm90IGluIFNhZmFyaSlcbiAgICAgICAgLy8gd2UgY2FuIGhhdmUgdGhlIHVybCBiZSBgYWJvdXQ6YmxhbmtgXG4gICAgICAgIGlmIChwYXJzZUZsb2F0KHRoaXMuaU9TU0RLVmVyc2lvbikgPCA3IHx8IHBhcnNlRmxvYXQodGhpcy5pT1NTREtWZXJzaW9uKSA+PSA5IHx8XG4gICAgICAgICAgICAodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiA9PT0gJzcuMScgJiYgdGhpcy5vcHRzLmFwcCAmJiB0aGlzLm9wdHMuYXBwLnRvTG93ZXJDYXNlKCkgIT09ICdzYWZhcmknKSkge1xuICAgICAgICAgIG1hdGNoaW5nQ3R4ID0gY3R4O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBtYXRjaGluZ0N0eCA/IG1hdGNoaW5nQ3R4LmlkIDogdW5kZWZpbmVkO1xufTtcblxuLy8gUmlnaHQgbm93IHdlIGRvbid0IG5lY2Vzc2FyaWx5IHdhaXQgZm9yIHdlYnZpZXdcbi8vIGFuZCBmcmFtZSB0byBsb2FkLCB3aGljaCBsZWFkcyB0byByYWNlIGNvbmRpdGlvbnMgYW5kIGZsYWtpbmVzcyxcbi8vIGxldCdzIHNlZSBpZiB3ZSBjYW4gdHJhbnNpdGlvbiB0byBzb21ldGhpbmcgYmV0dGVyXG5leHRlbnNpb25zLnVzZU5ld1NhZmFyaSA9IGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIHBhcnNlRmxvYXQodGhpcy5pb3NTZGtWZXJzaW9uKSA+PSA4LjEgJiZcbiAgICAgICAgIHBhcnNlRmxvYXQodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbikgPj0gOC4xICYmXG4gICAgICAgICAhdGhpcy5pc1JlYWxEZXZpY2UoKSAmJlxuICAgICAgICAgdGhpcy5vcHRzLnNhZmFyaTtcbn07XG5cbmV4dGVuc2lvbnMubmF2VG9Jbml0aWFsV2VidmlldyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IHRpbWVvdXQgPSAwO1xuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIHRpbWVvdXQgPSAzMDAwO1xuICAgIGxvZ2dlci5kZWJ1ZyhgV2FpdGluZyBmb3IgJHt0aW1lb3V0fSBtcyBiZWZvcmUgbmF2aWdhdGluZyB0byB2aWV3LmApO1xuICB9XG4gIGF3YWl0IEIuZGVsYXkodGltZW91dCk7XG4gIGlmICh0aGlzLnVzZU5ld1NhZmFyaSgpKSB7XG4gICAgYXdhaXQgdGhpcy50eXBlQW5kTmF2VG9VcmwoKTtcbiAgfSBlbHNlIGlmIChwYXJzZUludCh0aGlzLmlvc1Nka1ZlcnNpb24sIDEwKSA+PSA3ICYmICF0aGlzLmlzUmVhbERldmljZSgpICYmIHRoaXMub3B0cy5zYWZhcmkpIHtcbiAgICBhd2FpdCB0aGlzLm5hdlRvVmlld1Rocm91Z2hGYXZvcml0ZXMoKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCB0aGlzLm5hdlRvVmlld1dpdGhUaXRsZSgvLiovKTtcbiAgfVxufTtcblxuZXh0ZW5zaW9ucy50eXBlQW5kTmF2VG9VcmwgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIHRoaXMuc2V0Q3VycmVudFVybCh0aGlzLmNhcHMuc2FmYXJpSW5pdGlhbFVybCB8fCBgaHR0cDovLzEyNy4wLjAuMToke3RoaXMub3B0cy5wb3J0fS93ZWxjb21lYCk7XG5cbiAgbGV0IG9sZEltcFdhaXQgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuICB0aGlzLmltcGxpY2l0V2FpdE1zID0gNzAwMDtcblxuICAvLyBmaW5kIHRoZSB1cmwgYmFyLCBhbmQgdGFwIG9uIGl0LiByZXRyeSB0byBtYWtlIHN1cmUgd2UgZG9uJ3QgdHJ5XG4gIC8vIHRvbyBzb29uIHdoaWxlIHRoZSB2aWV3IGlzIHN0aWxsIGxvYWRpbmdcbiAgbGV0IGVsID0gYXdhaXQgcmV0cnlJbnRlcnZhbCgzLCAxMDAwLCBhc3luYyAoKSA9PiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVsZW1lbnQoJ2FjY2Vzc2liaWxpdHkgaWQnLCAnVVJMJyk7XG4gIH0pO1xuICB0aGlzLmltcGxpY2l0V2FpdE1zID0gb2xkSW1wV2FpdDtcbiAgYXdhaXQgdGhpcy5uYXRpdmVUYXAoZWwuRUxFTUVOVCk7XG5cbiAgLy8gZ2V0IHRoZSBsYXN0IGFkZHJlc3MgZWxlbWVudCBhbmQgc2V0IHRoZSB1cmxcbiAgLy8gdGhpcyBpcyBmbGFrZXkgb24gY2VydGFpbiBzeXN0ZW1zIHNvIHdlIHJldHJ5IHVudGlsIHdlIGdldCBzb21ldGhpbmdcbiAgbGV0IGVsSWQgPSBhd2FpdCByZXRyeUludGVydmFsKDUsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgZWwgPSBfLmxhc3QoYXdhaXQgdGhpcy5maW5kRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnVUlBVGV4dEZpZWxkJykpO1xuICAgIHJldHVybiBlbC5FTEVNRU5UO1xuICB9KTtcbiAgYXdhaXQgdGhpcy5zZXRWYWx1ZUltbWVkaWF0ZSh0aGlzLmdldEN1cnJlbnRVcmwoKSwgZWxJZCk7XG5cbiAgLy8gbWFrZSBpdCBoYXBwZW5cbiAgZWwgPSBhd2FpdCB0aGlzLmZpbmRFbGVtZW50KCdhY2Nlc3NpYmlsaXR5IGlkJywgJ0dvJyk7XG4gIGF3YWl0IHRoaXMubmF0aXZlVGFwKGVsLkVMRU1FTlQpO1xuICBhd2FpdCB0aGlzLm5hdlRvVmlld1dpdGhUaXRsZSgvLiovaSk7XG5cbiAgLy8gd2FpdCBmb3IgcGFnZSB0byBmaW5pc2ggbG9hZGluZy5cbiAgYXdhaXQgdGhpcy5yZW1vdGUucGFnZVVubG9hZCgpO1xufTtcblxuZXh0ZW5zaW9ucy5uYXZUb1ZpZXdUaHJvdWdoRmF2b3JpdGVzID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsb2dnZXIuZGVidWcoJ1dlIGFyZSBvbiBpT1M3KyBzaW11bGF0b3I6IGNsaWNraW5nIGFwcGxlIGJ1dHRvbiB0byBnZXQgaW50byBhIHdlYnZpZXcnKTtcbiAgbGV0IG9sZEltcFdhaXQgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuICB0aGlzLmltcGxpY2l0V2FpdE1zID0gNzAwMDsgLy8gd2FpdCA3cyBmb3IgYXBwbGUgYnV0dG9uIHRvIGV4aXN0XG5cbiAgbGV0IGVsO1xuICB0cnkge1xuICAgIGVsID0gYXdhaXQgdGhpcy5maW5kRWxlbWVudCgneHBhdGgnLCAnLy9VSUFTY3JvbGxWaWV3WzFdL1VJQUJ1dHRvblsxXScpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsZXQgbXNnID0gJ0NvdWxkIG5vdCBmaW5kIGJ1dHRvbiB0byBjbGljayB0byBnZXQgaW50byB3ZWJ2aWV3LiAnICtcbiAgICAgICAgICAgICAgJ1Byb2NlZWRpbmcgb24gdGhlIGFzc3VtcHRpb24gd2UgaGF2ZSBhIHdvcmtpbmcgb25lLic7XG4gICAgbG9nZ2VyLmVycm9yKG1zZyk7XG4gICAgdGhpcy5pbXBsaWNpdFdhaXRNcyA9IG9sZEltcFdhaXQ7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMubmF2VG9WaWV3V2l0aFRpdGxlKC8uKi9pKTtcbiAgfVxuICB0aGlzLmltcGxpY2l0V2FpdE1zID0gb2xkSW1wV2FpdDtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLm5hdGl2ZVRhcChlbC5FTEVNRU5UKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbGV0IG1zZyA9ICdDb3VsZCBub3QgY2xpY2sgYnV0dG9uIHRvIGdldCBpbnRvIHdlYnZpZXcuICcgK1xuICAgICAgICAgICAgICAnUHJvY2VlZGluZyBvbiB0aGUgYXNzdW1wdGlvbiB3ZSBoYXZlIGEgd29ya2luZyBvbmUuJztcbiAgICBsb2dnZXIuZXJyb3IobXNnKTtcbiAgfVxuICBhd2FpdCB0aGlzLm5hdlRvVmlld1dpdGhUaXRsZSgvYXBwbGUvaSk7XG59O1xuXG5leHRlbnNpb25zLm5hdlRvVmlld1dpdGhUaXRsZSA9IGFzeW5jIGZ1bmN0aW9uICh0aXRsZVJlZ2V4KSB7XG4gIGxvZ2dlci5kZWJ1ZygnTmF2aWdhdGluZyB0byBtb3N0IHJlY2VudGx5IG9wZW5lZCB3ZWJ2aWV3Jyk7XG4gIGxldCBzdGFydCA9IERhdGUubm93KCk7XG4gIGxldCBzcGluVGltZSA9IDUwMDtcbiAgbGV0IHNwaW5IYW5kbGVzID0gYXN5bmMgKCkgPT4ge1xuICAgIGxldCByZXM7XG4gICAgdHJ5IHtcbiAgICAgIHJlcyA9IGF3YWl0IHRoaXMuZ2V0TGF0ZXN0V2Vidmlld0NvbnRleHRGb3JUaXRsZSh0aXRsZVJlZ2V4KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChlcnIubWVzc2FnZS5pbmRleE9mKCdDb3VsZCBub3QgY29ubmVjdCB0byBhIHZhbGlkIGFwcCBhZnRlcicpID09PSAtMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBuYXZpZ2F0ZSB0byB3ZWJ2aWV3ISBFcnI6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICB9XG4gICAgICBsb2dnZXIuZGVidWcoJ0NvdWxkIG5vdCBuYXZpZ2F0ZSB0byB3ZWJ2aWV3LiBSZXRyeWluZyBpZiBwb3NzaWJsZS4nKTtcbiAgICB9XG4gICAgaWYgKHJlcykge1xuICAgICAgbGV0IGxhdGVzdFdpbmRvdyA9IHJlcztcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgUGlja2luZyB3ZWJ2aWV3ICcke2xhdGVzdFdpbmRvd30nYCk7XG4gICAgICBhd2FpdCB0aGlzLnNldENvbnRleHQobGF0ZXN0V2luZG93KTtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3RlLmNhbmNlbFBhZ2VMb2FkKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gbm8gd2VidmlldyB3YXMgZm91bmRcbiAgICBpZiAoKERhdGUubm93KCkgLSBzdGFydCkgPj0gOTAwMDApIHtcbiAgICAgIC8vIHRvbyBzbG93LCBnZXQgb3V0XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBuYXZpZ2F0ZSB0byB3ZWJ2aWV3OyB0aGVyZSBhcmUgbm9uZSEnKTtcbiAgICB9XG5cbiAgICBsb2dnZXIud2FybihcIkNvdWxkIG5vdCBmaW5kIGFueSB3ZWJ2aWV3cyB5ZXQsIHJlZnJlc2hpbmcvcmV0cnlpbmdcIik7XG4gICAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkgfHwgIXRoaXMub3B0cy5zYWZhcmkpIHtcbiAgICAgIC8vIG9uIGEgcmVhbCBkZXZpY2UsIHdoZW4gbm90IHVzaW5nIFNhZmFyaSwgd2UganVzdCB3YW50IHRvIHRyeSBhZ2FpblxuICAgICAgYXdhaXQgQi5kZWxheShzcGluVGltZSk7XG4gICAgICByZXR1cm4gYXdhaXQgc3BpbkhhbmRsZXMoKTtcbiAgICB9XG5cbiAgICAvLyBmaW5kIHRoZSByZWxvYWQgYnV0dG9uIGFuZCB0YXAgaXQsIGlmIHBvc3NpYmxlXG4gICAgbGV0IGVsZW1lbnQ7XG4gICAgdHJ5IHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnRmluZGluZyBhbmQgdGFwcGluZyByZWxvYWQgYnV0dG9uJyk7XG4gICAgICBlbGVtZW50ID0gYXdhaXQgdGhpcy5maW5kVUlFbGVtZW50T3JFbGVtZW50cygnYWNjZXNzaWJpbGl0eSBpZCcsICdSZWxvYWRCdXR0b24nLCAnJywgZmFsc2UpO1xuICAgICAgYXdhaXQgdGhpcy5uYXRpdmVUYXAoZWxlbWVudC5FTEVNRU5UKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci53YXJuKGBFcnJvciBmaW5kaW5nIGFuZCB0YXBwaW5nIHJlbG9hZCBidXR0b246ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICBsb2dnZXIud2FybignUmV0cnlpbmcuJyk7XG4gICAgICBhd2FpdCBCLmRlbGF5KHNwaW5UaW1lKTtcbiAgICB9XG5cbiAgICAvLyB0cnkgaXQgYWxsIGFnYWluXG4gICAgcmV0dXJuIGF3YWl0IHNwaW5IYW5kbGVzKCk7XG4gIH07XG4gIGF3YWl0IHNwaW5IYW5kbGVzKCk7XG59O1xuXG5oZWxwZXJzLmNsb3NlQWxlcnRCZWZvcmVUZXN0ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgcHJlc2VudCA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKCdhdS5hbGVydElzUHJlc2VudCgpJyk7XG4gIGlmICghcHJlc2VudCkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZygnQWxlcnQgcHJlc2VudCBiZWZvcmUgc3RhcnRpbmcgdGVzdCwgbGV0IHVzIGJhbmlzaCBpdCcpO1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZCgnYXUuZGlzbWlzc0FsZXJ0KCknKTtcbiAgbG9nZ2VyLmRlYnVnKCdBbGVydCBiYW5pc2hlZCEnKTtcbiAgcmV0dXJuIHRydWU7XG59O1xuXG5oZWxwZXJzLnN0b3BSZW1vdGUgPSBhc3luYyBmdW5jdGlvbiAoY2xvc2VXaW5kb3dCZWZvcmVEaXNjb25uZWN0aW5nID0gZmFsc2UpIHtcbiAgaWYgKCF0aGlzLnJlbW90ZSkge1xuICAgIGxvZ2dlci5lcnJvckFuZFRocm93KCdUcmllZCB0byBsZWF2ZSBhIHdlYiBmcmFtZSBidXQgd2VyZSBub3QgaW4gb25lJyk7XG4gIH1cblxuICBpZiAoY2xvc2VXaW5kb3dCZWZvcmVEaXNjb25uZWN0aW5nKSB7XG4gICAgYXdhaXQgdGhpcy5jbG9zZVdpbmRvdygpO1xuICB9XG4gIGF3YWl0IHRoaXMucmVtb3RlLmRpc2Nvbm5lY3QoKTtcbiAgdGhpcy5jdXJDb250ZXh0ID0gbnVsbDtcbiAgdGhpcy5jdXJXZWJGcmFtZXMgPSBbXTtcbiAgdGhpcy5jdXJXZWJDb29yZHMgPSBudWxsO1xuICB0aGlzLnJlbW90ZSA9IG51bGw7XG59O1xuXG5oZWxwZXJzLmlzV2ViQ29udGV4dCA9IGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuICEhdGhpcy5jdXJDb250ZXh0ICYmIHRoaXMuY3VyQ29udGV4dCAhPT0gTkFUSVZFX1dJTjtcbn07XG5cbmhlbHBlcnMuc2V0Q3VycmVudFVybCA9IGZ1bmN0aW9uICh1cmwpIHtcbiAgdGhpcy5fY3VycmVudFVybCA9IHVybDtcbn07XG5cbmhlbHBlcnMuZ2V0Q3VycmVudFVybCA9IGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIHRoaXMuX2N1cnJlbnRVcmw7XG59O1xuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMsIE5BVElWRV9XSU4sIFdFQlZJRVdfV0lOLCBXRUJWSUVXX0JBU0UgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXX0=