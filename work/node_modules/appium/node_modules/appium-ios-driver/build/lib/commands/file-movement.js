'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _mobileJsonWireProtocol = require('mobile-json-wire-protocol');

//import _ from 'lodash';

var _appiumSupport = require('appium-support');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _teen_process = require('teen_process');

var _admZip = require('adm-zip');

var _admZip2 = _interopRequireDefault(_admZip);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var commands = {},
    helpers = {},
    extensions = {};

// TODO: more explicit error message for all the file-movement commands

/*
 *  Get the full path to an iOS simulator file.
 *  Calls cb(err, fullFilePath)
 *  /Some/Path                           fetches a file relative to the root of the device's filesystem.
 *  /Applications/AppName.app/Some/Path  fetches a file relative to the root of that Application's .app directory, adding in the GUID.
 *  So it looks something like: /Applications/GUID-GUID-GUID-GUID/Some/Path
 */
helpers.getSimFileFullPath = function callee$0$0(remotePath) {
  var basePath, appName, appNameRegex, appNameMatches, findPath, _ref, stdout, appRoot, subPath;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        basePath = this.sim.getDir();
        appName = null;

        if (this.opts.app) {
          appNameRegex = new RegExp('\\' + _path2['default'].sep + '([\\w-]+\\.app)');
          appNameMatches = appNameRegex.exec(this.opts.app);

          if (appNameMatches) {
            appName = appNameMatches[1];
          }
        }
        // de-absolutize the path
        if (_appiumSupport.system.isWindows()) {
          if (remotePath.indexof("://") === 1) {
            remotePath = remotePath.slice(4);
          }
        } else {
          if (remotePath.indexOf("/") === 0) {
            remotePath = remotePath.slice(1);
          }
        }

        if (!(remotePath.indexOf(appName) === 0)) {
          context$1$0.next = 18;
          break;
        }

        _logger2['default'].debug("We want an app-relative file");

        findPath = basePath;

        if (this.opts.platformVersion >= 8) {
          // the .app file appears in /Containers/Data and /Containers/Bundle both. We only want /Bundle
          findPath = _path2['default'].resolve(basePath, "Containers", "Bundle");
        }
        findPath = findPath.replace(/\s/g, '\\ ');

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('find', [findPath, '-name', appName]));

      case 11:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        appRoot = stdout.replace(/\n$/, '');
        subPath = remotePath.substring(appName.length + 1);
        return context$1$0.abrupt('return', _path2['default'].resolve(appRoot, subPath));

      case 18:
        _logger2['default'].debug("We want a sim-relative file");
        return context$1$0.abrupt('return', _path2['default'].resolve(basePath, remotePath));

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pushFile = function callee$0$0(remotePath, base64Data) {
  var fullPath, content;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pushing ' + remotePath + ' to iOS simulator');

        if (!this.isRealDevice()) {
          context$1$0.next = 4;
          break;
        }

        _logger2['default'].debug("Unsupported: cannot write files to physical device");
        throw new _mobileJsonWireProtocol.errors.NotYetImplementedError();

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 6:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Attempting to write ' + fullPath + '...');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(fullPath));

      case 10:
        if (!context$1$0.sent) {
          context$1$0.next = 14;
          break;
        }

        _logger2['default'].debug(fullPath + ' already exists, deleting...');
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(fullPath));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].dirname(fullPath)));

      case 16:
        content = new Buffer(base64Data, 'base64');
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(fullPath, content));

      case 19:
        _logger2['default'].debug('Wrote ' + content.length + ' bytes to ' + fullPath);

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pullFile = function callee$0$0(remotePath) {
  var fullPath, data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pulling ' + remotePath + ' from sim');

        if (!this.isRealDevice()) {
          context$1$0.next = 3;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotYetImplementedError();

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 5:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Attempting to read ' + fullPath);
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(fullPath, { encoding: 'base64' }));

      case 9:
        data = context$1$0.sent;
        return context$1$0.abrupt('return', data);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.pullFolder = function callee$0$0(remotePath) {
  var fullPath, zip, buffer, data;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Pulling ' + remotePath + ' from sim');

        if (!this.isRealDevice()) {
          context$1$0.next = 3;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotYetImplementedError();

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.getSimFileFullPath(remotePath));

      case 5:
        fullPath = context$1$0.sent;

        _logger2['default'].debug('Adding ' + fullPath + ' to an in-memory zip archive');
        zip = new _admZip2['default']();

        zip.addLocalFolder(fullPath);
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(new _bluebird2['default'](function (resolve, reject) {
          zip.toBuffer(resolve, reject);
        }));

      case 11:
        buffer = context$1$0.sent;

        _logger2['default'].debug("Converting in-memory zip file to base64 encoded string");
        data = buffer.toString('base64');

        _logger2['default'].debug("Returning in-memory zip file as base54 encoded string");
        return context$1$0.abrupt('return', data);

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztzQ0FBdUIsMkJBQTJCOzs7OzZCQUVmLGdCQUFnQjs7c0JBQ2hDLFdBQVc7Ozs7b0JBQ2IsTUFBTTs7Ozs0QkFDRixjQUFjOztzQkFDaEIsU0FBUzs7Ozt3QkFDZCxVQUFVOzs7O0FBRXhCLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7Ozs7Ozs7Ozs7O0FBV2pELE9BQU8sQ0FBQyxrQkFBa0IsR0FBRyxvQkFBZ0IsVUFBVTtNQUNqRCxRQUFRLEVBQ1IsT0FBTyxFQUdMLFlBQVksRUFDWixjQUFjLEVBbUJkLFFBQVEsUUFPTixNQUFNLEVBQ1IsT0FBTyxFQUNQLE9BQU87Ozs7O0FBakNULGdCQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUU7QUFDNUIsZUFBTyxHQUFHLElBQUk7O0FBRWxCLFlBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7QUFDYixzQkFBWSxHQUFHLElBQUksTUFBTSxRQUFNLGtCQUFLLEdBQUcscUJBQWtCO0FBQ3pELHdCQUFjLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQzs7QUFDckQsY0FBSSxjQUFjLEVBQUU7QUFDbEIsbUJBQU8sR0FBRyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUM7V0FDN0I7U0FDRjs7QUFFRCxZQUFJLHNCQUFPLFNBQVMsRUFBRSxFQUFFO0FBQ3RCLGNBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7QUFDbkMsc0JBQVUsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1dBQ2xDO1NBQ0YsTUFBTTtBQUNMLGNBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FB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S04sSUFBSTs7OztBQWhCUiw0QkFBTyxLQUFLLGNBQVksVUFBVSxlQUFZLENBQUM7O2FBRTNDLElBQUksQ0FBQyxZQUFZLEVBQUU7Ozs7O2NBQ2YsSUFBSSwrQkFBTyxzQkFBc0IsRUFBRTs7Ozt5Q0FHdEIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQzs7O0FBQXBELGdCQUFROztBQUVaLDRCQUFPLEtBQUssYUFBVyxRQUFRLGtDQUErQixDQUFDO0FBQzNELFdBQUcsR0FBRyx5QkFBWTs7QUFDdEIsV0FBRyxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7eUNBQ1YsMEJBQU0sVUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFLO0FBQzVDLGFBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1NBQy9CLENBQUM7OztBQUZFLGNBQU07O0FBSVYsNEJBQU8sS0FBSyxDQUFDLHdEQUF3RCxDQUFDLENBQUM7QUFDbkUsWUFBSSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDOztBQUNwQyw0QkFBTyxLQUFLLENBQUMsdURBQXVELENBQUMsQ0FBQzs0Q0FDL0QsSUFBSTs7Ozs7OztDQUNaLENBQUM7O0FBRUYsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLFFBQVEsR0FBUixRQUFRO1FBQUUsT0FBTyxHQUFQLE9BQU87cUJBQ1gsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvZmlsZS1tb3ZlbWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycyB9IGZyb20gJ21vYmlsZS1qc29uLXdpcmUtcHJvdG9jb2wnO1xuLy9pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZnMsIHN5c3RlbSwgbWtkaXJwIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBBZG1aaXAgZnJvbSAnYWRtLXppcCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuLy8gVE9ETzogbW9yZSBleHBsaWNpdCBlcnJvciBtZXNzYWdlIGZvciBhbGwgdGhlIGZpbGUtbW92ZW1lbnQgY29tbWFuZHNcblxuLypcbiAqICBHZXQgdGhlIGZ1bGwgcGF0aCB0byBhbiBpT1Mgc2ltdWxhdG9yIGZpbGUuXG4gKiAgQ2FsbHMgY2IoZXJyLCBmdWxsRmlsZVBhdGgpXG4gKiAgL1NvbWUvUGF0aCAgICAgICAgICAgICAgICAgICAgICAgICAgIGZldGNoZXMgYSBmaWxlIHJlbGF0aXZlIHRvIHRoZSByb290IG9mIHRoZSBkZXZpY2UncyBmaWxlc3lzdGVtLlxuICogIC9BcHBsaWNhdGlvbnMvQXBwTmFtZS5hcHAvU29tZS9QYXRoICBmZXRjaGVzIGEgZmlsZSByZWxhdGl2ZSB0byB0aGUgcm9vdCBvZiB0aGF0IEFwcGxpY2F0aW9uJ3MgLmFwcCBkaXJlY3RvcnksIGFkZGluZyBpbiB0aGUgR1VJRC5cbiAqICBTbyBpdCBsb29rcyBzb21ldGhpbmcgbGlrZTogL0FwcGxpY2F0aW9ucy9HVUlELUdVSUQtR1VJRC1HVUlEL1NvbWUvUGF0aFxuICovXG5oZWxwZXJzLmdldFNpbUZpbGVGdWxsUGF0aCA9IGFzeW5jIGZ1bmN0aW9uIChyZW1vdGVQYXRoKSB7XG4gIGxldCBiYXNlUGF0aCA9IHRoaXMuc2ltLmdldERpcigpO1xuICBsZXQgYXBwTmFtZSA9IG51bGw7XG5cbiAgaWYgKHRoaXMub3B0cy5hcHApIHtcbiAgICBsZXQgYXBwTmFtZVJlZ2V4ID0gbmV3IFJlZ0V4cChgXFxcXCR7cGF0aC5zZXB9KFtcXFxcdy1dK1xcXFwuYXBwKWApO1xuICAgIGxldCBhcHBOYW1lTWF0Y2hlcyA9IGFwcE5hbWVSZWdleC5leGVjKHRoaXMub3B0cy5hcHApO1xuICAgIGlmIChhcHBOYW1lTWF0Y2hlcykge1xuICAgICAgYXBwTmFtZSA9IGFwcE5hbWVNYXRjaGVzWzFdO1xuICAgIH1cbiAgfVxuICAvLyBkZS1hYnNvbHV0aXplIHRoZSBwYXRoXG4gIGlmIChzeXN0ZW0uaXNXaW5kb3dzKCkpIHtcbiAgICBpZiAocmVtb3RlUGF0aC5pbmRleG9mKFwiOi8vXCIpID09PSAxKSB7XG4gICAgICByZW1vdGVQYXRoID0gcmVtb3RlUGF0aC5zbGljZSg0KTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKHJlbW90ZVBhdGguaW5kZXhPZihcIi9cIikgPT09IDApIHtcbiAgICAgIHJlbW90ZVBhdGggPSByZW1vdGVQYXRoLnNsaWNlKDEpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZW1vdGVQYXRoLmluZGV4T2YoYXBwTmFtZSkgPT09IDApIHtcbiAgICBsb2dnZXIuZGVidWcoXCJXZSB3YW50IGFuIGFwcC1yZWxhdGl2ZSBmaWxlXCIpO1xuXG4gICAgbGV0IGZpbmRQYXRoID0gYmFzZVBhdGg7XG4gICAgaWYgKHRoaXMub3B0cy5wbGF0Zm9ybVZlcnNpb24gPj0gOCkge1xuICAgICAgLy8gdGhlIC5hcHAgZmlsZSBhcHBlYXJzIGluIC9Db250YWluZXJzL0RhdGEgYW5kIC9Db250YWluZXJzL0J1bmRsZSBib3RoLiBXZSBvbmx5IHdhbnQgL0J1bmRsZVxuICAgICAgZmluZFBhdGggPSBwYXRoLnJlc29sdmUoYmFzZVBhdGgsIFwiQ29udGFpbmVyc1wiLCBcIkJ1bmRsZVwiKTtcbiAgICB9XG4gICAgZmluZFBhdGggPSAgZmluZFBhdGgucmVwbGFjZSgvXFxzL2csICdcXFxcICcpO1xuXG4gICAgbGV0IHsgc3Rkb3V0IH0gPSBhd2FpdCBleGVjKCdmaW5kJywgW2ZpbmRQYXRoLCAnLW5hbWUnLCBhcHBOYW1lXSk7XG4gICAgbGV0IGFwcFJvb3QgPSBzdGRvdXQucmVwbGFjZSgvXFxuJC8sICcnKTtcbiAgICBsZXQgc3ViUGF0aCA9IHJlbW90ZVBhdGguc3Vic3RyaW5nKGFwcE5hbWUubGVuZ3RoICsgMSk7XG4gICAgcmV0dXJuIHBhdGgucmVzb2x2ZShhcHBSb290LCBzdWJQYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIuZGVidWcoXCJXZSB3YW50IGEgc2ltLXJlbGF0aXZlIGZpbGVcIik7XG4gICAgcmV0dXJuIHBhdGgucmVzb2x2ZShiYXNlUGF0aCwgcmVtb3RlUGF0aCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnB1c2hGaWxlID0gYXN5bmMgZnVuY3Rpb24gKHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpIHtcbiAgbG9nZ2VyLmRlYnVnKGBQdXNoaW5nICR7cmVtb3RlUGF0aH0gdG8gaU9TIHNpbXVsYXRvcmApO1xuXG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiVW5zdXBwb3J0ZWQ6IGNhbm5vdCB3cml0ZSBmaWxlcyB0byBwaHlzaWNhbCBkZXZpY2VcIik7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICBsZXQgZnVsbFBhdGggPSBhd2FpdCB0aGlzLmdldFNpbUZpbGVGdWxsUGF0aChyZW1vdGVQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoYEF0dGVtcHRpbmcgdG8gd3JpdGUgJHtmdWxsUGF0aH0uLi5gKTtcbiAgaWYgKGF3YWl0IGZzLmV4aXN0cyhmdWxsUGF0aCkpIHtcbiAgICBsb2dnZXIuZGVidWcoYCR7ZnVsbFBhdGh9IGFscmVhZHkgZXhpc3RzLCBkZWxldGluZy4uLmApO1xuICAgIGF3YWl0IGZzLnVubGluayhmdWxsUGF0aCk7XG4gIH1cbiAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShmdWxsUGF0aCkpO1xuICBsZXQgY29udGVudCA9IG5ldyBCdWZmZXIoYmFzZTY0RGF0YSwgJ2Jhc2U2NCcpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUoZnVsbFBhdGgsIGNvbnRlbnQpO1xuICBsb2dnZXIuZGVidWcoYFdyb3RlICR7Y29udGVudC5sZW5ndGh9IGJ5dGVzIHRvICR7ZnVsbFBhdGh9YCk7XG59O1xuXG5jb21tYW5kcy5wdWxsRmlsZSA9IGFzeW5jIGZ1bmN0aW9uIChyZW1vdGVQYXRoKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgUHVsbGluZyAke3JlbW90ZVBhdGh9IGZyb20gc2ltYCk7XG5cbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuICBsZXQgZnVsbFBhdGggPSBhd2FpdCB0aGlzLmdldFNpbUZpbGVGdWxsUGF0aChyZW1vdGVQYXRoKTtcblxuICBsb2dnZXIuZGVidWcoYEF0dGVtcHRpbmcgdG8gcmVhZCAke2Z1bGxQYXRofWApO1xuICBsZXQgZGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKGZ1bGxQYXRoLCB7ZW5jb2Rpbmc6ICdiYXNlNjQnfSk7XG4gIHJldHVybiBkYXRhO1xufTtcblxuY29tbWFuZHMucHVsbEZvbGRlciA9IGFzeW5jIGZ1bmN0aW9uIChyZW1vdGVQYXRoKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgUHVsbGluZyAke3JlbW90ZVBhdGh9IGZyb20gc2ltYCk7XG5cbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuXG4gIGxldCBmdWxsUGF0aCA9IGF3YWl0IHRoaXMuZ2V0U2ltRmlsZUZ1bGxQYXRoKHJlbW90ZVBhdGgpO1xuXG4gIGxvZ2dlci5kZWJ1ZyhgQWRkaW5nICR7ZnVsbFBhdGh9IHRvIGFuIGluLW1lbW9yeSB6aXAgYXJjaGl2ZWApO1xuICBsZXQgemlwID0gbmV3IEFkbVppcCgpO1xuICB6aXAuYWRkTG9jYWxGb2xkZXIoZnVsbFBhdGgpO1xuICBsZXQgYnVmZmVyID0gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHppcC50b0J1ZmZlcihyZXNvbHZlLCByZWplY3QpO1xuICB9KTtcblxuICBsb2dnZXIuZGVidWcoXCJDb252ZXJ0aW5nIGluLW1lbW9yeSB6aXAgZmlsZSB0byBiYXNlNjQgZW5jb2RlZCBzdHJpbmdcIik7XG4gIGxldCBkYXRhID0gYnVmZmVyLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgbG9nZ2VyLmRlYnVnKFwiUmV0dXJuaW5nIGluLW1lbW9yeSB6aXAgZmlsZSBhcyBiYXNlNTQgZW5jb2RlZCBzdHJpbmdcIik7XG4gIHJldHVybiBkYXRhO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdfQ==