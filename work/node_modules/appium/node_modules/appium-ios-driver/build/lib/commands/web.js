'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _mobileJsonWireProtocol = require('mobile-json-wire-protocol');

var _appiumCookies = require('appium-cookies');

var _appiumCookies2 = _interopRequireDefault(_appiumCookies);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var commands = {},
    helpers = {},
    extensions = {};

var ELEMENT_OFFSET = 5000;

commands.setFrame = function callee$0$0(frame) {
  var command, atom, atomsElement, value;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 6;
          break;
        }

        frame = frame ? frame : 'target.frontMostApp()';
        command = 'wd_frame = ' + frame;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        atom = undefined;

        if (!_lodash2['default'].isNull(frame)) {
          context$1$0.next = 11;
          break;
        }

        this.curWebFrames = [];
        _logger2['default'].debug('Leaving web frame and going back to default content');
        return context$1$0.abrupt('return');

      case 11:
        if (_lodash2['default'].isUndefined(frame.ELEMENT)) {
          context$1$0.next = 20;
          break;
        }

        atomsElement = this.useAtomsElement(frame.ELEMENT);
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(this.executeAtom('get_frame_window', [atomsElement]));

      case 15:
        value = context$1$0.sent;

        _logger2['default'].debug('Entering new web frame: \'' + value.WINDOW + '\'');
        this.curWebFrames.unshift(value.WINDOW);
        context$1$0.next = 28;
        break;

      case 20:
        atom = _lodash2['default'].isNumber(frame) ? 'frame_by_index' : 'frame_by_id_or_name';
        context$1$0.next = 23;
        return _regeneratorRuntime.awrap(this.executeAtom(atom, [frame]));

      case 23:
        value = context$1$0.sent;

        if (!(_lodash2['default'].isNull(value) || _lodash2['default'].isUndefined(value.WINDOW))) {
          context$1$0.next = 26;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NoSuchFrameError();

      case 26:
        _logger2['default'].debug('Entering new web frame: \'' + value.WINDOW + '\'');
        this.curWebFrames.unshift(value.WINDOW);

      case 28:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getCssProperty = function callee$0$0(propertyName, el) {
  var atomsElement;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('get_value_of_css_property', [atomsElement, propertyName]));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.submit = function callee$0$0(el) {
  var atomsElement;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 6;
          break;
        }

        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.executeAtom('submit', [atomsElement]));

      case 4:
        context$1$0.next = 7;
        break;

      case 6:
        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.refresh = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('refresh', []));

      case 3:
        context$1$0.next = 6;
        break;

      case 5:
        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setUrl = function callee$0$0(url) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Attempting to set url \'' + url + '\'');

        if (this.isWebContext()) {
          context$1$0.next = 3;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 3:
        this.setCurrentUrl(url);
        // make sure to clear out any leftover web frames
        this.curWebFrames = [];
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.remote.navToUrl(url));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getUrl = function callee$0$0() {
  var url;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.remote.execute('window.location.href'));

      case 4:
        url = context$1$0.sent;

        this.setCurrentUrl(url);
        return context$1$0.abrupt('return', url);

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.title = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.executeAtom('title', [], true));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getCookies = function callee$0$0() {
  var script, jsCookies, cookies, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, _name, value;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 2:

        _logger2['default'].debug('Retrieving all cookies');

        script = 'return document.cookie';
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, []]));

      case 6:
        jsCookies = context$1$0.sent;
        cookies = [];
        context$1$0.prev = 8;
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 12;

        for (_iterator = _getIterator(_lodash2['default'].toPairs(_appiumCookies2['default'].createJWPCookie(undefined, jsCookies))); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          _step$value = _slicedToArray(_step.value, 2);
          _name = _step$value[0];
          value = _step$value[1];

          cookies.push({ name: _name, value: value });
        }
        context$1$0.next = 20;
        break;

      case 16:
        context$1$0.prev = 16;
        context$1$0.t0 = context$1$0['catch'](12);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 20:
        context$1$0.prev = 20;
        context$1$0.prev = 21;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 23:
        context$1$0.prev = 23;

        if (!_didIteratorError) {
          context$1$0.next = 26;
          break;
        }

        throw _iteratorError;

      case 26:
        return context$1$0.finish(23);

      case 27:
        return context$1$0.finish(20);

      case 28:
        return context$1$0.abrupt('return', cookies);

      case 31:
        context$1$0.prev = 31;
        context$1$0.t1 = context$1$0['catch'](8);

        _logger2['default'].error(context$1$0.t1);
        throw new _mobileJsonWireProtocol.errors.UnknownError('Error parsing cookies from result: \'' + jsCookies + '\'');

      case 35:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[8, 31], [12, 16, 20, 28], [21,, 23, 27]]);
};

commands.setCookie = function callee$0$0(cookie) {
  var jsCookie, script;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 2:

        cookie = _lodash2['default'].clone(cookie);

        // if `path` field is not specified, Safari will not update cookies as expected; eg issue #1708
        if (!cookie.path) {
          cookie.path = "/";
        }

        jsCookie = _appiumCookies2['default'].createJSCookie(cookie.name, cookie.value, {
          expires: _lodash2['default'].isNumber(cookie.expiry) ? new Date(cookie.expiry * 1000).toUTCString() : cookie.expiry,
          path: cookie.path,
          domain: cookie.domain,
          httpOnly: cookie.httpOnly,
          secure: cookie.secure
        });
        script = 'document.cookie = ' + JSON.stringify(jsCookie);
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, []]));

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.deleteCookie = function callee$0$0(cookieName) {
  var cookies;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.getCookies());

      case 4:
        cookies = context$1$0.sent;

        if (!(_lodash2['default'].indexOf(_lodash2['default'].map(cookies, 'name'), cookieName) === -1)) {
          context$1$0.next = 8;
          break;
        }

        _logger2['default'].debug('Cookie \'' + cookieName + '\' not found. Ignoring.');
        return context$1$0.abrupt('return', true);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this._deleteCookie(cookieName));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.deleteCookies = function callee$0$0() {
  var cookies, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, cookie;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (this.isWebContext()) {
          context$1$0.next = 2;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotImplementedError();

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.getCookies());

      case 4:
        cookies = context$1$0.sent;

        if (!cookies.length) {
          context$1$0.next = 32;
          break;
        }

        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 9;
        _iterator2 = _getIterator(cookies);

      case 11:
        if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
          context$1$0.next = 18;
          break;
        }

        cookie = _step2.value;
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(this._deleteCookie(cookie.name));

      case 15:
        _iteratorNormalCompletion2 = true;
        context$1$0.next = 11;
        break;

      case 18:
        context$1$0.next = 24;
        break;

      case 20:
        context$1$0.prev = 20;
        context$1$0.t0 = context$1$0['catch'](9);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t0;

      case 24:
        context$1$0.prev = 24;
        context$1$0.prev = 25;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 27:
        context$1$0.prev = 27;

        if (!_didIteratorError2) {
          context$1$0.next = 30;
          break;
        }

        throw _iteratorError2;

      case 30:
        return context$1$0.finish(27);

      case 31:
        return context$1$0.finish(24);

      case 32:
        return context$1$0.abrupt('return', true);

      case 33:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[9, 20, 24, 32], [25,, 27, 31]]);
};

helpers._deleteCookie = function callee$0$0(cookieName) {
  var webCookie, script;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Deleting cookie \'' + cookieName + '\'');
        webCookie = _appiumCookies2['default'].expireCookie(cookieName, { path: "/" });
        script = 'document.cookie = ' + JSON.stringify(webCookie);
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, []]));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.findWebElementOrElements = function callee$0$0(strategy, selector, many, ctx) {
  var atomsElement, element, doFind;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        atomsElement = this.getAtomsElement(ctx);
        element = undefined;

        doFind = function doFind() {
          return _regeneratorRuntime.async(function doFind$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.next = 2;
                return _regeneratorRuntime.awrap(this.executeAtom('find_element' + (many ? 's' : ''), [strategy, selector, atomsElement]));

              case 2:
                element = context$2$0.sent;
                return context$2$0.abrupt('return', !_lodash2['default'].isNull(element));

              case 4:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        };

        context$1$0.prev = 3;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.implicitWaitForCondition(doFind));

      case 6:
        context$1$0.next = 15;
        break;

      case 8:
        context$1$0.prev = 8;
        context$1$0.t0 = context$1$0['catch'](3);

        if (!(context$1$0.t0.message && context$1$0.t0.message.match(/Condition unmet/))) {
          context$1$0.next = 14;
          break;
        }

        // condition was not met setting res to empty array
        element = [];
        context$1$0.next = 15;
        break;

      case 14:
        throw context$1$0.t0;

      case 15:
        if (!many) {
          context$1$0.next = 19;
          break;
        }

        return context$1$0.abrupt('return', element);

      case 19:
        if (!(!element || _lodash2['default'].size(element) === 0)) {
          context$1$0.next = 21;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NoSuchElementError();

      case 21:
        return context$1$0.abrupt('return', element);

      case 22:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 8]]);
};

extensions.webFlickElement = function callee$0$0(el, xoffset, yoffset) {
  var atomsElement, _ref, x, y, _ref2, width, height, from, to, args, command;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.useAtomsElement(el));

      case 2:
        atomsElement = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('get_top_left_coordinates', [atomsElement]));

      case 5:
        _ref = context$1$0.sent;
        x = _ref.x;
        y = _ref.y;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.executeAtom('get_size', [atomsElement]));

      case 10:
        _ref2 = context$1$0.sent;
        width = _ref2.width;
        height = _ref2.height;

        // translate to proper coordinates
        x = x + width / 2;
        y = y + height / 2;

        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(this.translateWebCoords({ x: x, y: y }));

      case 17:
        from = context$1$0.sent;
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(this.translateWebCoords({ x: x + xoffset, y: y + yoffset }));

      case 20:
        to = context$1$0.sent;
        args = { from: from, to: to };
        command = 'au.flick(' + JSON.stringify(args) + ')';
        context$1$0.next = 25;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 25:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.mobileWebNav = function callee$0$0(navType) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        this.remote.allowNavigationWithoutReload();
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', ['history.' + navType + '();', null]));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.nativeWebTap = function callee$0$0(el) {
  var atomsElement, _ref3, x, y, _ref4, width, height;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        atomsElement = this.useAtomsElement(el);
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('get_top_left_coordinates', [atomsElement]));

      case 3:
        _ref3 = context$1$0.sent;
        x = _ref3.x;
        y = _ref3.y;
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.executeAtom('get_size', [atomsElement]));

      case 8:
        _ref4 = context$1$0.sent;
        width = _ref4.width;
        height = _ref4.height;

        x = x + width / 2;
        y = y + height / 2;
        this.curWebCoords = { x: x, y: y };
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.clickWebCoords());

      case 16:
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(500));

      case 18:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.clickWebCoords = function callee$0$0() {
  var coords;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.translateWebCoords(this.curWebCoords));

      case 2:
        coords = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.clickCoords(coords));

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

extensions.translateWebCoords = function callee$0$0(coords) {
  var wvCmd, webviewIndex, yOffset, webviews, wvId, locCmd, rect, wvPos, realDims, cmd, _ref5, w, h, wvDims, xRatio, yRatio, serviceBarHeight, newCoords;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Translating coordinates (' + JSON.stringify(coords) + ') to web coordinates');
        wvCmd = 'au.getElementsByType(\'webview\')';
        webviewIndex = this.webContextIndex();
        yOffset = this.curOrientation === 'LANDSCAPE' ? this.landscapeWebCoordsOffset : 0;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(wvCmd));

      case 6:
        webviews = context$1$0.sent;

        if (!(webviews.length < 1)) {
          context$1$0.next = 9;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.UnknownError.code('Could not find any webviews to click inside!');

      case 9:
        if (_lodash2['default'].isUndefined(webviews[webviewIndex])) {
          _logger2['default'].warn('Could not find webview at index ' + webviewIndex + ', taking ' + 'last available one for clicking purposes');
          webviewIndex = webviews.length - 1;
        }

        wvId = webviews[webviewIndex].ELEMENT;
        locCmd = 'au.getElement(\'' + wvId + '\').rect()';
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(locCmd));

      case 14:
        rect = context$1$0.sent;
        wvPos = { x: rect.origin.x, y: rect.origin.y };
        realDims = { w: rect.size.width, h: rect.size.height };
        cmd = '(function () { return {w: document.width, h: document.height}; })()';
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(this.remote.execute(cmd));

      case 20:
        _ref5 = context$1$0.sent;
        w = _ref5.w;
        h = _ref5.h;
        wvDims = { w: w, h: h };

        if (!(wvDims && realDims && wvPos)) {
          context$1$0.next = 32;
          break;
        }

        xRatio = realDims.w / wvDims.w;
        yRatio = realDims.h / wvDims.h;
        serviceBarHeight = 20;

        if (parseFloat(this.opts.platformVersion) >= 8) {
          // ios8 includes the service bar height in the app
          serviceBarHeight = 0;
        }
        newCoords = {
          x: wvPos.x + Math.round(xRatio * coords.x),
          y: wvPos.y + yOffset + Math.round(yRatio * coords.y) - serviceBarHeight
        };

        _logger2['default'].debug('Converted web coords ' + JSON.stringify(coords) + ' ' + ('into real coords ' + JSON.stringify(newCoords)));
        return context$1$0.abrupt('return', newCoords);

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.clickCoords = function callee$0$0(coords) {
  var opts, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.useRobot) {
          context$1$0.next = 4;
          break;
        }

        throw new _mobileJsonWireProtocol.errors.NotYetImplementedError();

      case 4:
        opts = coords;

        opts.tapCount = 1;
        opts.duration = 0.3;
        opts.touchCount = 1;
        command = 'au.complexTap(' + JSON.stringify(opts) + ')';
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.executeAtom = function callee$0$0(atom, args) {
  var alwaysDefaultFrame = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
  var frames, promise;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        frames = alwaysDefaultFrame === true ? [] : this.curWebFrames;
        promise = this.remote.executeAtom(atom, args, frames);
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.waitForAtom(promise));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.executeAtomAsync = function callee$0$0(atom, args, responseUrl) {
  var promise;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        promise = new _bluebird2['default'](function (resolve, reject) {
          _this2.asyncPromise = { resolve: resolve, reject: reject };
        });
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.remote.executeAtomAsync(atom, args, this.curWebFrames, responseUrl));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.waitForAtom(promise));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.waitForAtom = function callee$0$0(promise) {
  var done, error, i, res;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        done = false;
        error = null;

        promise.then(function (res) {
          done = true;
          return res;
        })['catch'](function (err) {
          _logger2['default'].debug('Error received while executing atom: ' + err.message);
          // error gets swallowed, so save and check later
          done = true;
          error = err;
        });
        // try ten times to check alert, if we are not done yet
        i = 0;

      case 4:
        if (!(i < 10)) {
          context$1$0.next = 18;
          break;
        }

        if (!done) {
          context$1$0.next = 7;
          break;
        }

        return context$1$0.abrupt('break', 18);

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(500));

      case 9:
        if (!done) {
          context$1$0.next = 11;
          break;
        }

        return context$1$0.abrupt('break', 18);

      case 11:
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(this.checkForAlert());

      case 13:
        if (!context$1$0.sent) {
          context$1$0.next = 15;
          break;
        }

        return context$1$0.abrupt('return', '');

      case 15:
        i++;
        context$1$0.next = 4;
        break;

      case 18:
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(promise);

      case 20:
        res = context$1$0.sent;

        if (!error) {
          context$1$0.next = 23;
          break;
        }

        throw error;

      case 23:
        return context$1$0.abrupt('return', this.parseExecuteResponse(res));

      case 24:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.checkForAlert = function callee$0$0() {
  var present;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (_lodash2['default'].isNull(this.uiAutoClient)) {
          context$1$0.next = 7;
          break;
        }

        _logger2['default'].debug('atom did not return yet, checking to see if ' + 'we are blocked by an alert');
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.alertIsPresent()'));

      case 4:
        present = context$1$0.sent;

        if (!present) {
          _logger2['default'].debug('No alert found.');
        } else {
          _logger2['default'].debug('Found an alert, returning control to client');
        }
        return context$1$0.abrupt('return', present);

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.getAtomsElement = function (wdId) {
  var atomsId = undefined;
  try {
    atomsId = this.webElementIds[parseInt(wdId, 10) - ELEMENT_OFFSET];
  } catch (e) {
    return null;
  }
  if (_lodash2['default'].isUndefined(atomsId)) {
    return null;
  }
  return { ELEMENT: atomsId };
};

helpers.useAtomsElement = function (el) {
  if (parseInt(el, 10) < ELEMENT_OFFSET) {
    _logger2['default'].debug('Element with id \'' + el + '\' passed in for use with ' + ('atoms, but it\'s out of our internal scope. Adding ' + ELEMENT_OFFSET + '.'));
    el = (parseInt(el, 10) + ELEMENT_OFFSET).toString();
  }
  var atomsElement = this.getAtomsElement(el);
  if (atomsElement === null) {
    throw new _mobileJsonWireProtocol.errors.UnknownError('Error converting element ID for using in WD atoms: ' + el);
  }
  return atomsElement;
};

helpers.convertElementsForAtoms = function () {
  var args = arguments.length <= 0 || arguments[0] === undefined ? [] : arguments[0];

  var newArgs = [];
  var _iteratorNormalCompletion3 = true;
  var _didIteratorError3 = false;
  var _iteratorError3 = undefined;

  try {
    for (var _iterator3 = _getIterator(args), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
      var arg = _step3.value;

      if (!_lodash2['default'].isNull(arg) && !_lodash2['default'].isUndefined(arg.ELEMENT)) {
        var atomsElement = this.getAtomsElement(arg.ELEMENT);
        if (atomsElement === null) {
          throw new _mobileJsonWireProtocol.errors.UnknownError('Error converting element ID for using in WD atoms: ' + arg.ELEMENT);
        }
        newArgs.push(atomsElement);
      } else {
        newArgs.push(arg);
      }
    }
  } catch (err) {
    _didIteratorError3 = true;
    _iteratorError3 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion3 && _iterator3['return']) {
        _iterator3['return']();
      }
    } finally {
      if (_didIteratorError3) {
        throw _iteratorError3;
      }
    }
  }

  return newArgs;
};

helpers.parseExecuteResponse = function (res) {
  if (_lodash2['default'].isNull(res) || _lodash2['default'].isUndefined(res)) return null;

  var wdElement = null;
  if (!_lodash2['default'].isArray(res)) {
    if (!_lodash2['default'].isUndefined(res.ELEMENT)) {
      wdElement = this.parseElementResponse(res);
      if (wdElement === null) {
        throw new _mobileJsonWireProtocol.errors.UnknownError('Error converting element ID atom for using in WD: ' + res.ELEMENT);
      }
      res = wdElement;
    }
  } else {
    // value is an array, so go through and convert each
    var args = [];
    var _iteratorNormalCompletion4 = true;
    var _didIteratorError4 = false;
    var _iteratorError4 = undefined;

    try {
      for (var _iterator4 = _getIterator(res), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
        var arg = _step4.value;

        wdElement = arg;
        if (!_lodash2['default'].isNull(arg) && !_lodash2['default'].isUndefined(arg.ELEMENT)) {
          wdElement = this.parseElementResponse(arg);
          if (wdElement === null) {
            throw new _mobileJsonWireProtocol.errors.UnknownError('Error converting element ID atom for using in WD: ' + arg.ELEMENT);
          }
          args.push(wdElement);
        }
      }
    } catch (err) {
      _didIteratorError4 = true;
      _iteratorError4 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion4 && _iterator4['return']) {
          _iterator4['return']();
        }
      } finally {
        if (_didIteratorError4) {
          throw _iteratorError4;
        }
      }
    }

    res = args;
  }
  return res;
};

helpers.parseElementResponse = function (element) {
  var objId = element.ELEMENT;
  var clientId = (ELEMENT_OFFSET + this.webElementIds.length).toString();
  this.webElementIds.push(objId);
  return { ELEMENT: clientId };
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// in the future, detect whether we have a UIWebView that we can use to
// make sense of this command. For now, and otherwise, it's a no-op

// check cookie existence

// make sure real tap actually has time to register

// add static offset for safari in landscape mode

// absolutize web coords

// var tapUrl = this.args.robotUrl + "/tap";
// request.post({url:tapUrl, form: {x:coords.x, y:coords.y}}, cb);
/*TODO*/
// save the resolve and reject methods of the promise to be waited for

// need to check for alert while the atom is being executed.
// so notify ourselves when it happens

// check if the promise has been resolved

// check if there is an alert

// we found an alert, and should just return control
//# sourceMappingURL=data:application/json;base64,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QUFFRixPQUFPLENBQUMsb0JBQW9CLEdBQUcsVUFBVSxPQUFPLEVBQUU7QUFDaEQsTUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztBQUM1QixNQUFJLFFBQVEsR0FBRyxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQSxDQUFFLFFBQVEsRUFBRSxDQUFDO0FBQ3ZFLE1BQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQy9CLFNBQU8sRUFBQyxPQUFPLEVBQUUsUUFBUSxFQUFDLENBQUM7Q0FDNUIsQ0FBQzs7QUFHRixlQUFjLFVBQVUsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDcEMsUUFBUSxHQUFSLFFBQVE7UUFBRSxPQUFPLEdBQVAsT0FBTztxQkFDWCxVQUFVIiwiZmlsZSI6ImxpYi9jb21tYW5kcy93ZWIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnbW9iaWxlLWpzb24td2lyZS1wcm90b2NvbCc7XG5pbXBvcnQgY29va2llVXRpbHMgZnJvbSAnYXBwaXVtLWNvb2tpZXMnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuXG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgRUxFTUVOVF9PRkZTRVQgPSA1MDAwO1xuXG5jb21tYW5kcy5zZXRGcmFtZSA9IGFzeW5jIGZ1bmN0aW9uIChmcmFtZSkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBmcmFtZSA9IGZyYW1lID8gZnJhbWUgOiAndGFyZ2V0LmZyb250TW9zdEFwcCgpJztcbiAgICBsZXQgY29tbWFuZCA9IGB3ZF9mcmFtZSA9ICR7ZnJhbWV9YDtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY29tbWFuZCk7XG4gIH1cblxuICBsZXQgYXRvbTtcbiAgaWYgKF8uaXNOdWxsKGZyYW1lKSkge1xuICAgIHRoaXMuY3VyV2ViRnJhbWVzID0gW107XG4gICAgbG9nZ2VyLmRlYnVnKCdMZWF2aW5nIHdlYiBmcmFtZSBhbmQgZ29pbmcgYmFjayB0byBkZWZhdWx0IGNvbnRlbnQnKTtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKCFfLmlzVW5kZWZpbmVkKGZyYW1lLkVMRU1FTlQpKSB7XG4gICAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMudXNlQXRvbXNFbGVtZW50KGZyYW1lLkVMRU1FTlQpO1xuICAgIGxldCB2YWx1ZSA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF9mcmFtZV93aW5kb3cnLCBbYXRvbXNFbGVtZW50XSk7XG4gICAgbG9nZ2VyLmRlYnVnKGBFbnRlcmluZyBuZXcgd2ViIGZyYW1lOiAnJHt2YWx1ZS5XSU5ET1d9J2ApO1xuICAgIHRoaXMuY3VyV2ViRnJhbWVzLnVuc2hpZnQodmFsdWUuV0lORE9XKTtcbiAgfSBlbHNlIHtcbiAgICBhdG9tID0gXy5pc051bWJlcihmcmFtZSkgPyAnZnJhbWVfYnlfaW5kZXgnIDogJ2ZyYW1lX2J5X2lkX29yX25hbWUnO1xuICAgIGxldCB2YWx1ZSA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oYXRvbSwgW2ZyYW1lXSk7XG4gICAgaWYgKF8uaXNOdWxsKHZhbHVlKSB8fCBfLmlzVW5kZWZpbmVkKHZhbHVlLldJTkRPVykpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRnJhbWVFcnJvcigpO1xuICAgIH1cbiAgICBsb2dnZXIuZGVidWcoYEVudGVyaW5nIG5ldyB3ZWIgZnJhbWU6ICcke3ZhbHVlLldJTkRPV30nYCk7XG4gICAgdGhpcy5jdXJXZWJGcmFtZXMudW5zaGlmdCh2YWx1ZS5XSU5ET1cpO1xuICB9XG59O1xuXG5jb21tYW5kcy5nZXRDc3NQcm9wZXJ0eSA9IGFzeW5jIGZ1bmN0aW9uIChwcm9wZXJ0eU5hbWUsIGVsKSB7XG4gIGxldCBhdG9tc0VsZW1lbnQgPSB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG4gIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfdmFsdWVfb2ZfY3NzX3Byb3BlcnR5JywgW2F0b21zRWxlbWVudCwgcHJvcGVydHlOYW1lXSk7XG59O1xuXG5jb21tYW5kcy5zdWJtaXQgPSBhc3luYyBmdW5jdGlvbiAoZWwpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuICAgIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ3N1Ym1pdCcsIFthdG9tc0VsZW1lbnRdKTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxufTtcblxuY29tbWFuZHMucmVmcmVzaCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdyZWZyZXNoJywgW10pO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG59O1xuXG5jb21tYW5kcy5zZXRVcmwgPSBhc3luYyBmdW5jdGlvbiAodXJsKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBzZXQgdXJsICcke3VybH0nYCk7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIC8vIGluIHRoZSBmdXR1cmUsIGRldGVjdCB3aGV0aGVyIHdlIGhhdmUgYSBVSVdlYlZpZXcgdGhhdCB3ZSBjYW4gdXNlIHRvXG4gICAgLy8gbWFrZSBzZW5zZSBvZiB0aGlzIGNvbW1hbmQuIEZvciBub3csIGFuZCBvdGhlcndpc2UsIGl0J3MgYSBuby1vcFxuICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG4gIHRoaXMuc2V0Q3VycmVudFVybCh1cmwpO1xuICAvLyBtYWtlIHN1cmUgdG8gY2xlYXIgb3V0IGFueSBsZWZ0b3ZlciB3ZWIgZnJhbWVzXG4gIHRoaXMuY3VyV2ViRnJhbWVzID0gW107XG4gIGF3YWl0IHRoaXMucmVtb3RlLm5hdlRvVXJsKHVybCk7XG59O1xuXG5jb21tYW5kcy5nZXRVcmwgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9XG4gIGxldCB1cmwgPSBhd2FpdCB0aGlzLnJlbW90ZS5leGVjdXRlKCd3aW5kb3cubG9jYXRpb24uaHJlZicpO1xuICB0aGlzLnNldEN1cnJlbnRVcmwodXJsKTtcbiAgcmV0dXJuIHVybDtcbn07XG5cbmNvbW1hbmRzLnRpdGxlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgndGl0bGUnLCBbXSwgdHJ1ZSk7XG59O1xuXG5jb21tYW5kcy5nZXRDb29raWVzID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZygnUmV0cmlldmluZyBhbGwgY29va2llcycpO1xuXG4gIGxldCBzY3JpcHQgPSAncmV0dXJuIGRvY3VtZW50LmNvb2tpZSc7XG4gIGxldCBqc0Nvb2tpZXMgPSBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdleGVjdXRlX3NjcmlwdCcsIFtzY3JpcHQsIFtdXSk7XG5cbiAgbGV0IGNvb2tpZXMgPSBbXTtcbiAgdHJ5IHtcbiAgICBmb3IgKGxldCBbbmFtZSwgdmFsdWVdIG9mIF8udG9QYWlycyhjb29raWVVdGlscy5jcmVhdGVKV1BDb29raWUodW5kZWZpbmVkLCBqc0Nvb2tpZXMpKSkge1xuICAgICAgY29va2llcy5wdXNoKHtuYW1lLCB2YWx1ZX0pO1xuICAgIH1cbiAgICByZXR1cm4gY29va2llcztcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmVycm9yKGVycik7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoYEVycm9yIHBhcnNpbmcgY29va2llcyBmcm9tIHJlc3VsdDogJyR7anNDb29raWVzfSdgKTtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0Q29va2llID0gYXN5bmMgZnVuY3Rpb24gKGNvb2tpZSkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuXG4gIGNvb2tpZSA9IF8uY2xvbmUoY29va2llKTtcblxuICAvLyBpZiBgcGF0aGAgZmllbGQgaXMgbm90IHNwZWNpZmllZCwgU2FmYXJpIHdpbGwgbm90IHVwZGF0ZSBjb29raWVzIGFzIGV4cGVjdGVkOyBlZyBpc3N1ZSAjMTcwOFxuICBpZiAoIWNvb2tpZS5wYXRoKSB7XG4gICAgY29va2llLnBhdGggPSBcIi9cIjtcbiAgfVxuXG4gIGxldCBqc0Nvb2tpZSA9IGNvb2tpZVV0aWxzLmNyZWF0ZUpTQ29va2llKGNvb2tpZS5uYW1lLCBjb29raWUudmFsdWUsIHtcbiAgICBleHBpcmVzOiBfLmlzTnVtYmVyKGNvb2tpZS5leHBpcnkpID8gKG5ldyBEYXRlKGNvb2tpZS5leHBpcnkgKiAxMDAwKSkudG9VVENTdHJpbmcoKSA6XG4gICAgICBjb29raWUuZXhwaXJ5LFxuICAgIHBhdGg6IGNvb2tpZS5wYXRoLFxuICAgIGRvbWFpbjogY29va2llLmRvbWFpbixcbiAgICBodHRwT25seTogY29va2llLmh0dHBPbmx5LFxuICAgIHNlY3VyZTogY29va2llLnNlY3VyZVxuICB9KTtcbiAgbGV0IHNjcmlwdCA9IGBkb2N1bWVudC5jb29raWUgPSAke0pTT04uc3RyaW5naWZ5KGpzQ29va2llKX1gO1xuICBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdleGVjdXRlX3NjcmlwdCcsIFtzY3JpcHQsIFtdXSk7XG59O1xuXG5jb21tYW5kcy5kZWxldGVDb29raWUgPSBhc3luYyBmdW5jdGlvbiAoY29va2llTmFtZSkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuXG4gIC8vIGNoZWNrIGNvb2tpZSBleGlzdGVuY2VcbiAgbGV0IGNvb2tpZXMgPSBhd2FpdCB0aGlzLmdldENvb2tpZXMoKTtcbiAgaWYgKF8uaW5kZXhPZihfLm1hcChjb29raWVzLCAnbmFtZScpLCBjb29raWVOYW1lKSA9PT0gLTEpIHtcbiAgICBsb2dnZXIuZGVidWcoYENvb2tpZSAnJHtjb29raWVOYW1lfScgbm90IGZvdW5kLiBJZ25vcmluZy5gKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCB0aGlzLl9kZWxldGVDb29raWUoY29va2llTmFtZSk7XG59O1xuXG5jb21tYW5kcy5kZWxldGVDb29raWVzID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAoIXRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoKTtcbiAgfVxuXG4gIGxldCBjb29raWVzID0gYXdhaXQgdGhpcy5nZXRDb29raWVzKCk7XG4gIGlmIChjb29raWVzLmxlbmd0aCkge1xuICAgIGZvciAobGV0IGNvb2tpZSBvZiBjb29raWVzKSB7XG4gICAgICBhd2FpdCB0aGlzLl9kZWxldGVDb29raWUoY29va2llLm5hbWUpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gdHJ1ZTtcbn07XG5cbmhlbHBlcnMuX2RlbGV0ZUNvb2tpZSA9IGFzeW5jIGZ1bmN0aW9uIChjb29raWVOYW1lKSB7XG4gIGxvZ2dlci5kZWJ1ZyhgRGVsZXRpbmcgY29va2llICcke2Nvb2tpZU5hbWV9J2ApO1xuICBsZXQgd2ViQ29va2llID0gY29va2llVXRpbHMuZXhwaXJlQ29va2llKGNvb2tpZU5hbWUsIHtwYXRoOiBcIi9cIn0pO1xuICBsZXQgc2NyaXB0ID0gYGRvY3VtZW50LmNvb2tpZSA9ICR7SlNPTi5zdHJpbmdpZnkod2ViQ29va2llKX1gO1xuICBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdleGVjdXRlX3NjcmlwdCcsIFtzY3JpcHQsIFtdXSk7XG59O1xuXG5leHRlbnNpb25zLmZpbmRXZWJFbGVtZW50T3JFbGVtZW50cyA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IsIG1hbnksIGN0eCkge1xuICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy5nZXRBdG9tc0VsZW1lbnQoY3R4KTtcbiAgbGV0IGVsZW1lbnQ7XG4gIGxldCBkb0ZpbmQgPSBhc3luYyAoKSA9PiB7XG4gICAgZWxlbWVudCA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oYGZpbmRfZWxlbWVudCR7bWFueSA/ICdzJyA6ICcnfWAsIFtzdHJhdGVneSwgc2VsZWN0b3IsIGF0b21zRWxlbWVudF0pO1xuICAgIHJldHVybiAhXy5pc051bGwoZWxlbWVudCk7XG4gIH07XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXRGb3JDb25kaXRpb24oZG9GaW5kKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGVyci5tZXNzYWdlICYmIGVyci5tZXNzYWdlLm1hdGNoKC9Db25kaXRpb24gdW5tZXQvKSl7XG4gICAgICAvLyBjb25kaXRpb24gd2FzIG5vdCBtZXQgc2V0dGluZyByZXMgdG8gZW1wdHkgYXJyYXlcbiAgICAgIGVsZW1lbnQgPSBbXTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxuXG4gIGlmIChtYW55KSB7XG4gICAgcmV0dXJuIGVsZW1lbnQ7XG4gIH0gZWxzZSB7XG4gICAgaWYgKCFlbGVtZW50IHx8IF8uc2l6ZShlbGVtZW50KSA9PT0gMCkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgICB9XG4gICAgcmV0dXJuIGVsZW1lbnQ7XG4gIH1cbn07XG5cbmV4dGVuc2lvbnMud2ViRmxpY2tFbGVtZW50ID0gYXN5bmMgZnVuY3Rpb24gKGVsLCB4b2Zmc2V0LCB5b2Zmc2V0KSB7XG4gIGxldCBhdG9tc0VsZW1lbnQgPSBhd2FpdCB0aGlzLnVzZUF0b21zRWxlbWVudChlbCk7XG5cbiAgbGV0IHt4LCB5fSA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF90b3BfbGVmdF9jb29yZGluYXRlcycsIFthdG9tc0VsZW1lbnRdKTtcbiAgbGV0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF9zaXplJywgW2F0b21zRWxlbWVudF0pO1xuXG4gIC8vIHRyYW5zbGF0ZSB0byBwcm9wZXIgY29vcmRpbmF0ZXNcbiAgeCA9IHggKyAod2lkdGggLyAyKTtcbiAgeSA9IHkgKyAoaGVpZ2h0IC8gMik7XG5cbiAgbGV0IGZyb20gPSBhd2FpdCB0aGlzLnRyYW5zbGF0ZVdlYkNvb3Jkcyh7eCwgeX0pO1xuICBsZXQgdG8gPSBhd2FpdCB0aGlzLnRyYW5zbGF0ZVdlYkNvb3Jkcyh7eDogeCArIHhvZmZzZXQsIHk6IHkgKyB5b2Zmc2V0fSk7XG5cbiAgbGV0IGFyZ3MgPSB7ZnJvbSwgdG99O1xuICBsZXQgY29tbWFuZCA9IGBhdS5mbGljaygke0pTT04uc3RyaW5naWZ5KGFyZ3MpfSlgO1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbn07XG5cbmV4dGVuc2lvbnMubW9iaWxlV2ViTmF2ID0gYXN5bmMgZnVuY3Rpb24gKG5hdlR5cGUpIHtcbiAgdGhpcy5yZW1vdGUuYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCgpO1xuICBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdleGVjdXRlX3NjcmlwdCcsIFtgaGlzdG9yeS4ke25hdlR5cGV9KCk7YCwgbnVsbF0pO1xufTtcblxuZXh0ZW5zaW9ucy5uYXRpdmVXZWJUYXAgPSBhc3luYyBmdW5jdGlvbiAoZWwpIHtcbiAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMudXNlQXRvbXNFbGVtZW50KGVsKTtcbiAgbGV0IHt4LCB5fSA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF90b3BfbGVmdF9jb29yZGluYXRlcycsIFthdG9tc0VsZW1lbnRdKTtcbiAgbGV0IHt3aWR0aCwgaGVpZ2h0fSA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF9zaXplJywgW2F0b21zRWxlbWVudF0pO1xuICB4ID0geCArICh3aWR0aCAvIDIpO1xuICB5ID0geSArIChoZWlnaHQgLyAyKTtcbiAgdGhpcy5jdXJXZWJDb29yZHMgPSB7eCwgeX07XG4gIGF3YWl0IHRoaXMuY2xpY2tXZWJDb29yZHMoKTtcbiAgLy8gbWFrZSBzdXJlIHJlYWwgdGFwIGFjdHVhbGx5IGhhcyB0aW1lIHRvIHJlZ2lzdGVyXG4gIGF3YWl0IEIuZGVsYXkoNTAwKTtcbn07XG5cbmV4dGVuc2lvbnMuY2xpY2tXZWJDb29yZHMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBjb29yZHMgPSBhd2FpdCB0aGlzLnRyYW5zbGF0ZVdlYkNvb3Jkcyh0aGlzLmN1cldlYkNvb3Jkcyk7XG4gIGF3YWl0IHRoaXMuY2xpY2tDb29yZHMoY29vcmRzKTtcbn07XG5cbmV4dGVuc2lvbnMudHJhbnNsYXRlV2ViQ29vcmRzID0gYXN5bmMgZnVuY3Rpb24gKGNvb3Jkcykge1xuICBsb2dnZXIuZGVidWcoYFRyYW5zbGF0aW5nIGNvb3JkaW5hdGVzICgke0pTT04uc3RyaW5naWZ5KGNvb3Jkcyl9KSB0byB3ZWIgY29vcmRpbmF0ZXNgKTtcbiAgbGV0IHd2Q21kID0gJ2F1LmdldEVsZW1lbnRzQnlUeXBlKFxcJ3dlYnZpZXdcXCcpJztcbiAgbGV0IHdlYnZpZXdJbmRleCA9IHRoaXMud2ViQ29udGV4dEluZGV4KCk7XG5cbiAgLy8gYWRkIHN0YXRpYyBvZmZzZXQgZm9yIHNhZmFyaSBpbiBsYW5kc2NhcGUgbW9kZVxuICBsZXQgeU9mZnNldCA9IHRoaXMuY3VyT3JpZW50YXRpb24gPT09ICdMQU5EU0NBUEUnID8gdGhpcy5sYW5kc2NhcGVXZWJDb29yZHNPZmZzZXQgOiAwO1xuXG4gIC8vIGFic29sdXRpemUgd2ViIGNvb3Jkc1xuICBsZXQgd2Vidmlld3MgPSBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZCh3dkNtZCk7XG4gIGlmICh3ZWJ2aWV3cy5sZW5ndGggPCAxKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IuY29kZSgnQ291bGQgbm90IGZpbmQgYW55IHdlYnZpZXdzIHRvIGNsaWNrIGluc2lkZSEnKTtcbiAgfVxuICBpZiAoXy5pc1VuZGVmaW5lZCh3ZWJ2aWV3c1t3ZWJ2aWV3SW5kZXhdKSkge1xuICAgIGxvZ2dlci53YXJuKGBDb3VsZCBub3QgZmluZCB3ZWJ2aWV3IGF0IGluZGV4ICR7d2Vidmlld0luZGV4fSwgdGFraW5nIGAgK1xuICAgICAgICAgICAgICAgIGBsYXN0IGF2YWlsYWJsZSBvbmUgZm9yIGNsaWNraW5nIHB1cnBvc2VzYCk7XG4gICAgd2Vidmlld0luZGV4ID0gd2Vidmlld3MubGVuZ3RoIC0gMTtcbiAgfVxuXG4gIGxldCB3dklkID0gd2Vidmlld3Nbd2Vidmlld0luZGV4XS5FTEVNRU5UO1xuICBsZXQgbG9jQ21kID0gYGF1LmdldEVsZW1lbnQoJyR7d3ZJZH0nKS5yZWN0KClgO1xuICBsZXQgcmVjdCA9IGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGxvY0NtZCk7XG4gIGxldCB3dlBvcyA9IHt4OiByZWN0Lm9yaWdpbi54LCB5OiByZWN0Lm9yaWdpbi55fTtcbiAgbGV0IHJlYWxEaW1zID0ge3c6IHJlY3Quc2l6ZS53aWR0aCwgaDogcmVjdC5zaXplLmhlaWdodH07XG5cbiAgbGV0IGNtZCA9ICcoZnVuY3Rpb24gKCkgeyByZXR1cm4ge3c6IGRvY3VtZW50LndpZHRoLCBoOiBkb2N1bWVudC5oZWlnaHR9OyB9KSgpJztcbiAgbGV0IHt3LCBofSA9IGF3YWl0IHRoaXMucmVtb3RlLmV4ZWN1dGUoY21kKTtcbiAgbGV0IHd2RGltcyA9IHt3LCBofTtcblxuICBpZiAod3ZEaW1zICYmIHJlYWxEaW1zICYmIHd2UG9zKSB7XG4gICAgbGV0IHhSYXRpbyA9IHJlYWxEaW1zLncgLyB3dkRpbXMudztcbiAgICBsZXQgeVJhdGlvID0gcmVhbERpbXMuaCAvIHd2RGltcy5oO1xuICAgIGxldCBzZXJ2aWNlQmFySGVpZ2h0ID0gMjA7XG4gICAgaWYgKHBhcnNlRmxvYXQodGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbikgPj0gOCkge1xuICAgICAgLy8gaW9zOCBpbmNsdWRlcyB0aGUgc2VydmljZSBiYXIgaGVpZ2h0IGluIHRoZSBhcHBcbiAgICAgIHNlcnZpY2VCYXJIZWlnaHQgPSAwO1xuICAgIH1cbiAgICBsZXQgbmV3Q29vcmRzID0ge1xuICAgICAgeDogd3ZQb3MueCArIE1hdGgucm91bmQoeFJhdGlvICogY29vcmRzLngpXG4gICAgLCB5OiB3dlBvcy55ICsgeU9mZnNldCArIE1hdGgucm91bmQoeVJhdGlvICogY29vcmRzLnkpIC0gc2VydmljZUJhckhlaWdodFxuICAgIH07XG4gICAgbG9nZ2VyLmRlYnVnKGBDb252ZXJ0ZWQgd2ViIGNvb3JkcyAke0pTT04uc3RyaW5naWZ5KGNvb3Jkcyl9IGAgK1xuICAgICAgICAgICAgICAgIGBpbnRvIHJlYWwgY29vcmRzICR7SlNPTi5zdHJpbmdpZnkobmV3Q29vcmRzKX1gKTtcbiAgICByZXR1cm4gbmV3Q29vcmRzO1xuICB9XG59O1xuXG5oZWxwZXJzLmNsaWNrQ29vcmRzID0gYXN5bmMgZnVuY3Rpb24gKGNvb3Jkcykge1xuICBpZiAodGhpcy51c2VSb2JvdCkge1xuICAgIC8vIHZhciB0YXBVcmwgPSB0aGlzLmFyZ3Mucm9ib3RVcmwgKyBcIi90YXBcIjtcbiAgICAvLyByZXF1ZXN0LnBvc3Qoe3VybDp0YXBVcmwsIGZvcm06IHt4OmNvb3Jkcy54LCB5OmNvb3Jkcy55fX0sIGNiKTtcbiAgICAvKlRPRE8qL3Rocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICB9IGVsc2Uge1xuICAgIGxldCBvcHRzID0gY29vcmRzO1xuICAgIG9wdHMudGFwQ291bnQgPSAxO1xuICAgIG9wdHMuZHVyYXRpb24gPSAwLjM7XG4gICAgb3B0cy50b3VjaENvdW50ID0gMTtcbiAgICBsZXQgY29tbWFuZCA9IGBhdS5jb21wbGV4VGFwKCR7SlNPTi5zdHJpbmdpZnkob3B0cyl9KWA7XG4gICAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY29tbWFuZCk7XG4gIH1cbn07XG5cbmhlbHBlcnMuZXhlY3V0ZUF0b20gPSBhc3luYyBmdW5jdGlvbiAoYXRvbSwgYXJncywgYWx3YXlzRGVmYXVsdEZyYW1lID0gZmFsc2UpIHtcbiAgbGV0IGZyYW1lcyA9IGFsd2F5c0RlZmF1bHRGcmFtZSA9PT0gdHJ1ZSA/IFtdIDogdGhpcy5jdXJXZWJGcmFtZXM7XG4gIGxldCBwcm9taXNlID0gdGhpcy5yZW1vdGUuZXhlY3V0ZUF0b20oYXRvbSwgYXJncywgZnJhbWVzKTtcbiAgcmV0dXJuIGF3YWl0IHRoaXMud2FpdEZvckF0b20ocHJvbWlzZSk7XG59O1xuXG5oZWxwZXJzLmV4ZWN1dGVBdG9tQXN5bmMgPSBhc3luYyBmdW5jdGlvbiAoYXRvbSwgYXJncywgcmVzcG9uc2VVcmwpIHtcbiAgLy8gc2F2ZSB0aGUgcmVzb2x2ZSBhbmQgcmVqZWN0IG1ldGhvZHMgb2YgdGhlIHByb21pc2UgdG8gYmUgd2FpdGVkIGZvclxuICBsZXQgcHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICB0aGlzLmFzeW5jUHJvbWlzZSA9IHtyZXNvbHZlLCByZWplY3R9O1xuICB9KTtcbiAgYXdhaXQgdGhpcy5yZW1vdGUuZXhlY3V0ZUF0b21Bc3luYyhhdG9tLCBhcmdzLCB0aGlzLmN1cldlYkZyYW1lcywgcmVzcG9uc2VVcmwpO1xuICByZXR1cm4gYXdhaXQgdGhpcy53YWl0Rm9yQXRvbShwcm9taXNlKTtcbn07XG5cbmhlbHBlcnMud2FpdEZvckF0b20gPSBhc3luYyBmdW5jdGlvbiAocHJvbWlzZSkge1xuICAvLyBuZWVkIHRvIGNoZWNrIGZvciBhbGVydCB3aGlsZSB0aGUgYXRvbSBpcyBiZWluZyBleGVjdXRlZC5cbiAgLy8gc28gbm90aWZ5IG91cnNlbHZlcyB3aGVuIGl0IGhhcHBlbnNcbiAgbGV0IGRvbmUgPSBmYWxzZTtcbiAgbGV0IGVycm9yID0gbnVsbDtcbiAgcHJvbWlzZS50aGVuKChyZXMpID0+IHtcbiAgICBkb25lID0gdHJ1ZTtcbiAgICByZXR1cm4gcmVzO1xuICB9KVxuICAuY2F0Y2goKGVycikgPT4ge1xuICAgIGxvZ2dlci5kZWJ1ZyhgRXJyb3IgcmVjZWl2ZWQgd2hpbGUgZXhlY3V0aW5nIGF0b206ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgLy8gZXJyb3IgZ2V0cyBzd2FsbG93ZWQsIHNvIHNhdmUgYW5kIGNoZWNrIGxhdGVyXG4gICAgZG9uZSA9IHRydWU7XG4gICAgZXJyb3IgPSBlcnI7XG4gIH0pO1xuICAvLyB0cnkgdGVuIHRpbWVzIHRvIGNoZWNrIGFsZXJ0LCBpZiB3ZSBhcmUgbm90IGRvbmUgeWV0XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgMTA7IGkrKykge1xuICAgIC8vIGNoZWNrIGlmIHRoZSBwcm9taXNlIGhhcyBiZWVuIHJlc29sdmVkXG4gICAgaWYgKGRvbmUpIGJyZWFrO1xuICAgIGF3YWl0IEIuZGVsYXkoNTAwKTtcbiAgICBpZiAoZG9uZSkgYnJlYWs7XG4gICAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgYW4gYWxlcnRcbiAgICBpZiAoYXdhaXQgdGhpcy5jaGVja0ZvckFsZXJ0KCkpIHtcbiAgICAgIC8vIHdlIGZvdW5kIGFuIGFsZXJ0LCBhbmQgc2hvdWxkIGp1c3QgcmV0dXJuIGNvbnRyb2xcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG4gIH1cblxuICBsZXQgcmVzID0gYXdhaXQgcHJvbWlzZTtcbiAgaWYgKGVycm9yKSB7XG4gICAgdGhyb3cgZXJyb3I7XG4gIH1cbiAgcmV0dXJuIHRoaXMucGFyc2VFeGVjdXRlUmVzcG9uc2UocmVzKTtcbn07XG5cbmhlbHBlcnMuY2hlY2tGb3JBbGVydCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKCFfLmlzTnVsbCh0aGlzLnVpQXV0b0NsaWVudCkpIHtcbiAgICBsb2dnZXIuZGVidWcoJ2F0b20gZGlkIG5vdCByZXR1cm4geWV0LCBjaGVja2luZyB0byBzZWUgaWYgJyArXG4gICAgICAgICAgICAgICAgICd3ZSBhcmUgYmxvY2tlZCBieSBhbiBhbGVydCcpO1xuICAgIGxldCBwcmVzZW50ID0gYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoJ2F1LmFsZXJ0SXNQcmVzZW50KCknKTtcbiAgICBpZiAoIXByZXNlbnQpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnTm8gYWxlcnQgZm91bmQuJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZygnRm91bmQgYW4gYWxlcnQsIHJldHVybmluZyBjb250cm9sIHRvIGNsaWVudCcpO1xuICAgIH1cbiAgICByZXR1cm4gcHJlc2VudDtcbiAgfVxufTtcblxuaGVscGVycy5nZXRBdG9tc0VsZW1lbnQgPSBmdW5jdGlvbiAod2RJZCkge1xuICBsZXQgYXRvbXNJZDtcbiAgdHJ5IHtcbiAgICBhdG9tc0lkID0gdGhpcy53ZWJFbGVtZW50SWRzW3BhcnNlSW50KHdkSWQsIDEwKSAtIEVMRU1FTlRfT0ZGU0VUXTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIGlmIChfLmlzVW5kZWZpbmVkKGF0b21zSWQpKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgcmV0dXJuIHtFTEVNRU5UOiBhdG9tc0lkfTtcbn07XG5cbmhlbHBlcnMudXNlQXRvbXNFbGVtZW50ID0gZnVuY3Rpb24gKGVsKSB7XG4gIGlmIChwYXJzZUludChlbCwgMTApIDwgRUxFTUVOVF9PRkZTRVQpIHtcbiAgICBsb2dnZXIuZGVidWcoYEVsZW1lbnQgd2l0aCBpZCAnJHtlbH0nIHBhc3NlZCBpbiBmb3IgdXNlIHdpdGggYCArXG4gICAgICAgICAgICAgICAgIGBhdG9tcywgYnV0IGl0J3Mgb3V0IG9mIG91ciBpbnRlcm5hbCBzY29wZS4gQWRkaW5nICR7RUxFTUVOVF9PRkZTRVR9LmApO1xuICAgIGVsID0gKHBhcnNlSW50KGVsLCAxMCkgKyBFTEVNRU5UX09GRlNFVCkudG9TdHJpbmcoKTtcbiAgfVxuICBsZXQgYXRvbXNFbGVtZW50ID0gdGhpcy5nZXRBdG9tc0VsZW1lbnQoZWwpO1xuICBpZiAoYXRvbXNFbGVtZW50ID09PSBudWxsKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoYEVycm9yIGNvbnZlcnRpbmcgZWxlbWVudCBJRCBmb3IgdXNpbmcgaW4gV0QgYXRvbXM6ICR7ZWx9YCk7XG4gIH1cbiAgcmV0dXJuIGF0b21zRWxlbWVudDtcbn07XG5cbmhlbHBlcnMuY29udmVydEVsZW1lbnRzRm9yQXRvbXMgPSBmdW5jdGlvbiAoYXJncyA9IFtdKSB7XG4gIGxldCBuZXdBcmdzID0gW107XG4gIGZvciAobGV0IGFyZyBvZiBhcmdzKSB7XG4gICAgaWYgKCFfLmlzTnVsbChhcmcpICYmICFfLmlzVW5kZWZpbmVkKGFyZy5FTEVNRU5UKSkge1xuICAgICAgbGV0IGF0b21zRWxlbWVudCA9IHRoaXMuZ2V0QXRvbXNFbGVtZW50KGFyZy5FTEVNRU5UKTtcbiAgICAgIGlmIChhdG9tc0VsZW1lbnQgPT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoYEVycm9yIGNvbnZlcnRpbmcgZWxlbWVudCBJRCBmb3IgdXNpbmcgaW4gV0QgYXRvbXM6ICR7YXJnLkVMRU1FTlR9YCk7XG4gICAgICB9XG4gICAgICBuZXdBcmdzLnB1c2goYXRvbXNFbGVtZW50KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbmV3QXJncy5wdXNoKGFyZyk7XG4gICAgfVxuICB9XG4gIHJldHVybiBuZXdBcmdzO1xufTtcblxuaGVscGVycy5wYXJzZUV4ZWN1dGVSZXNwb25zZSA9IGZ1bmN0aW9uIChyZXMpIHtcbiAgaWYgKF8uaXNOdWxsKHJlcykgfHwgXy5pc1VuZGVmaW5lZChyZXMpKSByZXR1cm4gbnVsbDtcblxuICBsZXQgd2RFbGVtZW50ID0gbnVsbDtcbiAgaWYgKCFfLmlzQXJyYXkocmVzKSkge1xuICAgIGlmICghXy5pc1VuZGVmaW5lZChyZXMuRUxFTUVOVCkpIHtcbiAgICAgIHdkRWxlbWVudCA9IHRoaXMucGFyc2VFbGVtZW50UmVzcG9uc2UocmVzKTtcbiAgICAgIGlmICh3ZEVsZW1lbnQgPT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoYEVycm9yIGNvbnZlcnRpbmcgZWxlbWVudCBJRCBhdG9tIGZvciB1c2luZyBpbiBXRDogJHtyZXMuRUxFTUVOVH1gKTtcbiAgICAgIH1cbiAgICAgIHJlcyA9IHdkRWxlbWVudDtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgLy8gdmFsdWUgaXMgYW4gYXJyYXksIHNvIGdvIHRocm91Z2ggYW5kIGNvbnZlcnQgZWFjaFxuICAgIGxldCBhcmdzID0gW107XG4gICAgZm9yIChsZXQgYXJnIG9mIHJlcykge1xuICAgICAgd2RFbGVtZW50ID0gYXJnO1xuICAgICAgaWYgKCFfLmlzTnVsbChhcmcpICYmICFfLmlzVW5kZWZpbmVkKGFyZy5FTEVNRU5UKSkge1xuICAgICAgICB3ZEVsZW1lbnQgPSB0aGlzLnBhcnNlRWxlbWVudFJlc3BvbnNlKGFyZyk7XG4gICAgICAgIGlmICh3ZEVsZW1lbnQgPT09IG51bGwpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRXJyb3IgY29udmVydGluZyBlbGVtZW50IElEIGF0b20gZm9yIHVzaW5nIGluIFdEOiAke2FyZy5FTEVNRU5UfWApO1xuICAgICAgICB9XG4gICAgICAgIGFyZ3MucHVzaCh3ZEVsZW1lbnQpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXMgPSBhcmdzO1xuICB9XG4gIHJldHVybiByZXM7XG59O1xuXG5oZWxwZXJzLnBhcnNlRWxlbWVudFJlc3BvbnNlID0gZnVuY3Rpb24gKGVsZW1lbnQpIHtcbiAgbGV0IG9iaklkID0gZWxlbWVudC5FTEVNRU5UO1xuICBsZXQgY2xpZW50SWQgPSAoRUxFTUVOVF9PRkZTRVQgKyB0aGlzLndlYkVsZW1lbnRJZHMubGVuZ3RoKS50b1N0cmluZygpO1xuICB0aGlzLndlYkVsZW1lbnRJZHMucHVzaChvYmpJZCk7XG4gIHJldHVybiB7RUxFTUVOVDogY2xpZW50SWR9O1xufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl19