/* globals expect */
"use strict";

var _regeneratorRuntime = require("babel-runtime/regenerator")["default"];

var _interopRequireDefault = require("babel-runtime/helpers/interop-require-default")["default"];

var _setupBase = require("../setup-base");

var _setupBase2 = _interopRequireDefault(_setupBase);

var _helpersEnv = require('../helpers/env');

var _helpersEnv2 = _interopRequireDefault(_helpersEnv);

var _helpersWebview = require("../helpers/webview");

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

describe("safari - windows and frames (" + _helpersEnv2["default"].DEVICE + ")", function () {
  var driver = (0, _setupBase2["default"])(this, {
    browserName: 'safari',
    nativeWebTap: true,
    safariAllowPopups: true
  }).driver;

  describe('within webview', function () {
    var _this = this;

    beforeEach(function () {
      return (0, _helpersWebview.loadWebView)("safari", driver);
    });

    it("should throw nosuchwindow if there's not one", function () {
      return driver.setWindow('noexistman').should.be.rejectedWith(/window could not be found/);
    });

    // unfortunately, iOS8 doesn't respond to the close() method on window
    // the way iOS7 does
    it("should be able to open and close windows @skip-ios8", function callee$2$0() {
      var el, handles;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'blanklink'));

          case 2:
            el = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(el));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(driver.getWindowHandles());

          case 9:
            handles = context$3$0.sent;
            context$3$0.next = 12;
            return _regeneratorRuntime.awrap(_bluebird2["default"].delay(2000));

          case 12:
            context$3$0.next = 14;
            return _regeneratorRuntime.awrap(driver.closeWindow());

          case 14:
            context$3$0.next = 16;
            return _regeneratorRuntime.awrap(_bluebird2["default"].delay(3000));

          case 16:
            context$3$0.next = 18;
            return _regeneratorRuntime.awrap(driver.getWindowHandles());

          case 18:
            context$3$0.t0 = handles.length;
            context$3$0.sent.should.be.below(context$3$0.t0);
            context$3$0.next = 22;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am a page title", driver));

          case 22:
          case "end":
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should be able to go back and forward', function callee$2$0() {
      var link;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('link text', 'i am a link'));

          case 2:
            link = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(link));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'only_on_page_2'));

          case 7:
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(driver.back());

          case 9:
            context$3$0.next = 11;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'i_am_a_textbox'));

          case 11:
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap(driver.forward());

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap(driver.findElement('id', 'only_on_page_2'));

          case 15:
          case "end":
            return context$3$0.stop();
        }
      }, null, _this);
    });

    // broken on real devices, see https://github.com/appium/appium/issues/5167
    it("should be able to open js popup windows with safariAllowPopups set to true @skip-real-device", function callee$2$0() {
      var link;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.findElement('link text', 'i am a new window link'));

          case 2:
            link = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.click(link));

          case 5:
            context$3$0.next = 7;
            return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver, 30));

          case 7:
          case "end":
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });
});

describe("safari - windows and frames (" + _helpersEnv2["default"].DEVICE + ") - without safariAllowPopups", function () {
  var _this2 = this;

  var driver = (0, _setupBase2["default"])(this, {
    browserName: 'safari',
    safariAllowPopups: false
  }).driver;

  beforeEach(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _helpersWebview.loadWebView)("safari", driver));

        case 2:
          return context$2$0.abrupt("return", context$2$0.sent);

        case 3:
        case "end":
          return context$2$0.stop();
      }
    }, null, _this2);
  });

  it("should not be able to open js popup windows with safariAllowPopups set to false", function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      var _this3 = this;

      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(driver.execute("window.open('/test/guinea-pig2.html', null)"));

        case 2:
          expect(function callee$2$0() {
            return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
              while (1) switch (context$3$0.prev = context$3$0.next) {
                case 0:
                  context$3$0.next = 2;
                  return _regeneratorRuntime.awrap((0, _helpersWebview.spinTitle)("I am another page title", driver, 5));

                case 2:
                  return context$3$0.abrupt("return", context$3$0.sent);

                case 3:
                case "end":
                  return context$3$0.stop();
              }
            }, null, _this3);
          }).to["throw"];

        case 3:
        case "end":
          return context$2$0.stop();
      }
    }, null, _this2);
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZTJlL3NhZmFyaS93aW5kb3dzLWZyYW1lLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7eUJBQ2tCLGVBQWU7Ozs7MEJBQ2pCLGdCQUFnQjs7Ozs4QkFDTyxvQkFBb0I7O3dCQUM3QyxVQUFVOzs7O0FBRXhCLFFBQVEsbUNBQWlDLHdCQUFJLE1BQU0sUUFBSyxZQUFXO0FBQ2pFLE1BQU0sTUFBTSxHQUFHLDRCQUFNLElBQUksRUFBRTtBQUN6QixlQUFXLEVBQUUsUUFBUTtBQUNyQixnQkFBWSxFQUFFLElBQUk7QUFDbEIscUJBQWlCLEVBQUUsSUFBSTtHQUN4QixDQUFDLENBQUMsTUFBTSxDQUFDOztBQUVWLFVBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxZQUFXOzs7QUFDcEMsY0FBVSxDQUFDO2FBQU0saUNBQVksUUFBUSxFQUFFLE1BQU0sQ0FBQztLQUFBLENBQUMsQ0FBQzs7QUFFaEQsTUFBRSxDQUFDLDhDQUE4QyxFQUFFLFlBQU07QUFDdkQsYUFBTyxNQUFNLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLDJCQUEyQixDQUFDLENBQUM7S0FDM0YsQ0FBQyxDQUFDOzs7O0FBSUgsTUFBRSxDQUFDLHFEQUFxRCxFQUFFO1VBQ3BELEVBQUUsRUFJRixPQUFPOzs7Ozs2Q0FKSSxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxXQUFXLENBQUM7OztBQUFoRCxjQUFFOzs2Q0FDQSxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQzs7Ozs2Q0FDaEIsK0JBQVUseUJBQXlCLEVBQUUsTUFBTSxDQUFDOzs7OzZDQUU5QixNQUFNLENBQUMsZ0JBQWdCLEVBQUU7OztBQUF6QyxtQkFBTzs7NkNBQ0wsc0JBQUUsS0FBSyxDQUFDLElBQUksQ0FBQzs7Ozs2Q0FDYixNQUFNLENBQUMsV0FBVyxFQUFFOzs7OzZDQUNwQixzQkFBRSxLQUFLLENBQUMsSUFBSSxDQUFDOzs7OzZDQUNaLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRTs7OzZCQUFrQixPQUFPLENBQUMsTUFBTTs2QkFBOUIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLOzs2Q0FDM0MsK0JBQVUsbUJBQW1CLEVBQUUsTUFBTSxDQUFDOzs7Ozs7O0tBQzdDLENBQUMsQ0FBQzs7QUFFSCxNQUFFLENBQUMsdUNBQXVDLEVBQUU7VUFDdEMsSUFBSTs7Ozs7NkNBQVMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDOzs7QUFBM0QsZ0JBQUk7OzZDQUNGLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDOzs7OzZDQUNsQixNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQzs7Ozs2Q0FDMUMsTUFBTSxDQUFDLElBQUksRUFBRTs7Ozs2Q0FDYixNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsQ0FBQzs7Ozs2Q0FDMUMsTUFBTSxDQUFDLE9BQU8sRUFBRTs7Ozs2Q0FDaEIsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLENBQUM7Ozs7Ozs7S0FDakQsQ0FBQyxDQUFDOzs7QUFHSCxNQUFFLENBQUMsOEZBQThGLEVBQUU7VUFDN0YsSUFBSTs7Ozs7NkNBQVMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLEVBQUUsd0JBQXdCLENBQUM7OztBQUF0RSxnQkFBSTs7NkNBQ0YsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7Ozs7NkNBQ2xCLCtCQUFVLHlCQUF5QixFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUM7Ozs7Ozs7S0FDdkQsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDOztBQUVILFFBQVEsbUNBQWlDLHdCQUFJLE1BQU0sb0NBQWlDLFlBQVc7OztBQUM3RixNQUFNLE1BQU0sR0FBRyw0QkFBTSxJQUFJLEVBQUU7QUFDekIsZUFBVyxFQUFFLFFBQVE7QUFDckIscUJBQWlCLEVBQUUsS0FBSztHQUN6QixDQUFDLENBQUMsTUFBTSxDQUFDOztBQUVWLFlBQVUsQ0FBQzs7Ozs7MkNBQWtCLGlDQUFZLFFBQVEsRUFBRSxNQUFNLENBQUM7Ozs7Ozs7Ozs7R0FBQSxDQUFDLENBQUM7O0FBRTVELElBQUUsQ0FBQyxpRkFBaUYsRUFBRTs7Ozs7OzsyQ0FDOUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyw2Q0FBNkMsQ0FBQzs7O0FBQ25FLGdCQUFNLENBQUM7Ozs7O21EQUFrQiwrQkFBVSx5QkFBeUIsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDOzs7Ozs7Ozs7O1dBQUEsQ0FBQyxDQUFDLEVBQUUsU0FBTSxDQUFDOzs7Ozs7O0dBQ3BGLENBQUMsQ0FBQztDQUNKLENBQUMsQ0FBQyIsImZpbGUiOiJ0ZXN0L2UyZS9zYWZhcmkvd2luZG93cy1mcmFtZS1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbHMgZXhwZWN0ICovXG5pbXBvcnQgc2V0dXAgZnJvbSBcIi4uL3NldHVwLWJhc2VcIjtcbmltcG9ydCBlbnYgZnJvbSAnLi4vaGVscGVycy9lbnYnO1xuaW1wb3J0IHsgbG9hZFdlYlZpZXcsIHNwaW5UaXRsZSB9IGZyb20gXCIuLi9oZWxwZXJzL3dlYnZpZXdcIjtcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuZGVzY3JpYmUoYHNhZmFyaSAtIHdpbmRvd3MgYW5kIGZyYW1lcyAoJHtlbnYuREVWSUNFfSlgLCBmdW5jdGlvbigpIHtcbiAgY29uc3QgZHJpdmVyID0gc2V0dXAodGhpcywge1xuICAgIGJyb3dzZXJOYW1lOiAnc2FmYXJpJyxcbiAgICBuYXRpdmVXZWJUYXA6IHRydWUsXG4gICAgc2FmYXJpQWxsb3dQb3B1cHM6IHRydWVcbiAgfSkuZHJpdmVyO1xuXG4gIGRlc2NyaWJlKCd3aXRoaW4gd2VidmlldycsIGZ1bmN0aW9uKCkge1xuICAgIGJlZm9yZUVhY2goKCkgPT4gbG9hZFdlYlZpZXcoXCJzYWZhcmlcIiwgZHJpdmVyKSk7XG5cbiAgICBpdChcInNob3VsZCB0aHJvdyBub3N1Y2h3aW5kb3cgaWYgdGhlcmUncyBub3Qgb25lXCIsICgpID0+IHtcbiAgICAgIHJldHVybiBkcml2ZXIuc2V0V2luZG93KCdub2V4aXN0bWFuJykuc2hvdWxkLmJlLnJlamVjdGVkV2l0aCgvd2luZG93IGNvdWxkIG5vdCBiZSBmb3VuZC8pO1xuICAgIH0pO1xuXG4gICAgLy8gdW5mb3J0dW5hdGVseSwgaU9TOCBkb2Vzbid0IHJlc3BvbmQgdG8gdGhlIGNsb3NlKCkgbWV0aG9kIG9uIHdpbmRvd1xuICAgIC8vIHRoZSB3YXkgaU9TNyBkb2VzXG4gICAgaXQoXCJzaG91bGQgYmUgYWJsZSB0byBvcGVuIGFuZCBjbG9zZSB3aW5kb3dzIEBza2lwLWlvczhcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGVsID0gYXdhaXQgZHJpdmVyLmZpbmRFbGVtZW50KCdpZCcsICdibGFua2xpbmsnKTtcbiAgICAgIGF3YWl0IGRyaXZlci5jbGljayhlbCk7XG4gICAgICBhd2FpdCBzcGluVGl0bGUoXCJJIGFtIGFub3RoZXIgcGFnZSB0aXRsZVwiLCBkcml2ZXIpO1xuXG4gICAgICBsZXQgaGFuZGxlcyA9IGF3YWl0IGRyaXZlci5nZXRXaW5kb3dIYW5kbGVzKCk7XG4gICAgICBhd2FpdCBCLmRlbGF5KDIwMDApO1xuICAgICAgYXdhaXQgZHJpdmVyLmNsb3NlV2luZG93KCk7XG4gICAgICBhd2FpdCBCLmRlbGF5KDMwMDApO1xuICAgICAgKGF3YWl0IGRyaXZlci5nZXRXaW5kb3dIYW5kbGVzKCkpLnNob3VsZC5iZS5iZWxvdyhoYW5kbGVzLmxlbmd0aCk7XG4gICAgICBhd2FpdCBzcGluVGl0bGUoXCJJIGFtIGEgcGFnZSB0aXRsZVwiLCBkcml2ZXIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBiZSBhYmxlIHRvIGdvIGJhY2sgYW5kIGZvcndhcmQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgbGluayA9IGF3YWl0IGRyaXZlci5maW5kRWxlbWVudCgnbGluayB0ZXh0JywgJ2kgYW0gYSBsaW5rJyk7XG4gICAgICBhd2FpdCBkcml2ZXIuY2xpY2sobGluayk7XG4gICAgICBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnQoJ2lkJywgJ29ubHlfb25fcGFnZV8yJyk7XG4gICAgICBhd2FpdCBkcml2ZXIuYmFjaygpO1xuICAgICAgYXdhaXQgZHJpdmVyLmZpbmRFbGVtZW50KCdpZCcsICdpX2FtX2FfdGV4dGJveCcpO1xuICAgICAgYXdhaXQgZHJpdmVyLmZvcndhcmQoKTtcbiAgICAgIGF3YWl0IGRyaXZlci5maW5kRWxlbWVudCgnaWQnLCAnb25seV9vbl9wYWdlXzInKTtcbiAgICB9KTtcblxuICAgIC8vIGJyb2tlbiBvbiByZWFsIGRldmljZXMsIHNlZSBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvNTE2N1xuICAgIGl0KFwic2hvdWxkIGJlIGFibGUgdG8gb3BlbiBqcyBwb3B1cCB3aW5kb3dzIHdpdGggc2FmYXJpQWxsb3dQb3B1cHMgc2V0IHRvIHRydWUgQHNraXAtcmVhbC1kZXZpY2VcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGxpbmsgPSBhd2FpdCBkcml2ZXIuZmluZEVsZW1lbnQoJ2xpbmsgdGV4dCcsICdpIGFtIGEgbmV3IHdpbmRvdyBsaW5rJyk7XG4gICAgICBhd2FpdCBkcml2ZXIuY2xpY2sobGluayk7XG4gICAgICBhd2FpdCBzcGluVGl0bGUoXCJJIGFtIGFub3RoZXIgcGFnZSB0aXRsZVwiLCBkcml2ZXIsIDMwKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoYHNhZmFyaSAtIHdpbmRvd3MgYW5kIGZyYW1lcyAoJHtlbnYuREVWSUNFfSkgLSB3aXRob3V0IHNhZmFyaUFsbG93UG9wdXBzYCwgZnVuY3Rpb24oKSB7XG4gIGNvbnN0IGRyaXZlciA9IHNldHVwKHRoaXMsIHtcbiAgICBicm93c2VyTmFtZTogJ3NhZmFyaScsXG4gICAgc2FmYXJpQWxsb3dQb3B1cHM6IGZhbHNlXG4gIH0pLmRyaXZlcjtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IGF3YWl0IGxvYWRXZWJWaWV3KFwic2FmYXJpXCIsIGRyaXZlcikpO1xuXG4gIGl0KFwic2hvdWxkIG5vdCBiZSBhYmxlIHRvIG9wZW4ganMgcG9wdXAgd2luZG93cyB3aXRoIHNhZmFyaUFsbG93UG9wdXBzIHNldCB0byBmYWxzZVwiLCBhc3luYyAoKSA9PiB7XG4gICAgYXdhaXQgZHJpdmVyLmV4ZWN1dGUoXCJ3aW5kb3cub3BlbignL3Rlc3QvZ3VpbmVhLXBpZzIuaHRtbCcsIG51bGwpXCIpO1xuICAgIGV4cGVjdChhc3luYyAoKSA9PiBhd2FpdCBzcGluVGl0bGUoXCJJIGFtIGFub3RoZXIgcGFnZSB0aXRsZVwiLCBkcml2ZXIsIDUpKS50by50aHJvdztcbiAgfSk7XG59KTtcbiJdfQ==