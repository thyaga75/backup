'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

function elOrNull(driver, using, value) {
  var els;
  return _regeneratorRuntime.async(function elOrNull$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(driver.findElements(using, value));

      case 2:
        els = context$1$0.sent;
        return context$1$0.abrupt('return', els[0]);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function clickBack(driver) {
  var el;
  return _regeneratorRuntime.async(function clickBack$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(elOrNull(driver, 'accessibility id', 'Back'));

      case 2:
        el = context$1$0.sent;
        context$1$0.t0 = el;

        if (!context$1$0.t0) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(driver.elementDisplayed(el));

      case 7:
        context$1$0.t0 = context$1$0.sent;

      case 8:
        if (!context$1$0.t0) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(driver.click(el));

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function clickButton(driver, name) {
  var el;
  return _regeneratorRuntime.async(function clickButton$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(elOrNull(driver, 'xpath', '//UIAButton[@name = \'' + name + '\']'));

      case 2:
        el = context$1$0.sent;
        context$1$0.t0 = el;

        if (!context$1$0.t0) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(driver.elementDisplayed(el));

      case 7:
        context$1$0.t0 = context$1$0.sent;

      case 8:
        if (!context$1$0.t0) {
          context$1$0.next = 11;
          break;
        }

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(driver.click(el));

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function throwMatchableError(err) {
  // When using several versions of a library (i.e. mobile-json-wire-protocol),
  // instanceof doesn't work as expected, so in tests we just use jsonwpCode
  // and message to determine that the expected error was sent.
  throw new Error('jsonwpCode: ' + err.jsonwpCode + ' ' + err.message);
}

function filterDisplayed(driver, els) {
  var displayedEls;
  return _regeneratorRuntime.async(function filterDisplayed$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_bluebird2['default'].all(_lodash2['default'].map(els, function (el) {
          return driver.elementDisplayed(el);
        })));

      case 2:
        displayedEls = context$1$0.sent;
        return context$1$0.abrupt('return', _lodash2['default'].filter(els, function (el, i) {
          return displayedEls[i];
        }));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function filterVisibleUiaSelector(selector) {
  return selector.replace(/;$/, '.withPredicate("isVisible == 1");');
}

function okIfAlert(driver) {
  var text;
  return _regeneratorRuntime.async(function okIfAlert$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        text = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(driver.getAlertText());

      case 4:
        text = context$1$0.sent;
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        if (!(context$1$0.t0.jsonwpCode !== 27)) {
          context$1$0.next = 11;
          break;
        }

        throw context$1$0.t0;

      case 11:
        if (!text) {
          context$1$0.next = 14;
          break;
        }

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(driver.postAcceptAlert());

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
}

exports.clickBack = clickBack;
exports.clickButton = clickButton;
exports.elOrNull = elOrNull;
exports.throwMatchableError = throwMatchableError;
exports.filterDisplayed = filterDisplayed;
exports.filterVisibleUiaSelector = filterVisibleUiaSelector;
exports.okIfAlert = okIfAlert;

// if NoAlertOpenError (27) continue
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZTJlL2hlbHBlcnMvcmVjaXBlcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O3NCQUFjLFFBQVE7Ozs7d0JBQ1IsVUFBVTs7OztBQUV4QixTQUFlLFFBQVEsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUs7TUFDdEMsR0FBRzs7Ozs7eUNBQVMsTUFBTSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDOzs7QUFBN0MsV0FBRzs0Q0FDQSxHQUFHLENBQUMsQ0FBQyxDQUFDOzs7Ozs7O0NBQ2Q7O0FBRUQsU0FBZSxTQUFTLENBQUUsTUFBTTtNQUMxQixFQUFFOzs7Ozt5Q0FBUyxRQUFRLENBQUMsTUFBTSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sQ0FBQzs7O0FBQXZELFVBQUU7eUJBQ0YsRUFBRTs7Ozs7Ozs7eUNBQVcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQzs7Ozs7Ozs7Ozs7O3lDQUNwQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQzs7Ozs7OztDQUV6Qjs7QUFFRCxTQUFlLFdBQVcsQ0FBRSxNQUFNLEVBQUUsSUFBSTtNQUNsQyxFQUFFOzs7Ozt5Q0FBUyxRQUFRLENBQUMsTUFBTSxFQUFFLE9BQU8sNkJBQTBCLElBQUksU0FBSzs7O0FBQXRFLFVBQUU7eUJBQ0YsRUFBRTs7Ozs7Ozs7eUNBQVcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQzs7Ozs7Ozs7Ozs7O3lDQUNwQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQzs7Ozs7OztDQUV6Qjs7QUFFRCxTQUFTLG1CQUFtQixDQUFFLEdBQUcsRUFBRTs7OztBQUlqQyxRQUFNLElBQUksS0FBSyxrQkFBZ0IsR0FBRyxDQUFDLFVBQVUsU0FBSSxHQUFHLENBQUMsT0FBTyxDQUFHLENBQUM7Q0FDakU7O0FBRUQsU0FBZSxlQUFlLENBQUMsTUFBTSxFQUFFLEdBQUc7TUFDcEMsWUFBWTs7Ozs7eUNBQVMsc0JBQUUsR0FBRyxDQUFDLG9CQUFFLEdBQUcsQ0FBQyxHQUFHLEVBQUUsVUFBVSxFQUFFLEVBQUU7QUFBRSxpQkFBTyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxDQUFDLENBQUM7U0FBRSxDQUFDLENBQUM7OztBQUE3RixvQkFBWTs0Q0FDVCxvQkFBRSxNQUFNLENBQUMsR0FBRyxFQUFFLFVBQVUsRUFBRSxFQUFFLENBQUMsRUFBRTtBQUFFLGlCQUFPLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUFFLENBQUM7Ozs7Ozs7Q0FDbkU7O0FBRUQsU0FBUyx3QkFBd0IsQ0FBQyxRQUFRLEVBQUU7QUFDMUMsU0FBTyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxtQ0FBbUMsQ0FBQyxDQUFDO0NBQ3BFOztBQUVELFNBQWUsU0FBUyxDQUFDLE1BQU07TUFDekIsSUFBSTs7OztBQUFKLFlBQUk7Ozt5Q0FFTyxNQUFNLENBQUMsWUFBWSxFQUFFOzs7QUFBbEMsWUFBSTs7Ozs7Ozs7Y0FHQSxlQUFJLFVBQVUsS0FBSyxFQUFFLENBQUE7Ozs7Ozs7O2FBSXZCLElBQUk7Ozs7Ozt5Q0FDQSxNQUFNLENBQUMsZUFBZSxFQUFFOzs7Ozs7O0NBRWpDOztRQUVRLFNBQVMsR0FBVCxTQUFTO1FBQUUsV0FBVyxHQUFYLFdBQVc7UUFBRSxRQUFRLEdBQVIsUUFBUTtRQUFFLG1CQUFtQixHQUFuQixtQkFBbUI7UUFBRSxlQUFlLEdBQWYsZUFBZTtRQUN0RSx3QkFBd0IsR0FBeEIsd0JBQXdCO1FBQUUsU0FBUyxHQUFULFNBQVMiLCJmaWxlIjoidGVzdC9lMmUvaGVscGVycy9yZWNpcGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuYXN5bmMgZnVuY3Rpb24gZWxPck51bGwoZHJpdmVyLCB1c2luZywgdmFsdWUpIHtcbiAgbGV0IGVscyA9IGF3YWl0IGRyaXZlci5maW5kRWxlbWVudHModXNpbmcsIHZhbHVlKTtcbiAgcmV0dXJuIGVsc1swXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2xpY2tCYWNrIChkcml2ZXIpIHtcbiAgbGV0IGVsID0gYXdhaXQgZWxPck51bGwoZHJpdmVyLCAnYWNjZXNzaWJpbGl0eSBpZCcsICdCYWNrJyk7XG4gIGlmIChlbCAmJiAoYXdhaXQgZHJpdmVyLmVsZW1lbnREaXNwbGF5ZWQoZWwpKSkge1xuICAgIGF3YWl0IGRyaXZlci5jbGljayhlbCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY2xpY2tCdXR0b24gKGRyaXZlciwgbmFtZSkge1xuICBsZXQgZWwgPSBhd2FpdCBlbE9yTnVsbChkcml2ZXIsICd4cGF0aCcsIGAvL1VJQUJ1dHRvbltAbmFtZSA9ICcke25hbWV9J11gKTtcbiAgaWYgKGVsICYmIChhd2FpdCBkcml2ZXIuZWxlbWVudERpc3BsYXllZChlbCkpKSB7XG4gICAgYXdhaXQgZHJpdmVyLmNsaWNrKGVsKTtcbiAgfVxufVxuXG5mdW5jdGlvbiB0aHJvd01hdGNoYWJsZUVycm9yIChlcnIpIHtcbiAgLy8gV2hlbiB1c2luZyBzZXZlcmFsIHZlcnNpb25zIG9mIGEgbGlicmFyeSAoaS5lLiBtb2JpbGUtanNvbi13aXJlLXByb3RvY29sKSxcbiAgLy8gaW5zdGFuY2VvZiBkb2Vzbid0IHdvcmsgYXMgZXhwZWN0ZWQsIHNvIGluIHRlc3RzIHdlIGp1c3QgdXNlIGpzb253cENvZGVcbiAgLy8gYW5kIG1lc3NhZ2UgdG8gZGV0ZXJtaW5lIHRoYXQgdGhlIGV4cGVjdGVkIGVycm9yIHdhcyBzZW50LlxuICB0aHJvdyBuZXcgRXJyb3IoYGpzb253cENvZGU6ICR7ZXJyLmpzb253cENvZGV9ICR7ZXJyLm1lc3NhZ2V9YCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpbHRlckRpc3BsYXllZChkcml2ZXIsIGVscykge1xuICBsZXQgZGlzcGxheWVkRWxzID0gYXdhaXQgQi5hbGwoXy5tYXAoZWxzLCBmdW5jdGlvbiAoZWwpIHsgcmV0dXJuIGRyaXZlci5lbGVtZW50RGlzcGxheWVkKGVsKTsgfSkpO1xuICByZXR1cm4gXy5maWx0ZXIoZWxzLCBmdW5jdGlvbiAoZWwsIGkpIHsgcmV0dXJuIGRpc3BsYXllZEVsc1tpXTsgfSk7XG59XG5cbmZ1bmN0aW9uIGZpbHRlclZpc2libGVVaWFTZWxlY3RvcihzZWxlY3Rvcikge1xuICByZXR1cm4gc2VsZWN0b3IucmVwbGFjZSgvOyQvLCAnLndpdGhQcmVkaWNhdGUoXCJpc1Zpc2libGUgPT0gMVwiKTsnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gb2tJZkFsZXJ0KGRyaXZlcikge1xuICBsZXQgdGV4dDtcbiAgdHJ5IHtcbiAgICB0ZXh0ID0gYXdhaXQgZHJpdmVyLmdldEFsZXJ0VGV4dCgpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyBpZiBOb0FsZXJ0T3BlbkVycm9yICgyNykgY29udGludWVcbiAgICBpZiAoZXJyLmpzb253cENvZGUgIT09IDI3KSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG4gIGlmICh0ZXh0KSB7XG4gICAgYXdhaXQgZHJpdmVyLnBvc3RBY2NlcHRBbGVydCgpO1xuICB9XG59XG5cbmV4cG9ydCB7IGNsaWNrQmFjaywgY2xpY2tCdXR0b24sIGVsT3JOdWxsLCB0aHJvd01hdGNoYWJsZUVycm9yLCBmaWx0ZXJEaXNwbGF5ZWQsXG4gICAgICAgICBmaWx0ZXJWaXNpYmxlVWlhU2VsZWN0b3IsIG9rSWZBbGVydCB9O1xuIl19