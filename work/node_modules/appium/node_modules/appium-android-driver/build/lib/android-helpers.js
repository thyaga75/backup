'use strict';

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _teen_process = require('teen_process');

var _asyncbox = require('asyncbox');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _appiumAndroidIme = require('appium-android-ime');

var _ioAppiumSettings = require('io.appium.settings');

var _appiumUnlock = require('appium-unlock');

var _appiumAndroidBootstrap = require('appium-android-bootstrap');

var _appiumAndroidBootstrap2 = _interopRequireDefault(_appiumAndroidBootstrap);

var _appiumAdb = require('appium-adb');

var _appiumAdb2 = _interopRequireDefault(_appiumAdb);

var REMOTE_TEMP_PATH = "/data/local/tmp";
var REMOTE_INSTALL_TIMEOUT = 90000; // milliseconds
var CHROME_BROWSERS = ["Chrome", "Chromium", "Chromebeta", "Browser", "chrome", "chromium", "chromebeta", "browser"];

var helpers = {};

helpers.parseJavaVersion = function (stderr) {
  var lines = stderr.split("\n");
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = _getIterator(lines), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      var line = _step.value;

      if (new RegExp(/(java|openjdk) version/).test(line)) {
        return line.split(" ")[2].replace(/"/g, '');
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator['return']) {
        _iterator['return']();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  return null;
};

helpers.getJavaVersion = function callee$0$0() {
  var _ref, stderr, javaVer;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug("Getting Java version");

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('java', ['-version']));

      case 3:
        _ref = context$1$0.sent;
        stderr = _ref.stderr;
        javaVer = helpers.parseJavaVersion(stderr);

        if (!(javaVer === null)) {
          context$1$0.next = 8;
          break;
        }

        throw new Error("Could not get the Java version. Is Java installed?");

      case 8:
        _logger2['default'].info('Java version is: ' + javaVer);
        return context$1$0.abrupt('return', javaVer);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.prepareEmulator = function callee$0$0(adb, opts) {
  var avd, avdArgs, language, locale, avdLaunchTimeout, avdReadyTimeout, avdName, runningAVD;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        avd = opts.avd;
        avdArgs = opts.avdArgs;
        language = opts.language;
        locale = opts.locale;
        avdLaunchTimeout = opts.avdLaunchTimeout;
        avdReadyTimeout = opts.avdReadyTimeout;

        if (avd) {
          context$1$0.next = 8;
          break;
        }

        throw new Error("Cannot launch AVD without AVD name");

      case 8:
        avdName = avd.replace('@', '');
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(adb.getRunningAVD(avdName));

      case 11:
        runningAVD = context$1$0.sent;

        if (!(runningAVD !== null)) {
          context$1$0.next = 15;
          break;
        }

        _logger2['default'].debug("Not launching AVD because it is already running.");
        return context$1$0.abrupt('return');

      case 15:
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(adb.launchAVD(avd, avdArgs, language, locale, avdLaunchTimeout, avdReadyTimeout));

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.ensureDeviceLocale = function callee$0$0(adb, language, locale) {
  var haveLanguage, haveCountry, curLanguage, country, changed;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        haveLanguage = language && typeof language === "string";
        haveCountry = locale && typeof locale === "string";

        if (!(!haveLanguage && !haveCountry)) {
          context$1$0.next = 4;
          break;
        }

        return context$1$0.abrupt('return');

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(adb.getDeviceLanguage());

      case 6:
        curLanguage = context$1$0.sent;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(adb.getDeviceCountry());

      case 9:
        country = context$1$0.sent;
        changed = false;

        if (!(haveLanguage && language !== curLanguage)) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(adb.setDeviceLanguage(language));

      case 14:
        changed = true;

      case 15:
        if (!(haveCountry && locale !== country)) {
          context$1$0.next = 19;
          break;
        }

        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(adb.setDeviceCountry(locale));

      case 18:
        changed = true;

      case 19:
        if (!changed) {
          context$1$0.next = 22;
          break;
        }

        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(adb.reboot());

      case 22:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.getDeviceInfoFromCaps = function callee$0$0() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var adb, udid, emPort, devices;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumAdb2['default'].createADB({
          javaVersion: opts.javaVersion,
          adbPort: opts.adbPort
        }));

      case 2:
        adb = context$1$0.sent;
        udid = opts.udid;
        emPort = null;

        _logger2['default'].info("Retrieving device list");
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(adb.getDevicesWithRetry());

      case 8:
        devices = context$1$0.sent;

        if (udid) {
          if (!_lodash2['default'].contains(_lodash2['default'].pluck(devices, 'udid'), udid)) {
            _logger2['default'].errorAndThrow('Device ' + udid + ' was not in the list ' + 'of connected devices');
          }
          emPort = adb.getPortFromEmulatorString(udid);
        } else {
          udid = devices[0].udid;
          emPort = adb.getPortFromEmulatorString(udid);
        }
        _logger2['default'].info('Using device: ' + udid);
        return context$1$0.abrupt('return', { udid: udid, emPort: emPort });

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// returns a new adb instance with deviceId set
helpers.createADB = function callee$0$0(javaVersion, udid, emPort, adbPort) {
  var adb;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumAdb2['default'].createADB({ javaVersion: javaVersion, adbPort: adbPort }));

      case 2:
        adb = context$1$0.sent;

        adb.setDeviceId(udid);
        if (emPort) {
          adb.setEmulatorPort(emPort);
        }

        return context$1$0.abrupt('return', adb);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.getLaunchInfo = function callee$0$0(adb, opts) {
  var app, appPackage, appActivity, appWaitPackage, appWaitActivity, _ref2, apkPackage, apkActivity;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        app = opts.app;
        appPackage = opts.appPackage;
        appActivity = opts.appActivity;
        appWaitPackage = opts.appWaitPackage;
        appWaitActivity = opts.appWaitActivity;

        if (app) {
          context$1$0.next = 8;
          break;
        }

        _logger2['default'].warn("No app sent in, not parsing package/activity");
        return context$1$0.abrupt('return');

      case 8:
        if (!(appPackage && appActivity)) {
          context$1$0.next = 10;
          break;
        }

        return context$1$0.abrupt('return');

      case 10:

        _logger2['default'].debug("Parsing package and activity from app manifest");
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(adb.packageAndLaunchActivityFromManifest(app));

      case 13:
        _ref2 = context$1$0.sent;
        apkPackage = _ref2.apkPackage;
        apkActivity = _ref2.apkActivity;

        if (apkPackage && !appPackage) {
          appPackage = apkPackage;
        }
        if (!appWaitPackage) {
          appWaitPackage = appPackage;
        }
        if (apkActivity && !appActivity) {
          appActivity = apkActivity;
        }
        if (!appWaitActivity) {
          appWaitActivity = appActivity;
        }
        _logger2['default'].debug('Parsed package and activity are: ' + apkPackage + '/' + apkActivity);
        return context$1$0.abrupt('return', { appPackage: appPackage, appWaitPackage: appWaitPackage, appActivity: appActivity, appWaitActivity: appWaitActivity });

      case 22:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.getRemoteApkPath = function (localApkMd5) {
  var remotePath = REMOTE_TEMP_PATH + '/' + localApkMd5 + '.apk';
  _logger2['default'].info('Remote apk path is ' + remotePath);
  return remotePath;
};

helpers.resetApp = function callee$0$0(adb, localApkPath, pkg, fastReset) {
  var apkMd5, remotePath;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!fastReset) {
          context$1$0.next = 6;
          break;
        }

        _logger2['default'].debug("Running fast reset (stop and clear)");
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(adb.stopAndClear(pkg));

      case 4:
        context$1$0.next = 17;
        break;

      case 6:
        _logger2['default'].debug("Running old fashion reset (reinstall)");
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.md5(localApkPath));

      case 9:
        apkMd5 = context$1$0.sent;
        remotePath = helpers.getRemoteApkPath(apkMd5, localApkPath);
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(adb.fileExists(remotePath));

      case 13:
        if (context$1$0.sent) {
          context$1$0.next = 15;
          break;
        }

        throw new Error("Can't run slow reset without a remote apk!");

      case 15:
        context$1$0.next = 17;
        return _regeneratorRuntime.awrap(helpers.reinstallRemoteApk(adb, localApkPath, pkg, remotePath));

      case 17:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.reinstallRemoteApk = function callee$0$0(adb, localApkPath, pkg, remotePath) {
  var tries = arguments.length <= 4 || arguments[4] === undefined ? 2 : arguments[4];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _asyncbox.retry)(tries, function callee$1$0() {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.prev = 0;
                context$2$0.next = 3;
                return _regeneratorRuntime.awrap(adb.uninstallApk(pkg));

              case 3:
                context$2$0.next = 8;
                break;

              case 5:
                context$2$0.prev = 5;
                context$2$0.t0 = context$2$0['catch'](0);

                _logger2['default'].warn("Uninstalling remote APK failed, maybe it wasn't installed");

              case 8:
                context$2$0.prev = 8;
                context$2$0.next = 11;
                return _regeneratorRuntime.awrap(adb.installFromDevicePath(remotePath, { timeout: 90000 }));

              case 11:
                context$2$0.next = 21;
                break;

              case 13:
                context$2$0.prev = 13;
                context$2$0.t1 = context$2$0['catch'](8);

                _logger2['default'].warn("Installing remote APK failed, going to uninstall and try " + "again");
                // if remote install failed, remove ALL the apks and re-push ours
                // to the remote cache
                context$2$0.next = 18;
                return _regeneratorRuntime.awrap(helpers.removeRemoteApks(adb));

              case 18:
                context$2$0.next = 20;
                return _regeneratorRuntime.awrap(adb.push(localApkPath, remotePath));

              case 20:
                throw context$2$0.t1;

              case 21:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this, [[0, 5], [8, 13]]);
        }));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// throw an error to trigger the retry
helpers.installApkRemotely = function callee$0$0(adb, localApkPath, pkg, fastReset) {
  var installTimeout, apkMd5, remotePath, remoteApkExists, installed;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        installTimeout = REMOTE_INSTALL_TIMEOUT;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.md5(localApkPath));

      case 3:
        apkMd5 = context$1$0.sent;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(helpers.getRemoteApkPath(apkMd5, localApkPath));

      case 6:
        remotePath = context$1$0.sent;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(adb.fileExists(remotePath));

      case 9:
        remoteApkExists = context$1$0.sent;

        _logger2['default'].debug("Checking if app is installed");
        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(adb.isAppInstalled(pkg));

      case 13:
        installed = context$1$0.sent;

        if (!(installed && remoteApkExists && fastReset)) {
          context$1$0.next = 20;
          break;
        }

        _logger2['default'].info("Apk is already on remote and installed, resetting");
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(helpers.resetApp(adb, localApkPath, pkg, fastReset));

      case 18:
        context$1$0.next = 34;
        break;

      case 20:
        if (!(!installed || !remoteApkExists && fastReset)) {
          context$1$0.next = 34;
          break;
        }

        if (!installed) {
          _logger2['default'].info("Apk is not yet installed");
        } else {
          _logger2['default'].info("Apk was already installed but not from our remote path");
        }
        _logger2['default'].info((installed ? 'Re' : '') + 'installing apk from remote');
        context$1$0.next = 25;
        return _regeneratorRuntime.awrap(adb.mkdir(REMOTE_TEMP_PATH));

      case 25:
        _logger2['default'].info("Clearing out any existing remote apks with the same hash");
        context$1$0.next = 28;
        return _regeneratorRuntime.awrap(helpers.removeRemoteApks(adb, [apkMd5]));

      case 28:
        if (remoteApkExists) {
          context$1$0.next = 32;
          break;
        }

        // push from local to remote
        _logger2['default'].info('Pushing ' + pkg + ' to device. Will wait up to ' + installTimeout + ' ' + 'milliseconds before aborting');
        context$1$0.next = 32;
        return _regeneratorRuntime.awrap(adb.push(localApkPath, remotePath, { timeout: installTimeout }));

      case 32:
        context$1$0.next = 34;
        return _regeneratorRuntime.awrap(helpers.reinstallRemoteApk(adb, localApkPath, pkg, remotePath));

      case 34:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.removeRemoteApks = function callee$0$0(adb) {
  var exceptMd5s = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];

  var apks, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, apk;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug("Removing any old apks");
        if (exceptMd5s) {
          _logger2['default'].debug('Except ' + JSON.stringify(exceptMd5s));
        } else {
          exceptMd5s = [];
        }
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(adb.ls(REMOTE_TEMP_PATH + '/*.apk'));

      case 4:
        apks = context$1$0.sent;

        if (!(apks.length < 1)) {
          context$1$0.next = 8;
          break;
        }

        _logger2['default'].debug("No apks to examine");
        return context$1$0.abrupt('return');

      case 8:
        apks = apks.filter(function (apk) {
          var _iteratorNormalCompletion2 = true;
          var _didIteratorError2 = false;
          var _iteratorError2 = undefined;

          try {
            for (var _iterator2 = _getIterator(exceptMd5s), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              var md5 = _step2.value;

              return apk.indexOf(md5) === -1;
            }
          } catch (err) {
            _didIteratorError2 = true;
            _iteratorError2 = err;
          } finally {
            try {
              if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                _iterator2['return']();
              }
            } finally {
              if (_didIteratorError2) {
                throw _iteratorError2;
              }
            }
          }
        });
        _iteratorNormalCompletion3 = true;
        _didIteratorError3 = false;
        _iteratorError3 = undefined;
        context$1$0.prev = 12;
        _iterator3 = _getIterator(apks);

      case 14:
        if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
          context$1$0.next = 22;
          break;
        }

        apk = _step3.value;

        _logger2['default'].info('Will remove ' + apk);
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(adb.shell(['rm', '-f', apk]));

      case 19:
        _iteratorNormalCompletion3 = true;
        context$1$0.next = 14;
        break;

      case 22:
        context$1$0.next = 28;
        break;

      case 24:
        context$1$0.prev = 24;
        context$1$0.t0 = context$1$0['catch'](12);
        _didIteratorError3 = true;
        _iteratorError3 = context$1$0.t0;

      case 28:
        context$1$0.prev = 28;
        context$1$0.prev = 29;

        if (!_iteratorNormalCompletion3 && _iterator3['return']) {
          _iterator3['return']();
        }

      case 31:
        context$1$0.prev = 31;

        if (!_didIteratorError3) {
          context$1$0.next = 34;
          break;
        }

        throw _iteratorError3;

      case 34:
        return context$1$0.finish(31);

      case 35:
        return context$1$0.finish(28);

      case 36:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[12, 24, 28, 36], [29,, 31, 35]]);
};

helpers.initUnicodeKeyboard = function callee$0$0(adb) {
  var defaultIME, appiumIME;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Enabling Unicode keyboard support');
        _logger2['default'].debug("Pushing unicode ime to device...");
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(adb.install(_appiumAndroidIme.path, false));

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(adb.defaultIME());

      case 6:
        defaultIME = context$1$0.sent;

        _logger2['default'].debug('Unsetting previous IME ' + defaultIME);
        appiumIME = 'io.appium.android.ime/.UnicodeIME';

        _logger2['default'].debug('Setting IME to \'' + appiumIME + '\'');
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(adb.enableIME(appiumIME));

      case 12:
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(adb.setIME(appiumIME));

      case 14:
        return context$1$0.abrupt('return', defaultIME);

      case 15:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.pushSettingsApp = function callee$0$0(adb) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug("Pushing settings apk to device...");
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(adb.install(_ioAppiumSettings.path, false));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.pushUnlock = function callee$0$0(adb) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug("Pushing unlock helper app to device...");
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(adb.install(_appiumUnlock.path, false));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// pushStrings method extracts string.xml and converts it to string.json and pushes
// it to /data/local/tmp/string.json on for use of bootstrap
// if app is not present to extract string.xml it deletes remote strings.json
// if app does not have strings.xml we push an empty json object to remote
helpers.pushStrings = function callee$0$0(language, adb, opts) {
  var remotePath, stringsJson, stringsTmpDir, _ref3, apkStrings, localPath, remoteFile;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        remotePath = '/data/local/tmp';
        stringsJson = 'strings.json';
        stringsTmpDir = _path2['default'].resolve(opts.tmpDir, opts.appPackage);
        context$1$0.prev = 3;

        _logger2['default'].debug('Extracting strings from apk', opts.app, language, stringsTmpDir);
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(adb.extractStringsFromApk(opts.app, language, stringsTmpDir));

      case 7:
        _ref3 = context$1$0.sent;
        apkStrings = _ref3.apkStrings;
        localPath = _ref3.localPath;
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(adb.push(localPath, remotePath));

      case 12:
        return context$1$0.abrupt('return', apkStrings);

      case 15:
        context$1$0.prev = 15;
        context$1$0.t0 = context$1$0['catch'](3);
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(opts.app));

      case 19:
        if (context$1$0.sent) {
          context$1$0.next = 24;
          break;
        }

        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(adb.rimraf(remotePath + '/' + stringsJson));

      case 22:
        context$1$0.next = 28;
        break;

      case 24:
        _logger2['default'].warn("Could not get strings, continuing anyway");
        remoteFile = remotePath + '/' + stringsJson;
        context$1$0.next = 28;
        return _regeneratorRuntime.awrap(adb.shell('echo', ['\'{}\' > ' + remoteFile]));

      case 28:
        return context$1$0.abrupt('return', {});

      case 29:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 15]]);
};

helpers.unlock = function callee$0$0(adb) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    var _this2 = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(adb.isScreenLocked());

      case 2:
        if (context$1$0.sent) {
          context$1$0.next = 5;
          break;
        }

        _logger2['default'].info("Screen already unlocked, doing nothing");
        return context$1$0.abrupt('return');

      case 5:
        _logger2['default'].info("Unlocking screen");

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(10, 1000, function callee$1$0() {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                _logger2['default'].debug("Screen is locked, trying to unlock");
                context$2$0.next = 3;
                return _regeneratorRuntime.awrap(adb.startApp({
                  pkg: "io.appium.unlock",
                  activity: ".Unlock",
                  action: "android.intent.action.MAIN",
                  category: "android.intent.category.LAUNCHER",
                  flags: "0x10200000"
                }));

              case 3:
                context$2$0.next = 5;
                return _regeneratorRuntime.awrap(adb.isScreenLocked());

              case 5:
                if (context$2$0.sent) {
                  context$2$0.next = 9;
                  break;
                }

                _logger2['default'].debug("Screen unlocked successfully");
                context$2$0.next = 10;
                break;

              case 9:
                throw new Error("Screen did not unlock successfully, retrying");

              case 10:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this2);
        }));

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.initDevice = function callee$0$0(adb, opts) {
  var defaultIME;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!opts.avd) {
          context$1$0.next = 3;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(helpers.prepareEmulator(adb, opts));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(adb.waitForDevice());

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(helpers.ensureDeviceLocale(adb, opts.language, opts.locale));

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(adb.startLogcat());

      case 9:
        defaultIME = undefined;

        if (!opts.unicodeKeyboard) {
          context$1$0.next = 14;
          break;
        }

        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(helpers.initUnicodeKeyboard(adb));

      case 13:
        defaultIME = context$1$0.sent;

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(helpers.pushSettingsApp(adb));

      case 16:
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(helpers.pushUnlock(adb));

      case 18:
        return context$1$0.abrupt('return', defaultIME);

      case 19:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.removeNullProperties = function (obj) {
  var _iteratorNormalCompletion4 = true;
  var _didIteratorError4 = false;
  var _iteratorError4 = undefined;

  try {
    for (var _iterator4 = _getIterator(_lodash2['default'].keys(obj)), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
      var key = _step4.value;

      if (_lodash2['default'].isNull(obj[key]) || _lodash2['default'].isUndefined(obj[key])) {
        delete obj[key];
      }
    }
  } catch (err) {
    _didIteratorError4 = true;
    _iteratorError4 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion4 && _iterator4['return']) {
        _iterator4['return']();
      }
    } finally {
      if (_didIteratorError4) {
        throw _iteratorError4;
      }
    }
  }
};

helpers.truncateDecimals = function (number, digits) {
  var multiplier = Math.pow(10, digits),
      adjustedNum = number * multiplier,
      truncatedNum = Math[adjustedNum < 0 ? 'ceil' : 'floor'](adjustedNum);

  return truncatedNum / multiplier;
};

helpers.isChromeBrowser = function (browser) {
  return _lodash2['default'].contains(CHROME_BROWSERS, browser);
};

helpers.getChromePkg = function (browser) {
  var pkg = undefined,
      act = undefined;

  browser = browser.toLowerCase();
  if (browser === "chromium") {
    pkg = "org.chromium.chrome.shell";
    act = ".ChromeShellActivity";
  } else if (browser === "chromebeta") {
    pkg = "com.chrome.beta";
    act = "com.google.android.apps.chrome.Main";
  } else if (browser === "browser") {
    pkg = "com.android.browser";
    act = "com.android.browser.BrowserActivity";
  } else {
    pkg = "com.android.chrome";
    act = "com.google.android.apps.chrome.Main";
  }
  return { pkg: pkg, activity: act };
};

helpers.bootstrap = _appiumAndroidBootstrap2['default'];

exports['default'] = helpers;
exports.CHROME_BROWSERS = CHROME_BROWSERS;

// we can create a throwaway ADB instance here, so there is no dependency
// on instantiating on earlier (at this point, we have no udid)
// we can only use this ADB object for commands that would not be confused
// if multiple devices are connected

// first do an uninstall of the package to make sure it's not there

// Next, install from the remote path. This can be flakey. If it doesn't
// work, clear out any cached apks, re-push from local, and try again

// get the default IME so we can return back to it later if we want

// delete remote string.json if present
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9hbmRyb2lkLWhlbHBlcnMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O3NCQUFjLFFBQVE7Ozs7b0JBQ0wsTUFBTTs7Ozs0QkFDRixjQUFjOzt3QkFDRSxVQUFVOztzQkFDNUIsVUFBVTs7Ozs2QkFDVixnQkFBZ0I7O2dDQUNJLG9CQUFvQjs7Z0NBQ25CLG9CQUFvQjs7NEJBQ3RCLGVBQWU7O3NDQUMvQiwwQkFBMEI7Ozs7eUJBQ2hDLFlBQVk7Ozs7QUFFNUIsSUFBTSxnQkFBZ0IsR0FBRyxpQkFBaUIsQ0FBQztBQUMzQyxJQUFNLHNCQUFzQixHQUFHLEtBQUssQ0FBQztBQUNyQyxJQUFNLGVBQWUsR0FBRyxDQUFDLFFBQVEsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFDN0MsUUFBUSxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsU0FBUyxDQUFDLENBQUM7O0FBRXhFLElBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQzs7QUFFakIsT0FBTyxDQUFDLGdCQUFnQixHQUFHLFVBQVUsTUFBTSxFQUFFO0FBQzNDLE1BQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7Ozs7OztBQUMvQixzQ0FBaUIsS0FBSyw0R0FBRTtVQUFmLElBQUk7O0FBQ1gsVUFBSSxJQUFJLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtBQUNuRCxlQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztPQUM3QztLQUNGOzs7Ozs7Ozs7Ozs7Ozs7O0FBQ0QsU0FBTyxJQUFJLENBQUM7Q0FDYixDQUFDOztBQUVGLE9BQU8sQ0FBQyxjQUFjLEdBQUc7WUFHbEIsTUFBTSxFQUNQLE9BQU87Ozs7O0FBSFgsNEJBQU8sS0FBSyxDQUFDLHNCQUFzQixDQUFDLENBQUM7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Q2hDLE1BQUksT0FBTyxLQUFLLFVBQVUsRUFBRTtBQUMxQixPQUFHLEdBQUcsMkJBQTJCLENBQUM7QUFDbEMsT0FBRyxHQUFHLHNCQUFzQixDQUFDO0dBQzlCLE1BQU0sSUFBSSxPQUFPLEtBQUssWUFBWSxFQUFFO0FBQ25DLE9BQUcsR0FBRyxpQkFBaUIsQ0FBQztBQUN4QixPQUFHLEdBQUcscUNBQXFDLENBQUM7R0FDN0MsTUFBTSxJQUFJLE9BQU8sS0FBSyxTQUFTLEVBQUU7QUFDaEMsT0FBRyxHQUFHLHFCQUFxQixDQUFDO0FBQzVCLE9BQUcsR0FBRyxxQ0FBcUMsQ0FBQztHQUM3QyxNQUFNO0FBQ0wsT0FBRyxHQUFHLG9CQUFvQixDQUFDO0FBQzNCLE9BQUcsR0FBRyxxQ0FBcUMsQ0FBQztHQUM3QztBQUNELFNBQU8sRUFBQyxHQUFHLEVBQUgsR0FBRyxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUMsQ0FBQztDQUM3QixDQUFDOztBQUVGLE9BQU8sQ0FBQyxTQUFTLHNDQUFZLENBQUM7O3FCQUVmLE9BQU87UUFDYixlQUFlLEdBQWYsZUFBZSIsImZpbGUiOiJsaWIvYW5kcm9pZC1oZWxwZXJzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyByZXRyeSwgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBwYXRoIGFzIHVuaWNvZGVJTUVQYXRoIH0gZnJvbSAnYXBwaXVtLWFuZHJvaWQtaW1lJztcbmltcG9ydCB7IHBhdGggYXMgc2V0dGluZ3NBcGtQYXRoIH0gZnJvbSAnaW8uYXBwaXVtLnNldHRpbmdzJztcbmltcG9ydCB7IHBhdGggYXMgdW5sb2NrQXBrUGF0aCB9IGZyb20gJ2FwcGl1bS11bmxvY2snO1xuaW1wb3J0IEJvb3RzdHJhcCBmcm9tICdhcHBpdW0tYW5kcm9pZC1ib290c3RyYXAnO1xuaW1wb3J0IEFEQiBmcm9tICdhcHBpdW0tYWRiJztcblxuY29uc3QgUkVNT1RFX1RFTVBfUEFUSCA9IFwiL2RhdGEvbG9jYWwvdG1wXCI7XG5jb25zdCBSRU1PVEVfSU5TVEFMTF9USU1FT1VUID0gOTAwMDA7IC8vIG1pbGxpc2Vjb25kc1xuY29uc3QgQ0hST01FX0JST1dTRVJTID0gW1wiQ2hyb21lXCIsIFwiQ2hyb21pdW1cIiwgXCJDaHJvbWViZXRhXCIsIFwiQnJvd3NlclwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgIFwiY2hyb21lXCIsIFwiY2hyb21pdW1cIiwgXCJjaHJvbWViZXRhXCIsIFwiYnJvd3NlclwiXTtcblxubGV0IGhlbHBlcnMgPSB7fTtcblxuaGVscGVycy5wYXJzZUphdmFWZXJzaW9uID0gZnVuY3Rpb24gKHN0ZGVycikge1xuICBsZXQgbGluZXMgPSBzdGRlcnIuc3BsaXQoXCJcXG5cIik7XG4gIGZvciAobGV0IGxpbmUgb2YgbGluZXMpIHtcbiAgICBpZiAobmV3IFJlZ0V4cCgvKGphdmF8b3BlbmpkaykgdmVyc2lvbi8pLnRlc3QobGluZSkpIHtcbiAgICAgIHJldHVybiBsaW5lLnNwbGl0KFwiIFwiKVsyXS5yZXBsYWNlKC9cIi9nLCAnJyk7XG4gICAgfVxuICB9XG4gIHJldHVybiBudWxsO1xufTtcblxuaGVscGVycy5nZXRKYXZhVmVyc2lvbiA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbG9nZ2VyLmRlYnVnKFwiR2V0dGluZyBKYXZhIHZlcnNpb25cIik7XG5cbiAgbGV0IHtzdGRlcnJ9ID0gYXdhaXQgZXhlYygnamF2YScsIFsnLXZlcnNpb24nXSk7XG4gIGxldCBqYXZhVmVyID0gaGVscGVycy5wYXJzZUphdmFWZXJzaW9uKHN0ZGVycik7XG4gIGlmIChqYXZhVmVyID09PSBudWxsKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiQ291bGQgbm90IGdldCB0aGUgSmF2YSB2ZXJzaW9uLiBJcyBKYXZhIGluc3RhbGxlZD9cIik7XG4gIH1cbiAgbG9nZ2VyLmluZm8oYEphdmEgdmVyc2lvbiBpczogJHtqYXZhVmVyfWApO1xuICByZXR1cm4gamF2YVZlcjtcbn07XG5cbmhlbHBlcnMucHJlcGFyZUVtdWxhdG9yID0gYXN5bmMgZnVuY3Rpb24gKGFkYiwgb3B0cykge1xuICBsZXQge2F2ZCwgYXZkQXJncywgbGFuZ3VhZ2UsIGxvY2FsZSwgYXZkTGF1bmNoVGltZW91dCxcbiAgICAgICBhdmRSZWFkeVRpbWVvdXR9ID0gb3B0cztcbiAgaWYgKCFhdmQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgbGF1bmNoIEFWRCB3aXRob3V0IEFWRCBuYW1lXCIpO1xuICB9XG4gIGxldCBhdmROYW1lID0gYXZkLnJlcGxhY2UoJ0AnLCAnJyk7XG4gIGxldCBydW5uaW5nQVZEID0gYXdhaXQgYWRiLmdldFJ1bm5pbmdBVkQoYXZkTmFtZSk7XG4gIGlmIChydW5uaW5nQVZEICE9PSBudWxsKSB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiTm90IGxhdW5jaGluZyBBVkQgYmVjYXVzZSBpdCBpcyBhbHJlYWR5IHJ1bm5pbmcuXCIpO1xuICAgIHJldHVybjtcbiAgfVxuICBhd2FpdCBhZGIubGF1bmNoQVZEKGF2ZCwgYXZkQXJncywgbGFuZ3VhZ2UsIGxvY2FsZSwgYXZkTGF1bmNoVGltZW91dCxcbiAgICAgICAgICAgICAgICAgICAgICBhdmRSZWFkeVRpbWVvdXQpO1xufTtcblxuaGVscGVycy5lbnN1cmVEZXZpY2VMb2NhbGUgPSBhc3luYyBmdW5jdGlvbiAoYWRiLCBsYW5ndWFnZSwgbG9jYWxlKSB7XG4gIGxldCBoYXZlTGFuZ3VhZ2UgPSBsYW5ndWFnZSAmJiB0eXBlb2YgbGFuZ3VhZ2UgPT09IFwic3RyaW5nXCI7XG4gIGxldCBoYXZlQ291bnRyeSA9IGxvY2FsZSAmJiB0eXBlb2YgbG9jYWxlID09PSBcInN0cmluZ1wiO1xuICBpZiAoIWhhdmVMYW5ndWFnZSAmJiAhaGF2ZUNvdW50cnkpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgbGV0IGN1ckxhbmd1YWdlID0gYXdhaXQgYWRiLmdldERldmljZUxhbmd1YWdlKCk7XG4gIGxldCBjb3VudHJ5ID0gYXdhaXQgYWRiLmdldERldmljZUNvdW50cnkoKTtcbiAgbGV0IGNoYW5nZWQgPSBmYWxzZTtcbiAgaWYgKGhhdmVMYW5ndWFnZSAmJiBsYW5ndWFnZSAhPT0gY3VyTGFuZ3VhZ2UpIHtcbiAgICBhd2FpdCBhZGIuc2V0RGV2aWNlTGFuZ3VhZ2UobGFuZ3VhZ2UpO1xuICAgIGNoYW5nZWQgPSB0cnVlO1xuICB9XG4gIGlmIChoYXZlQ291bnRyeSAmJiBsb2NhbGUgIT09IGNvdW50cnkpIHtcbiAgICBhd2FpdCBhZGIuc2V0RGV2aWNlQ291bnRyeShsb2NhbGUpO1xuICAgIGNoYW5nZWQgPSB0cnVlO1xuICB9XG4gIGlmIChjaGFuZ2VkKSB7XG4gICAgYXdhaXQgYWRiLnJlYm9vdCgpO1xuICB9XG59O1xuXG5oZWxwZXJzLmdldERldmljZUluZm9Gcm9tQ2FwcyA9IGFzeW5jIGZ1bmN0aW9uIChvcHRzID0ge30pIHtcbiAgLy8gd2UgY2FuIGNyZWF0ZSBhIHRocm93YXdheSBBREIgaW5zdGFuY2UgaGVyZSwgc28gdGhlcmUgaXMgbm8gZGVwZW5kZW5jeVxuICAvLyBvbiBpbnN0YW50aWF0aW5nIG9uIGVhcmxpZXIgKGF0IHRoaXMgcG9pbnQsIHdlIGhhdmUgbm8gdWRpZClcbiAgLy8gd2UgY2FuIG9ubHkgdXNlIHRoaXMgQURCIG9iamVjdCBmb3IgY29tbWFuZHMgdGhhdCB3b3VsZCBub3QgYmUgY29uZnVzZWRcbiAgLy8gaWYgbXVsdGlwbGUgZGV2aWNlcyBhcmUgY29ubmVjdGVkXG4gIGxldCBhZGIgPSBhd2FpdCBBREIuY3JlYXRlQURCKHtcbiAgICBqYXZhVmVyc2lvbjogb3B0cy5qYXZhVmVyc2lvbixcbiAgICBhZGJQb3J0OiBvcHRzLmFkYlBvcnRcbiAgfSk7XG4gIGxldCB1ZGlkID0gb3B0cy51ZGlkO1xuICBsZXQgZW1Qb3J0ID0gbnVsbDtcblxuICBsb2dnZXIuaW5mbyhcIlJldHJpZXZpbmcgZGV2aWNlIGxpc3RcIik7XG4gIGxldCBkZXZpY2VzID0gYXdhaXQgYWRiLmdldERldmljZXNXaXRoUmV0cnkoKTtcbiAgaWYgKHVkaWQpIHtcbiAgICBpZiAoIV8uY29udGFpbnMoXy5wbHVjayhkZXZpY2VzLCAndWRpZCcpLCB1ZGlkKSkge1xuICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coYERldmljZSAke3VkaWR9IHdhcyBub3QgaW4gdGhlIGxpc3QgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBgb2YgY29ubmVjdGVkIGRldmljZXNgKTtcbiAgICB9XG4gICAgZW1Qb3J0ID0gYWRiLmdldFBvcnRGcm9tRW11bGF0b3JTdHJpbmcodWRpZCk7XG4gIH0gZWxzZSB7XG4gICAgdWRpZCA9IGRldmljZXNbMF0udWRpZDtcbiAgICBlbVBvcnQgPSBhZGIuZ2V0UG9ydEZyb21FbXVsYXRvclN0cmluZyh1ZGlkKTtcbiAgfVxuICBsb2dnZXIuaW5mbyhgVXNpbmcgZGV2aWNlOiAke3VkaWR9YCk7XG4gIHJldHVybiB7dWRpZCwgZW1Qb3J0fTtcbn07XG5cbi8vIHJldHVybnMgYSBuZXcgYWRiIGluc3RhbmNlIHdpdGggZGV2aWNlSWQgc2V0XG5oZWxwZXJzLmNyZWF0ZUFEQiA9IGFzeW5jIGZ1bmN0aW9uIChqYXZhVmVyc2lvbiwgdWRpZCwgZW1Qb3J0LCBhZGJQb3J0KSB7XG4gIGxldCBhZGIgPSBhd2FpdCBBREIuY3JlYXRlQURCKHtqYXZhVmVyc2lvbiwgYWRiUG9ydH0pO1xuXG4gIGFkYi5zZXREZXZpY2VJZCh1ZGlkKTtcbiAgaWYgKGVtUG9ydCkge1xuICAgIGFkYi5zZXRFbXVsYXRvclBvcnQoZW1Qb3J0KTtcbiAgfVxuXG4gIHJldHVybiBhZGI7XG59O1xuXG5oZWxwZXJzLmdldExhdW5jaEluZm8gPSBhc3luYyBmdW5jdGlvbiAoYWRiLCBvcHRzKSB7XG4gIGxldCB7YXBwLCBhcHBQYWNrYWdlLCBhcHBBY3Rpdml0eSwgYXBwV2FpdFBhY2thZ2UsIGFwcFdhaXRBY3Rpdml0eX0gPSBvcHRzO1xuICBpZiAoIWFwcCkge1xuICAgIGxvZ2dlci53YXJuKFwiTm8gYXBwIHNlbnQgaW4sIG5vdCBwYXJzaW5nIHBhY2thZ2UvYWN0aXZpdHlcIik7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmIChhcHBQYWNrYWdlICYmIGFwcEFjdGl2aXR5KSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKFwiUGFyc2luZyBwYWNrYWdlIGFuZCBhY3Rpdml0eSBmcm9tIGFwcCBtYW5pZmVzdFwiKTtcbiAgbGV0IHthcGtQYWNrYWdlLCBhcGtBY3Rpdml0eX0gPVxuICAgIGF3YWl0IGFkYi5wYWNrYWdlQW5kTGF1bmNoQWN0aXZpdHlGcm9tTWFuaWZlc3QoYXBwKTtcbiAgaWYgKGFwa1BhY2thZ2UgJiYgIWFwcFBhY2thZ2UpIHtcbiAgICBhcHBQYWNrYWdlID0gYXBrUGFja2FnZTtcbiAgfVxuICBpZiAoIWFwcFdhaXRQYWNrYWdlKSB7XG4gICAgYXBwV2FpdFBhY2thZ2UgPSBhcHBQYWNrYWdlO1xuICB9XG4gIGlmIChhcGtBY3Rpdml0eSAmJiAhYXBwQWN0aXZpdHkpIHtcbiAgICBhcHBBY3Rpdml0eSA9IGFwa0FjdGl2aXR5O1xuICB9XG4gIGlmICghYXBwV2FpdEFjdGl2aXR5KSB7XG4gICAgYXBwV2FpdEFjdGl2aXR5ID0gYXBwQWN0aXZpdHk7XG4gIH1cbiAgbG9nZ2VyLmRlYnVnKGBQYXJzZWQgcGFja2FnZSBhbmQgYWN0aXZpdHkgYXJlOiAke2Fwa1BhY2thZ2V9LyR7YXBrQWN0aXZpdHl9YCk7XG4gIHJldHVybiB7YXBwUGFja2FnZSwgYXBwV2FpdFBhY2thZ2UsIGFwcEFjdGl2aXR5LCBhcHBXYWl0QWN0aXZpdHl9O1xufTtcblxuaGVscGVycy5nZXRSZW1vdGVBcGtQYXRoID0gZnVuY3Rpb24gKGxvY2FsQXBrTWQ1KSB7XG4gIGxldCByZW1vdGVQYXRoID0gYCR7UkVNT1RFX1RFTVBfUEFUSH0vJHtsb2NhbEFwa01kNX0uYXBrYDtcbiAgbG9nZ2VyLmluZm8oYFJlbW90ZSBhcGsgcGF0aCBpcyAke3JlbW90ZVBhdGh9YCk7XG4gIHJldHVybiByZW1vdGVQYXRoO1xufTtcblxuaGVscGVycy5yZXNldEFwcCA9IGFzeW5jIGZ1bmN0aW9uIChhZGIsIGxvY2FsQXBrUGF0aCwgcGtnLCBmYXN0UmVzZXQpIHtcbiAgaWYgKGZhc3RSZXNldCkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIlJ1bm5pbmcgZmFzdCByZXNldCAoc3RvcCBhbmQgY2xlYXIpXCIpO1xuICAgIGF3YWl0IGFkYi5zdG9wQW5kQ2xlYXIocGtnKTtcbiAgfSBlbHNlIHtcbiAgICBsb2dnZXIuZGVidWcoXCJSdW5uaW5nIG9sZCBmYXNoaW9uIHJlc2V0IChyZWluc3RhbGwpXCIpO1xuICAgIGxldCBhcGtNZDUgPSBhd2FpdCBmcy5tZDUobG9jYWxBcGtQYXRoKTtcbiAgICBsZXQgcmVtb3RlUGF0aCA9IGhlbHBlcnMuZ2V0UmVtb3RlQXBrUGF0aChhcGtNZDUsIGxvY2FsQXBrUGF0aCk7XG4gICAgaWYgKCFhd2FpdCBhZGIuZmlsZUV4aXN0cyhyZW1vdGVQYXRoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2FuJ3QgcnVuIHNsb3cgcmVzZXQgd2l0aG91dCBhIHJlbW90ZSBhcGshXCIpO1xuICAgIH1cbiAgICBhd2FpdCBoZWxwZXJzLnJlaW5zdGFsbFJlbW90ZUFwayhhZGIsIGxvY2FsQXBrUGF0aCwgcGtnLCByZW1vdGVQYXRoKTtcbiAgfVxufTtcblxuaGVscGVycy5yZWluc3RhbGxSZW1vdGVBcGsgPSBhc3luYyBmdW5jdGlvbiAoYWRiLCBsb2NhbEFwa1BhdGgsIHBrZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZVBhdGgsIHRyaWVzID0gMikge1xuICBhd2FpdCByZXRyeSh0cmllcywgYXN5bmMgKCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBmaXJzdCBkbyBhbiB1bmluc3RhbGwgb2YgdGhlIHBhY2thZ2UgdG8gbWFrZSBzdXJlIGl0J3Mgbm90IHRoZXJlXG4gICAgICBhd2FpdCBhZGIudW5pbnN0YWxsQXBrKHBrZyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nZ2VyLndhcm4oXCJVbmluc3RhbGxpbmcgcmVtb3RlIEFQSyBmYWlsZWQsIG1heWJlIGl0IHdhc24ndCBpbnN0YWxsZWRcIik7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBhZGIuaW5zdGFsbEZyb21EZXZpY2VQYXRoKHJlbW90ZVBhdGgsIHt0aW1lb3V0OiA5MDAwMH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZ2dlci53YXJuKFwiSW5zdGFsbGluZyByZW1vdGUgQVBLIGZhaWxlZCwgZ29pbmcgdG8gdW5pbnN0YWxsIGFuZCB0cnkgXCIgK1xuICAgICAgICAgICAgICAgICAgXCJhZ2FpblwiKTtcbiAgICAgIC8vIGlmIHJlbW90ZSBpbnN0YWxsIGZhaWxlZCwgcmVtb3ZlIEFMTCB0aGUgYXBrcyBhbmQgcmUtcHVzaCBvdXJzXG4gICAgICAvLyB0byB0aGUgcmVtb3RlIGNhY2hlXG4gICAgICBhd2FpdCBoZWxwZXJzLnJlbW92ZVJlbW90ZUFwa3MoYWRiKTtcbiAgICAgIGF3YWl0IGFkYi5wdXNoKGxvY2FsQXBrUGF0aCwgcmVtb3RlUGF0aCk7XG4gICAgICB0aHJvdyBlOyAvLyB0aHJvdyBhbiBlcnJvciB0byB0cmlnZ2VyIHRoZSByZXRyeVxuICAgIH1cbiAgfSk7XG59O1xuXG5oZWxwZXJzLmluc3RhbGxBcGtSZW1vdGVseSA9IGFzeW5jIGZ1bmN0aW9uIChhZGIsIGxvY2FsQXBrUGF0aCwgcGtnLCBmYXN0UmVzZXQpIHtcbiAgbGV0IGluc3RhbGxUaW1lb3V0ID0gUkVNT1RFX0lOU1RBTExfVElNRU9VVDtcblxuICBsZXQgYXBrTWQ1ID0gYXdhaXQgZnMubWQ1KGxvY2FsQXBrUGF0aCk7XG4gIGxldCByZW1vdGVQYXRoID0gYXdhaXQgaGVscGVycy5nZXRSZW1vdGVBcGtQYXRoKGFwa01kNSwgbG9jYWxBcGtQYXRoKTtcbiAgbGV0IHJlbW90ZUFwa0V4aXN0cyA9IGF3YWl0IGFkYi5maWxlRXhpc3RzKHJlbW90ZVBhdGgpO1xuICBsb2dnZXIuZGVidWcoXCJDaGVja2luZyBpZiBhcHAgaXMgaW5zdGFsbGVkXCIpO1xuICBsZXQgaW5zdGFsbGVkID0gYXdhaXQgYWRiLmlzQXBwSW5zdGFsbGVkKHBrZyk7XG5cbiAgaWYgKGluc3RhbGxlZCAmJiByZW1vdGVBcGtFeGlzdHMgJiYgZmFzdFJlc2V0KSB7XG4gICAgbG9nZ2VyLmluZm8oXCJBcGsgaXMgYWxyZWFkeSBvbiByZW1vdGUgYW5kIGluc3RhbGxlZCwgcmVzZXR0aW5nXCIpO1xuICAgIGF3YWl0IGhlbHBlcnMucmVzZXRBcHAoYWRiLCBsb2NhbEFwa1BhdGgsIHBrZywgZmFzdFJlc2V0KTtcbiAgfSBlbHNlIGlmICghaW5zdGFsbGVkIHx8ICghcmVtb3RlQXBrRXhpc3RzICYmIGZhc3RSZXNldCkpIHtcbiAgICBpZiAoIWluc3RhbGxlZCkge1xuICAgICAgbG9nZ2VyLmluZm8oXCJBcGsgaXMgbm90IHlldCBpbnN0YWxsZWRcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5pbmZvKFwiQXBrIHdhcyBhbHJlYWR5IGluc3RhbGxlZCBidXQgbm90IGZyb20gb3VyIHJlbW90ZSBwYXRoXCIpO1xuICAgIH1cbiAgICBsb2dnZXIuaW5mbyhgJHtpbnN0YWxsZWQgPyAnUmUnIDogJyd9aW5zdGFsbGluZyBhcGsgZnJvbSByZW1vdGVgKTtcbiAgICBhd2FpdCBhZGIubWtkaXIoUkVNT1RFX1RFTVBfUEFUSCk7XG4gICAgbG9nZ2VyLmluZm8oXCJDbGVhcmluZyBvdXQgYW55IGV4aXN0aW5nIHJlbW90ZSBhcGtzIHdpdGggdGhlIHNhbWUgaGFzaFwiKTtcbiAgICBhd2FpdCBoZWxwZXJzLnJlbW92ZVJlbW90ZUFwa3MoYWRiLCBbYXBrTWQ1XSk7XG4gICAgaWYgKCFyZW1vdGVBcGtFeGlzdHMpIHtcbiAgICAgIC8vIHB1c2ggZnJvbSBsb2NhbCB0byByZW1vdGVcbiAgICAgIGxvZ2dlci5pbmZvKGBQdXNoaW5nICR7cGtnfSB0byBkZXZpY2UuIFdpbGwgd2FpdCB1cCB0byAke2luc3RhbGxUaW1lb3V0fSBgICtcbiAgICAgICAgICAgICAgICAgIGBtaWxsaXNlY29uZHMgYmVmb3JlIGFib3J0aW5nYCk7XG4gICAgICBhd2FpdCBhZGIucHVzaChsb2NhbEFwa1BhdGgsIHJlbW90ZVBhdGgsIHt0aW1lb3V0OiBpbnN0YWxsVGltZW91dH0pO1xuICAgIH1cblxuICAgIC8vIE5leHQsIGluc3RhbGwgZnJvbSB0aGUgcmVtb3RlIHBhdGguIFRoaXMgY2FuIGJlIGZsYWtleS4gSWYgaXQgZG9lc24ndFxuICAgIC8vIHdvcmssIGNsZWFyIG91dCBhbnkgY2FjaGVkIGFwa3MsIHJlLXB1c2ggZnJvbSBsb2NhbCwgYW5kIHRyeSBhZ2FpblxuICAgIGF3YWl0IGhlbHBlcnMucmVpbnN0YWxsUmVtb3RlQXBrKGFkYiwgbG9jYWxBcGtQYXRoLCBwa2csIHJlbW90ZVBhdGgpO1xuICB9XG59O1xuXG5oZWxwZXJzLnJlbW92ZVJlbW90ZUFwa3MgPSBhc3luYyBmdW5jdGlvbiAoYWRiLCBleGNlcHRNZDVzID0gbnVsbCkge1xuICBsb2dnZXIuZGVidWcoXCJSZW1vdmluZyBhbnkgb2xkIGFwa3NcIik7XG4gIGlmIChleGNlcHRNZDVzKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBFeGNlcHQgJHtKU09OLnN0cmluZ2lmeShleGNlcHRNZDVzKX1gKTtcbiAgfSBlbHNlIHtcbiAgICBleGNlcHRNZDVzID0gW107XG4gIH1cbiAgbGV0IGFwa3MgPSBhd2FpdCBhZGIubHMoYCR7UkVNT1RFX1RFTVBfUEFUSH0vKi5hcGtgKTtcbiAgaWYgKGFwa3MubGVuZ3RoIDwgMSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIk5vIGFwa3MgdG8gZXhhbWluZVwiKTtcbiAgICByZXR1cm47XG4gIH1cbiAgYXBrcyA9IGFwa3MuZmlsdGVyKGFwayA9PiB7XG4gICAgZm9yIChsZXQgbWQ1IG9mIGV4Y2VwdE1kNXMpIHtcbiAgICAgIHJldHVybiBhcGsuaW5kZXhPZihtZDUpID09PSAtMTtcbiAgICB9XG4gIH0pO1xuICBmb3IgKGxldCBhcGsgb2YgYXBrcykge1xuICAgIGxvZ2dlci5pbmZvKGBXaWxsIHJlbW92ZSAke2Fwa31gKTtcbiAgICBhd2FpdCBhZGIuc2hlbGwoWydybScsICctZicsIGFwa10pO1xuICB9XG59O1xuXG5oZWxwZXJzLmluaXRVbmljb2RlS2V5Ym9hcmQgPSBhc3luYyBmdW5jdGlvbiAoYWRiKSB7XG4gIGxvZ2dlci5kZWJ1ZygnRW5hYmxpbmcgVW5pY29kZSBrZXlib2FyZCBzdXBwb3J0Jyk7XG4gIGxvZ2dlci5kZWJ1ZyhcIlB1c2hpbmcgdW5pY29kZSBpbWUgdG8gZGV2aWNlLi4uXCIpO1xuICBhd2FpdCBhZGIuaW5zdGFsbCh1bmljb2RlSU1FUGF0aCwgZmFsc2UpO1xuXG4gIC8vIGdldCB0aGUgZGVmYXVsdCBJTUUgc28gd2UgY2FuIHJldHVybiBiYWNrIHRvIGl0IGxhdGVyIGlmIHdlIHdhbnRcbiAgbGV0IGRlZmF1bHRJTUUgPSBhd2FpdCBhZGIuZGVmYXVsdElNRSgpO1xuXG4gIGxvZ2dlci5kZWJ1ZyhgVW5zZXR0aW5nIHByZXZpb3VzIElNRSAke2RlZmF1bHRJTUV9YCk7XG4gIGNvbnN0IGFwcGl1bUlNRSA9ICdpby5hcHBpdW0uYW5kcm9pZC5pbWUvLlVuaWNvZGVJTUUnO1xuICBsb2dnZXIuZGVidWcoYFNldHRpbmcgSU1FIHRvICcke2FwcGl1bUlNRX0nYCk7XG4gIGF3YWl0IGFkYi5lbmFibGVJTUUoYXBwaXVtSU1FKTtcbiAgYXdhaXQgYWRiLnNldElNRShhcHBpdW1JTUUpO1xuICByZXR1cm4gZGVmYXVsdElNRTtcbn07XG5cbmhlbHBlcnMucHVzaFNldHRpbmdzQXBwID0gYXN5bmMgZnVuY3Rpb24gKGFkYikge1xuICBsb2dnZXIuZGVidWcoXCJQdXNoaW5nIHNldHRpbmdzIGFwayB0byBkZXZpY2UuLi5cIik7XG4gIGF3YWl0IGFkYi5pbnN0YWxsKHNldHRpbmdzQXBrUGF0aCwgZmFsc2UpO1xufTtcblxuaGVscGVycy5wdXNoVW5sb2NrID0gYXN5bmMgZnVuY3Rpb24gKGFkYikge1xuICBsb2dnZXIuZGVidWcoXCJQdXNoaW5nIHVubG9jayBoZWxwZXIgYXBwIHRvIGRldmljZS4uLlwiKTtcbiAgYXdhaXQgYWRiLmluc3RhbGwodW5sb2NrQXBrUGF0aCwgZmFsc2UpO1xufTtcblxuLy8gcHVzaFN0cmluZ3MgbWV0aG9kIGV4dHJhY3RzIHN0cmluZy54bWwgYW5kIGNvbnZlcnRzIGl0IHRvIHN0cmluZy5qc29uIGFuZCBwdXNoZXNcbi8vIGl0IHRvIC9kYXRhL2xvY2FsL3RtcC9zdHJpbmcuanNvbiBvbiBmb3IgdXNlIG9mIGJvb3RzdHJhcFxuLy8gaWYgYXBwIGlzIG5vdCBwcmVzZW50IHRvIGV4dHJhY3Qgc3RyaW5nLnhtbCBpdCBkZWxldGVzIHJlbW90ZSBzdHJpbmdzLmpzb25cbi8vIGlmIGFwcCBkb2VzIG5vdCBoYXZlIHN0cmluZ3MueG1sIHdlIHB1c2ggYW4gZW1wdHkganNvbiBvYmplY3QgdG8gcmVtb3RlXG5oZWxwZXJzLnB1c2hTdHJpbmdzID0gYXN5bmMgZnVuY3Rpb24gKGxhbmd1YWdlLCBhZGIsIG9wdHMpIHtcbiAgbGV0IHJlbW90ZVBhdGggPSAnL2RhdGEvbG9jYWwvdG1wJztcbiAgbGV0IHN0cmluZ3NKc29uID0gJ3N0cmluZ3MuanNvbic7XG4gIGxldCBzdHJpbmdzVG1wRGlyID0gcGF0aC5yZXNvbHZlKG9wdHMudG1wRGlyLCBvcHRzLmFwcFBhY2thZ2UpO1xuICB0cnkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRXh0cmFjdGluZyBzdHJpbmdzIGZyb20gYXBrJywgb3B0cy5hcHAsIGxhbmd1YWdlLCBzdHJpbmdzVG1wRGlyKTtcbiAgICBsZXQge2Fwa1N0cmluZ3MsIGxvY2FsUGF0aH0gPSBhd2FpdCBhZGIuZXh0cmFjdFN0cmluZ3NGcm9tQXBrKFxuICAgICAgICAgIG9wdHMuYXBwLCBsYW5ndWFnZSwgc3RyaW5nc1RtcERpcik7XG4gICAgYXdhaXQgYWRiLnB1c2gobG9jYWxQYXRoLCByZW1vdGVQYXRoKTtcbiAgICByZXR1cm4gYXBrU3RyaW5ncztcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKG9wdHMuYXBwKSkpIHtcbiAgICAgIC8vIGRlbGV0ZSByZW1vdGUgc3RyaW5nLmpzb24gaWYgcHJlc2VudFxuICAgICAgYXdhaXQgYWRiLnJpbXJhZihgJHtyZW1vdGVQYXRofS8ke3N0cmluZ3NKc29ufWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dnZXIud2FybihcIkNvdWxkIG5vdCBnZXQgc3RyaW5ncywgY29udGludWluZyBhbnl3YXlcIik7XG4gICAgICBsZXQgcmVtb3RlRmlsZSA9IGAke3JlbW90ZVBhdGh9LyR7c3RyaW5nc0pzb259YDtcbiAgICAgIGF3YWl0IGFkYi5zaGVsbCgnZWNobycsIFtgJ3t9JyA+ICR7cmVtb3RlRmlsZX1gXSk7XG4gICAgfVxuICB9XG4gIHJldHVybiB7fTtcbn07XG5cbmhlbHBlcnMudW5sb2NrID0gYXN5bmMgZnVuY3Rpb24gKGFkYikge1xuICBpZiAoIShhd2FpdCBhZGIuaXNTY3JlZW5Mb2NrZWQoKSkpIHtcbiAgICBsb2dnZXIuaW5mbyhcIlNjcmVlbiBhbHJlYWR5IHVubG9ja2VkLCBkb2luZyBub3RoaW5nXCIpO1xuICAgIHJldHVybjtcbiAgfVxuICBsb2dnZXIuaW5mbyhcIlVubG9ja2luZyBzY3JlZW5cIik7XG5cbiAgYXdhaXQgcmV0cnlJbnRlcnZhbCgxMCwgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIlNjcmVlbiBpcyBsb2NrZWQsIHRyeWluZyB0byB1bmxvY2tcIik7XG4gICAgYXdhaXQgYWRiLnN0YXJ0QXBwKHtcbiAgICAgIHBrZzogXCJpby5hcHBpdW0udW5sb2NrXCIsXG4gICAgICBhY3Rpdml0eTogXCIuVW5sb2NrXCIsXG4gICAgICBhY3Rpb246IFwiYW5kcm9pZC5pbnRlbnQuYWN0aW9uLk1BSU5cIixcbiAgICAgIGNhdGVnb3J5OiBcImFuZHJvaWQuaW50ZW50LmNhdGVnb3J5LkxBVU5DSEVSXCIsXG4gICAgICBmbGFnczogXCIweDEwMjAwMDAwXCJcbiAgICB9KTtcbiAgICBpZiAoIWF3YWl0IGFkYi5pc1NjcmVlbkxvY2tlZCgpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoXCJTY3JlZW4gdW5sb2NrZWQgc3VjY2Vzc2Z1bGx5XCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJTY3JlZW4gZGlkIG5vdCB1bmxvY2sgc3VjY2Vzc2Z1bGx5LCByZXRyeWluZ1wiKTtcbiAgICB9XG4gIH0pO1xufTtcblxuaGVscGVycy5pbml0RGV2aWNlID0gYXN5bmMgZnVuY3Rpb24gKGFkYiwgb3B0cykge1xuICBpZiAob3B0cy5hdmQpIHtcbiAgICBhd2FpdCBoZWxwZXJzLnByZXBhcmVFbXVsYXRvcihhZGIsIG9wdHMpO1xuICB9XG5cbiAgYXdhaXQgYWRiLndhaXRGb3JEZXZpY2UoKTtcblxuICBhd2FpdCBoZWxwZXJzLmVuc3VyZURldmljZUxvY2FsZShhZGIsIG9wdHMubGFuZ3VhZ2UsIG9wdHMubG9jYWxlKTtcbiAgYXdhaXQgYWRiLnN0YXJ0TG9nY2F0KCk7XG4gIGxldCBkZWZhdWx0SU1FO1xuICBpZiAob3B0cy51bmljb2RlS2V5Ym9hcmQpIHtcbiAgICBkZWZhdWx0SU1FID0gYXdhaXQgaGVscGVycy5pbml0VW5pY29kZUtleWJvYXJkKGFkYik7XG4gIH1cbiAgYXdhaXQgaGVscGVycy5wdXNoU2V0dGluZ3NBcHAoYWRiKTtcbiAgYXdhaXQgaGVscGVycy5wdXNoVW5sb2NrKGFkYik7XG4gIHJldHVybiBkZWZhdWx0SU1FO1xufTtcblxuaGVscGVycy5yZW1vdmVOdWxsUHJvcGVydGllcyA9IGZ1bmN0aW9uIChvYmopIHtcbiAgZm9yIChsZXQga2V5IG9mIF8ua2V5cyhvYmopKSB7XG4gICAgaWYgKF8uaXNOdWxsKG9ialtrZXldKSB8fCBfLmlzVW5kZWZpbmVkKG9ialtrZXldKSkge1xuICAgICAgZGVsZXRlIG9ialtrZXldO1xuICAgIH1cbiAgfVxufTtcblxuaGVscGVycy50cnVuY2F0ZURlY2ltYWxzID0gZnVuY3Rpb24gKG51bWJlciwgZGlnaXRzKSB7XG4gIGxldCBtdWx0aXBsaWVyID0gTWF0aC5wb3coMTAsIGRpZ2l0cyksXG4gICAgICBhZGp1c3RlZE51bSA9IG51bWJlciAqIG11bHRpcGxpZXIsXG4gICAgICB0cnVuY2F0ZWROdW0gPSBNYXRoW2FkanVzdGVkTnVtIDwgMCA/ICdjZWlsJyA6ICdmbG9vciddKGFkanVzdGVkTnVtKTtcblxuICByZXR1cm4gdHJ1bmNhdGVkTnVtIC8gbXVsdGlwbGllcjtcbn07XG5cbmhlbHBlcnMuaXNDaHJvbWVCcm93c2VyID0gZnVuY3Rpb24gKGJyb3dzZXIpIHtcbiAgcmV0dXJuIF8uY29udGFpbnMoQ0hST01FX0JST1dTRVJTLCBicm93c2VyKTtcbn07XG5cbmhlbHBlcnMuZ2V0Q2hyb21lUGtnID0gZnVuY3Rpb24gKGJyb3dzZXIpIHtcbiAgbGV0IHBrZywgYWN0O1xuXG4gIGJyb3dzZXIgPSBicm93c2VyLnRvTG93ZXJDYXNlKCk7XG4gIGlmIChicm93c2VyID09PSBcImNocm9taXVtXCIpIHtcbiAgICBwa2cgPSBcIm9yZy5jaHJvbWl1bS5jaHJvbWUuc2hlbGxcIjtcbiAgICBhY3QgPSBcIi5DaHJvbWVTaGVsbEFjdGl2aXR5XCI7XG4gIH0gZWxzZSBpZiAoYnJvd3NlciA9PT0gXCJjaHJvbWViZXRhXCIpIHtcbiAgICBwa2cgPSBcImNvbS5jaHJvbWUuYmV0YVwiO1xuICAgIGFjdCA9IFwiY29tLmdvb2dsZS5hbmRyb2lkLmFwcHMuY2hyb21lLk1haW5cIjtcbiAgfSBlbHNlIGlmIChicm93c2VyID09PSBcImJyb3dzZXJcIikge1xuICAgIHBrZyA9IFwiY29tLmFuZHJvaWQuYnJvd3NlclwiO1xuICAgIGFjdCA9IFwiY29tLmFuZHJvaWQuYnJvd3Nlci5Ccm93c2VyQWN0aXZpdHlcIjtcbiAgfSBlbHNlIHtcbiAgICBwa2cgPSBcImNvbS5hbmRyb2lkLmNocm9tZVwiO1xuICAgIGFjdCA9IFwiY29tLmdvb2dsZS5hbmRyb2lkLmFwcHMuY2hyb21lLk1haW5cIjtcbiAgfVxuICByZXR1cm4ge3BrZywgYWN0aXZpdHk6IGFjdH07XG59O1xuXG5oZWxwZXJzLmJvb3RzdHJhcCA9IEJvb3RzdHJhcDtcblxuZXhwb3J0IGRlZmF1bHQgaGVscGVycztcbmV4cG9ydCB7IENIUk9NRV9CUk9XU0VSUyB9O1xuIl19