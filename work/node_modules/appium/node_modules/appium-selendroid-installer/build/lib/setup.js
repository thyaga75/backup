'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var SE_VER = "0.17.0";
var SE_DOWNLOAD = 'https://github.com/selendroid/selendroid/releases/' + ('download/' + SE_VER + '/selendroid-standalone-' + SE_VER + '-with') + '-dependencies.jar';
var SE_DOWNLOAD_MD5 = "5e1f7de5e4d2eb77b68675d76c5edf6a";
var SE_DIR = _path2['default'].resolve(__dirname, "..", "..", "selendroid");
var SE_DOWNLOAD_DIR = _path2['default'].resolve(SE_DIR, "download");
var SE_JAR_PATH = _path2['default'].resolve(SE_DOWNLOAD_DIR, "selendroid-server.jar");
var SE_APK_PATH = _path2['default'].resolve(SE_DIR, "selendroid-server.apk");
var SE_MANIFEST_PATH = _path2['default'].resolve(SE_DIR, "AndroidManifest.xml");

function setupSelendroid() {
  var manifestPath, serverPath, extractedManifestPath, extractedServerPath;
  return _regeneratorRuntime.async(function setupSelendroid$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_JAR_PATH));

      case 2:
        context$1$0.t0 = context$1$0.sent;

        if (!context$1$0.t0) {
          context$1$0.next = 9;
          break;
        }

        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.md5(SE_JAR_PATH));

      case 6:
        context$1$0.t1 = context$1$0.sent;
        context$1$0.t2 = SE_DOWNLOAD_MD5;
        context$1$0.t0 = context$1$0.t1 === context$1$0.t2;

      case 9:
        if (!context$1$0.t0) {
          context$1$0.next = 13;
          break;
        }

        _logger2['default'].info("Standalone jar exists and has correct hash, skipping download");
        context$1$0.next = 15;
        break;

      case 13:
        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(downloadSelendroid());

      case 15:
        _logger2['default'].info('Determining AndroidManifest location');
        context$1$0.next = 18;
        return _regeneratorRuntime.awrap(getFilePathFromJar(/AndroidManifest.*\.xml$/, SE_JAR_PATH));

      case 18:
        manifestPath = context$1$0.sent;

        _logger2['default'].info('Determining server apk location');
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(getFilePathFromJar(/selendroid-server.*\.apk$/, SE_JAR_PATH));

      case 22:
        serverPath = context$1$0.sent;

        _logger2['default'].info('Extracting manifest and apk to ' + SE_DOWNLOAD_DIR);
        context$1$0.next = 26;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('jar', ['xf', SE_JAR_PATH, manifestPath, serverPath], {
          cwd: SE_DOWNLOAD_DIR
        }));

      case 26:
        _logger2['default'].info('Copying manifest and apk to ' + SE_DIR);
        extractedManifestPath = _path2['default'].resolve(SE_DOWNLOAD_DIR, manifestPath);
        extractedServerPath = _path2['default'].resolve(SE_DOWNLOAD_DIR, serverPath);
        context$1$0.next = 31;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(extractedManifestPath, SE_MANIFEST_PATH));

      case 31:
        context$1$0.next = 33;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(extractedServerPath, SE_APK_PATH));

      case 33:
        _logger2['default'].info("Cleaning up temp files");
        context$1$0.next = 36;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(extractedManifestPath));

      case 36:
        context$1$0.next = 38;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(extractedServerPath));

      case 38:
        _logger2['default'].info('Fixing AndroidManifest icon bug');
        context$1$0.next = 41;
        return _regeneratorRuntime.awrap(fixManifestIcons(SE_MANIFEST_PATH));

      case 41:
        context$1$0.next = 43;
        return _regeneratorRuntime.awrap(serverExists());

      case 43:
        if (context$1$0.sent) {
          context$1$0.next = 45;
          break;
        }

        throw new Error("Something went wrong in setting up selendroid");

      case 45:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function downloadSelendroid() {
  var body;
  return _regeneratorRuntime.async(function downloadSelendroid$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info('Ensuring ' + SE_DOWNLOAD_DIR + ' exists');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(SE_DIR));

      case 3:
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(SE_DOWNLOAD_DIR));

      case 5:
        _logger2['default'].info('Downloading Selendroid standalone server version ' + SE_VER + ' from ' + (SE_DOWNLOAD + ' --> ' + SE_JAR_PATH));
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: SE_DOWNLOAD, encoding: 'binary' }));

      case 8:
        body = context$1$0.sent;

        _logger2['default'].info('Writing binary content to ' + SE_JAR_PATH);
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(SE_JAR_PATH, body, { encoding: 'binary' }));

      case 12:
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.chmod(SE_JAR_PATH, 420));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.md5(SE_JAR_PATH));

      case 16:
        context$1$0.t0 = context$1$0.sent;
        context$1$0.t1 = SE_DOWNLOAD_MD5;

        if (!(context$1$0.t0 === context$1$0.t1)) {
          context$1$0.next = 22;
          break;
        }

        _logger2['default'].info("Selendroid standalone server downloaded");
        context$1$0.next = 23;
        break;

      case 22:
        _logger2['default'].warn("Selendroid standalone server downloaded, but MD5 hash did not " + "match, please be careful");

      case 23:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getFilePathFromJar(fileRegex, jarPath) {
  var _ref, stdout, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, line;

  return _regeneratorRuntime.async(function getFilePathFromJar$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('jar', ['tf', jarPath]));

      case 2:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 7;
        _iterator = _getIterator(stdout.split("\n"));

      case 9:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 16;
          break;
        }

        line = _step.value;

        if (!fileRegex.test(line.trim())) {
          context$1$0.next = 13;
          break;
        }

        return context$1$0.abrupt('return', line.trim());

      case 13:
        _iteratorNormalCompletion = true;
        context$1$0.next = 9;
        break;

      case 16:
        context$1$0.next = 22;
        break;

      case 18:
        context$1$0.prev = 18;
        context$1$0.t0 = context$1$0['catch'](7);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 22:
        context$1$0.prev = 22;
        context$1$0.prev = 23;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 25:
        context$1$0.prev = 25;

        if (!_didIteratorError) {
          context$1$0.next = 28;
          break;
        }

        throw _iteratorError;

      case 28:
        return context$1$0.finish(25);

      case 29:
        return context$1$0.finish(22);

      case 30:
        throw new Error('Could not find ' + fileRegex + ' in ' + jarPath);

      case 31:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[7, 18, 22, 30], [23,, 25, 29]]);
}

function serverExists() {
  return _regeneratorRuntime.async(function serverExists$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.prev = 0;
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_APK_PATH));

      case 3:
        context$1$0.t0 = context$1$0.sent;

        if (!context$1$0.t0) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(SE_MANIFEST_PATH));

      case 7:
        context$1$0.t0 = context$1$0.sent;

      case 8:
        return context$1$0.abrupt('return', context$1$0.t0);

      case 11:
        context$1$0.prev = 11;
        context$1$0.t1 = context$1$0['catch'](0);

        if (!(context$1$0.t1.code.indexOf("ENOENT") !== -1)) {
          context$1$0.next = 15;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 15:
        throw context$1$0.t1;

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[0, 11]]);
}

function fixManifestIcons(manifest) {
  var curData, iconRe, newData;
  return _regeneratorRuntime.async(function fixManifestIcons$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(manifest));

      case 2:
        curData = context$1$0.sent.toString('utf8');
        iconRe = /application[\s\S]+android:icon="[^"]+"/;
        newData = curData.replace(iconRe, "application");
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(manifest, newData));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.setupSelendroid = setupSelendroid;
exports.serverExists = serverExists;
exports.SE_APK_PATH = SE_APK_PATH;
exports.SE_MANIFEST_PATH = SE_MANIFEST_PATH;
//# sourceMappingURL=data:application/json;base64,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Qzs7Ozs7Ozs7Ozs7eUNBQ3RCLGtCQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQzs7Ozs7Ozs7Ozs7O2NBRXJDLGVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQTs7Ozs7NENBQzFCLEtBQUs7Ozs7Ozs7Ozs7Q0FJakI7O0FBRUQsU0FBZSxnQkFBZ0IsQ0FBRSxRQUFRO01BQ25DLE9BQU8sRUFDUCxNQUFNLEVBQ04sT0FBTzs7Ozs7eUNBRlUsa0JBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQzs7O0FBQXRDLGVBQU8sb0JBQWlDLFFBQVEsQ0FBQyxNQUFNO0FBQ3ZELGNBQU0sR0FBRyx3Q0FBd0M7QUFDakQsZUFBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLGFBQWEsQ0FBQzs7eUNBQzlDLGtCQUFHLFNBQVMsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDOzs7Ozs7O0NBQ3RDOztRQUVRLGVBQWUsR0FBZixlQUFlO1FBQUUsWUFBWSxHQUFaLFlBQVk7UUFBRSxXQUFXLEdBQVgsV0FBVztRQUFFLGdCQUFnQixHQUFoQixnQkFBZ0IiLCJmaWxlIjoibGliL3NldHVwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuXG5jb25zdCBTRV9WRVIgPSBcIjAuMTcuMFwiO1xuY29uc3QgU0VfRE9XTkxPQUQgPSBgaHR0cHM6Ly9naXRodWIuY29tL3NlbGVuZHJvaWQvc2VsZW5kcm9pZC9yZWxlYXNlcy9gICtcbiAgICAgICAgICAgICAgICAgICAgYGRvd25sb2FkLyR7U0VfVkVSfS9zZWxlbmRyb2lkLXN0YW5kYWxvbmUtJHtTRV9WRVJ9LXdpdGhgICtcbiAgICAgICAgICAgICAgICAgICAgYC1kZXBlbmRlbmNpZXMuamFyYDtcbmNvbnN0IFNFX0RPV05MT0FEX01ENSA9IFwiNWUxZjdkZTVlNGQyZWI3N2I2ODY3NWQ3NmM1ZWRmNmFcIjtcbmNvbnN0IFNFX0RJUiA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsIFwiLi5cIiwgXCIuLlwiLCBcInNlbGVuZHJvaWRcIik7XG5jb25zdCBTRV9ET1dOTE9BRF9ESVIgPSBwYXRoLnJlc29sdmUoU0VfRElSLCBcImRvd25sb2FkXCIpO1xuY29uc3QgU0VfSkFSX1BBVEggPSBwYXRoLnJlc29sdmUoU0VfRE9XTkxPQURfRElSLCBcInNlbGVuZHJvaWQtc2VydmVyLmphclwiKTtcbmNvbnN0IFNFX0FQS19QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RJUiwgXCJzZWxlbmRyb2lkLXNlcnZlci5hcGtcIik7XG5jb25zdCBTRV9NQU5JRkVTVF9QQVRIID0gcGF0aC5yZXNvbHZlKFNFX0RJUiwgXCJBbmRyb2lkTWFuaWZlc3QueG1sXCIpO1xuXG5hc3luYyBmdW5jdGlvbiBzZXR1cFNlbGVuZHJvaWQgKCkge1xuICBpZiAoYXdhaXQgZnMuZXhpc3RzKFNFX0pBUl9QQVRIKSAmJlxuICAgICAgYXdhaXQgZnMubWQ1KFNFX0pBUl9QQVRIKSA9PT0gU0VfRE9XTkxPQURfTUQ1KSB7XG4gICAgbG9nLmluZm8oXCJTdGFuZGFsb25lIGphciBleGlzdHMgYW5kIGhhcyBjb3JyZWN0IGhhc2gsIHNraXBwaW5nIGRvd25sb2FkXCIpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IGRvd25sb2FkU2VsZW5kcm9pZCgpO1xuICB9XG4gIGxvZy5pbmZvKGBEZXRlcm1pbmluZyBBbmRyb2lkTWFuaWZlc3QgbG9jYXRpb25gKTtcbiAgbGV0IG1hbmlmZXN0UGF0aCA9IGF3YWl0IGdldEZpbGVQYXRoRnJvbUphcigvQW5kcm9pZE1hbmlmZXN0LipcXC54bWwkLyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTRV9KQVJfUEFUSCk7XG4gIGxvZy5pbmZvKGBEZXRlcm1pbmluZyBzZXJ2ZXIgYXBrIGxvY2F0aW9uYCk7XG4gIGxldCBzZXJ2ZXJQYXRoID0gYXdhaXQgZ2V0RmlsZVBhdGhGcm9tSmFyKC9zZWxlbmRyb2lkLXNlcnZlci4qXFwuYXBrJC8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNFX0pBUl9QQVRIKTtcbiAgbG9nLmluZm8oYEV4dHJhY3RpbmcgbWFuaWZlc3QgYW5kIGFwayB0byAke1NFX0RPV05MT0FEX0RJUn1gKTtcbiAgYXdhaXQgZXhlYygnamFyJywgWyd4ZicsIFNFX0pBUl9QQVRILCBtYW5pZmVzdFBhdGgsIHNlcnZlclBhdGhdLCB7XG4gICAgY3dkOiBTRV9ET1dOTE9BRF9ESVJcbiAgfSk7XG4gIGxvZy5pbmZvKGBDb3B5aW5nIG1hbmlmZXN0IGFuZCBhcGsgdG8gJHtTRV9ESVJ9YCk7XG4gIGxldCBleHRyYWN0ZWRNYW5pZmVzdFBhdGggPSBwYXRoLnJlc29sdmUoU0VfRE9XTkxPQURfRElSLCBtYW5pZmVzdFBhdGgpO1xuICBsZXQgZXh0cmFjdGVkU2VydmVyUGF0aCA9IHBhdGgucmVzb2x2ZShTRV9ET1dOTE9BRF9ESVIsIHNlcnZlclBhdGgpO1xuICBhd2FpdCBmcy5jb3B5RmlsZShleHRyYWN0ZWRNYW5pZmVzdFBhdGgsIFNFX01BTklGRVNUX1BBVEgpO1xuICBhd2FpdCBmcy5jb3B5RmlsZShleHRyYWN0ZWRTZXJ2ZXJQYXRoLCBTRV9BUEtfUEFUSCk7XG4gIGxvZy5pbmZvKFwiQ2xlYW5pbmcgdXAgdGVtcCBmaWxlc1wiKTtcbiAgYXdhaXQgZnMucmltcmFmKGV4dHJhY3RlZE1hbmlmZXN0UGF0aCk7XG4gIGF3YWl0IGZzLnJpbXJhZihleHRyYWN0ZWRTZXJ2ZXJQYXRoKTtcbiAgbG9nLmluZm8oYEZpeGluZyBBbmRyb2lkTWFuaWZlc3QgaWNvbiBidWdgKTtcbiAgYXdhaXQgZml4TWFuaWZlc3RJY29ucyhTRV9NQU5JRkVTVF9QQVRIKTtcbiAgaWYgKCEoYXdhaXQgc2VydmVyRXhpc3RzKCkpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiU29tZXRoaW5nIHdlbnQgd3JvbmcgaW4gc2V0dGluZyB1cCBzZWxlbmRyb2lkXCIpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRvd25sb2FkU2VsZW5kcm9pZCAoKSB7XG4gIGxvZy5pbmZvKGBFbnN1cmluZyAke1NFX0RPV05MT0FEX0RJUn0gZXhpc3RzYCk7XG4gIGF3YWl0IGZzLm1rZGlyKFNFX0RJUik7XG4gIGF3YWl0IGZzLm1rZGlyKFNFX0RPV05MT0FEX0RJUik7XG4gIGxvZy5pbmZvKGBEb3dubG9hZGluZyBTZWxlbmRyb2lkIHN0YW5kYWxvbmUgc2VydmVyIHZlcnNpb24gJHtTRV9WRVJ9IGZyb20gYCArXG4gICAgICAgICAgIGAke1NFX0RPV05MT0FEfSAtLT4gJHtTRV9KQVJfUEFUSH1gKTtcbiAgbGV0IGJvZHkgPSBhd2FpdCByZXF1ZXN0LmdldCh7dXJsOiBTRV9ET1dOTE9BRCwgZW5jb2Rpbmc6ICdiaW5hcnknfSk7XG4gIGxvZy5pbmZvKGBXcml0aW5nIGJpbmFyeSBjb250ZW50IHRvICR7U0VfSkFSX1BBVEh9YCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZShTRV9KQVJfUEFUSCwgYm9keSwge2VuY29kaW5nOiAnYmluYXJ5J30pO1xuICBhd2FpdCBmcy5jaG1vZChTRV9KQVJfUEFUSCwgMG8wNjQ0KTtcbiAgaWYgKGF3YWl0IGZzLm1kNShTRV9KQVJfUEFUSCkgPT09IFNFX0RPV05MT0FEX01ENSkge1xuICAgIGxvZy5pbmZvKFwiU2VsZW5kcm9pZCBzdGFuZGFsb25lIHNlcnZlciBkb3dubG9hZGVkXCIpO1xuICB9IGVsc2Uge1xuICAgIGxvZy53YXJuKFwiU2VsZW5kcm9pZCBzdGFuZGFsb25lIHNlcnZlciBkb3dubG9hZGVkLCBidXQgTUQ1IGhhc2ggZGlkIG5vdCBcIiArXG4gICAgICAgICAgICAgXCJtYXRjaCwgcGxlYXNlIGJlIGNhcmVmdWxcIik7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RmlsZVBhdGhGcm9tSmFyIChmaWxlUmVnZXgsIGphclBhdGgpIHtcbiAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnamFyJywgWyd0ZicsIGphclBhdGhdKTtcbiAgZm9yIChsZXQgbGluZSBvZiBzdGRvdXQuc3BsaXQoXCJcXG5cIikpIHtcbiAgICBpZiAoZmlsZVJlZ2V4LnRlc3QobGluZS50cmltKCkpKSB7XG4gICAgICByZXR1cm4gbGluZS50cmltKCk7XG4gICAgfVxuICB9XG4gIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgJHtmaWxlUmVnZXh9IGluICR7amFyUGF0aH1gKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VydmVyRXhpc3RzICgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gKGF3YWl0IGZzLmV4aXN0cyhTRV9BUEtfUEFUSCkgJiZcbiAgICAgICAgICAgIGF3YWl0IGZzLmV4aXN0cyhTRV9NQU5JRkVTVF9QQVRIKSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZS5jb2RlLmluZGV4T2YoXCJFTk9FTlRcIikgIT09IC0xKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4TWFuaWZlc3RJY29ucyAobWFuaWZlc3QpIHtcbiAgbGV0IGN1ckRhdGEgPSAoYXdhaXQgZnMucmVhZEZpbGUobWFuaWZlc3QpKS50b1N0cmluZygndXRmOCcpO1xuICBsZXQgaWNvblJlID0gL2FwcGxpY2F0aW9uW1xcc1xcU10rYW5kcm9pZDppY29uPVwiW15cIl0rXCIvO1xuICBsZXQgbmV3RGF0YSA9IGN1ckRhdGEucmVwbGFjZShpY29uUmUsIFwiYXBwbGljYXRpb25cIik7XG4gIGF3YWl0IGZzLndyaXRlRmlsZShtYW5pZmVzdCwgbmV3RGF0YSk7XG59XG5cbmV4cG9ydCB7IHNldHVwU2VsZW5kcm9pZCwgc2VydmVyRXhpc3RzLCBTRV9BUEtfUEFUSCwgU0VfTUFOSUZFU1RfUEFUSCB9O1xuIl19