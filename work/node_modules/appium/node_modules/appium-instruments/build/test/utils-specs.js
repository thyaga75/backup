require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Promise = require('babel-runtime/core-js/promise')['default'];

var _interopRequireWildcard = require('babel-runtime/helpers/interop-require-wildcard')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _ = require('..');

var _teen_process = require('teen_process');

var tp = _interopRequireWildcard(_teen_process);

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _appiumTestSupport = require('appium-test-support');

var _appiumSupport = require('appium-support');

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('utils', function () {
  describe('getInstrumentsPath', (0, _appiumTestSupport.withMocks)({ tp: tp }, function (mocks) {
    it('should retrieve path', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            mocks.tp.expects('exec').once().returns(_Promise.resolve({ stdout: '/a/b/c/d\n', stderr: '' }));
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(_.utils.getInstrumentsPath());

          case 3:
            context$3$0.sent.should.equal('/a/b/c/d');

            (0, _appiumTestSupport.verify)(mocks);

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should throw an error if cannnot find Instruments', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            mocks.tp.expects('exec').once().throws(new Error('Instruments not found'));
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(_.utils.getInstrumentsPath().should.be.rejectedWith(/Could not find the instruments binary/));

          case 3:
            (0, _appiumTestSupport.verify)(mocks);

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  }));
  describe('getAvailableDevices', (0, _appiumTestSupport.withMocks)({ tp: tp }, function (mocks) {
    it('should work', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            mocks.tp.expects('exec').once().returns(_Promise.resolve({ stdout: '/a/b/c/d\n', stderr: '' }));
            mocks.tp.expects('exec').once().returns(_Promise.resolve({ stdout: 'iphone1\niphone2\niphone3', stderr: '' }));
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(_.utils.getAvailableDevices());

          case 4:
            context$3$0.t0 = ['iphone1', 'iphone2', 'iphone3'];
            context$3$0.sent.should.deep.equal(context$3$0.t0);

            (0, _appiumTestSupport.verify)(mocks);

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should throw an error when Instruments fails', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            mocks.tp.expects('exec').once().returns(_Promise.resolve({ stdout: '/a/b/c/d\n', stderr: '' }));
            mocks.tp.expects('exec').once().throws(new Error('Instruments failed'));
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(_.utils.getAvailableDevices().should.be.rejectedWith(/Failed getting devices, err: Error: Instruments failed./));

          case 4:
            (0, _appiumTestSupport.verify)(mocks);

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  }));
  describe('killAllInstruments', (0, _appiumTestSupport.withMocks)({ tp: tp }, function (mocks) {
    it('should work', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            mocks.tp.expects('exec').once().returns(_Promise.resolve({ stdout: '', stderr: '' }));
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(_.utils.killAllInstruments());

          case 3:
            (0, _appiumTestSupport.verify)(mocks);

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  }));
  describe('cleanAllTraces', (0, _appiumTestSupport.withMocks)({ fs: _appiumSupport.fs }, function (mocks) {
    (0, _appiumTestSupport.stubEnv)();
    it('should work', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            process.env.CLEAN_TRACES = 1;
            mocks.fs.expects('rimraf').once().returns(_Promise.resolve({ stdout: '', stderr: '' }));
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(_.utils.cleanAllTraces());

          case 4:
            (0, _appiumTestSupport.verify)(mocks);

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  }));
  describe('parseLaunchTimeout', function () {
    (0, _appiumTestSupport.stubEnv)();
    it('should work', function () {
      _.utils.parseLaunchTimeout(90000).should.deep.equal({
        global: 90000 });
      _.utils.parseLaunchTimeout('90000').should.deep.equal({
        global: 90000 });
      _.utils.parseLaunchTimeout({ global: 90000, afterLaunch: 30000 }).should.deep.equal({
        global: 90000, afterLaunch: 30000 });
      _.utils.parseLaunchTimeout('{"global": 90000, "afterLaunch": 30000}').should.deep.equal({
        global: 90000, afterLaunch: 30000 });
    });
    it('should work with invalid JSON', function () {
      _.utils.parseLaunchTimeout('x').should.equal('x');
    });
  });
  describe('getIwdPath', (0, _appiumTestSupport.withMocks)({ fs: _appiumSupport.fs }, function (mocks) {
    it('should work when path is found', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            mocks.fs.expects('exists').once().returns(_Promise.resolve(true));
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(_.utils.getIwdPath('10'));

          case 3:
            context$3$0.sent.should.match(/.*thirdparty\/iwd10/);

            (0, _appiumTestSupport.verify)(mocks);

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should work when path is not found', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            mocks.fs.expects('exists').once().returns(_Promise.resolve(false));
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(_.utils.getIwdPath('10'));

          case 3:
            context$3$0.sent.should.match(/.*thirdparty\/iwd/);

            (0, _appiumTestSupport.verify)(mocks);

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  }));

  describe('quickLaunch', (0, _appiumTestSupport.withMocks)({ fs: _appiumSupport.fs, tp: tp }, function (mocks) {
    it('should remove trace directory', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            mocks.fs.expects('rimraf').once().returns(_Promise.resolve());
            mocks.tp.expects('exec').once().withArgs('xcrun').returns(_Promise.resolve({ stdout: '', stderr: '' }));
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(_.utils.quickLaunch());

          case 4:
            (0, _appiumTestSupport.verify)(mocks);

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  }));

  describe('quickInstruments', (0, _appiumTestSupport.withMocks)({ xcode: _appiumXcode2['default'] }, function (mocks) {
    it('should create an Instruments object', function callee$2$0() {
      var inst;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(_.utils.quickInstruments({
              xcodeTraceTemplatePath: '/some/path'
            }));

          case 2:
            inst = context$3$0.sent;

            inst.should.be.an['instanceof'](_.Instruments);

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should get xcode trace template if none supplied', function callee$2$0() {
      var inst;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            mocks.xcode.expects('getAutomationTraceTemplatePath').once().returns(_Promise.resolve('/some/path'));
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(_.utils.quickInstruments());

          case 3:
            inst = context$3$0.sent;

            inst.template.should.equal('/some/path');

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  }));
});
//# sourceMappingURL=data:application/json;base64,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QUFDOzs7Ozs7O0tBQ2YsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDLENBQUM7O0FBRUosVUFBUSxDQUFDLGtCQUFrQixFQUFFLGtDQUFVLEVBQUMsS0FBSywwQkFBQSxFQUFDLEVBQUUsVUFBQyxLQUFLLEVBQUs7QUFDekQsTUFBRSxDQUFDLHFDQUFxQyxFQUFFO1VBQ3BDLElBQUk7Ozs7OzZDQUFTLFFBQU0sZ0JBQWdCLENBQUM7QUFDdEMsb0NBQXNCLEVBQUUsWUFBWTthQUNyQyxDQUFDOzs7QUFGRSxnQkFBSTs7QUFHUixnQkFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBRSxjQUFXLGVBQWEsQ0FBQzs7Ozs7OztLQUMzQyxDQUFDLENBQUM7O0FBRUgsTUFBRSxDQUFDLGtEQUFrRCxFQUFFO1VBS2pELElBQUk7Ozs7QUFKUixpQkFBSyxDQUFDLEtBQUssQ0FDUixPQUFPLENBQUMsZ0NBQWdDLENBQUMsQ0FDekMsSUFBSSxFQUFFLENBQ04sT0FBTyxDQUFDLFNBQVEsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7OzZDQUN6QixRQUFNLGdCQUFnQixFQUFFOzs7QUFBckMsZ0JBQUk7O0FBQ1IsZ0JBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQzs7Ozs7OztLQUMxQyxDQUFDLENBQUM7R0FDSixDQUFDLENBQUMsQ0FBQztDQUNMLENBQUMsQ0FBQyIsImZpbGUiOiJ0ZXN0L3V0aWxzLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHJhbnNwaWxlOm1vY2hhXG5cbmltcG9ydCB7IHV0aWxzLCBJbnN0cnVtZW50cyB9IGZyb20gJy4uJztcbmltcG9ydCAqIGFzIHRwIGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IHsgd2l0aE1vY2tzLCB2ZXJpZnksIHN0dWJFbnYgfSBmcm9tICdhcHBpdW0tdGVzdC1zdXBwb3J0JztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuXG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmRlc2NyaWJlKCd1dGlscycsICgpID0+IHtcbiAgZGVzY3JpYmUoJ2dldEluc3RydW1lbnRzUGF0aCcsIHdpdGhNb2Nrcyh7dHB9LCAobW9ja3MpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHJpZXZlIHBhdGgnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2Nrcy50cFxuICAgICAgICAuZXhwZWN0cygnZXhlYycpXG4gICAgICAgIC5vbmNlKClcbiAgICAgICAgLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKHtzdGRvdXQ6ICcvYS9iL2MvZFxcbicsIHN0ZGVycjonJyB9KSk7XG4gICAgICAoYXdhaXQgdXRpbHMuZ2V0SW5zdHJ1bWVudHNQYXRoKCkpLnNob3VsZC5lcXVhbCgnL2EvYi9jL2QnKTtcbiAgICAgIHZlcmlmeShtb2Nrcyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBhbiBlcnJvciBpZiBjYW5ubm90IGZpbmQgSW5zdHJ1bWVudHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2Nrcy50cFxuICAgICAgICAuZXhwZWN0cygnZXhlYycpXG4gICAgICAgIC5vbmNlKClcbiAgICAgICAgLnRocm93cyhuZXcgRXJyb3IoJ0luc3RydW1lbnRzIG5vdCBmb3VuZCcpKTtcbiAgICAgIGF3YWl0IHV0aWxzLmdldEluc3RydW1lbnRzUGF0aCgpLnNob3VsZC5iZS5yZWplY3RlZFdpdGgoL0NvdWxkIG5vdCBmaW5kIHRoZSBpbnN0cnVtZW50cyBiaW5hcnkvKTtcbiAgICAgIHZlcmlmeShtb2Nrcyk7XG4gICAgfSk7XG4gIH0pKTtcbiAgZGVzY3JpYmUoJ2dldEF2YWlsYWJsZURldmljZXMnLCB3aXRoTW9ja3Moe3RwfSwgKG1vY2tzKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCB3b3JrJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja3MudHBcbiAgICAgICAgLmV4cGVjdHMoJ2V4ZWMnKVxuICAgICAgICAub25jZSgpXG4gICAgICAgIC5yZXR1cm5zKFByb21pc2UucmVzb2x2ZSh7c3Rkb3V0OiAnL2EvYi9jL2RcXG4nLCBzdGRlcnI6JycgfSkpO1xuICAgICAgbW9ja3MudHBcbiAgICAgICAgLmV4cGVjdHMoJ2V4ZWMnKVxuICAgICAgICAub25jZSgpXG4gICAgICAgIC5yZXR1cm5zKFByb21pc2UucmVzb2x2ZSh7c3Rkb3V0OiAnaXBob25lMVxcbmlwaG9uZTJcXG5pcGhvbmUzJywgc3RkZXJyOicnIH0pKTtcbiAgICAgIChhd2FpdCB1dGlscy5nZXRBdmFpbGFibGVEZXZpY2VzKCkpLnNob3VsZC5kZWVwLmVxdWFsKFxuICAgICAgICBbJ2lwaG9uZTEnLCAnaXBob25lMicsICdpcGhvbmUzJ10pO1xuICAgICAgdmVyaWZ5KG1vY2tzKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIHdoZW4gSW5zdHJ1bWVudHMgZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2Nrcy50cFxuICAgICAgICAuZXhwZWN0cygnZXhlYycpXG4gICAgICAgIC5vbmNlKClcbiAgICAgICAgLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKHtzdGRvdXQ6ICcvYS9iL2MvZFxcbicsIHN0ZGVycjonJyB9KSk7XG4gICAgICBtb2Nrcy50cFxuICAgICAgICAuZXhwZWN0cygnZXhlYycpXG4gICAgICAgIC5vbmNlKClcbiAgICAgICAgLnRocm93cyhuZXcgRXJyb3IoJ0luc3RydW1lbnRzIGZhaWxlZCcpKTtcbiAgICAgIGF3YWl0IHV0aWxzLmdldEF2YWlsYWJsZURldmljZXMoKS5zaG91bGQuYmUucmVqZWN0ZWRXaXRoKC9GYWlsZWQgZ2V0dGluZyBkZXZpY2VzLCBlcnI6IEVycm9yOiBJbnN0cnVtZW50cyBmYWlsZWQuLyk7XG4gICAgICB2ZXJpZnkobW9ja3MpO1xuICAgIH0pO1xuICB9KSk7XG4gIGRlc2NyaWJlKCdraWxsQWxsSW5zdHJ1bWVudHMnLCB3aXRoTW9ja3Moe3RwfSwgKG1vY2tzKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCB3b3JrJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja3MudHBcbiAgICAgICAgLmV4cGVjdHMoJ2V4ZWMnKVxuICAgICAgICAub25jZSgpXG4gICAgICAgIC5yZXR1cm5zKFByb21pc2UucmVzb2x2ZSh7c3Rkb3V0OiAnJywgc3RkZXJyOicnIH0pKTtcbiAgICAgIGF3YWl0IHV0aWxzLmtpbGxBbGxJbnN0cnVtZW50cygpO1xuICAgICAgdmVyaWZ5KG1vY2tzKTtcbiAgICB9KTtcbiAgfSkpO1xuICBkZXNjcmliZSgnY2xlYW5BbGxUcmFjZXMnLCB3aXRoTW9ja3Moe2ZzfSwgKG1vY2tzKSA9PiB7XG4gICAgc3R1YkVudigpO1xuICAgIGl0KCdzaG91bGQgd29yaycsIGFzeW5jICgpID0+IHtcbiAgICAgIHByb2Nlc3MuZW52LkNMRUFOX1RSQUNFUyA9IDE7XG4gICAgICBtb2Nrcy5mc1xuICAgICAgICAuZXhwZWN0cygncmltcmFmJylcbiAgICAgICAgLm9uY2UoKVxuICAgICAgICAucmV0dXJucyhQcm9taXNlLnJlc29sdmUoe3N0ZG91dDogJycsIHN0ZGVycjonJyB9KSk7XG4gICAgICBhd2FpdCB1dGlscy5jbGVhbkFsbFRyYWNlcygpO1xuICAgICAgdmVyaWZ5KG1vY2tzKTtcbiAgICB9KTtcbiAgfSkpO1xuICBkZXNjcmliZSgncGFyc2VMYXVuY2hUaW1lb3V0JywgKCkgPT4ge1xuICAgIHN0dWJFbnYoKTtcbiAgICBpdCgnc2hvdWxkIHdvcmsnLCAoKSA9PiB7XG4gICAgICB1dGlscy5wYXJzZUxhdW5jaFRpbWVvdXQoOTAwMDApLnNob3VsZC5kZWVwLmVxdWFsKHtcbiAgICAgICAgZ2xvYmFsOiA5MDAwMCB9KTtcbiAgICAgIHV0aWxzLnBhcnNlTGF1bmNoVGltZW91dCgnOTAwMDAnKS5zaG91bGQuZGVlcC5lcXVhbCh7XG4gICAgICAgIGdsb2JhbDogOTAwMDAgfSk7XG4gICAgICB1dGlscy5wYXJzZUxhdW5jaFRpbWVvdXQoe2dsb2JhbDogOTAwMDAsIGFmdGVyTGF1bmNoOiAzMDAwMH0pLnNob3VsZC5kZWVwLmVxdWFsKHtcbiAgICAgICAgZ2xvYmFsOiA5MDAwMCwgYWZ0ZXJMYXVuY2g6IDMwMDAwIH0pO1xuICAgICAgdXRpbHMucGFyc2VMYXVuY2hUaW1lb3V0KCd7XCJnbG9iYWxcIjogOTAwMDAsIFwiYWZ0ZXJMYXVuY2hcIjogMzAwMDB9Jykuc2hvdWxkLmRlZXAuZXF1YWwoe1xuICAgICAgICBnbG9iYWw6IDkwMDAwLCBhZnRlckxhdW5jaDogMzAwMDAgfSk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCB3b3JrIHdpdGggaW52YWxpZCBKU09OJywgKCkgPT4ge1xuICAgICAgdXRpbHMucGFyc2VMYXVuY2hUaW1lb3V0KCd4Jykuc2hvdWxkLmVxdWFsKCd4Jyk7XG4gICAgfSk7XG4gIH0pO1xuICBkZXNjcmliZSgnZ2V0SXdkUGF0aCcsIHdpdGhNb2Nrcyh7ZnN9LCAobW9ja3MpID0+IHtcbiAgICBpdCgnc2hvdWxkIHdvcmsgd2hlbiBwYXRoIGlzIGZvdW5kJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja3MuZnNcbiAgICAgICAgLmV4cGVjdHMoJ2V4aXN0cycpXG4gICAgICAgIC5vbmNlKClcbiAgICAgICAgLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKHRydWUpKTtcbiAgICAgIChhd2FpdCB1dGlscy5nZXRJd2RQYXRoKCcxMCcpKS5zaG91bGQubWF0Y2goXG4gICAgICAgIC8uKnRoaXJkcGFydHlcXC9pd2QxMC8pO1xuICAgICAgdmVyaWZ5KG1vY2tzKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHdvcmsgd2hlbiBwYXRoIGlzIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tzLmZzXG4gICAgICAgIC5leHBlY3RzKCdleGlzdHMnKVxuICAgICAgICAub25jZSgpXG4gICAgICAgIC5yZXR1cm5zKFByb21pc2UucmVzb2x2ZShmYWxzZSkpO1xuICAgICAgKGF3YWl0IHV0aWxzLmdldEl3ZFBhdGgoJzEwJykpLnNob3VsZC5tYXRjaChcbiAgICAgICAgLy4qdGhpcmRwYXJ0eVxcL2l3ZC8pO1xuICAgICAgdmVyaWZ5KG1vY2tzKTtcbiAgICB9KTtcbiAgfSkpO1xuXG4gIGRlc2NyaWJlKCdxdWlja0xhdW5jaCcsIHdpdGhNb2Nrcyh7ZnMsIHRwfSwgKG1vY2tzKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZW1vdmUgdHJhY2UgZGlyZWN0b3J5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja3MuZnNcbiAgICAgICAgLmV4cGVjdHMoJ3JpbXJhZicpXG4gICAgICAgIC5vbmNlKClcbiAgICAgICAgLnJldHVybnMoUHJvbWlzZS5yZXNvbHZlKCkpO1xuICAgICAgbW9ja3MudHBcbiAgICAgICAgLmV4cGVjdHMoJ2V4ZWMnKVxuICAgICAgICAub25jZSgpXG4gICAgICAgIC53aXRoQXJncygneGNydW4nKVxuICAgICAgICAucmV0dXJucyhQcm9taXNlLnJlc29sdmUoe3N0ZG91dDogJycsIHN0ZGVycjonJyB9KSk7XG4gICAgICBhd2FpdCB1dGlscy5xdWlja0xhdW5jaCgpO1xuICAgICAgdmVyaWZ5KG1vY2tzKTtcbiAgICB9KTtcbiAgfSkpO1xuXG4gIGRlc2NyaWJlKCdxdWlja0luc3RydW1lbnRzJywgd2l0aE1vY2tzKHt4Y29kZX0sIChtb2NrcykgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIGFuIEluc3RydW1lbnRzIG9iamVjdCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBpbnN0ID0gYXdhaXQgdXRpbHMucXVpY2tJbnN0cnVtZW50cyh7XG4gICAgICAgIHhjb2RlVHJhY2VUZW1wbGF0ZVBhdGg6ICcvc29tZS9wYXRoJ1xuICAgICAgfSk7XG4gICAgICBpbnN0LnNob3VsZC5iZS5hbi5pbnN0YW5jZW9mKEluc3RydW1lbnRzKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZ2V0IHhjb2RlIHRyYWNlIHRlbXBsYXRlIGlmIG5vbmUgc3VwcGxpZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2Nrcy54Y29kZVxuICAgICAgICAuZXhwZWN0cygnZ2V0QXV0b21hdGlvblRyYWNlVGVtcGxhdGVQYXRoJylcbiAgICAgICAgLm9uY2UoKVxuICAgICAgICAucmV0dXJucyhQcm9taXNlLnJlc29sdmUoJy9zb21lL3BhdGgnKSk7XG4gICAgICBsZXQgaW5zdCA9IGF3YWl0IHV0aWxzLnF1aWNrSW5zdHJ1bWVudHMoKTtcbiAgICAgIGluc3QudGVtcGxhdGUuc2hvdWxkLmVxdWFsKCcvc29tZS9wYXRoJyk7XG4gICAgfSk7XG4gIH0pKTtcbn0pO1xuIl19