'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _teen_process = require('teen_process');

var _appiumSupport = require('appium-support');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _instruments = require('./instruments');

var _instruments2 = _interopRequireDefault(_instruments);

var rootDir = _path2['default'].resolve(__dirname, '../..');
var INST_STALL_TIMEOUT = 12000;

function getInstrumentsPath() {
  var instrumentsPath, _ref, stdout;

  return _regeneratorRuntime.async(function getInstrumentsPath$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        instrumentsPath = undefined;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['-find', 'instruments']));

      case 4:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;

        instrumentsPath = (stdout || '').trim().replace('\n$', '');
        context$1$0.next = 12;
        break;

      case 9:
        context$1$0.prev = 9;
        context$1$0.t0 = context$1$0['catch'](1);

        if (context$1$0.t0) _logger2['default'].error(context$1$0.t0.message);

      case 12:
        if (!instrumentsPath) {
          _logger2['default'].errorAndThrow('Could not find the instruments binary. Please ensure ' + '`xcrun -find instruments` can locate it.');
        }
        _logger2['default'].debug('Instruments is at: ' + instrumentsPath);
        return context$1$0.abrupt('return', instrumentsPath);

      case 15:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 9]]);
}

function getAvailableDevices() {
  var instrumentsPath, opts, lines, _ref2, stdout, devices;

  return _regeneratorRuntime.async(function getAvailableDevices$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Getting list of devices instruments supports');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(getInstrumentsPath());

      case 3:
        instrumentsPath = context$1$0.sent;
        opts = { timeout: INST_STALL_TIMEOUT };
        lines = undefined;
        context$1$0.prev = 6;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(instrumentsPath, ['-s', 'devices'], opts));

      case 9:
        _ref2 = context$1$0.sent;
        stdout = _ref2.stdout;

        lines = stdout.split('\n');
        context$1$0.next = 17;
        break;

      case 14:
        context$1$0.prev = 14;
        context$1$0.t0 = context$1$0['catch'](6);

        _logger2['default'].errorAndThrow('Failed getting devices, err: ' + context$1$0.t0 + '.');

      case 17:
        devices = lines.filter(function (line) {
          return (/^i.+$/.test(line)
          );
        });
        return context$1$0.abrupt('return', devices);

      case 19:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 14]]);
}

function killAllInstruments() {
  return _regeneratorRuntime.async(function killAllInstruments$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Killing all instruments');
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('pkill', ['-f', 'instruments']));

      case 4:
        context$1$0.next = 8;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](1);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 6]]);
}

function cleanAllTraces() {
  return _regeneratorRuntime.async(function cleanAllTraces$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!process.env.CLEAN_TRACES) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf('instrumentscli*.trace'));

      case 4:
        context$1$0.next = 8;
        break;

      case 6:
        context$1$0.prev = 6;
        context$1$0.t0 = context$1$0['catch'](1);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 6]]);
}

function parseLaunchTimeout(launchTimeout) {
  // number or object like { global: 40000, afterSimLaunch: 5000 }
  // may also parse JSON strings.
  if (_lodash2['default'].isString(launchTimeout)) {
    try {
      launchTimeout = JSON.parse(launchTimeout);
    } catch (err) {
      _logger2['default'].warn('Invalid launch timeout: ' + launchTimeout);
    }
  }
  if (_lodash2['default'].isNumber(launchTimeout)) {
    launchTimeout = {
      global: launchTimeout
    };
  }
  return launchTimeout;
}

function getIwdPath(xcodeMajorVersion) {
  var thirdpartyPath, iwdPath;
  return _regeneratorRuntime.async(function getIwdPath$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        thirdpartyPath = _path2['default'].resolve(rootDir, 'thirdparty');
        iwdPath = _path2['default'].resolve(thirdpartyPath, 'iwd' + xcodeMajorVersion);
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(iwdPath));

      case 4:
        if (context$1$0.sent) {
          context$1$0.next = 6;
          break;
        }

        iwdPath = _path2['default'].resolve(thirdpartyPath, 'iwd');

      case 6:
        _logger2['default'].debug('Found Insruments-Without-Delay: ' + iwdPath);
        return context$1$0.abrupt('return', iwdPath);

      case 8:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

// this function launches an instruments test with a default test
// that immediately passes. In this way we can start a simulator
// and be notified when it completely launches
function quickLaunch(udid) {
  var appPath = arguments.length <= 1 || arguments[1] === undefined ? _path2['default'].resolve(__dirname, '..', '..', 'assets', 'TestApp.app') : arguments[1];
  var traceTemplatePath, scriptPath, traceDocument, resultsPath, args;
  return _regeneratorRuntime.async(function quickLaunch$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getAutomationTraceTemplatePath());

      case 2:
        traceTemplatePath = context$1$0.sent;
        scriptPath = _path2['default'].resolve(__dirname, '..', '..', 'assets', 'blank_instruments_test.js');
        traceDocument = _path2['default'].resolve('/', 'tmp', 'testTrace.trace');
        resultsPath = _path2['default'].resolve('/', 'tmp');
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(traceDocument));

      case 8:
        args = ['instruments', '-D', traceDocument, '-t', traceTemplatePath, '-w', udid, appPath, '-e', 'UIASCRIPT', scriptPath, '-e', 'UIARESULTSPATH', resultsPath];

        _logger2['default'].debug('Running command: \'xcrun ' + args.join(' ') + '\'');
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', args));

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function quickInstruments() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var xcodeTraceTemplatePath;
  return _regeneratorRuntime.async(function quickInstruments$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        opts = _lodash2['default'].cloneDeep(opts);
        context$1$0.t0 = opts.xcodeTraceTemplatePath;

        if (context$1$0.t0) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumXcode2['default'].getAutomationTraceTemplatePath());

      case 5:
        context$1$0.t0 = context$1$0.sent;

      case 6:
        xcodeTraceTemplatePath = context$1$0.t0;

        _lodash2['default'].defaults(opts, {
          launchTimeout: 60000,
          template: xcodeTraceTemplatePath,
          withoutDelay: true,
          xcodeVersion: '8.1',
          webSocket: null,
          flakeyRetries: true,
          logNoColors: false
        });
        return context$1$0.abrupt('return', new _instruments2['default'](opts));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.rootDir = rootDir;
exports.killAllInstruments = killAllInstruments;
exports.cleanAllTraces = cleanAllTraces;
exports.getInstrumentsPath = getInstrumentsPath;
exports.getAvailableDevices = getAvailableDevices;
exports.parseLaunchTimeout = parseLaunchTimeout;
exports.getIwdPath = getIwdPath;
exports.quickLaunch = quickLaunch;
exports.quickInstruments = quickInstruments;

// the trace document can be in a weird state
// but we never do anything with it, so delete
//# sourceMappingURL=data:application/json;base64,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LGdCQUFnQixFQUFFLFdBQVcsQ0FBQzs7QUFDakQsNEJBQUksS0FBSywrQkFBNEIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBSSxDQUFDOzt5Q0FDbEQsd0JBQUssT0FBTyxFQUFFLElBQUksQ0FBQzs7Ozs7OztDQUMxQjs7QUFFRCxTQUFlLGdCQUFnQjtNQUFFLElBQUkseURBQUcsRUFBRTtNQUVwQyxzQkFBc0I7Ozs7QUFEMUIsWUFBSSxHQUFHLG9CQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQzt5QkFDSSxJQUFJLENBQUMsc0JBQXNCOzs7Ozs7Ozt5Q0FDOUMseUJBQU0sOEJBQThCLEVBQUU7Ozs7OztBQUQ1Qyw4QkFBc0I7O0FBRTFCLDRCQUFFLFFBQVEsQ0FBQyxJQUFJLEVBQUU7QUFDZix1QkFBYSxFQUFFLEtBQUs7QUFDcEIsa0JBQVEsRUFBRSxzQkFBc0I7QUFDaEMsc0JBQVksRUFBRSxJQUFJO0FBQ2xCLHNCQUFZLEVBQUUsS0FBSztBQUNuQixtQkFBUyxFQUFFLElBQUk7QUFDZix1QkFBYSxFQUFFLElBQUk7QUFDbkIscUJBQVcsRUFBRSxLQUFLO1NBQ25CLENBQUMsQ0FBQzs0Q0FDSSw2QkFBZ0IsSUFBSSxDQUFDOzs7Ozs7O0NBQzdCOztRQUVRLE9BQU8sR0FBUCxPQUFPO1FBQUUsa0JBQWtCLEdBQWxCLGtCQUFrQjtRQUFFLGNBQWMsR0FBZCxjQUFjO1FBQUUsa0JBQWtCLEdBQWxCLGtCQUFrQjtRQUMvRCxtQkFBbUIsR0FBbkIsbUJBQW1CO1FBQUUsa0JBQWtCLEdBQWxCLGtCQUFrQjtRQUFFLFVBQVUsR0FBVixVQUFVO1FBQUUsV0FBVyxHQUFYLFdBQVc7UUFDaEUsZ0JBQWdCLEdBQWhCLGdCQUFnQiIsImZpbGUiOiJsaWIvdXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB4Y29kZSBmcm9tICdhcHBpdW0teGNvZGUnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBJbnN0cnVtZW50cyBmcm9tICcuL2luc3RydW1lbnRzJztcblxuXG5jb25zdCByb290RGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uLy4uJyk7XG5jb25zdCBJTlNUX1NUQUxMX1RJTUVPVVQgPSAxMjAwMDtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0SW5zdHJ1bWVudHNQYXRoICgpIHtcbiAgbGV0IGluc3RydW1lbnRzUGF0aDtcbiAgdHJ5IHtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKCd4Y3J1bicsIFsnLWZpbmQnLCAnaW5zdHJ1bWVudHMnXSk7XG4gICAgaW5zdHJ1bWVudHNQYXRoID0gKHN0ZG91dCB8fCAnJykudHJpbSgpLnJlcGxhY2UoJ1xcbiQnLCAnJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIpIGxvZy5lcnJvcihlcnIubWVzc2FnZSk7XG4gIH1cbiAgaWYgKCFpbnN0cnVtZW50c1BhdGgpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdygnQ291bGQgbm90IGZpbmQgdGhlIGluc3RydW1lbnRzIGJpbmFyeS4gUGxlYXNlIGVuc3VyZSAnICtcbiAgICAgICAgICAgICAgICAgICAgICAnYHhjcnVuIC1maW5kIGluc3RydW1lbnRzYCBjYW4gbG9jYXRlIGl0LicpO1xuICB9XG4gIGxvZy5kZWJ1ZyhgSW5zdHJ1bWVudHMgaXMgYXQ6ICR7aW5zdHJ1bWVudHNQYXRofWApO1xuICByZXR1cm4gaW5zdHJ1bWVudHNQYXRoO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBdmFpbGFibGVEZXZpY2VzICgpIHtcbiAgbG9nLmRlYnVnKCdHZXR0aW5nIGxpc3Qgb2YgZGV2aWNlcyBpbnN0cnVtZW50cyBzdXBwb3J0cycpO1xuICBsZXQgaW5zdHJ1bWVudHNQYXRoID0gYXdhaXQgZ2V0SW5zdHJ1bWVudHNQYXRoKCk7XG4gIGxldCBvcHRzID0ge3RpbWVvdXQ6IElOU1RfU1RBTExfVElNRU9VVH07XG4gIGxldCBsaW5lcztcbiAgdHJ5IHtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKGluc3RydW1lbnRzUGF0aCwgWyctcycsICdkZXZpY2VzJ10sIG9wdHMpO1xuICAgIGxpbmVzID0gc3Rkb3V0LnNwbGl0KCdcXG4nKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEZhaWxlZCBnZXR0aW5nIGRldmljZXMsIGVycjogJHtlcnJ9LmApO1xuICB9XG4gIGxldCBkZXZpY2VzID0gbGluZXMuZmlsdGVyKChsaW5lKSA9PiB7XG4gICAgcmV0dXJuIC9eaS4rJC8udGVzdChsaW5lKTtcbiAgfSk7XG4gIHJldHVybiBkZXZpY2VzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBraWxsQWxsSW5zdHJ1bWVudHMgKCkge1xuICBsb2cuZGVidWcoJ0tpbGxpbmcgYWxsIGluc3RydW1lbnRzJyk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYygncGtpbGwnLCAgWyctZicsICdpbnN0cnVtZW50cyddKTtcbiAgfSBjYXRjaCAoaWduKSB7fVxufVxuXG5hc3luYyBmdW5jdGlvbiBjbGVhbkFsbFRyYWNlcyAoKSB7XG4gIGlmIChwcm9jZXNzLmVudi5DTEVBTl9UUkFDRVMpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKCdpbnN0cnVtZW50c2NsaSoudHJhY2UnKTtcbiAgICB9IGNhdGNoIChpZ24pIHt9XG4gIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VMYXVuY2hUaW1lb3V0IChsYXVuY2hUaW1lb3V0KSB7XG4gIC8vIG51bWJlciBvciBvYmplY3QgbGlrZSB7IGdsb2JhbDogNDAwMDAsIGFmdGVyU2ltTGF1bmNoOiA1MDAwIH1cbiAgLy8gbWF5IGFsc28gcGFyc2UgSlNPTiBzdHJpbmdzLlxuICBpZiAoXy5pc1N0cmluZyhsYXVuY2hUaW1lb3V0KSkge1xuICAgIHRyeSB7XG4gICAgICBsYXVuY2hUaW1lb3V0ID0gSlNPTi5wYXJzZShsYXVuY2hUaW1lb3V0KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGBJbnZhbGlkIGxhdW5jaCB0aW1lb3V0OiAke2xhdW5jaFRpbWVvdXR9YCk7XG4gICAgfVxuICB9XG4gIGlmIChfLmlzTnVtYmVyKGxhdW5jaFRpbWVvdXQpKSB7XG4gICAgbGF1bmNoVGltZW91dCA9IHtcbiAgICAgIGdsb2JhbDogbGF1bmNoVGltZW91dFxuICAgIH07XG4gIH1cbiAgcmV0dXJuIGxhdW5jaFRpbWVvdXQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEl3ZFBhdGgoeGNvZGVNYWpvclZlcnNpb24pIHtcbiAgbGV0IHRoaXJkcGFydHlQYXRoID0gcGF0aC5yZXNvbHZlKHJvb3REaXIsICd0aGlyZHBhcnR5Jyk7XG4gIGxldCBpd2RQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXJkcGFydHlQYXRoLCBgaXdkJHt4Y29kZU1ham9yVmVyc2lvbn1gKTtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMoaXdkUGF0aCkpIHtcbiAgICBpd2RQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXJkcGFydHlQYXRoLCAnaXdkJyk7XG4gIH1cbiAgbG9nLmRlYnVnKGBGb3VuZCBJbnNydW1lbnRzLVdpdGhvdXQtRGVsYXk6ICR7aXdkUGF0aH1gKTtcbiAgcmV0dXJuIGl3ZFBhdGg7XG59XG5cbi8vIHRoaXMgZnVuY3Rpb24gbGF1bmNoZXMgYW4gaW5zdHJ1bWVudHMgdGVzdCB3aXRoIGEgZGVmYXVsdCB0ZXN0XG4vLyB0aGF0IGltbWVkaWF0ZWx5IHBhc3Nlcy4gSW4gdGhpcyB3YXkgd2UgY2FuIHN0YXJ0IGEgc2ltdWxhdG9yXG4vLyBhbmQgYmUgbm90aWZpZWQgd2hlbiBpdCBjb21wbGV0ZWx5IGxhdW5jaGVzXG5hc3luYyBmdW5jdGlvbiBxdWlja0xhdW5jaCAodWRpZCwgYXBwUGF0aCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdhc3NldHMnLCAnVGVzdEFwcC5hcHAnKSkge1xuICBsZXQgdHJhY2VUZW1wbGF0ZVBhdGggPSBhd2FpdCB4Y29kZS5nZXRBdXRvbWF0aW9uVHJhY2VUZW1wbGF0ZVBhdGgoKTtcbiAgbGV0IHNjcmlwdFBhdGggPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnYXNzZXRzJywgJ2JsYW5rX2luc3RydW1lbnRzX3Rlc3QuanMnKTtcbiAgbGV0IHRyYWNlRG9jdW1lbnQgPSBwYXRoLnJlc29sdmUoJy8nLCAndG1wJywgJ3Rlc3RUcmFjZS50cmFjZScpO1xuICBsZXQgcmVzdWx0c1BhdGggPSBwYXRoLnJlc29sdmUoJy8nLCAndG1wJyk7XG5cbiAgLy8gdGhlIHRyYWNlIGRvY3VtZW50IGNhbiBiZSBpbiBhIHdlaXJkIHN0YXRlXG4gIC8vIGJ1dCB3ZSBuZXZlciBkbyBhbnl0aGluZyB3aXRoIGl0LCBzbyBkZWxldGVcbiAgYXdhaXQgZnMucmltcmFmKHRyYWNlRG9jdW1lbnQpO1xuXG4gIGxldCBhcmdzID0gWydpbnN0cnVtZW50cycsXG4gICAgICAgICAgICAgICctRCcsIHRyYWNlRG9jdW1lbnQsXG4gICAgICAgICAgICAgICAnLXQnLCB0cmFjZVRlbXBsYXRlUGF0aCxcbiAgICAgICAgICAgICAgICctdycsIHVkaWQsXG4gICAgICAgICAgICAgICBhcHBQYXRoLFxuICAgICAgICAgICAgICAgJy1lJywgJ1VJQVNDUklQVCcsIHNjcmlwdFBhdGgsXG4gICAgICAgICAgICAgICAnLWUnLCAnVUlBUkVTVUxUU1BBVEgnLCByZXN1bHRzUGF0aF07XG4gIGxvZy5kZWJ1ZyhgUnVubmluZyBjb21tYW5kOiAneGNydW4gJHthcmdzLmpvaW4oJyAnKX0nYCk7XG4gIGF3YWl0IGV4ZWMoJ3hjcnVuJywgYXJncyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHF1aWNrSW5zdHJ1bWVudHMgKG9wdHMgPSB7fSkge1xuICBvcHRzID0gXy5jbG9uZURlZXAob3B0cyk7XG4gIGxldCB4Y29kZVRyYWNlVGVtcGxhdGVQYXRoID0gb3B0cy54Y29kZVRyYWNlVGVtcGxhdGVQYXRoIHx8XG4gICAgICBhd2FpdCB4Y29kZS5nZXRBdXRvbWF0aW9uVHJhY2VUZW1wbGF0ZVBhdGgoKTtcbiAgXy5kZWZhdWx0cyhvcHRzLCB7XG4gICAgbGF1bmNoVGltZW91dDogNjAwMDAsXG4gICAgdGVtcGxhdGU6IHhjb2RlVHJhY2VUZW1wbGF0ZVBhdGgsXG4gICAgd2l0aG91dERlbGF5OiB0cnVlLFxuICAgIHhjb2RlVmVyc2lvbjogJzguMScsXG4gICAgd2ViU29ja2V0OiBudWxsLFxuICAgIGZsYWtleVJldHJpZXM6IHRydWUsXG4gICAgbG9nTm9Db2xvcnM6IGZhbHNlLFxuICB9KTtcbiAgcmV0dXJuIG5ldyBJbnN0cnVtZW50cyhvcHRzKTtcbn1cblxuZXhwb3J0IHsgcm9vdERpciwga2lsbEFsbEluc3RydW1lbnRzLCBjbGVhbkFsbFRyYWNlcywgZ2V0SW5zdHJ1bWVudHNQYXRoLFxuICAgICAgICAgZ2V0QXZhaWxhYmxlRGV2aWNlcywgcGFyc2VMYXVuY2hUaW1lb3V0LCBnZXRJd2RQYXRoLCBxdWlja0xhdW5jaCxcbiAgICAgICAgIHF1aWNrSW5zdHJ1bWVudHMgfTtcbiJdfQ==