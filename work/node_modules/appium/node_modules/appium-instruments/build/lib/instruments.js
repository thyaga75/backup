// Wrapper around Apple's Instruments app

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _toConsumableArray = require('babel-runtime/helpers/to-consumable-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _teen_process = require('teen_process');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _through = require('through');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumIosSimulator = require('appium-ios-simulator');

var _utils = require('./utils');

var _streams = require('./streams');

require('colors');

var ERR_NEVER_CHECKED_IN = 'Instruments never checked in';
var ERR_CRASHED_ON_STARTUP = 'Instruments crashed on startup';

var Instruments = (function () {
  _createClass(Instruments, null, [{
    key: 'quickInstruments',

    // simple factory with sane defaults
    value: function quickInstruments(opts) {
      var xcodeTraceTemplatePath;
      return _regeneratorRuntime.async(function quickInstruments$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            opts = _lodash2['default'].clone(opts);
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getAutomationTraceTemplatePath());

          case 3:
            xcodeTraceTemplatePath = context$2$0.sent;

            _lodash2['default'].defaults(opts, {
              launchTimeout: 60000,
              template: xcodeTraceTemplatePath,
              withoutDelay: true,
              xcodeVersion: '8.1',
              webSocket: null,
              flakeyRetries: 2
            });
            return context$2$0.abrupt('return', new Instruments(opts));

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /*
     * opts:
     *   - app
     *   - termTimeout - defaults to 5000
     *   - flakeyRetries - defaults to 0
     *   - udid
     *   - bootstrap
     *   - template
     *   - withoutDelay
     *   - processArguments
     *   - simulatorSdkAndDevice
     *   - tmpDir - defaults to `/tmp/appium-instruments`
     *   - traceDir
     *   - launchTimeout - defaults to 90000
     *   - webSocket
     *   - instrumentsPath
     */
  }]);

  function Instruments(opts) {
    var _this = this;

    _classCallCheck(this, Instruments);

    opts = _lodash2['default'].cloneDeep(opts);
    _lodash2['default'].defaults(opts, {
      termTimeout: 5000,
      tmpDir: '/tmp/appium-instruments',
      launchTimeout: 90000,
      flakeyRetries: 0
    });

    // config
    var _arr = ['app', 'termTimeout', 'flakeyRetries', 'udid', 'bootstrap', 'template', 'withoutDelay', 'processArguments', 'simulatorSdkAndDevice', 'tmpDir', 'traceDir'];
    for (var _i = 0; _i < _arr.length; _i++) {
      var f = _arr[_i];
      this[f] = opts[f];
    }
    this.traceDir = this.traceDir || this.tmpDir;
    this.launchTimeout = (0, _utils.parseLaunchTimeout)(opts.launchTimeout);

    // state
    this.proc = null;
    this.webSocket = opts.webSocket;
    this.instrumentsPath = opts.instrumentsPath;
    this.launchTries = 0;
    this.socketConnectDelays = [];
    this.gotFBSOpenApplicationError = false;
    this.onShutdown = new _bluebird2['default'](function (resolve, reject) {
      _this.onShutdownDeferred = { resolve: resolve, reject: reject };
    });
    // avoids UnhandledException
    this.onShutdown['catch'](function () {}).done();
  }

  _createClass(Instruments, [{
    key: 'configure',
    value: function configure() {
      return _regeneratorRuntime.async(function configure$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this.xcodeVersion) {
              context$2$0.next = 4;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getVersion(true));

          case 3:
            this.xcodeVersion = context$2$0.sent;

          case 4:
            if (this.xcodeVersion.versionFloat === 6.0 && this.withoutDelay) {
              _logger2['default'].info('In xcode 6.0, instruments-without-delay does not work. ' + 'If using Appium, you can disable instruments-without-delay ' + 'with the --native-instruments-lib server flag');
            }

            if (!(this.xcodeVersion.versionString === '5.0.1')) {
              context$2$0.next = 7;
              break;
            }

            throw new Error('Xcode 5.0.1 ships with a broken version of ' + 'Instruments. please upgrade to 5.0.2');

          case 7:
            if (this.template) {
              context$2$0.next = 11;
              break;
            }

            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getAutomationTraceTemplatePath());

          case 10:
            this.template = context$2$0.sent;

          case 11:
            if (this.instrumentsPath) {
              context$2$0.next = 15;
              break;
            }

            context$2$0.next = 14;
            return _regeneratorRuntime.awrap((0, _utils.getInstrumentsPath)());

          case 14:
            this.instrumentsPath = context$2$0.sent;

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'launchOnce',
    value: function launchOnce() {
      var launchResultPromise, actOnStderr;
      return _regeneratorRuntime.async(function launchOnce$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Launching instruments');
            // prepare temp dir
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(this.tmpDir));

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(this.tmpDir));

          case 5:
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(this.traceDir));

          case 7:

            this.exitListener = null;
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.spawnInstruments());

          case 10:
            this.proc = context$2$0.sent;

            this.proc.on('exit', function (code) {
              _logger2['default'].debug('Instruments exited with code ' + code);
            });

            // set up the promise to handle launch
            launchResultPromise = new _bluebird2['default'](function (resolve, reject) {
              _this2.launchResultDeferred = { resolve: resolve, reject: reject };
            });

            // There was a special case for ignoreStartupExit
            // but it is not needed anymore, you may just listen for exit.
            this.setExitListener(function () {
              _this2.proc = null;
              _this2.launchResultDeferred.reject(new Error(ERR_CRASHED_ON_STARTUP));
            });

            this.proc.on('error', function (err) {
              _logger2['default'].debug('Error with instruments proc: ' + err.message);
              if (err.message.indexOf('ENOENT') !== -1) {
                _this2.proc = null; // otherwise we'll try to send sigkill
                _logger2['default'].error('Unable to spawn instruments: ' + err.message);
                _this2.launchResultDeferred.reject(err);
              }
            });

            this.proc.stdout.setEncoding('utf8');
            this.proc.stdout.pipe((0, _streams.outputStream)()).pipe((0, _streams.dumpStream)());

            this.proc.stderr.setEncoding('utf8');

            actOnStderr = function actOnStderr(output) {
              if (_this2.launchTimeout.afterSimLaunch && output && output.match(/CLTilesManagerClient: initialize/)) {
                _this2.addSocketConnectTimer(_this2.launchTimeout.afterSimLaunch, 'afterLaunch', function callee$3$0() {
                  return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                    while (1) switch (context$4$0.prev = context$4$0.next) {
                      case 0:
                        context$4$0.next = 2;
                        return _regeneratorRuntime.awrap((0, _utils.killAllInstruments)());

                      case 2:
                      case 'end':
                        return context$4$0.stop();
                    }
                  }, null, _this2);
                });
              }

              var fbsErrStr = '(FBSOpenApplicationErrorDomain error 8.)';
              if (output.indexOf(fbsErrStr) !== -1) {
                _this2.gotFBSOpenApplicationError = true;
              }
            };

            this.proc.stderr.pipe((0, _through.through)(function (output) {
              actOnStderr(output);
              this.queue(output);
            })).pipe((0, _streams.errorStream)()).pipe((0, _streams.webSocketAlertStream)(this.webSocket)).pipe((0, _streams.dumpStream)());

            // start waiting for instruments to launch successfully
            this.addSocketConnectTimer(this.launchTimeout.global, 'global', function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap((0, _utils.killAllInstruments)());

                  case 2:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this2);
            });

            context$2$0.prev = 21;
            context$2$0.next = 24;
            return _regeneratorRuntime.awrap(launchResultPromise);

          case 24:
            context$2$0.prev = 24;

            this.clearSocketConnectTimers();
            return context$2$0.finish(24);

          case 27:
            this.setExitListener(function (code) {
              _this2.proc = null;
              _this2.onShutdownDeferred.reject(new Error('Abnormal exit with code: ' + code));
            });

          case 28:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[21,, 24, 27]]);
    }
  }, {
    key: 'launch',
    value: function launch() {
      var launchTries, errIsCatchable;
      return _regeneratorRuntime.async(function launch$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.configure());

          case 2:
            launchTries = 0;

          case 3:
            launchTries++;
            _logger2['default'].debug('Attempting to launch instruments, this is try #' + launchTries);

            context$2$0.prev = 5;
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(this.launchOnce());

          case 8:
            return context$2$0.abrupt('break', 33);

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](5);

            _logger2['default'].error('Error launching instruments: ' + context$2$0.t0.message);
            errIsCatchable = context$2$0.t0.message === ERR_NEVER_CHECKED_IN || context$2$0.t0.message === ERR_CRASHED_ON_STARTUP;

            if (errIsCatchable) {
              context$2$0.next = 17;
              break;
            }

            throw context$2$0.t0;

          case 17:
            if (!(launchTries <= this.flakeyRetries)) {
              context$2$0.next = 31;
              break;
            }

            if (!this.gotFBSOpenApplicationError) {
              context$2$0.next = 25;
              break;
            }

            _logger2['default'].debug('Got the FBSOpenApplicationError, not killing the ' + 'sim but leaving it open so the app will launch');
            this.gotFBSOpenApplicationError = false; // clear out for next launch
            context$2$0.next = 23;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(1000));

          case 23:
            context$2$0.next = 29;
            break;

          case 25:
            context$2$0.next = 27;
            return _regeneratorRuntime.awrap((0, _appiumIosSimulator.killAllSimulators)());

          case 27:
            context$2$0.next = 29;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(5000));

          case 29:
            context$2$0.next = 32;
            break;

          case 31:
            _logger2['default'].errorAndThrow('We exceeded the number of retries allowed for ' + 'instruments to successfully start; failing launch');

          case 32:
            if (true) {
              context$2$0.next = 3;
              break;
            }

          case 33:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[5, 11]]);
    }
  }, {
    key: 'registerLaunch',
    value: function registerLaunch() {
      this.launchResultDeferred.resolve();
    }
  }, {
    key: 'spawnInstruments',
    value: function spawnInstruments() {
      var traceDir, i, args, env, iwdPath, instrumentsExecArgs;
      return _regeneratorRuntime.async(function spawnInstruments$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            traceDir = undefined;
            i = 0;

          case 2:
            // loop while there are tracedirs to delete
            traceDir = _path2['default'].resolve(this.traceDir, 'instrumentscli' + i + '.trace');
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(traceDir));

          case 5:
            if (context$2$0.sent) {
              context$2$0.next = 7;
              break;
            }

            return context$2$0.abrupt('break', 10);

          case 7:
            i++;
            context$2$0.next = 2;
            break;

          case 10:
            args = ['-t', this.template, '-D', traceDir];

            if (this.udid) {
              // real device, so specify udid
              args = args.concat(['-w', this.udid]);
              _logger2['default'].debug('Attempting to run app on real device with UDID \'' + this.udid + '\'');
            }
            if (!this.udid && this.simulatorSdkAndDevice) {
              // sim, so specify the sdk and device
              args = args.concat(['-w', this.simulatorSdkAndDevice]);
              _logger2['default'].debug('Attempting to run app on ' + this.simulatorSdkAndDevice);
            }
            args = args.concat([this.app]);
            if (this.processArguments) {
              // any additional stuff specifyied by the user
              args = args.concat(this.processArguments);
              _logger2['default'].debug('Attempting to run app with process arguments: ' + JSON.stringify(this.processArguments));
            }
            args = args.concat(['-e', 'UIASCRIPT', this.bootstrap]);
            args = args.concat(['-e', 'UIARESULTSPATH', this.tmpDir]);

            env = _lodash2['default'].clone(process.env);

            if (this.xcodeVersion.major >= 7 && !this.udid) {
              // iwd currently does not work with xcode7, setting withoutDelay to false
              _logger2['default'].info("On xcode 7.0+, instruments-without-delay does not work, " + "skipping instruments-without-delay");
              this.withoutDelay = false;
            }
            context$2$0.next = 21;
            return _regeneratorRuntime.awrap((0, _utils.getIwdPath)(this.xcodeVersion.major));

          case 21:
            iwdPath = context$2$0.sent;

            env.CA_DEBUG_TRANSACTIONS = 1;
            if (this.withoutDelay && !this.udid) {
              // sim, and using i-w-d
              env.DYLD_INSERT_LIBRARIES = _path2['default'].resolve(iwdPath, 'InstrumentsShim.dylib');
              env.LIB_PATH = iwdPath;
            }
            instrumentsExecArgs = [this.instrumentsPath].concat(_toConsumableArray(args));

            instrumentsExecArgs = _lodash2['default'].map(instrumentsExecArgs, function (arg) {
              if (arg === null) {
                throw new Error('A null value was passed as an arg to execute ' + 'instruments on the command line. A letiable is ' + 'probably not getting set. Array of command args: ' + JSON.stringify(instrumentsExecArgs));
              }
              // escape any argument that has a space in it
              if (_lodash2['default'].isString(arg) && arg.indexOf(' ') !== -1) {
                return '"' + arg + '"';
              }
              // otherwise just use the argument
              return arg;
            });

            _logger2['default'].debug('Spawning instruments with command: \'' + instrumentsExecArgs.join(' ') + '\'');
            if (this.withoutDelay) {
              _logger2['default'].debug('And extra without-delay env: ' + JSON.stringify({
                DYLD_INSERT_LIBRARIES: env.DYLD_INSERT_LIBRARIES,
                LIB_PATH: env.LIB_PATH
              }));
            }
            _logger2['default'].debug('And launch timeouts (in ms): ' + JSON.stringify(this.launchTimeout));
            context$2$0.next = 31;
            return _regeneratorRuntime.awrap((0, _teen_process.spawn)(this.instrumentsPath, args, { env: env }));

          case 31:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 32:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'addSocketConnectTimer',
    value: function addSocketConnectTimer(delay, type, doAction) {
      var _this3 = this;

      var socketConnectDelay = (0, _appiumSupport.cancellableDelay)(delay);
      socketConnectDelay.then(function () {
        _logger2['default'].warn('Instruments socket client never checked in; timing out (' + type + ')');
        _this3.setExitListener(function () {
          _this3.proc = null;
          _this3.launchResultDeferred.reject(new Error(ERR_NEVER_CHECKED_IN));
        });
        return doAction();
      })['catch'](_bluebird2['default'].CancellationError, function () {}).done();
      this.socketConnectDelays.push(socketConnectDelay);
    }
  }, {
    key: 'clearSocketConnectTimers',
    value: function clearSocketConnectTimers() {
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _getIterator(this.socketConnectDelays), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          var delay = _step.value;

          delay.cancel();
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      this.socketConnectDelays = [];
    }
  }, {
    key: 'setExitListener',
    value: function setExitListener(exitListener) {
      if (!this.proc) return;
      if (this.exitListener) {
        this.proc.removeListener('exit', this.exitListener);
      }
      this.exitListener = exitListener;
      this.proc.on('exit', exitListener);
    }

    /* PROCESS MANAGEMENT */
  }, {
    key: 'shutdown',
    value: function shutdown() {
      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        var _this5 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (!this.proc) {
              context$2$0.next = 3;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((function callee$2$0() {
              var wasTerminated, termDelay, termPromise;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this4 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    _logger2['default'].debug('Starting shutdown.');
                    wasTerminated = false;
                    termDelay = (0, _appiumSupport.cancellableDelay)(this.termTimeout);
                    termPromise = termDelay['catch'](_bluebird2['default'].CancellationError, function () {});

                    this.setExitListener(function () {
                      _this4.proc = null;
                      wasTerminated = true;
                      termDelay.cancel();
                      _this4.onShutdownDeferred.resolve();
                    });
                    _logger2['default'].debug('Sending sigterm to instruments');
                    this.proc.kill('SIGTERM');
                    context$3$0.next = 9;
                    return _regeneratorRuntime.awrap(termPromise);

                  case 9:
                    if (wasTerminated) {
                      context$3$0.next = 11;
                      break;
                    }

                    throw new Error('Instruments did not terminate after ' + this.termTimeout / 1000 + ' seconds!');

                  case 11:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this5);
            })());

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return Instruments;
})();

exports['default'] = Instruments;
module.exports = exports['default'];

// build up the arguments to use

// monitoring process termination
//# sourceMappingURL=data:application/json;base64,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SUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQzs7cURBQ3BCLFdBQVc7Ozt3QkFDWixhQUFhOzs7OzswQkFDVixJQUFJLEtBQUssMENBQXdDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxlQUFZOzs7Ozs7Ozs7Ozs7OztLQUcvRjs7O1NBaFVHLFdBQVc7OztxQkFtVUYsV0FBVyIsImZpbGUiOiJsaWIvaW5zdHJ1bWVudHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBXcmFwcGVyIGFyb3VuZCBBcHBsZSdzIEluc3RydW1lbnRzIGFwcFxuXG5pbXBvcnQgeyBzcGF3biB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyB0aHJvdWdoIH0gZnJvbSAndGhyb3VnaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IG1rZGlycCwgZnMsIGNhbmNlbGxhYmxlRGVsYXkgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGtpbGxBbGxTaW11bGF0b3JzIH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IHsga2lsbEFsbEluc3RydW1lbnRzLCBnZXRJbnN0cnVtZW50c1BhdGgsIHBhcnNlTGF1bmNoVGltZW91dCxcbiAgICAgICAgIGdldEl3ZFBhdGggfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IG91dHB1dFN0cmVhbSwgZXJyb3JTdHJlYW0sIHdlYlNvY2tldEFsZXJ0U3RyZWFtLCBkdW1wU3RyZWFtIH0gZnJvbSAnLi9zdHJlYW1zJztcbmltcG9ydCAnY29sb3JzJztcblxuXG5jb25zdCBFUlJfTkVWRVJfQ0hFQ0tFRF9JTiA9ICdJbnN0cnVtZW50cyBuZXZlciBjaGVja2VkIGluJztcbmNvbnN0IEVSUl9DUkFTSEVEX09OX1NUQVJUVVAgPSAnSW5zdHJ1bWVudHMgY3Jhc2hlZCBvbiBzdGFydHVwJztcblxuY2xhc3MgSW5zdHJ1bWVudHMge1xuICAvLyBzaW1wbGUgZmFjdG9yeSB3aXRoIHNhbmUgZGVmYXVsdHNcbiAgc3RhdGljIGFzeW5jIHF1aWNrSW5zdHJ1bWVudHMgKG9wdHMpIHtcbiAgICBvcHRzID0gXy5jbG9uZShvcHRzKTtcbiAgICBsZXQgeGNvZGVUcmFjZVRlbXBsYXRlUGF0aCA9IGF3YWl0IHhjb2RlLmdldEF1dG9tYXRpb25UcmFjZVRlbXBsYXRlUGF0aCgpO1xuICAgIF8uZGVmYXVsdHMob3B0cywge1xuICAgICAgICAgIGxhdW5jaFRpbWVvdXQ6IDYwMDAwLFxuICAgICAgICAgIHRlbXBsYXRlOiB4Y29kZVRyYWNlVGVtcGxhdGVQYXRoLFxuICAgICAgICAgIHdpdGhvdXREZWxheTogdHJ1ZSxcbiAgICAgICAgICB4Y29kZVZlcnNpb246ICc4LjEnLFxuICAgICAgICAgIHdlYlNvY2tldDogbnVsbCxcbiAgICAgICAgICBmbGFrZXlSZXRyaWVzOiAyXG4gICAgfSk7XG4gICAgcmV0dXJuIG5ldyBJbnN0cnVtZW50cyhvcHRzKTtcbiAgfVxuXG4gIC8qXG4gICAqIG9wdHM6XG4gICAqICAgLSBhcHBcbiAgICogICAtIHRlcm1UaW1lb3V0IC0gZGVmYXVsdHMgdG8gNTAwMFxuICAgKiAgIC0gZmxha2V5UmV0cmllcyAtIGRlZmF1bHRzIHRvIDBcbiAgICogICAtIHVkaWRcbiAgICogICAtIGJvb3RzdHJhcFxuICAgKiAgIC0gdGVtcGxhdGVcbiAgICogICAtIHdpdGhvdXREZWxheVxuICAgKiAgIC0gcHJvY2Vzc0FyZ3VtZW50c1xuICAgKiAgIC0gc2ltdWxhdG9yU2RrQW5kRGV2aWNlXG4gICAqICAgLSB0bXBEaXIgLSBkZWZhdWx0cyB0byBgL3RtcC9hcHBpdW0taW5zdHJ1bWVudHNgXG4gICAqICAgLSB0cmFjZURpclxuICAgKiAgIC0gbGF1bmNoVGltZW91dCAtIGRlZmF1bHRzIHRvIDkwMDAwXG4gICAqICAgLSB3ZWJTb2NrZXRcbiAgICogICAtIGluc3RydW1lbnRzUGF0aFxuICAgKi9cbiAgY29uc3RydWN0b3IgKG9wdHMpIHtcbiAgICBvcHRzID0gXy5jbG9uZURlZXAob3B0cyk7XG4gICAgXy5kZWZhdWx0cyhvcHRzLCB7XG4gICAgICB0ZXJtVGltZW91dDogNTAwMCxcbiAgICAgIHRtcERpcjogJy90bXAvYXBwaXVtLWluc3RydW1lbnRzJyxcbiAgICAgIGxhdW5jaFRpbWVvdXQ6IDkwMDAwLFxuICAgICAgZmxha2V5UmV0cmllczogMFxuICAgIH0pO1xuXG4gICAgLy8gY29uZmlnXG4gICAgZm9yIChsZXQgZiBvZiBbJ2FwcCcsICd0ZXJtVGltZW91dCcsICdmbGFrZXlSZXRyaWVzJywgJ3VkaWQnLCAnYm9vdHN0cmFwJyxcbiAgICAgICAgICAgICAgICAgICAndGVtcGxhdGUnLCAnd2l0aG91dERlbGF5JywgJ3Byb2Nlc3NBcmd1bWVudHMnLFxuICAgICAgICAgICAgICAgICAgICdzaW11bGF0b3JTZGtBbmREZXZpY2UnLCAndG1wRGlyJywgJ3RyYWNlRGlyJ10pIHtcbiAgICAgIHRoaXNbZl0gPSBvcHRzW2ZdO1xuICAgIH1cbiAgICB0aGlzLnRyYWNlRGlyID0gdGhpcy50cmFjZURpciB8fCB0aGlzLnRtcERpcjtcbiAgICB0aGlzLmxhdW5jaFRpbWVvdXQgPSBwYXJzZUxhdW5jaFRpbWVvdXQob3B0cy5sYXVuY2hUaW1lb3V0KTtcblxuICAgIC8vIHN0YXRlXG4gICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICB0aGlzLndlYlNvY2tldCA9IG9wdHMud2ViU29ja2V0O1xuICAgIHRoaXMuaW5zdHJ1bWVudHNQYXRoID0gb3B0cy5pbnN0cnVtZW50c1BhdGg7XG4gICAgdGhpcy5sYXVuY2hUcmllcyA9IDA7XG4gICAgdGhpcy5zb2NrZXRDb25uZWN0RGVsYXlzID0gW107XG4gICAgdGhpcy5nb3RGQlNPcGVuQXBwbGljYXRpb25FcnJvciA9IGZhbHNlO1xuICAgIHRoaXMub25TaHV0ZG93biA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMub25TaHV0ZG93bkRlZmVycmVkID0ge3Jlc29sdmUsIHJlamVjdH07XG4gICAgfSk7XG4gICAgLy8gYXZvaWRzIFVuaGFuZGxlZEV4Y2VwdGlvblxuICAgIHRoaXMub25TaHV0ZG93bi5jYXRjaCgoKSA9PiB7fSkuZG9uZSgpO1xuICB9XG5cbiAgYXN5bmMgY29uZmlndXJlICgpIHtcbiAgICBpZiAoIXRoaXMueGNvZGVWZXJzaW9uKSB7XG4gICAgICB0aGlzLnhjb2RlVmVyc2lvbiA9IGF3YWl0IHhjb2RlLmdldFZlcnNpb24odHJ1ZSk7XG4gICAgfVxuICAgIGlmICh0aGlzLnhjb2RlVmVyc2lvbi52ZXJzaW9uRmxvYXQgPT09IDYuMCAmJiB0aGlzLndpdGhvdXREZWxheSkge1xuICAgICAgbG9nLmluZm8oJ0luIHhjb2RlIDYuMCwgaW5zdHJ1bWVudHMtd2l0aG91dC1kZWxheSBkb2VzIG5vdCB3b3JrLiAnICtcbiAgICAgICAgICAgICAgICdJZiB1c2luZyBBcHBpdW0sIHlvdSBjYW4gZGlzYWJsZSBpbnN0cnVtZW50cy13aXRob3V0LWRlbGF5ICcgK1xuICAgICAgICAgICAgICAgJ3dpdGggdGhlIC0tbmF0aXZlLWluc3RydW1lbnRzLWxpYiBzZXJ2ZXIgZmxhZycpO1xuICAgIH1cbiAgICBpZiAodGhpcy54Y29kZVZlcnNpb24udmVyc2lvblN0cmluZyA9PT0gJzUuMC4xJykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdYY29kZSA1LjAuMSBzaGlwcyB3aXRoIGEgYnJva2VuIHZlcnNpb24gb2YgJyArXG4gICAgICAgICAgICAgICAgICAgICAgJ0luc3RydW1lbnRzLiBwbGVhc2UgdXBncmFkZSB0byA1LjAuMicpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy50ZW1wbGF0ZSkge1xuICAgICAgdGhpcy50ZW1wbGF0ZSA9IGF3YWl0IHhjb2RlLmdldEF1dG9tYXRpb25UcmFjZVRlbXBsYXRlUGF0aCgpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5pbnN0cnVtZW50c1BhdGgpIHtcbiAgICAgIHRoaXMuaW5zdHJ1bWVudHNQYXRoID0gYXdhaXQgZ2V0SW5zdHJ1bWVudHNQYXRoKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbGF1bmNoT25jZSAoKSB7XG4gICAgbG9nLmluZm8oJ0xhdW5jaGluZyBpbnN0cnVtZW50cycpO1xuICAgIC8vIHByZXBhcmUgdGVtcCBkaXJcbiAgICBhd2FpdCBmcy5yaW1yYWYodGhpcy50bXBEaXIpO1xuICAgIGF3YWl0IG1rZGlycCh0aGlzLnRtcERpcik7XG4gICAgYXdhaXQgbWtkaXJwKHRoaXMudHJhY2VEaXIpO1xuXG4gICAgdGhpcy5leGl0TGlzdGVuZXIgPSBudWxsO1xuICAgIHRoaXMucHJvYyA9IGF3YWl0IHRoaXMuc3Bhd25JbnN0cnVtZW50cygpO1xuICAgIHRoaXMucHJvYy5vbignZXhpdCcsIChjb2RlKSA9PiB7XG4gICAgICBsb2cuZGVidWcoYEluc3RydW1lbnRzIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfWApO1xuICAgIH0pO1xuXG4gICAgLy8gc2V0IHVwIHRoZSBwcm9taXNlIHRvIGhhbmRsZSBsYXVuY2hcbiAgICBsZXQgbGF1bmNoUmVzdWx0UHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMubGF1bmNoUmVzdWx0RGVmZXJyZWQgPSB7cmVzb2x2ZSwgcmVqZWN0fTtcbiAgICB9KTtcblxuICAgIC8vIFRoZXJlIHdhcyBhIHNwZWNpYWwgY2FzZSBmb3IgaWdub3JlU3RhcnR1cEV4aXRcbiAgICAvLyBidXQgaXQgaXMgbm90IG5lZWRlZCBhbnltb3JlLCB5b3UgbWF5IGp1c3QgbGlzdGVuIGZvciBleGl0LlxuICAgIHRoaXMuc2V0RXhpdExpc3RlbmVyKCgpID0+IHtcbiAgICAgIHRoaXMucHJvYyA9IG51bGw7XG4gICAgICB0aGlzLmxhdW5jaFJlc3VsdERlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoRVJSX0NSQVNIRURfT05fU1RBUlRVUCkpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5wcm9jLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgIGxvZy5kZWJ1ZyhgRXJyb3Igd2l0aCBpbnN0cnVtZW50cyBwcm9jOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgaWYgKGVyci5tZXNzYWdlLmluZGV4T2YoJ0VOT0VOVCcpICE9PSAtMSkge1xuICAgICAgICB0aGlzLnByb2MgPSBudWxsOyAvLyBvdGhlcndpc2Ugd2UnbGwgdHJ5IHRvIHNlbmQgc2lna2lsbFxuICAgICAgICBsb2cuZXJyb3IoYFVuYWJsZSB0byBzcGF3biBpbnN0cnVtZW50czogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgdGhpcy5sYXVuY2hSZXN1bHREZWZlcnJlZC5yZWplY3QoZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMucHJvYy5zdGRvdXQuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICB0aGlzLnByb2Muc3Rkb3V0LnBpcGUob3V0cHV0U3RyZWFtKCkpLnBpcGUoZHVtcFN0cmVhbSgpKTtcblxuICAgIHRoaXMucHJvYy5zdGRlcnIuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICBsZXQgYWN0T25TdGRlcnIgPSAob3V0cHV0KSA9PiB7XG4gICAgICBpZiAodGhpcy5sYXVuY2hUaW1lb3V0LmFmdGVyU2ltTGF1bmNoICYmIG91dHB1dCAmJiBvdXRwdXQubWF0Y2goL0NMVGlsZXNNYW5hZ2VyQ2xpZW50OiBpbml0aWFsaXplLykpIHtcbiAgICAgICAgdGhpcy5hZGRTb2NrZXRDb25uZWN0VGltZXIodGhpcy5sYXVuY2hUaW1lb3V0LmFmdGVyU2ltTGF1bmNoLCAnYWZ0ZXJMYXVuY2gnLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgYXdhaXQga2lsbEFsbEluc3RydW1lbnRzKCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBsZXQgZmJzRXJyU3RyID0gJyhGQlNPcGVuQXBwbGljYXRpb25FcnJvckRvbWFpbiBlcnJvciA4LiknO1xuICAgICAgaWYgKG91dHB1dC5pbmRleE9mKGZic0VyclN0cikgIT09IC0xKSB7XG4gICAgICAgIHRoaXMuZ290RkJTT3BlbkFwcGxpY2F0aW9uRXJyb3IgPSB0cnVlO1xuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5wcm9jLnN0ZGVyci5waXBlKHRocm91Z2goZnVuY3Rpb24gKG91dHB1dCkge1xuICAgICAgYWN0T25TdGRlcnIob3V0cHV0KTtcbiAgICAgIHRoaXMucXVldWUob3V0cHV0KTtcbiAgICB9KSkucGlwZShlcnJvclN0cmVhbSgpKVxuICAgIC5waXBlKHdlYlNvY2tldEFsZXJ0U3RyZWFtKHRoaXMud2ViU29ja2V0KSlcbiAgICAucGlwZShkdW1wU3RyZWFtKCkpO1xuXG4gICAgLy8gc3RhcnQgd2FpdGluZyBmb3IgaW5zdHJ1bWVudHMgdG8gbGF1bmNoIHN1Y2Nlc3NmdWxseVxuICAgIHRoaXMuYWRkU29ja2V0Q29ubmVjdFRpbWVyKHRoaXMubGF1bmNoVGltZW91dC5nbG9iYWwsICdnbG9iYWwnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBraWxsQWxsSW5zdHJ1bWVudHMoKTtcbiAgICB9KTtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBsYXVuY2hSZXN1bHRQcm9taXNlO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLmNsZWFyU29ja2V0Q29ubmVjdFRpbWVycygpO1xuICAgIH1cbiAgICB0aGlzLnNldEV4aXRMaXN0ZW5lcigoY29kZSkgPT4ge1xuICAgICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICAgIHRoaXMub25TaHV0ZG93bkRlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoYEFibm9ybWFsIGV4aXQgd2l0aCBjb2RlOiAke2NvZGV9YCkpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgbGF1bmNoICgpIHtcbiAgICBhd2FpdCB0aGlzLmNvbmZpZ3VyZSgpO1xuICAgIGxldCBsYXVuY2hUcmllcyA9IDA7XG4gICAgZG8ge1xuICAgICAgbGF1bmNoVHJpZXMrKztcbiAgICAgIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBsYXVuY2ggaW5zdHJ1bWVudHMsIHRoaXMgaXMgdHJ5ICMke2xhdW5jaFRyaWVzfWApO1xuXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmxhdW5jaE9uY2UoKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nLmVycm9yKGBFcnJvciBsYXVuY2hpbmcgaW5zdHJ1bWVudHM6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgIGxldCBlcnJJc0NhdGNoYWJsZSA9IGVyci5tZXNzYWdlID09PSBFUlJfTkVWRVJfQ0hFQ0tFRF9JTiB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnIubWVzc2FnZSA9PT0gRVJSX0NSQVNIRURfT05fU1RBUlRVUDtcbiAgICAgICAgaWYgKCFlcnJJc0NhdGNoYWJsZSkge1xuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfVxuICAgICAgICBpZiAobGF1bmNoVHJpZXMgPD0gdGhpcy5mbGFrZXlSZXRyaWVzKSB7XG4gICAgICAgICAgaWYgKHRoaXMuZ290RkJTT3BlbkFwcGxpY2F0aW9uRXJyb3IpIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZygnR290IHRoZSBGQlNPcGVuQXBwbGljYXRpb25FcnJvciwgbm90IGtpbGxpbmcgdGhlICcgK1xuICAgICAgICAgICAgICAgICAgICAgICdzaW0gYnV0IGxlYXZpbmcgaXQgb3BlbiBzbyB0aGUgYXBwIHdpbGwgbGF1bmNoJyk7XG4gICAgICAgICAgICB0aGlzLmdvdEZCU09wZW5BcHBsaWNhdGlvbkVycm9yID0gZmFsc2U7IC8vIGNsZWFyIG91dCBmb3IgbmV4dCBsYXVuY2hcbiAgICAgICAgICAgIGF3YWl0IEIuZGVsYXkoMTAwMCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGF3YWl0IGtpbGxBbGxTaW11bGF0b3JzKCk7XG4gICAgICAgICAgICBhd2FpdCBCLmRlbGF5KDUwMDApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdygnV2UgZXhjZWVkZWQgdGhlIG51bWJlciBvZiByZXRyaWVzIGFsbG93ZWQgZm9yICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdpbnN0cnVtZW50cyB0byBzdWNjZXNzZnVsbHkgc3RhcnQ7IGZhaWxpbmcgbGF1bmNoJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IHdoaWxlICh0cnVlKTtcbiAgfVxuXG4gIHJlZ2lzdGVyTGF1bmNoICgpIHtcbiAgICB0aGlzLmxhdW5jaFJlc3VsdERlZmVycmVkLnJlc29sdmUoKTtcbiAgfVxuXG4gIGFzeW5jIHNwYXduSW5zdHJ1bWVudHMgKCkge1xuICAgIGxldCB0cmFjZURpcjtcbiAgICBmb3IgKGxldCBpID0gMDsgOyBpKyspIHtcbiAgICAgIC8vIGxvb3Agd2hpbGUgdGhlcmUgYXJlIHRyYWNlZGlycyB0byBkZWxldGVcbiAgICAgIHRyYWNlRGlyID0gcGF0aC5yZXNvbHZlKHRoaXMudHJhY2VEaXIsIGBpbnN0cnVtZW50c2NsaSR7aX0udHJhY2VgKTtcbiAgICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHRyYWNlRGlyKSkgYnJlYWs7XG4gICAgfVxuXG4gICAgLy8gYnVpbGQgdXAgdGhlIGFyZ3VtZW50cyB0byB1c2VcbiAgICBsZXQgYXJncyA9IFsnLXQnLCB0aGlzLnRlbXBsYXRlLCAnLUQnLCB0cmFjZURpcl07XG4gICAgaWYgKHRoaXMudWRpZCkge1xuICAgICAgLy8gcmVhbCBkZXZpY2UsIHNvIHNwZWNpZnkgdWRpZFxuICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFsnLXcnLCB0aGlzLnVkaWRdKTtcbiAgICAgIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBydW4gYXBwIG9uIHJlYWwgZGV2aWNlIHdpdGggVURJRCAnJHt0aGlzLnVkaWR9J2ApO1xuICAgIH1cbiAgICBpZiAoIXRoaXMudWRpZCAmJiB0aGlzLnNpbXVsYXRvclNka0FuZERldmljZSkge1xuICAgICAgLy8gc2ltLCBzbyBzcGVjaWZ5IHRoZSBzZGsgYW5kIGRldmljZVxuICAgICAgYXJncyA9IGFyZ3MuY29uY2F0KFsnLXcnLCB0aGlzLnNpbXVsYXRvclNka0FuZERldmljZV0pO1xuICAgICAgbG9nLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHJ1biBhcHAgb24gJHt0aGlzLnNpbXVsYXRvclNka0FuZERldmljZX1gKTtcbiAgICB9XG4gICAgYXJncyA9IGFyZ3MuY29uY2F0KFt0aGlzLmFwcF0pO1xuICAgIGlmICh0aGlzLnByb2Nlc3NBcmd1bWVudHMpIHtcbiAgICAgIC8vIGFueSBhZGRpdGlvbmFsIHN0dWZmIHNwZWNpZnlpZWQgYnkgdGhlIHVzZXJcbiAgICAgIGFyZ3MgPSBhcmdzLmNvbmNhdCh0aGlzLnByb2Nlc3NBcmd1bWVudHMpO1xuICAgICAgbG9nLmRlYnVnKGBBdHRlbXB0aW5nIHRvIHJ1biBhcHAgd2l0aCBwcm9jZXNzIGFyZ3VtZW50czogJHtKU09OLnN0cmluZ2lmeSh0aGlzLnByb2Nlc3NBcmd1bWVudHMpfWApO1xuICAgIH1cbiAgICBhcmdzID0gYXJncy5jb25jYXQoWyctZScsICdVSUFTQ1JJUFQnLCB0aGlzLmJvb3RzdHJhcF0pO1xuICAgIGFyZ3MgPSBhcmdzLmNvbmNhdChbJy1lJywgJ1VJQVJFU1VMVFNQQVRIJywgdGhpcy50bXBEaXJdKTtcblxuICAgIGxldCBlbnYgPSBfLmNsb25lKHByb2Nlc3MuZW52KTtcbiAgICBpZiAodGhpcy54Y29kZVZlcnNpb24ubWFqb3IgPj0gNyAmJiAhdGhpcy51ZGlkKSB7XG4gICAgICAvLyBpd2QgY3VycmVudGx5IGRvZXMgbm90IHdvcmsgd2l0aCB4Y29kZTcsIHNldHRpbmcgd2l0aG91dERlbGF5IHRvIGZhbHNlXG4gICAgICBsb2cuaW5mbyhcIk9uIHhjb2RlIDcuMCssIGluc3RydW1lbnRzLXdpdGhvdXQtZGVsYXkgZG9lcyBub3Qgd29yaywgXCIgK1xuICAgICAgICAgICAgICAgXCJza2lwcGluZyBpbnN0cnVtZW50cy13aXRob3V0LWRlbGF5XCIpO1xuICAgICAgdGhpcy53aXRob3V0RGVsYXkgPSBmYWxzZTtcbiAgICB9XG4gICAgbGV0IGl3ZFBhdGggPSBhd2FpdCBnZXRJd2RQYXRoKHRoaXMueGNvZGVWZXJzaW9uLm1ham9yKTtcbiAgICBlbnYuQ0FfREVCVUdfVFJBTlNBQ1RJT05TID0gMTtcbiAgICBpZiAodGhpcy53aXRob3V0RGVsYXkgJiYgIXRoaXMudWRpZCkge1xuICAgICAgLy8gc2ltLCBhbmQgdXNpbmcgaS13LWRcbiAgICAgIGVudi5EWUxEX0lOU0VSVF9MSUJSQVJJRVMgPSBwYXRoLnJlc29sdmUoaXdkUGF0aCwgJ0luc3RydW1lbnRzU2hpbS5keWxpYicpO1xuICAgICAgZW52LkxJQl9QQVRIID0gaXdkUGF0aDtcbiAgICB9XG4gICAgbGV0IGluc3RydW1lbnRzRXhlY0FyZ3MgPSBbdGhpcy5pbnN0cnVtZW50c1BhdGgsIC4uLmFyZ3NdO1xuICAgIGluc3RydW1lbnRzRXhlY0FyZ3MgPSBfLm1hcChpbnN0cnVtZW50c0V4ZWNBcmdzLCBmdW5jdGlvbiAoYXJnKSB7XG4gICAgICBpZiAoYXJnID09PSBudWxsKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQSBudWxsIHZhbHVlIHdhcyBwYXNzZWQgYXMgYW4gYXJnIHRvIGV4ZWN1dGUgJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnaW5zdHJ1bWVudHMgb24gdGhlIGNvbW1hbmQgbGluZS4gQSBsZXRpYWJsZSBpcyAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICdwcm9iYWJseSBub3QgZ2V0dGluZyBzZXQuIEFycmF5IG9mIGNvbW1hbmQgYXJnczogJyArXG4gICAgICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShpbnN0cnVtZW50c0V4ZWNBcmdzKSk7XG4gICAgICB9XG4gICAgICAvLyBlc2NhcGUgYW55IGFyZ3VtZW50IHRoYXQgaGFzIGEgc3BhY2UgaW4gaXRcbiAgICAgIGlmIChfLmlzU3RyaW5nKGFyZykgJiYgYXJnLmluZGV4T2YoJyAnKSAhPT0gLTEpIHtcbiAgICAgICAgcmV0dXJuIGBcIiR7YXJnfVwiYDtcbiAgICAgIH1cbiAgICAgIC8vIG90aGVyd2lzZSBqdXN0IHVzZSB0aGUgYXJndW1lbnRcbiAgICAgIHJldHVybiBhcmc7XG4gICAgfSk7XG5cbiAgICBsb2cuZGVidWcoYFNwYXduaW5nIGluc3RydW1lbnRzIHdpdGggY29tbWFuZDogJyR7aW5zdHJ1bWVudHNFeGVjQXJncy5qb2luKCcgJyl9J2ApO1xuICAgIGlmICh0aGlzLndpdGhvdXREZWxheSkge1xuICAgICAgbG9nLmRlYnVnKCdBbmQgZXh0cmEgd2l0aG91dC1kZWxheSBlbnY6ICcgKyBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIERZTERfSU5TRVJUX0xJQlJBUklFUzogZW52LkRZTERfSU5TRVJUX0xJQlJBUklFUyxcbiAgICAgICAgTElCX1BBVEg6IGVudi5MSUJfUEFUSFxuICAgICAgfSkpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYEFuZCBsYXVuY2ggdGltZW91dHMgKGluIG1zKTogJHtKU09OLnN0cmluZ2lmeSh0aGlzLmxhdW5jaFRpbWVvdXQpfWApO1xuICAgIHJldHVybiBhd2FpdCBzcGF3bih0aGlzLmluc3RydW1lbnRzUGF0aCwgYXJncywge2VudjogZW52fSk7XG4gIH1cblxuICBhZGRTb2NrZXRDb25uZWN0VGltZXIgKGRlbGF5LCB0eXBlLCBkb0FjdGlvbikge1xuICAgIGxldCBzb2NrZXRDb25uZWN0RGVsYXkgPSBjYW5jZWxsYWJsZURlbGF5KGRlbGF5KTtcbiAgICBzb2NrZXRDb25uZWN0RGVsYXkudGhlbigoKSA9PiB7XG4gICAgICBsb2cud2FybihgSW5zdHJ1bWVudHMgc29ja2V0IGNsaWVudCBuZXZlciBjaGVja2VkIGluOyB0aW1pbmcgb3V0ICgke3R5cGV9KWApO1xuICAgICAgdGhpcy5zZXRFeGl0TGlzdGVuZXIoKCkgPT4ge1xuICAgICAgICB0aGlzLnByb2MgPSBudWxsO1xuICAgICAgICB0aGlzLmxhdW5jaFJlc3VsdERlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoRVJSX05FVkVSX0NIRUNLRURfSU4pKTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGRvQWN0aW9uKCk7XG4gICAgfSkuY2F0Y2goQi5DYW5jZWxsYXRpb25FcnJvciwgKCkgPT4ge30pLmRvbmUoKTtcbiAgICB0aGlzLnNvY2tldENvbm5lY3REZWxheXMucHVzaChzb2NrZXRDb25uZWN0RGVsYXkpO1xuICB9XG5cbiAgY2xlYXJTb2NrZXRDb25uZWN0VGltZXJzICgpIHtcbiAgICBmb3IgKGxldCBkZWxheSBvZiB0aGlzLnNvY2tldENvbm5lY3REZWxheXMpIHtcbiAgICAgIGRlbGF5LmNhbmNlbCgpO1xuICAgIH1cbiAgICB0aGlzLnNvY2tldENvbm5lY3REZWxheXMgPSBbXTtcbiAgfVxuXG4gIHNldEV4aXRMaXN0ZW5lciAoZXhpdExpc3RlbmVyKSB7XG4gICAgaWYgKCF0aGlzLnByb2MpIHJldHVybjtcbiAgICBpZiAodGhpcy5leGl0TGlzdGVuZXIpIHtcbiAgICAgIHRoaXMucHJvYy5yZW1vdmVMaXN0ZW5lcignZXhpdCcsIHRoaXMuZXhpdExpc3RlbmVyKTtcbiAgICB9XG4gICAgdGhpcy5leGl0TGlzdGVuZXIgPSBleGl0TGlzdGVuZXI7XG4gICAgdGhpcy5wcm9jLm9uKCdleGl0JywgZXhpdExpc3RlbmVyKTtcbiAgfVxuXG4gIC8qIFBST0NFU1MgTUFOQUdFTUVOVCAqL1xuICBhc3luYyBzaHV0ZG93biAoKSB7XG4gICAgaWYgKHRoaXMucHJvYykge1xuICAgICAgbG9nLmRlYnVnKCdTdGFydGluZyBzaHV0ZG93bi4nKTtcbiAgICAgIGxldCB3YXNUZXJtaW5hdGVkID0gZmFsc2U7XG4gICAgICAvLyBtb25pdG9yaW5nIHByb2Nlc3MgdGVybWluYXRpb25cbiAgICAgIGxldCB0ZXJtRGVsYXkgPSBjYW5jZWxsYWJsZURlbGF5KHRoaXMudGVybVRpbWVvdXQpO1xuICAgICAgbGV0IHRlcm1Qcm9taXNlID0gdGVybURlbGF5LmNhdGNoKEIuQ2FuY2VsbGF0aW9uRXJyb3IsICgpID0+IHt9KTtcbiAgICAgIHRoaXMuc2V0RXhpdExpc3RlbmVyKCgpID0+IHtcbiAgICAgICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICAgICAgd2FzVGVybWluYXRlZCA9IHRydWU7XG4gICAgICAgIHRlcm1EZWxheS5jYW5jZWwoKTtcbiAgICAgICAgdGhpcy5vblNodXRkb3duRGVmZXJyZWQucmVzb2x2ZSgpO1xuICAgICAgfSk7XG4gICAgICBsb2cuZGVidWcoJ1NlbmRpbmcgc2lndGVybSB0byBpbnN0cnVtZW50cycpO1xuICAgICAgdGhpcy5wcm9jLmtpbGwoJ1NJR1RFUk0nKTtcbiAgICAgIGF3YWl0IHRlcm1Qcm9taXNlO1xuICAgICAgaWYgKCF3YXNUZXJtaW5hdGVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW5zdHJ1bWVudHMgZGlkIG5vdCB0ZXJtaW5hdGUgYWZ0ZXIgJHt0aGlzLnRlcm1UaW1lb3V0IC8gMTAwMH0gc2Vjb25kcyFgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSW5zdHJ1bWVudHM7XG4iXX0=