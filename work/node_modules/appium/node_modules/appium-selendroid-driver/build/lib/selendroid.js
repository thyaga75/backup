'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumJsonwpProxy = require('appium-jsonwp-proxy');

var _appiumJsonwpProxy2 = _interopRequireDefault(_appiumJsonwpProxy);

var _asyncbox = require('asyncbox');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _appiumSelendroidInstaller = require('appium-selendroid-installer');

var REQD_PARAMS = ['adb', 'appPackage', 'appActivity', 'tmpDir', 'apk', 'host', 'systemPort', 'devicePort'];

var SelendroidServer = (function () {
  function SelendroidServer() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, SelendroidServer);

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(REQD_PARAMS), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var req = _step.value;

        if (!opts || !opts[req]) {
          throw new Error('Option \'' + req + '\' is required!');
        }
        this[req] = opts[req];
      }

      // new package name for repackaged selendroid server
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    this.modServerPkg = 'selendroid.' + this.appPackage;
    // path to the repackaged selendroid server specific to this app
    this.modServerPath = _path2['default'].resolve(this.tmpDir, this.modServerPkg + '.apk');
    this.jwproxy = new _appiumJsonwpProxy2['default']({ host: this.host, port: this.systemPort });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
  }

  _createClass(SelendroidServer, [{
    key: 'prepareModifiedServer',
    value: function prepareModifiedServer() {
      var needsUninstall;
      return _regeneratorRuntime.async(function prepareModifiedServer$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            needsUninstall = false;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.modServerPath));

          case 3:
            if (context$2$0.sent) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.buildNewModServer());

          case 6:
            needsUninstall = true;

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.checkAndSignCert(this.modServerPath));

          case 9:
            context$2$0.t0 = context$2$0.sent;

            if (context$2$0.t0) {
              context$2$0.next = 12;
              break;
            }

            context$2$0.t0 = needsUninstall;

          case 12:
            needsUninstall = context$2$0.t0;

            if (!needsUninstall) {
              context$2$0.next = 17;
              break;
            }

            _logger2['default'].info("New server was built, uninstalling any instances of it");
            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(this.adb.uninstallApk(this.modServerPkg));

          case 17:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'installModifiedServer',
    value: function installModifiedServer() {
      var installed;
      return _regeneratorRuntime.async(function installModifiedServer$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.isAppInstalled(this.modServerPkg));

          case 2:
            installed = context$2$0.sent;

            if (installed) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.install(this.modServerPath));

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'buildNewModServer',
    value: function buildNewModServer() {
      var packageTmpDir, newManifestPath;
      return _regeneratorRuntime.async(function buildNewModServer$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Repackaging selendroid for: \'' + this.appPackage + '\'');
            packageTmpDir = _path2['default'].resolve(this.tmpDir, this.appPackage);
            newManifestPath = _path2['default'].resolve(this.tmpDir, 'AndroidManifest.xml');

            _logger2['default'].info('Creating new manifest: \'' + newManifestPath + '\'');
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(packageTmpDir));

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(_appiumSelendroidInstaller.SE_MANIFEST_PATH, newManifestPath));

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.adb.initAapt());

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.adb.compileManifest(newManifestPath, this.modServerPkg, this.appPackage));

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.adb.insertManifest(newManifestPath, _appiumSelendroidInstaller.SE_APK_PATH, this.modServerPath));

          case 14:
            _logger2['default'].info('Repackaged selendroid ready: \'' + this.modServerPath + '\'');

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'checkAndSignCert',
    value: function checkAndSignCert(apk) {
      var signed;
      return _regeneratorRuntime.async(function checkAndSignCert$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.checkApkCert(apk, this.appPackage));

          case 2:
            signed = context$2$0.sent;

            if (signed) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.sign(apk));

          case 6:
            return context$2$0.abrupt('return', !signed);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession(caps) {
      var instrumentWith;
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            instrumentWith = this.modServerPkg + '/' + 'io.selendroid.server.ServerInstrumentation';

            _logger2['default'].info('Starting selendroid server with instrumentation: ' + ('' + instrumentWith));
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.adb.instrument(this.appPackage, this.appActivity, instrumentWith));

          case 4:

            _logger2['default'].info('Waiting for Selendroid to be online...');
            // wait 20s for Selendroid to be online
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 1000, function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.jwproxy.command('/status', 'GET'));

                  case 2:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            }));

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/session', 'POST', { desiredCapabilities: caps }));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting Selendroid server session');
            // rely on jwproxy's intelligence to know what we're talking about and
            // delete the current session
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/', 'DELETE'));

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].warn('Did not get confirmation Selendroid deleteSession worked; ' + ('Error was: ' + context$2$0.t0));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }]);

  return SelendroidServer;
})();

exports['default'] = SelendroidServer;
module.exports = exports['default'];

// TODO might have a race condition if we try building this with multiple
// sessions at the same time. OTOH we probably want to share the mod
// server...
// TODO this should be internal to adb

// return whether the apk was signed
//# sourceMappingURL=data:application/json;base64,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TSxFQUFFLEVBQUMsbUJBQW1CLEVBQUUsSUFBSSxFQUFDLENBQUM7Ozs7Ozs7S0FDNUU7OztXQUVtQjs7OztBQUNsQixnQ0FBTyxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQzs7Ozs7NkNBSTNDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxRQUFRLENBQUM7Ozs7Ozs7Ozs7QUFFekMsZ0NBQU8sSUFBSSxDQUFDLCtGQUNtQixDQUFDLENBQUM7Ozs7Ozs7S0FFcEM7OztTQTFGRyxnQkFBZ0I7OztxQkE2RlAsZ0JBQWdCIiwiZmlsZSI6ImxpYi9zZWxlbmRyb2lkLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEpXUHJveHkgZnJvbSAnYXBwaXVtLWpzb253cC1wcm94eSc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgU0VfQVBLX1BBVEgsIFNFX01BTklGRVNUX1BBVEggfSBmcm9tICdhcHBpdW0tc2VsZW5kcm9pZC1pbnN0YWxsZXInO1xuXG5cbmNvbnN0IFJFUURfUEFSQU1TID0gWydhZGInLCAnYXBwUGFja2FnZScsICdhcHBBY3Rpdml0eScsICd0bXBEaXInLCAnYXBrJyxcbiAgICAgICAgICAgICAgICAgICAgICdob3N0JywgJ3N5c3RlbVBvcnQnLCAnZGV2aWNlUG9ydCddO1xuXG5jbGFzcyBTZWxlbmRyb2lkU2VydmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGZvciAobGV0IHJlcSBvZiBSRVFEX1BBUkFNUykge1xuICAgICAgaWYgKCFvcHRzIHx8ICFvcHRzW3JlcV0pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJyR7cmVxfScgaXMgcmVxdWlyZWQhYCk7XG4gICAgICB9XG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XG4gICAgfVxuXG4gICAgLy8gbmV3IHBhY2thZ2UgbmFtZSBmb3IgcmVwYWNrYWdlZCBzZWxlbmRyb2lkIHNlcnZlclxuICAgIHRoaXMubW9kU2VydmVyUGtnID0gYHNlbGVuZHJvaWQuJHt0aGlzLmFwcFBhY2thZ2V9YDtcbiAgICAvLyBwYXRoIHRvIHRoZSByZXBhY2thZ2VkIHNlbGVuZHJvaWQgc2VydmVyIHNwZWNpZmljIHRvIHRoaXMgYXBwXG4gICAgdGhpcy5tb2RTZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBgJHt0aGlzLm1vZFNlcnZlclBrZ30uYXBrYCk7XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe2hvc3Q6IHRoaXMuaG9zdCwgcG9ydDogdGhpcy5zeXN0ZW1Qb3J0fSk7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuandwcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMuandwcm94eSk7XG4gIH1cblxuICBhc3luYyBwcmVwYXJlTW9kaWZpZWRTZXJ2ZXIgKCkge1xuICAgIC8vIFRPRE8gbWlnaHQgaGF2ZSBhIHJhY2UgY29uZGl0aW9uIGlmIHdlIHRyeSBidWlsZGluZyB0aGlzIHdpdGggbXVsdGlwbGVcbiAgICAvLyBzZXNzaW9ucyBhdCB0aGUgc2FtZSB0aW1lLiBPVE9IIHdlIHByb2JhYmx5IHdhbnQgdG8gc2hhcmUgdGhlIG1vZFxuICAgIC8vIHNlcnZlci4uLlxuICAgIGxldCBuZWVkc1VuaW5zdGFsbCA9IGZhbHNlO1xuICAgIGlmICghKGF3YWl0IGZzLmV4aXN0cyh0aGlzLm1vZFNlcnZlclBhdGgpKSkge1xuICAgICAgYXdhaXQgdGhpcy5idWlsZE5ld01vZFNlcnZlcigpO1xuICAgICAgbmVlZHNVbmluc3RhbGwgPSB0cnVlO1xuICAgIH1cbiAgICBuZWVkc1VuaW5zdGFsbCA9IGF3YWl0IHRoaXMuY2hlY2tBbmRTaWduQ2VydCh0aGlzLm1vZFNlcnZlclBhdGgpIHx8IG5lZWRzVW5pbnN0YWxsO1xuICAgIGlmIChuZWVkc1VuaW5zdGFsbCkge1xuICAgICAgbG9nZ2VyLmluZm8oXCJOZXcgc2VydmVyIHdhcyBidWlsdCwgdW5pbnN0YWxsaW5nIGFueSBpbnN0YW5jZXMgb2YgaXRcIik7XG4gICAgICBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsodGhpcy5tb2RTZXJ2ZXJQa2cpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxNb2RpZmllZFNlcnZlciAoKSB7XG4gICAgbGV0IGluc3RhbGxlZCA9IGF3YWl0IHRoaXMuYWRiLmlzQXBwSW5zdGFsbGVkKHRoaXMubW9kU2VydmVyUGtnKTtcbiAgICBpZiAoIWluc3RhbGxlZCkge1xuICAgICAgYXdhaXQgdGhpcy5hZGIuaW5zdGFsbCh0aGlzLm1vZFNlcnZlclBhdGgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGJ1aWxkTmV3TW9kU2VydmVyICgpIHtcbiAgICBsb2dnZXIuaW5mbyhgUmVwYWNrYWdpbmcgc2VsZW5kcm9pZCBmb3I6ICcke3RoaXMuYXBwUGFja2FnZX0nYCk7XG4gICAgbGV0IHBhY2thZ2VUbXBEaXIgPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsIHRoaXMuYXBwUGFja2FnZSk7XG4gICAgbGV0IG5ld01hbmlmZXN0UGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgJ0FuZHJvaWRNYW5pZmVzdC54bWwnKTtcbiAgICBsb2dnZXIuaW5mbyhgQ3JlYXRpbmcgbmV3IG1hbmlmZXN0OiAnJHtuZXdNYW5pZmVzdFBhdGh9J2ApO1xuICAgIGF3YWl0IGZzLm1rZGlyKHBhY2thZ2VUbXBEaXIpO1xuICAgIGF3YWl0IGZzLmNvcHlGaWxlKFNFX01BTklGRVNUX1BBVEgsIG5ld01hbmlmZXN0UGF0aCk7XG4gICAgYXdhaXQgdGhpcy5hZGIuaW5pdEFhcHQoKTsgLy8gVE9ETyB0aGlzIHNob3VsZCBiZSBpbnRlcm5hbCB0byBhZGJcbiAgICBhd2FpdCB0aGlzLmFkYi5jb21waWxlTWFuaWZlc3QobmV3TWFuaWZlc3RQYXRoLCB0aGlzLm1vZFNlcnZlclBrZyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBQYWNrYWdlKTtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbnNlcnRNYW5pZmVzdChuZXdNYW5pZmVzdFBhdGgsIFNFX0FQS19QQVRILFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgbG9nZ2VyLmluZm8oYFJlcGFja2FnZWQgc2VsZW5kcm9pZCByZWFkeTogJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofSdgKTtcbiAgfVxuXG4gIGFzeW5jIGNoZWNrQW5kU2lnbkNlcnQgKGFwaykge1xuICAgIGxldCBzaWduZWQgPSBhd2FpdCB0aGlzLmFkYi5jaGVja0Fwa0NlcnQoYXBrLCB0aGlzLmFwcFBhY2thZ2UpO1xuICAgIGlmICghc2lnbmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5zaWduKGFwayk7XG4gICAgfVxuXG4gICAgLy8gcmV0dXJuIHdoZXRoZXIgdGhlIGFwayB3YXMgc2lnbmVkXG4gICAgcmV0dXJuICFzaWduZWQ7XG4gIH1cblxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcbiAgICB2YXIgaW5zdHJ1bWVudFdpdGggPSBgJHt0aGlzLm1vZFNlcnZlclBrZ30vYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgYGlvLnNlbGVuZHJvaWQuc2VydmVyLlNlcnZlckluc3RydW1lbnRhdGlvbmA7XG4gICAgbG9nZ2VyLmluZm8oYFN0YXJ0aW5nIHNlbGVuZHJvaWQgc2VydmVyIHdpdGggaW5zdHJ1bWVudGF0aW9uOiBgICtcbiAgICAgICAgICAgICBgJHtpbnN0cnVtZW50V2l0aH1gKTtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbnN0cnVtZW50KHRoaXMuYXBwUGFja2FnZSwgdGhpcy5hcHBBY3Rpdml0eSwgaW5zdHJ1bWVudFdpdGgpO1xuXG4gICAgbG9nZ2VyLmluZm8oJ1dhaXRpbmcgZm9yIFNlbGVuZHJvaWQgdG8gYmUgb25saW5lLi4uJyk7XG4gICAgLy8gd2FpdCAyMHMgZm9yIFNlbGVuZHJvaWQgdG8gYmUgb25saW5lXG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyMCwgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgfSk7XG4gICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogY2Fwc30pO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdEZWxldGluZyBTZWxlbmRyb2lkIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvJywgJ0RFTEVURScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLndhcm4oYERpZCBub3QgZ2V0IGNvbmZpcm1hdGlvbiBTZWxlbmRyb2lkIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcbiAgICAgICAgICAgICAgICAgIGBFcnJvciB3YXM6ICR7ZXJyfWApO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBTZWxlbmRyb2lkU2VydmVyO1xuIl19