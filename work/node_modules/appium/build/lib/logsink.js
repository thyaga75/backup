'use strict';

var _Object$keys = require('babel-runtime/core-js/object/keys')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _npmlog = require('npmlog');

var _npmlog2 = _interopRequireDefault(_npmlog);

var _appiumLogger = require('appium-logger');

var _winston = require('winston');

var _winston2 = _interopRequireDefault(_winston);

var _appiumSupport = require('appium-support');

require('date-utils');

// set up distributed logging before everything else
(0, _appiumLogger.patchLogger)(_npmlog2['default']);
global._global_npmlog = _npmlog2['default'];

// npmlog is used only for emitting, we use winston for output
_npmlog2['default'].level = "silent";
var levels = {
  debug: 1,
  info: 2,
  warn: 3,
  error: 4
};

var colors = {
  info: 'cyan',
  debug: 'grey',
  warn: 'yellow',
  error: 'red'
};

var npmToWinstonLevels = {
  silly: 'debug',
  verbose: 'debug',
  debug: 'debug',
  info: 'info',
  http: 'info',
  warn: 'warn',
  error: 'error'
};

var logger = null;
var timeZone = null;

function timestamp() {
  var date = new Date();
  if (!timeZone) {
    date = new Date(date.valueOf() + date.getTimezoneOffset() * 60000);
  }
  return date.toFormat("YYYY-MM-DD HH24:MI:SS:LL");
}

// Strip the color marking within messages.
// We need to patch the transports, because the stripColor functionality in
// Winston is wrongly implemented at the logger level, and we want to avoid
// having to create 2 loggers.
function applyStripColorPatch(transport) {
  var _log = transport.log.bind(transport);
  transport.log = function (level, msg, meta, callback) {
    var code = /\u001b\[(\d+(;\d+)*)?m/g;
    msg = ('' + msg).replace(code, '');
    _log(level, msg, meta, callback);
  };
}

function _createConsoleTransport(args, logLvl) {
  var transport = new _winston2['default'].transports.Console({
    name: "console",
    timestamp: args.logTimestamp ? timestamp : undefined,
    colorize: !args.logNoColors,
    handleExceptions: true,
    exitOnError: false,
    json: false,
    level: logLvl,
    formatter: function formatter(options) {
      var meta = options.meta && _Object$keys(options.meta).length ? '\n\t' + JSON.stringify(options.meta) : '';
      var timestampPrefix = '';
      if (options.timestamp) {
        timestampPrefix = options.timestamp() + ' - ';
      }
      return '' + timestampPrefix + (options.message || '') + meta;
    }
  });
  if (args.logNoColors) {
    applyStripColorPatch(transport);
  }
  return transport;
}

function _createFileTransport(args, logLvl) {
  var transport = new _winston2['default'].transports.File({
    name: "file",
    timestamp: timestamp,
    filename: args.log,
    maxFiles: 1,
    handleExceptions: true,
    exitOnError: false,
    json: false,
    level: logLvl
  });
  applyStripColorPatch(transport);
  return transport;
}

function _createWebhookTransport(args, logLvl) {
  var host = null,
      port = null;

  if (args.webhook.match(':')) {
    var hostAndPort = args.webhook.split(':');
    host = hostAndPort[0];
    port = parseInt(hostAndPort[1], 10);
  }

  var transport = new _winston2['default'].transports.Webhook({
    name: "webhook",
    host: host || '127.0.0.1',
    port: port || 9003,
    path: '/',
    handleExceptions: true,
    exitOnError: false,
    json: false,
    level: logLvl
  });
  applyStripColorPatch(transport);
  return transport;
}

function _createTransports(args) {
  var transports, consoleLogLevel, fileLogLevel, lvlPair;
  return _regeneratorRuntime.async(function _createTransports$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        transports = [];
        consoleLogLevel = null;
        fileLogLevel = null;

        if (args.loglevel && args.loglevel.match(":")) {
          lvlPair = args.loglevel.split(':');

          consoleLogLevel = lvlPair[0] || consoleLogLevel;
          fileLogLevel = lvlPair[1] || fileLogLevel;
        } else {
          consoleLogLevel = fileLogLevel = args.loglevel;
        }

        transports.push(_createConsoleTransport(args, consoleLogLevel));

        if (!args.log) {
          context$1$0.next = 18;
          break;
        }

        context$1$0.prev = 6;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(args.log));

      case 9:
        if (!context$1$0.sent) {
          context$1$0.next = 12;
          break;
        }

        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(args.log));

      case 12:

        transports.push(_createFileTransport(args, fileLogLevel));
        context$1$0.next = 18;
        break;

      case 15:
        context$1$0.prev = 15;
        context$1$0.t0 = context$1$0['catch'](6);

        console.log('Tried to attach logging to file ' + args.log + ' but an error ' + ('occurred: ' + context$1$0.t0.message));

      case 18:

        if (args.webhook) {
          try {
            transports.push(_createWebhookTransport(args, fileLogLevel));
          } catch (e) {
            console.log('Tried to attach logging to webhook at ' + args.webhook + ' but ' + ('an error occurred: ' + e.message));
          }
        }

        return context$1$0.abrupt('return', transports);

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 15]]);
}

function init(args) {
  return _regeneratorRuntime.async(function init$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        // set de facto param passed to timestamp function
        timeZone = args.localTimezone;

        // by not adding colors here and not setting 'colorize' in transports
        // when logNoColors === true, console output is fully stripped of color.
        if (!args.logNoColors) {
          _winston2['default'].addColors(colors);
        }

        context$1$0.t0 = _winston2['default'].Logger;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_createTransports(args));

      case 5:
        context$1$0.t1 = context$1$0.sent;
        context$1$0.t2 = {
          transports: context$1$0.t1
        };
        logger = new context$1$0.t0(context$1$0.t2);

        // Capture logs emitted via npmlog and pass them through winston
        _npmlog2['default'].on('log', function (logObj) {
          var winstonLevel = npmToWinstonLevels[logObj.level] || 'info';
          var msg = logObj.message;
          if (logObj.prefix) {
            var prefix = '[' + logObj.prefix + ']';
            msg = prefix.magenta + ' ' + msg;
          }
          logger[winstonLevel](msg);
        });

        logger.setLevels(levels);

        // 8/19/14 this is a hack to force Winston to print debug messages to stdout rather than stderr.
        // TODO: remove this if winston provides an API for directing streams.
        if (levels[logger.transports.console.level] === levels.debug) {
          logger.debug = function (msg) {
            logger.info('[debug] ' + msg);
          };
        }

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.init = init;
exports['default'] = init;

// --log-level arg can optionally provide diff logging levels for console and file, separated by a colon

// if we don't delete the log file, winston will always append and it will grow infinitely large;
// winston allows for limiting log file size, but as of 9.2.14 there's a serious bug when using
// maxFiles and maxSize together. https://github.com/flatiron/winston/issues/397
//# sourceMappingURL=data:application/json;base64,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QixnQkFBSSxNQUFNLFNBQU8sTUFBTSxDQUFDLE1BQU0sTUFBRyxDQUFDO0FBQ2xDLGVBQUcsR0FBTSxNQUFNLENBQUMsT0FBTyxTQUFJLEdBQUcsQUFBRSxDQUFDO1dBQ2xDO0FBQ0QsZ0JBQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMzQixDQUFDLENBQUM7O0FBR0gsY0FBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQzs7OztBQUl6QixZQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxNQUFNLENBQUMsS0FBSyxFQUFFO0FBQzVELGdCQUFNLENBQUMsS0FBSyxHQUFHLFVBQVUsR0FBRyxFQUFFO0FBQzVCLGtCQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUMsQ0FBQztXQUMvQixDQUFDO1NBQ0g7Ozs7Ozs7Q0FDRjs7UUFHUSxJQUFJLEdBQUosSUFBSTtxQkFDRSxJQUFJIiwiZmlsZSI6ImxpYi9sb2dzaW5rLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG5wbWxvZyBmcm9tICducG1sb2cnO1xuaW1wb3J0IHsgcGF0Y2hMb2dnZXIgfSBmcm9tICdhcHBpdW0tbG9nZ2VyJztcbmltcG9ydCB3aW5zdG9uICBmcm9tICd3aW5zdG9uJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0ICdkYXRlLXV0aWxzJztcblxuXG4vLyBzZXQgdXAgZGlzdHJpYnV0ZWQgbG9nZ2luZyBiZWZvcmUgZXZlcnl0aGluZyBlbHNlXG5wYXRjaExvZ2dlcihucG1sb2cpO1xuZ2xvYmFsLl9nbG9iYWxfbnBtbG9nID0gbnBtbG9nO1xuXG4vLyBucG1sb2cgaXMgdXNlZCBvbmx5IGZvciBlbWl0dGluZywgd2UgdXNlIHdpbnN0b24gZm9yIG91dHB1dFxubnBtbG9nLmxldmVsID0gXCJzaWxlbnRcIjtcbmNvbnN0IGxldmVscyA9IHtcbiAgZGVidWc6IDEsXG4gIGluZm86IDIsXG4gIHdhcm46IDMsXG4gIGVycm9yOiA0LFxufTtcblxuY29uc3QgY29sb3JzID0ge1xuICBpbmZvOiAnY3lhbicsXG4gIGRlYnVnOiAnZ3JleScsXG4gIHdhcm46ICd5ZWxsb3cnLFxuICBlcnJvcjogJ3JlZCcsXG59O1xuXG5jb25zdCBucG1Ub1dpbnN0b25MZXZlbHMgPSB7XG4gIHNpbGx5OiAnZGVidWcnLFxuICB2ZXJib3NlOiAnZGVidWcnLFxuICBkZWJ1ZzogJ2RlYnVnJyxcbiAgaW5mbzogJ2luZm8nLFxuICBodHRwOiAnaW5mbycsXG4gIHdhcm46ICd3YXJuJyxcbiAgZXJyb3I6ICdlcnJvcicsXG59O1xuXG5sZXQgbG9nZ2VyID0gbnVsbDtcbmxldCB0aW1lWm9uZSA9IG51bGw7XG5cbmZ1bmN0aW9uIHRpbWVzdGFtcCAoKSB7XG4gIGxldCBkYXRlID0gbmV3IERhdGUoKTtcbiAgaWYgKCF0aW1lWm9uZSkge1xuICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlLnZhbHVlT2YoKSArIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKSAqIDYwMDAwKTtcbiAgfVxuICByZXR1cm4gZGF0ZS50b0Zvcm1hdChcIllZWVktTU0tREQgSEgyNDpNSTpTUzpMTFwiKTtcbn1cblxuLy8gU3RyaXAgdGhlIGNvbG9yIG1hcmtpbmcgd2l0aGluIG1lc3NhZ2VzLlxuLy8gV2UgbmVlZCB0byBwYXRjaCB0aGUgdHJhbnNwb3J0cywgYmVjYXVzZSB0aGUgc3RyaXBDb2xvciBmdW5jdGlvbmFsaXR5IGluXG4vLyBXaW5zdG9uIGlzIHdyb25nbHkgaW1wbGVtZW50ZWQgYXQgdGhlIGxvZ2dlciBsZXZlbCwgYW5kIHdlIHdhbnQgdG8gYXZvaWRcbi8vIGhhdmluZyB0byBjcmVhdGUgMiBsb2dnZXJzLlxuZnVuY3Rpb24gYXBwbHlTdHJpcENvbG9yUGF0Y2ggKHRyYW5zcG9ydCkge1xuICBsZXQgX2xvZyA9IHRyYW5zcG9ydC5sb2cuYmluZCh0cmFuc3BvcnQpO1xuICB0cmFuc3BvcnQubG9nID0gZnVuY3Rpb24gKGxldmVsLCBtc2csIG1ldGEsIGNhbGxiYWNrKSB7XG4gICAgbGV0IGNvZGUgPSAvXFx1MDAxYlxcWyhcXGQrKDtcXGQrKSopP20vZztcbiAgICBtc2cgPSAoJycgKyBtc2cpLnJlcGxhY2UoY29kZSwgJycpO1xuICAgIF9sb2cobGV2ZWwsIG1zZywgbWV0YSwgY2FsbGJhY2spO1xuICB9O1xufVxuXG5mdW5jdGlvbiBfY3JlYXRlQ29uc29sZVRyYW5zcG9ydCAoYXJncywgbG9nTHZsKSB7XG4gIGxldCB0cmFuc3BvcnQgPSBuZXcgKHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKSh7XG4gICAgbmFtZTogXCJjb25zb2xlXCIsXG4gICAgdGltZXN0YW1wOiBhcmdzLmxvZ1RpbWVzdGFtcCA/IHRpbWVzdGFtcCA6IHVuZGVmaW5lZCxcbiAgICBjb2xvcml6ZTogIWFyZ3MubG9nTm9Db2xvcnMsXG4gICAgaGFuZGxlRXhjZXB0aW9uczogdHJ1ZSxcbiAgICBleGl0T25FcnJvcjogZmFsc2UsXG4gICAganNvbjogZmFsc2UsXG4gICAgbGV2ZWw6IGxvZ0x2bCxcbiAgICBmb3JtYXR0ZXI6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICBsZXQgbWV0YSA9IG9wdGlvbnMubWV0YSAmJiBPYmplY3Qua2V5cyhvcHRpb25zLm1ldGEpLmxlbmd0aCA/IGBcXG5cXHQke0pTT04uc3RyaW5naWZ5KG9wdGlvbnMubWV0YSl9YCA6ICcnO1xuICAgICAgbGV0IHRpbWVzdGFtcFByZWZpeCA9ICcnO1xuICAgICAgaWYgKG9wdGlvbnMudGltZXN0YW1wKSB7XG4gICAgICAgIHRpbWVzdGFtcFByZWZpeCA9IGAke29wdGlvbnMudGltZXN0YW1wKCl9IC0gYDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBgJHt0aW1lc3RhbXBQcmVmaXh9JHtvcHRpb25zLm1lc3NhZ2UgfHwgJyd9JHttZXRhfWA7XG4gICAgfVxuICB9KTtcbiAgaWYgKGFyZ3MubG9nTm9Db2xvcnMpIHtcbiAgICBhcHBseVN0cmlwQ29sb3JQYXRjaCh0cmFuc3BvcnQpO1xuICB9XG4gIHJldHVybiB0cmFuc3BvcnQ7XG59XG5cbmZ1bmN0aW9uIF9jcmVhdGVGaWxlVHJhbnNwb3J0IChhcmdzLCBsb2dMdmwpIHtcbiAgbGV0IHRyYW5zcG9ydCA9IG5ldyAod2luc3Rvbi50cmFuc3BvcnRzLkZpbGUpKHtcbiAgICAgIG5hbWU6IFwiZmlsZVwiLFxuICAgICAgdGltZXN0YW1wOiB0aW1lc3RhbXAsXG4gICAgICBmaWxlbmFtZTogYXJncy5sb2csXG4gICAgICBtYXhGaWxlczogMSxcbiAgICAgIGhhbmRsZUV4Y2VwdGlvbnM6IHRydWUsXG4gICAgICBleGl0T25FcnJvcjogZmFsc2UsXG4gICAgICBqc29uOiBmYWxzZSxcbiAgICAgIGxldmVsOiBsb2dMdmwsXG4gICAgfVxuICApO1xuICBhcHBseVN0cmlwQ29sb3JQYXRjaCh0cmFuc3BvcnQpO1xuICByZXR1cm4gdHJhbnNwb3J0O1xufVxuXG5mdW5jdGlvbiBfY3JlYXRlV2ViaG9va1RyYW5zcG9ydCAoYXJncywgbG9nTHZsKSB7XG4gIGxldCBob3N0ID0gbnVsbCxcbiAgICAgIHBvcnQgPSBudWxsO1xuXG4gIGlmIChhcmdzLndlYmhvb2subWF0Y2goJzonKSkge1xuICAgIGxldCBob3N0QW5kUG9ydCA9IGFyZ3Mud2ViaG9vay5zcGxpdCgnOicpO1xuICAgIGhvc3QgPSBob3N0QW5kUG9ydFswXTtcbiAgICBwb3J0ID0gcGFyc2VJbnQoaG9zdEFuZFBvcnRbMV0sIDEwKTtcbiAgfVxuXG4gIGxldCB0cmFuc3BvcnQgPSBuZXcgKHdpbnN0b24udHJhbnNwb3J0cy5XZWJob29rKSh7XG4gICAgbmFtZTogXCJ3ZWJob29rXCIsXG4gICAgaG9zdDogaG9zdCB8fCAnMTI3LjAuMC4xJyxcbiAgICBwb3J0OiBwb3J0IHx8IDkwMDMsXG4gICAgcGF0aDogJy8nLFxuICAgIGhhbmRsZUV4Y2VwdGlvbnM6IHRydWUsXG4gICAgZXhpdE9uRXJyb3I6IGZhbHNlLFxuICAgIGpzb246IGZhbHNlLFxuICAgIGxldmVsOiBsb2dMdmwsXG4gIH0pO1xuICBhcHBseVN0cmlwQ29sb3JQYXRjaCh0cmFuc3BvcnQpO1xuICByZXR1cm4gdHJhbnNwb3J0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBfY3JlYXRlVHJhbnNwb3J0cyAoYXJncykge1xuICBsZXQgdHJhbnNwb3J0cyA9IFtdO1xuICBsZXQgY29uc29sZUxvZ0xldmVsID0gbnVsbDtcbiAgbGV0IGZpbGVMb2dMZXZlbCA9IG51bGw7XG5cbiAgaWYgKGFyZ3MubG9nbGV2ZWwgJiYgYXJncy5sb2dsZXZlbC5tYXRjaChcIjpcIikpIHtcbiAgICAvLyAtLWxvZy1sZXZlbCBhcmcgY2FuIG9wdGlvbmFsbHkgcHJvdmlkZSBkaWZmIGxvZ2dpbmcgbGV2ZWxzIGZvciBjb25zb2xlIGFuZCBmaWxlLCBzZXBhcmF0ZWQgYnkgYSBjb2xvblxuICAgIGxldCBsdmxQYWlyID0gYXJncy5sb2dsZXZlbC5zcGxpdCgnOicpO1xuICAgIGNvbnNvbGVMb2dMZXZlbCA9ICBsdmxQYWlyWzBdIHx8IGNvbnNvbGVMb2dMZXZlbDtcbiAgICBmaWxlTG9nTGV2ZWwgPSBsdmxQYWlyWzFdIHx8IGZpbGVMb2dMZXZlbDtcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlTG9nTGV2ZWwgPSBmaWxlTG9nTGV2ZWwgPSBhcmdzLmxvZ2xldmVsO1xuICB9XG5cbiAgdHJhbnNwb3J0cy5wdXNoKF9jcmVhdGVDb25zb2xlVHJhbnNwb3J0KGFyZ3MsIGNvbnNvbGVMb2dMZXZlbCkpO1xuXG4gIGlmIChhcmdzLmxvZykge1xuICAgIHRyeSB7XG4gICAgICAvLyBpZiB3ZSBkb24ndCBkZWxldGUgdGhlIGxvZyBmaWxlLCB3aW5zdG9uIHdpbGwgYWx3YXlzIGFwcGVuZCBhbmQgaXQgd2lsbCBncm93IGluZmluaXRlbHkgbGFyZ2U7XG4gICAgICAvLyB3aW5zdG9uIGFsbG93cyBmb3IgbGltaXRpbmcgbG9nIGZpbGUgc2l6ZSwgYnV0IGFzIG9mIDkuMi4xNCB0aGVyZSdzIGEgc2VyaW91cyBidWcgd2hlbiB1c2luZ1xuICAgICAgLy8gbWF4RmlsZXMgYW5kIG1heFNpemUgdG9nZXRoZXIuIGh0dHBzOi8vZ2l0aHViLmNvbS9mbGF0aXJvbi93aW5zdG9uL2lzc3Vlcy8zOTdcbiAgICAgIGlmIChhd2FpdCBmcy5leGlzdHMoYXJncy5sb2cpKSB7XG4gICAgICAgIGF3YWl0IGZzLnVubGluayhhcmdzLmxvZyk7XG4gICAgICB9XG5cbiAgICAgIHRyYW5zcG9ydHMucHVzaChfY3JlYXRlRmlsZVRyYW5zcG9ydChhcmdzLCBmaWxlTG9nTGV2ZWwpKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmxvZyhgVHJpZWQgdG8gYXR0YWNoIGxvZ2dpbmcgdG8gZmlsZSAke2FyZ3MubG9nfSBidXQgYW4gZXJyb3IgYCArXG4gICAgICAgICAgICAgICAgICBgb2NjdXJyZWQ6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIGlmIChhcmdzLndlYmhvb2spIHtcbiAgICB0cnkge1xuICAgICAgdHJhbnNwb3J0cy5wdXNoKF9jcmVhdGVXZWJob29rVHJhbnNwb3J0KGFyZ3MsIGZpbGVMb2dMZXZlbCkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnNvbGUubG9nKGBUcmllZCB0byBhdHRhY2ggbG9nZ2luZyB0byB3ZWJob29rIGF0ICR7YXJncy53ZWJob29rfSBidXQgYCArXG4gICAgICAgICAgICAgICAgICBgYW4gZXJyb3Igb2NjdXJyZWQ6ICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0cmFuc3BvcnRzO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbml0IChhcmdzKSB7XG4gIC8vIHNldCBkZSBmYWN0byBwYXJhbSBwYXNzZWQgdG8gdGltZXN0YW1wIGZ1bmN0aW9uXG4gIHRpbWVab25lID0gYXJncy5sb2NhbFRpbWV6b25lO1xuXG4gIC8vIGJ5IG5vdCBhZGRpbmcgY29sb3JzIGhlcmUgYW5kIG5vdCBzZXR0aW5nICdjb2xvcml6ZScgaW4gdHJhbnNwb3J0c1xuICAvLyB3aGVuIGxvZ05vQ29sb3JzID09PSB0cnVlLCBjb25zb2xlIG91dHB1dCBpcyBmdWxseSBzdHJpcHBlZCBvZiBjb2xvci5cbiAgaWYgKCFhcmdzLmxvZ05vQ29sb3JzKSB7XG4gICAgd2luc3Rvbi5hZGRDb2xvcnMoY29sb3JzKTtcbiAgfVxuXG4gIGxvZ2dlciA9IG5ldyAod2luc3Rvbi5Mb2dnZXIpKHtcbiAgICB0cmFuc3BvcnRzOiBhd2FpdCBfY3JlYXRlVHJhbnNwb3J0cyhhcmdzKVxuICB9KTtcblxuICAvLyBDYXB0dXJlIGxvZ3MgZW1pdHRlZCB2aWEgbnBtbG9nIGFuZCBwYXNzIHRoZW0gdGhyb3VnaCB3aW5zdG9uXG4gIG5wbWxvZy5vbignbG9nJywgKGxvZ09iaikgPT4ge1xuICAgIGxldCB3aW5zdG9uTGV2ZWwgPSBucG1Ub1dpbnN0b25MZXZlbHNbbG9nT2JqLmxldmVsXSB8fCAnaW5mbyc7XG4gICAgbGV0IG1zZyA9IGxvZ09iai5tZXNzYWdlO1xuICAgIGlmIChsb2dPYmoucHJlZml4KSB7XG4gICAgICBsZXQgcHJlZml4ID0gYFske2xvZ09iai5wcmVmaXh9XWA7XG4gICAgICBtc2cgPSBgJHtwcmVmaXgubWFnZW50YX0gJHttc2d9YDtcbiAgICB9XG4gICAgbG9nZ2VyW3dpbnN0b25MZXZlbF0obXNnKTtcbiAgfSk7XG5cblxuICBsb2dnZXIuc2V0TGV2ZWxzKGxldmVscyk7XG5cbiAgLy8gOC8xOS8xNCB0aGlzIGlzIGEgaGFjayB0byBmb3JjZSBXaW5zdG9uIHRvIHByaW50IGRlYnVnIG1lc3NhZ2VzIHRvIHN0ZG91dCByYXRoZXIgdGhhbiBzdGRlcnIuXG4gIC8vIFRPRE86IHJlbW92ZSB0aGlzIGlmIHdpbnN0b24gcHJvdmlkZXMgYW4gQVBJIGZvciBkaXJlY3Rpbmcgc3RyZWFtcy5cbiAgaWYgKGxldmVsc1tsb2dnZXIudHJhbnNwb3J0cy5jb25zb2xlLmxldmVsXSA9PT0gbGV2ZWxzLmRlYnVnKSB7XG4gICAgbG9nZ2VyLmRlYnVnID0gZnVuY3Rpb24gKG1zZykge1xuICAgICAgbG9nZ2VyLmluZm8oJ1tkZWJ1Z10gJyArIG1zZyk7XG4gICAgfTtcbiAgfVxufVxuXG5cbmV4cG9ydCB7IGluaXQgfTtcbmV4cG9ydCBkZWZhdWx0IGluaXQ7XG4iXX0=